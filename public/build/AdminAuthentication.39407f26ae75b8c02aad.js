"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5592],{38441:(le,S,t)=>{t.d(S,{F:()=>M});var e=t(74848),c=t(22803),P=t(96540),g=t(54148),T=t(25356),D=t(54594),x=t(11817),X=t(32027);const M=({confirmRedirect:y,onDiscard:p,onLocationChange:d})=>{const[r,O]=(0,P.useState)(!1),[K,v]=(0,P.useState)(null),[L,fe]=(0,P.useState)(!1);(0,P.useEffect)(()=>{const k=z=>{y&&(z.preventDefault(),z.returnValue="")};return window.addEventListener("beforeunload",k),()=>{window.removeEventListener("beforeunload",k)}},[y]);const me=k=>{const z=window.location.pathname,pe=k.pathname;if(z===pe)return!0;const W=d?.(k);let Q=y&&!L;return W!==void 0&&(Q=Q&&W),Q?(O(!0),v(k),!1):(W&&p(),!0)},B=()=>{O(!1),v(null)},xe=()=>{O(!1),fe(!0),p()};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(X.X,{when:!0,message:me}),K&&L&&(0,e.jsx)(g.C5,{replace:!0,to:K}),(0,e.jsx)(G,{isOpen:r,onDiscard:xe,onBackToForm:B})]})},G=({onDiscard:y,onBackToForm:p,isOpen:d})=>(0,e.jsxs)(T.a,{isOpen:d,title:"Leave page?",onDismiss:p,icon:"exclamation-triangle",className:(0,c.css)({width:"500px"}),children:[(0,e.jsx)("h5",{children:(0,e.jsx)(x.x6,{i18nKey:"form-prompt.description",children:"Changes that you made may not be saved."})}),(0,e.jsxs)(T.a.ButtonRow,{children:[(0,e.jsx)(D.$n,{variant:"secondary",onClick:p,fill:"outline",children:(0,e.jsx)(x.x6,{i18nKey:"form-prompt.continue-button",children:"Continue editing"})}),(0,e.jsx)(D.$n,{variant:"destructive",onClick:y,children:(0,e.jsx)(x.x6,{i18nKey:"form-prompt.discard-button",children:"Discard unsaved changes"})})]})]})},32027:(le,S,t)=>{t.d(S,{X:()=>P});var e=t(96540),c=t(53027);const P=({message:g,when:T=!0})=>{const D=c.Ny.getHistory();return(0,e.useEffect)(()=>{if(!T)return;const x=D.block(g);return()=>{x()}},[T,g,D]),null}},53094:(le,S,t)=>{t.r(S),t.d(S,{AuthConfigPageUnconnected:()=>Pe,default:()=>ee});var e=t(74848),c=t(96540),P=t(71468),g=t(96698),T=t(56276),D=t(54731),x=t(52120),X=t(98349),M=t(54122),G=t(88023),y=t(22803),p=t(29675),d=t(58528),r=t(45565),O=t(29010),K=t(54594),v=t(17687),L=t(90416);const fe=l=>({allowInsecureEmail:l.authConfig.settings?.auth?.oauth_allow_insecure_email_lookup.toLowerCase()==="true"}),me={loadSettings:L.M5,saveSettings:L.DZ},k=(0,P.connect)(fe,me)(({allowInsecureEmail:l,loadSettings:j,onClose:w,saveSettings:I})=>{const F=(0,v._2)(),$=async()=>{try{await I({updates:{auth:{oauth_allow_insecure_email_lookup:""+!l}}}),await j(!1),F.success("Settings saved")}catch{F.error("Failed to save settings")}},te=async()=>{try{await I({removals:{auth:["oauth_allow_insecure_email_lookup"]}}),await j(!1),F.success("Settings saved")}catch{F.error("Failed to save settings")}},H=(0,e.jsxs)(e.Fragment,{children:["Configure auth settings. Find out more in our"," ",(0,e.jsx)(D.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication/#settings",children:"documentation"}),"."]}),ue=(0,p.of)(z);return(0,e.jsxs)(d._,{title:"Auth Settings",subtitle:H,size:"md",onClose:w,children:[(0,e.jsxs)("div",{className:ue.advancedAuth,children:[(0,e.jsx)(r.E,{variant:"h4",children:"Advanced Auth"}),(0,e.jsx)(r.E,{variant:"h5",children:"Enable insecure email lookup"}),(0,e.jsx)(r.E,{variant:"body",color:"secondary",children:"Allow users to use the same email address to log into Grafana with different identity providers."}),(0,e.jsx)(O.d,{value:l,onChange:$})]}),(0,e.jsx)(K.$n,{size:"md",variant:"secondary",className:ue.button,onClick:te,tooltip:"This action will disregard any saved changes and load the configuration from the configuration file.",children:"Reset"})]})}),z=l=>({advancedAuth:(0,y.css)({display:"flex",flexDirection:"column",gap:l.spacing(1)}),button:(0,y.css)({marginTop:l.spacing(2)})});var pe=t(48583),W=t(79784);const Q=()=>{const l=(0,p.of)(be);return(0,e.jsxs)("div",{className:l.container,children:[(0,e.jsxs)(pe.B,{gap:1,alignItems:"center",children:[(0,e.jsx)(W.I,{name:"cog"}),(0,e.jsx)(r.E,{children:"Configuration required"})]}),(0,e.jsx)(r.E,{variant:"bodySmall",color:"secondary",children:"You have no authentication configuration created at the moment."}),(0,e.jsx)(D.Y,{href:"https://grafana.com/docs/grafana/latest/auth/overview/",external:!0,children:"Refer to the documentation on how to configure authentication"})]})},be=l=>({container:(0,y.css)({display:"flex",flexDirection:"column",gap:l.spacing(2),backgroundColor:l.colors.background.secondary,borderRadius:l.shape.radius.default,padding:l.spacing(3),width:"max-content",margin:l.spacing(3,"auto")})}),je=Q;var Ee=t(5005),q=t(6210),Ae=t(66384),ge=t(86288),Ce=t(95290);function ye({providerId:l,enabled:j,configPath:w,authType:I,onClick:F}){const $=(0,Ce.h)({configPath:w,id:l}),[te,H]=ge.L[l]||["lock",l.toUpperCase()];return(0,e.jsxs)(q.Z,{href:$,onClick:F,children:[(0,e.jsx)(q.Z.Heading,{children:H}),(0,e.jsx)(q.Z.Meta,{children:I}),(0,Ee.n6)(te)&&(0,e.jsx)(q.Z.Figure,{children:(0,e.jsx)(W.I,{name:te,size:"xxxl"})}),(0,e.jsx)(q.Z.Actions,{children:(0,e.jsx)(Ae.E,{text:j?"Enabled":"Not enabled",color:j?"green":"blue"})})]})}var de=t(4545);function Se(l){const{isLoading:j,providerStatuses:w,providers:I}=l.authConfig;return{isLoading:j,providerStatuses:w,providers:I}}const _={loadSettings:L.M5},Oe=(0,P.connect)(Se,_),Pe=({providerStatuses:l,isLoading:j,loadSettings:w,providers:I})=>{(0,c.useEffect)(()=>{w()},[w]);const[F,$]=(0,c.useState)(!1),H=(0,de.getRegisteredAuthProviders)().filter(m=>!l[m.id]?.hide),ue=(m,J)=>{(0,T.rR)("authentication_ui_provider_clicked",{provider:m,enabled:J})};I=I.filter(m=>m.provider!=="saml"),I=I.map(m=>m.provider==="ldap"?{...m,settings:{...m.settings,type:"LDAP"}}:m);const ce=H.length?[...H.map(m=>({provider:m.id,settings:{...l[m.id],configPath:m.configPath,type:m.type}})),...I]:I;return(0,e.jsx)(M.Y,{navId:"authentication",subTitle:(0,e.jsxs)(e.Fragment,{children:["Manage your auth settings and configure single sign-on. Find out more in our"," ",(0,e.jsx)(D.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication",children:"documentation"}),"."]}),actions:G.$W.buildInfo.edition!==g.r.OpenSource&&(0,e.jsx)(x.I,{icon:"cog",variant:"canvas",onClick:()=>$(!0),children:"Auth settings"}),children:(0,e.jsx)(M.Y.Contents,{isLoading:j,children:ce.length?(0,e.jsxs)(X.x,{gap:3,minColumnWidth:34,children:[ce.filter(({provider:m})=>!["grafana_com"].includes(m)).map(({provider:m,settings:J})=>(0,e.jsx)(ye,{authType:J.type||"OAuth",providerId:m,enabled:J.enabled,onClick:()=>ue(m,J.enabled),configPath:J.configPath},m)),F&&(0,e.jsx)(k,{onClose:()=>$(!1)})]}):(0,e.jsx)(je,{})})})},ee=Oe(Pe)},95599:(le,S,t)=>{t.r(S),t.d(S,{ProviderConfigPage:()=>Ge,default:()=>Ke});var e=t(74848),c=t(96540),P=t(54148),g=t(48583),T=t(45565),D=t(66384),x=t(54122),X=t(57017),M=t(61491),G=t(49785),y=t(52718),p=t(86833),d=t(28082),r=t(56276),O=t(53027),K=t(19224),v=t(86489),L=t(29010),fe=t(91036),me=t(90231),B=t(54594),xe=t(60232),k=t(99764),z=t(65164),pe=t(38441),W=t(22803),Q=t(29675),be=t(34128),je=t(79232),Ee=t(44826),q=t(81942),Ae=t(41391),ge=t(32370),Ce=t(54731),ye=t(87638),de=t(11817),Se=t(25356),_=t(95290);const Oe=({isOpen:a,onClose:n,onSuccess:s,isLoading:i})=>{const{handleSubmit:h,register:b,formState:{errors:f}}=(0,G.mN)({mode:"onBlur",defaultValues:{url:""}}),A=E=>E===""?"Please enter the .well-known/openid-configuration endpoint for your IdP":(0,_.K)(E)?!0:"Please enter a valid URL";return(0,e.jsx)(Se.a,{title:"OpenID Connect Discovery URL",onDismiss:n,onClickBackdrop:n,isOpen:a,children:(0,e.jsxs)("form",{onSubmit:E=>(E.stopPropagation(),h(s)(E)),children:[(0,e.jsx)(v.D,{label:"The .well-known/openid-configuration endpoint for your IdP",invalid:!!f.url,error:f.url?.message,htmlFor:"url",children:(0,e.jsx)(be.p,{...b("url",{validate:A}),width:80,id:"url"})}),(0,e.jsxs)(Se.a.ButtonRow,{children:[(0,e.jsx)(B.$n,{type:"submit",variant:"primary",disabled:i,children:i?(0,e.jsx)(de.x6,{i18nKey:"oauth.form.server-discovery-modal-loading",children:"Loading..."}):(0,e.jsx)(de.x6,{i18nKey:"oauth.form.server-discovery-modal-submit",children:"Submit"})}),(0,e.jsx)(B.$n,{type:"button",variant:"secondary",onClick:n,children:(0,e.jsx)(de.x6,{i18nKey:"oauth.form.server-discovery-modal-close",children:"Close"})})]})]})})},Pe=({setValue:a})=>{const n=(0,p.J7)(),[s,i]=(0,c.useState)(!1),[h,b]=(0,c.useState)(!1),f=()=>i(!1),A=async E=>{b(!0);try{const ne="/.well-known/openid-configuration",he=new URL(E.url);he.pathname.includes(ne)||(E.url=he.origin+ne);const N=await(0,d.AI)().get(E.url);if(!N.token_endpoint||!N.authorization_endpoint){n.publish({type:y.r1.alertWarning.name,payload:["The URL provided is not a valid .well-known/openid-configuration endpoint"]});return}a("tokenUrl",N.token_endpoint),a("authUrl",N.authorization_endpoint),N.userinfo_endpoint&&a("apiUrl",N.userinfo_endpoint),n.publish({type:y.r1.alertSuccess.name,payload:["OpenID Connect Discovery URL has been successfully fetched."]})}catch{n.publish({type:y.r1.alertWarning.name,payload:["Failed to fetch URL or invalid content"]})}finally{f(),b(!1)}};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(B.$n,{type:"button",variant:"secondary",onClick:()=>{i(!0)},children:(0,e.jsx)(de.x6,{i18nKey:"oauth.form.server-discovery-action-button",children:"Enter OpenID Connect Discovery URL"})}),(0,e.jsx)(Oe,{isOpen:s,onClose:f,onSuccess:A,isLoading:h})]})};function ee(a){return Array.isArray(a)&&a.every(n=>typeof n=="object"&&n!==null&&"value"in n)}const l={azuread:[{name:"General settings",id:"general",fields:["name","clientAuthentication","clientId","clientSecret","managedIdentityClientId","federatedCredentialAudience","scopes","authUrl","tokenUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","allowedGroups","forceUseGraphApi","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],generic_oauth:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","authStyle","scopes","serverDiscoveryUrl","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["nameAttributePath","loginAttributePath","emailAttributeName","emailAttributePath","idTokenAttributeName","roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","defineAllowedGroups",{name:"allowedGroups",dependsOn:"defineAllowedGroups"},{name:"groupsAttributePath",dependsOn:"defineAllowedGroups"},"defineAllowedTeamsIds",{name:"teamIds",dependsOn:"defineAllowedTeamsIds"},{name:"teamsUrl",dependsOn:"defineAllowedTeamsIds"},{name:"teamIdsAttributePath",dependsOn:"defineAllowedTeamsIds"},"usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],google:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["validateHd","hostedDomain","allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],github:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","teamIds","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],gitlab:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],okta:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}]};function j(a){return{clientAuthentication:{label:"Client authentication",type:"select",description:"The client authentication method used to authenticate to the token endpoint.",multi:!1,options:F(a),defaultValue:{value:"none",label:"None"},validation:{required:!0,message:"This field is required"}},clientId:{label:"Client Id",type:"text",description:"The client Id of your OAuth2 app.",validation:{required:!0,message:"This field is required"}},clientSecret:{label:"Client secret",type:"secret",description:"The client secret of your OAuth2 app."},managedIdentityClientId:{label:"FIC managed identity client Id",type:"text",description:"The managed identity client Id of the federated identity credential of your OAuth2 app."},federatedCredentialAudience:{label:"FIC audience",type:"text",description:"The audience of the federated identity credential of your OAuth2 app."},allowedOrganizations:{label:"Allowed organizations",type:"select",description:`List of comma- or space-separated organizations. The user should be a member 
of at least one organization to log in.`,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter organizations (my-team, myteam...) and press Enter to add"},allowedDomains:{label:"Allowed domains",type:"select",description:`List of comma- or space-separated domains. The user should belong to at least 
one domain to log in.`,multi:!0,allowCustomValue:!0,options:[]},authUrl:{label:"Auth URL",type:"text",description:"The authorization endpoint of your OAuth2 provider.",validation:{required:!0,validate:n=>(0,_.K)(n),message:"This field is required and must be a valid URL."}},authStyle:{label:"Auth style",type:"select",description:"It determines how client_id and client_secret are sent to Oauth2 provider. Default is AutoDetect.",multi:!1,options:[{value:"AutoDetect",label:"AutoDetect"},{value:"InParams",label:"InParams"},{value:"InHeader",label:"InHeader"}],defaultValue:{value:"AutoDetect",label:"AutoDetect"}},tokenUrl:{label:"Token URL",type:"text",description:"The token endpoint of your OAuth2 provider.",validation:{required:!0,validate:n=>(0,_.K)(n),message:"This field is required and must be a valid URL."}},scopes:{label:"Scopes",type:"select",description:"List of comma- or space-separated OAuth2 scopes.",multi:!0,allowCustomValue:!0,options:[]},allowedGroups:{label:"Allowed groups",type:"select",description:(0,e.jsxs)(e.Fragment,{children:["List of comma- or space-separated groups. The user should be a member of at least one group to log in."," ",a==="generic_oauth"&&"If you configure allowed_groups, you must also configure groups_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],validation:a==="azuread"?{validate:n=>typeof n=="string"?(0,Ae.A)(n):ee(n)?n.every(s=>s?.value&&(0,Ae.A)(s.value)):!0,message:"Allowed groups must be Object Ids."}:void 0},apiUrl:{label:"API URL",type:"text",description:(0,e.jsxs)(e.Fragment,{children:["The user information endpoint of your OAuth2 provider. Information returned by this endpoint must be compatible with"," ",(0,e.jsx)(Ce.Y,{href:"https://connect2id.com/products/server/docs/api/userinfo",external:!0,variant:"bodySmall",children:"OpenID UserInfo"}),"."]}),validation:{required:!1,validate:n=>typeof n!="string"?!1:n.length?(0,_.K)(n):!0,message:"This field must be a valid URL if set."}},roleAttributePath:{label:"Role attribute path",description:"JMESPath expression to use for Grafana role lookup.",type:"text",validation:{required:!1}},name:{label:"Display name",description:'Will be displayed on the login page as "Sign in with ...". Helpful if you use more than one identity providers or SSO protocols.',type:"text"},allowSignUp:{label:"Allow sign up",description:"If not enabled, only existing Grafana users can log in using OAuth.",type:"switch"},autoLogin:{label:"Auto login",description:"Log in automatically, skipping the login screen.",type:"switch"},signoutRedirectUrl:{label:"Sign out redirect URL",description:"The URL to redirect the user to after signing out from Grafana.",type:"text",validation:{required:!1}},emailAttributeName:{label:"Email attribute name",description:"Name of the key to use for user email lookup within the attributes map of OAuth2 ID token.",type:"text"},emailAttributePath:{label:"Email attribute path",description:"JMESPath expression to use for user email lookup from the user information.",type:"text"},nameAttributePath:{label:"Name attribute path",description:`JMESPath expression to use for user name lookup from the user ID token. 
This name will be used as the user\u2019s display name.`,type:"text"},loginAttributePath:{label:"Login attribute path",description:"JMESPath expression to use for user login lookup from the user ID token.",type:"text"},idTokenAttributeName:{label:"ID token attribute name",description:"The name of the key used to extract the ID token from the returned OAuth2 token.",type:"text"},roleAttributeStrict:{label:"Role attribute strict mode",description:"If enabled, denies user login if the Grafana role cannot be extracted using Role attribute path.",type:"switch"},allowAssignGrafanaAdmin:{label:"Allow assign Grafana admin",description:"If enabled, it will automatically sync the Grafana server administrator role.",type:"switch",hidden:!ye.TP.isGrafanaAdmin},skipOrgRoleSync:{label:"Skip organization role sync",description:"Prevent synchronizing users\u2019 organization roles from your IdP.",type:"switch"},orgMapping:{label:"Organization mapping",description:I(a),type:"select",hidden:!ye.TP.isGrafanaAdmin,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter mappings (my-team:1:Viewer...) and press Enter to add"},orgAttributePath:{label:"Organization attribute path",description:"JMESPath expression to use for organization lookup.",type:"text",hidden:!(["generic_oauth","okta"].includes(a)&&ye.TP.isGrafanaAdmin)},defineAllowedGroups:{label:"Define allowed groups",type:"switch"},defineAllowedTeamsIds:{label:"Define allowed teams ids",type:"switch"},forceUseGraphApi:{label:"Force use Graph API",description:"If enabled, Grafana will fetch the users' groups using the Microsoft Graph API.",type:"checkbox"},usePkce:{label:"Use PKCE",description:(0,e.jsxs)(e.Fragment,{children:["If enabled, Grafana will use"," ",(0,e.jsx)(Ce.Y,{external:!0,variant:"bodySmall",href:"https://datatracker.ietf.org/doc/html/rfc7636",children:"Proof Key for Code Exchange (PKCE)"})," ","with the OAuth2 Authorization Code Grant."]}),type:"checkbox"},useRefreshToken:{label:"Use refresh token",description:"If enabled, Grafana will fetch a new access token using the refresh token provided by the OAuth2 provider.",type:"checkbox"},tlsClientCa:{label:"TLS client ca",description:"The file path to the trusted certificate authority list. Is not applicable on Grafana Cloud.",type:"text",hidden:!ge.$.localFileSystemAvailable},tlsClientCert:{label:"TLS client cert",description:"The file path to the certificate. Is not applicable on Grafana Cloud.",type:"text",hidden:!ge.$.localFileSystemAvailable},tlsClientKey:{label:"TLS client key",description:"The file path to the key. Is not applicable on Grafana Cloud.",type:"text",hidden:!ge.$.localFileSystemAvailable},tlsSkipVerifyInsecure:{label:"TLS skip verify",description:`If enabled, the client accepts any certificate presented by the server and any host 
name in that certificate. You should only use this for testing, because this mode leaves 
SSL/TLS susceptible to man-in-the-middle attacks.`,type:"switch"},groupsAttributePath:{label:"Groups attribute path",description:`JMESPath expression to use for user group lookup. If you configure allowed_groups, 
you must also configure groups_attribute_path.`,type:"text"},teamsUrl:{label:"Teams URL",description:(0,e.jsxs)(e.Fragment,{children:["The URL used to query for Team Ids. If not set, the default value is /teams."," ",a==="generic_oauth"&&"If you configure teams_url, you must also configure team_ids_attribute_path."]}),type:"text",validation:{validate:(n,s)=>{let i=!0;return s.teamIds.length&&(i=!!n),typeof n=="string"&&n.length&&(i=(0,_.K)(n)),i},message:"This field must be set if Team Ids are configured and must be a valid URL."}},teamIdsAttributePath:{label:"Team Ids attribute path",description:"The JMESPath expression to use for Grafana Team Id lookup within the results returned by the teams_url endpoint.",type:"text",validation:{validate:(n,s)=>s.teamIds.length?!!n:!0,message:"This field must be set if Team Ids are configured."}},teamIds:{label:"Team Ids",type:"select",description:(0,e.jsxs)(e.Fragment,{children:[a==="github"?"Integer":"String"," list of Team Ids. If set, the user must be a member of one of the given teams to log in."," ",a==="generic_oauth"&&"If you configure team_ids, you must also configure teams_url and team_ids_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter Team Ids and press Enter to add",validation:a==="github"?{validate:n=>typeof n=="string"?w(n):ee(n)?n.every(s=>s?.value&&w(s.value)):!0,message:"Team Ids must be numbers."}:void 0},hostedDomain:{label:"Hosted domain",description:"The domain under which Grafana is hosted and accessible.",type:"text"},validateHd:{label:"Validate hosted domain",description:"If enabled, Grafana will match the Hosted Domain retrieved from the Google ID Token against the Allowed Domains list specified by the user.",type:"checkbox"},serverDiscoveryUrl:{label:"OpenID Connect Discovery URL",description:"The .well-known/openid-configuration endpoint for your IdP. The info extracted from this URL will be used to populate the Auth URL, Token URL and API URL fields.",type:"custom",content:n=>(0,e.jsx)(Pe,{setValue:n})}}}function w(a){return/^-?\d+$/.test(a)}function I(a){switch(a){case"azuread":return'List of "<GroupID>:<OrgIdOrName>:<Role>" mappings.';case"github":return'List of "<GitHubTeamName>:<OrgIdOrName>:<Role>" mappings.';case"gitlab":return'List of "<GitlabGroupName>:<OrgIdOrName>:<Role>';case"google":return'List of "<GoogleGroupName>:<OrgIdOrName>:<Role>';default:return'List of "<ExternalName>:<OrgIdOrName>:<Role>" mappings.'}}function F(a){switch(a){case"azuread":return[{value:"none",label:"None"},{value:"client_secret_post",label:"Client secret"},{value:"managed_identity",label:"Managed identity"}];default:return[{value:"none",label:"None"},{value:"client_secret_post",label:"Client secret"}]}}const $=({field:a,register:n,errors:s,watch:i,setValue:h,getValues:b,control:f,unregister:A,secretConfigured:E,provider:ne})=>{const[he,N]=(0,c.useState)(E),ae=typeof a!="string",o=ae?a.name:a,ie=ae?i(a.dependsOn):null,u=j(ne)[o],Ue=(0,Q.$j)();(0,c.useEffect)(()=>{ae&&(ie||A(o))},[A,o,ie,ae]);const Te=U=>Array.isArray(U)&&U.length>0&&"value"in U[0];if((0,c.useEffect)(()=>{if(u.defaultValue){const U=b(o),se=u.options?.find(oe=>oe.value===(Te(U)?U[0].value:void 0));h(o,se?.value||u.defaultValue.value)}},[]),!a)return console.log("missing field:",o),null;if(u.hidden||ae&&!i(a.dependsOn))return null;const Y={label:u.label,required:!!u.validation?.required,invalid:!!s[o],error:u.validation?.message,description:u.description,defaultValue:u.defaultValue?.value};switch(u.type){case"text":return(0,e.jsx)(v.D,{...Y,children:(0,e.jsx)(be.p,{...n(o,u.validation),type:u.type,id:o,autoComplete:"off"})},o);case"secret":return(0,e.jsx)(v.D,{...Y,htmlFor:o,children:(0,e.jsx)(G.xI,{name:o,control:f,rules:u.validation,render:({field:{ref:oe,value:re,...ve}})=>(0,e.jsx)(je.L4,{...ve,autoComplete:"off",id:o,value:typeof re=="string"?re:"",isConfigured:he,onReset:()=>{N(!1),h(o,"")}})})},o);case"select":const U=i(o);let se=u.options;return u.options?.length||(se=ee(U)?U:[]),(0,e.jsx)(v.D,{...Y,htmlFor:o,children:(0,e.jsx)(G.xI,{rules:u.validation,name:o,control:f,render:({field:{ref:oe,onChange:re,...ve},fieldState:{invalid:Re}})=>(0,e.jsx)(Ee.l6,{...ve,placeholder:u.placeholder,isMulti:u.multi,invalid:Re,inputId:o,options:se,allowCustomValue:!!u.allowCustomValue,defaultValue:u.defaultValue,onChange:re,onCreateOption:V=>{const De={value:V,label:V};re([...se||[],De])}})})},o);case"switch":return(0,e.jsx)(v.D,{...Y,children:(0,e.jsx)(L.d,{...n(o),id:o})},o);case"checkbox":return(0,e.jsx)(q.S,{...n(o),id:o,...Y,className:(0,W.css)({marginBottom:Ue.spacing(2)})},o);case"custom":return(0,e.jsx)(v.D,{...Y,children:u.content?u.content(h):(0,e.jsx)(e.Fragment,{})},o);default:return console.error(`Unknown field type: ${u.type}`),null}},te={allowAssignGrafanaAdmin:!1,allowSignUp:!1,allowedDomains:[],allowedGroups:[],allowedOrganizations:[],apiUrl:"",authStyle:"",authUrl:"",autoLogin:!1,clientAuthentication:"",clientId:"",clientSecret:"",managedIdentityClientId:"",federatedCredentialAudience:"",emailAttributeName:"",emailAttributePath:"",emptyScopes:!1,enabled:!1,extra:{},groupsAttributePath:"",hostedDomain:"",icon:"shield",name:"",roleAttributePath:"",roleAttributeStrict:!1,scopes:[],signoutRedirectUrl:"",skipOrgRoleSync:!1,teamIds:[],teamIdsAttributePath:"",teamsUrl:"",tlsClientCa:"",tlsClientCert:"",tlsClientKey:"",tlsSkipVerify:!1,tokenUrl:"",type:"",usePkce:!1,useRefreshToken:!1},H=a=>{if(!a?.length)return[];if(Array.isArray(a))return a.map(n=>({label:n,value:n}));if(a.startsWith("[")&&a.endsWith("]"))try{return JSON.parse(a).map(n=>({label:n,value:n}))}catch{}return a.split(/[\s,]/).map(n=>({label:n,value:n}))};function ue(a){if(!a)return te;const n=m(a.provider),s=we(j(a.provider),n),i={...a.settings};for(const h of s)i[h]=H(i[h]);return i}const ce=a=>JSON.stringify(a.map(({value:n})=>n)),m=a=>{const n=l[a],s=["enabled"];return Object.values(n).reduce((i,h)=>[...i,...h.fields.map(b=>typeof b=="string"?b:b.name)],s)};function J(a,n){let s=a;const i=m(n),h=we(j(n),i),b=Object.keys(s).filter(f=>i.includes(f)).reduce((f,A)=>({...f,[A]:s[A]}),{});for(const f of h){const A=s[f];A&&(ee(A)?b[f]=ce(A):ee([A])&&(b[f]=A.value))}return b}function we(a,n){return Object.entries(a).filter(([s,i])=>n.includes(s)&&i.type==="select").map(([s])=>s)}const Ie=(0,p.J7)(),ke=({config:a,provider:n,isLoading:s})=>{const{register:i,handleSubmit:h,control:b,reset:f,watch:A,setValue:E,getValues:ne,unregister:he,formState:{errors:N,dirtyFields:ae,isSubmitted:o}}=(0,G.mN)({defaultValues:ue(a),mode:"onSubmit",reValidateMode:"onChange"}),[ie,u]=(0,c.useState)(!1),[Ue,Te]=(0,c.useState)(!1),Y=o&&!Ue,U=l[n],[se,oe]=(0,c.useState)(!1),re=(0,e.jsx)(K.W,{children:(0,e.jsx)(K.W.Item,{label:"Reset to default values",icon:"history-alt",onClick:()=>{oe(!0)}})}),ve=async C=>{u(!0),Te(!1);const Z=J(C,n);try{await(0,d.AI)().put(`/api/v1/sso-settings/${n}`,{id:a?.id,provider:a?.provider,settings:{...Z}},{showErrorAlert:!1}),(0,r.rR)("grafana_authentication_ssosettings_saved",{provider:n,enabled:Z.enabled}),Ie.publish({type:y.r1.alertSuccess.name,payload:["Settings saved"]}),f(C),setTimeout(()=>{O.Ny.push("/admin/authentication")},300)}catch(R){let Le="";(0,d.NF)(R)?Le=R.data.message:R instanceof Error&&(Le=R.message),Ie.publish({type:y.r1.alertError.name,payload:[Le]}),Te(!0),u(!1)}},Re=async()=>{try{await(0,d.AI)().delete(`/api/v1/sso-settings/${n}`,void 0,{showSuccessAlert:!1}),(0,r.rR)("grafana_authentication_ssosettings_removed",{provider:n}),Ie.publish({type:y.r1.alertSuccess.name,payload:["Settings reset to defaults"]}),setTimeout(()=>{O.Ny.push("/admin/authentication")})}catch(C){let Z="";(0,d.NF)(C)?Z=C.data.message:C instanceof Error&&(Z=C.message),Ie.publish({type:y.r1.alertError.name,payload:[Z]})}},V=a?.settings.enabled,De=C=>{(0,r.rR)("grafana_authentication_ssosettings_save_attempt",{provider:n,enabled:C?!V:V}),C&&E("enabled",!V)};return(0,e.jsxs)(x.Y.Contents,{isLoading:s,children:[(0,e.jsxs)("form",{onSubmit:h(ve),style:{maxWidth:"600px"},children:[(0,e.jsx)(pe.F,{confirmRedirect:!!Object.keys(ae).length&&!Y,onDiscard:()=>{(0,r.rR)("grafana_authentication_ssosettings_abandoned",{provider:n}),f()}}),(0,e.jsx)(v.D,{label:"Enabled",hidden:!0,children:(0,e.jsx)(L.d,{...i("enabled"),id:"enabled",label:"Enabled"})}),(0,e.jsx)(g.B,{gap:2,direction:"column",children:U.filter(C=>!C.hidden).map((C,Z)=>(0,e.jsx)(fe.M,{label:C.name,isOpen:Z===0,children:C.fields.filter(R=>typeof R!="string"?!R.hidden:!0).map(R=>(0,e.jsx)($,{field:R,control:b,errors:N,setValue:E,getValues:ne,register:i,watch:A,unregister:he,provider:n,secretConfigured:!!a?.settings.clientSecret},typeof R=="string"?R:R.name))},C.name))}),(0,e.jsx)(me.a,{display:"flex",gap:2,marginTop:5,children:(0,e.jsxs)(g.B,{alignItems:"center",gap:2,children:[(0,e.jsx)(B.$n,{type:"submit",disabled:ie,onClick:()=>De(!0),variant:V?"secondary":void 0,children:ie?V?"Disabling...":"Saving...":V?"Disable":"Save and enable"}),(0,e.jsx)(B.$n,{type:"submit",disabled:ie,variant:"secondary",onClick:()=>De(!1),children:ie?"Saving...":"Save"}),(0,e.jsx)(B.z9,{href:"/admin/authentication",variant:"secondary",children:"Discard"}),(0,e.jsx)(xe.m,{overlay:re,placement:"bottom-start",children:(0,e.jsx)(k.K,{tooltip:"More actions",title:"More actions",tooltipPlacement:"top",size:"md",variant:"secondary",name:"ellipsis-v",hidden:a?.source==="system"})})]})})]}),se&&(0,e.jsx)(z.u,{isOpen:!0,icon:"trash-alt",title:"Reset",body:(0,e.jsxs)(g.B,{direction:"column",gap:3,children:[(0,e.jsx)("span",{children:"Are you sure you want to reset this configuration?"}),(0,e.jsx)("small",{children:"After resetting these settings Grafana will use the provider configuration from the system (config file/environment variables) if any."})]}),confirmText:"Reset",onDismiss:()=>oe(!1),onConfirm:async()=>{await Re(),oe(!1)}})]})};var Me=t(86288),Fe=t(90416);const Ne=a=>{if(!a)return{text:"Authentication",subTitle:"Configure authentication providers",icon:"shield",id:"authentication"};const n=Me.L[a.provider][1]||a.provider.toUpperCase();return{text:n||"",subTitle:`To configure ${n} OAuth2 you must register your application with ${n}. The provider will generate a Client ID and Client Secret for you to use.`,icon:a.settings.icon||"shield",id:a.provider}},Ge=()=>{const a=(0,M.useDispatch)(),{isLoading:n,providers:s}=(0,M.useSelector)(f=>f.authConfig),{provider:i=""}=(0,P.g)(),h=s.find(f=>f.provider===i);if((0,c.useEffect)(()=>{a((0,Fe.TD)(i))},[a,i]),!h||!h.provider||!Me.L[h.provider])return(0,e.jsx)(X.H,{});const b=Ne(h);return(0,e.jsx)(x.Y,{navId:"authentication",pageNav:b,renderTitle:f=>(0,e.jsxs)(g.B,{gap:2,alignItems:"center",children:[(0,e.jsx)(T.E,{variant:"h1",children:f}),(0,e.jsx)(D.E,{text:h.settings.enabled?"Enabled":"Not enabled",color:h.settings.enabled?"green":"blue",icon:h.settings.enabled?"check":void 0})]}),children:(0,e.jsx)(ke,{config:h,isLoading:n,provider:i})})},Ke=Ge},86288:(le,S,t)=>{t.d(S,{L:()=>c,o:()=>e});const e="admin/authentication/",c={github:["github","GitHub"],gitlab:["gitlab","GitLab"],google:["google","Google"],generic_oauth:["lock","Generic OAuth"],grafana_com:["grafana","Grafana.com"],azuread:["microsoft","Azure AD"],okta:["okta","Okta"]}},90416:(le,S,t)=>{t.d(S,{DZ:()=>y,M5:()=>X,TD:()=>M});var e=t(75505),c=t(28082),P=t(32370),g=t(87638),T=t(61491),D=t(4545),x=t(33790);function X(p=!0){return async d=>{if(g.TP.hasPermission(T.AccessControlAction.SettingsRead)){p&&d((0,x.sr)()),d(M());const r=await(0,c.AI)().get("/api/admin/settings");return d((0,x.jA)(r)),await d(G()),p&&d((0,x.MH)()),r}}}function M(p=""){return async d=>{if(!P.$.featureToggles.ssoSettingsApi)return[];const r=await(0,c.AI)().get(`/api/v1/sso-settings${p?`/${p}`:""}`);return d((0,x.Oy)(p?[r]:r)),r}}function G(){return async p=>{const d=(0,D.getRegisteredAuthProviders)(),r={},O=[];for(const v of d)O.push((0,D.getAuthProviderStatus)(v.id));const K=await Promise.all(O);for(let v=0;v<d.length;v++){const L=d[v];r[L.id]=K[v]}p((0,x.TO)(r))}}function y(p){return async d=>{if(g.TP.hasPermission(T.AccessControlAction.SettingsWrite))try{return await(0,e.s)((0,c.AI)().fetch({url:"/api/admin/settings",method:"PUT",data:p,showSuccessAlert:!1,showErrorAlert:!1})),d((0,x.SH)()),!0}catch(r){if(console.log(r),(0,c.NF)(r)){r.isHandled=!0;const O={message:r.data?.message,errors:r.data?.errors};return d((0,x.Nh)(O)),!1}}return!1}}},95290:(le,S,t)=>{t.d(S,{K:()=>P,h:()=>c});var e=t(86288);function c(g){return e.o+(g.configPath||g.id)}const P=g=>{if(typeof g!="string")return!1;try{return new URL(g).protocol.includes("http")}catch{return!1}}}}]);

//# sourceMappingURL=AdminAuthentication.39407f26ae75b8c02aad.js.map