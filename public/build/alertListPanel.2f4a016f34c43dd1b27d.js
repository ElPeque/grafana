"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3375],{99696:(pe,T,s)=>{s.d(T,{R:()=>X});var n=s(74848),Q=s(22803),$=s(29675),U=s(99764);const X=({labelKey:S,value:j,operator:F="=",onRemoveLabel:y})=>{const q=(0,$.of)(k);return(0,n.jsxs)("div",{className:q.wrapper,children:[S,F,j,!!y&&(0,n.jsx)(U.K,{name:"times",size:"xs",onClick:y,tooltip:"Remove label"})]})},k=S=>({wrapper:(0,Q.css)({padding:S.spacing(.5,1),borderRadius:S.shape.radius.default,border:`solid 1px ${S.colors.border.medium}`,fontSize:S.typography.bodySmall.fontSize,backgroundColor:S.colors.background.secondary,fontWeight:S.typography.fontWeightBold,color:S.colors.text.primary,display:"inline-block",lineHeight:"1.2"})})},33797:(pe,T,s)=>{s.r(T),s.d(T,{plugin:()=>tt});var n=s(74848),Q=s(68256),$=s(48583),U=s(54594),X=s(96843),k=s(15773),S=s(61491),j=s(88214),F=s(2543),y=s(96540),q=s(44826),Y=s(79784),_=s(9912),z=s(48542),E=s(4013),A=s(51876),ve=s(70584);const ye=e=>{const{onChange:a,id:t,defaultValue:o,dataSource:l}=e,r=(0,S.useDispatch)();(0,y.useEffect)(()=>{l?l&&r((0,z.mB)({rulesSourceName:l})):r((0,z.nV)())},[r,l]);const i=(0,_.$)(m=>m.promRules),p=(0,E.p0)(i),x=(0,E.Vf)(i),c=(0,y.useMemo)(()=>{if((0,F.isEmpty)(i))return[];if(!p)return[];const m=Object.keys(i).flatMap(d=>i[d].result??[]).flatMap(d=>d.groups).flatMap(d=>d.rules.filter(v=>v.type===A.JS.Alerting)).flatMap(d=>d.alerts??[]).map(d=>Object.keys(d.labels??{})).flatMap(d=>d.filter(v=>!(0,ve.F2)(v)));return(0,F.uniq)(m)},[p,i]);return(0,n.jsx)(q.KF,{id:t,isLoading:x,defaultValue:o,"aria-label":"group by label keys",placeholder:"Group by",prefix:(0,n.jsx)(Y.I,{name:"tag-alt"}),onChange:m=>{a(m.map(d=>d.value??""))},options:c.map(m=>({label:m,value:m}))})};var u=s(22803),xe=s(42941),Ae=s(94701),Re=s(86833),V=s(29675),Se=s(99134),K=s(5958),je=s(81876),Fe=s(37e3),Ie=s(88023),ie=s(71481),be=s(5240),C=s(6774),De=s(91064),Ne=s(83466),ce=s(55936),R=s(82700),de=s(16910),P=s(747),f=s(2255),Be=s(99696),Ce=s(55127),Me=s.n(Ce),Le=s(57732),we=s(85651),Ee=s(40828),Ve=s(1814),N=s(35004);function Pe(e,a){const t=(0,ce.Zc)(e);return(0,Ve.Av)(a,t)}function ee(e,a){const{stateFilter:t,alertInstanceLabelFilter:o}=e;return(0,F.isEmpty)(t)?a:a.filter(l=>(t.firing&&((0,N.SA)(l,A.Gi.Alerting)||(0,N.SA)(l,A.cF.Firing))||t.pending&&((0,N.SA)(l,A.Gi.Pending)||(0,N.SA)(l,A.cF.Pending))||t.noData&&(0,N.SA)(l,A.Gi.NoData)||t.normal&&(0,N.SA)(l,A.Gi.Normal)||t.error&&(0,N.SA)(l,A.Gi.Error)||t.inactive&&(0,N.SA)(l,A.cF.Inactive))&&(o?Pe(e.alertInstanceLabelFilter,l.labels):!0))}const ue=({rule:e,alerts:a,options:t,grafanaTotalInstances:o,handleInstancesLimit:l,limitInstances:r,grafanaFilteredInstancesTotal:i})=>{const p=t.groupMode===f.r6.Custom?!0:t.showInstances,[x,c]=(0,y.useState)(p),m=(0,V.of)(Oe),d=(0,V.of)(U.my),v=(0,y.useCallback)(()=>{c(w=>!w)},[]),h=(0,y.useMemo)(()=>ee(t,(0,we.Cp)(t.sortOrder,a))??[],[a,t]),g=o!==void 0,b=o&&i?o-i:0,I=a.length-h.length,B=g?b:I,M=h.length>0,G=M?v:F.noop;(0,y.useEffect)(()=>{h.length===0&&c(!1)},[h]);const L=async()=>{l&&(l(!1),c(!0))},ae=async()=>{l&&(l(!0),c(!0))},se=r?i:h.length,ne=h.length,H=g?se:ne,le=r?`Showing ${C.Ys} of ${o} instances`:`Showing all ${o} instances`,re=r?"View all instances":`Limit the result to ${C.Ys} instances`,oe=o&&C.Ys===h.length&&o>h.length,Z=o&&C.Ys<h.length&&!r,J=oe||Z?(0,n.jsxs)("div",{className:m.footerRow,children:[(0,n.jsx)("div",{children:le}),(0,n.jsx)(U.$n,{size:"sm",variant:"secondary",onClick:r?L:ae,children:re})]}):void 0;return(0,n.jsxs)("div",{children:[t.groupMode===f.r6.Default&&(0,n.jsxs)("button",{className:(0,u.cx)(d,M?m.clickable:""),onClick:()=>G(),children:[M&&(0,n.jsx)(Y.I,{name:x?"angle-down":"angle-right",size:"md"}),(0,n.jsx)("span",{children:`${H} ${Me()("instance",H)}`}),B>0&&(0,n.jsxs)("span",{children:[", ",`${B} hidden by filters`]})]}),x&&(0,n.jsx)(Le.D,{rule:e,instances:h,pagination:{itemsPerPage:2*Ee.FG},footerRow:J})]})},Oe=e=>({clickable:(0,u.css)({cursor:"pointer"}),footerRow:(0,u.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),justifyContent:"space-between",alignItems:"center",width:"100%"})}),O="__ungrouped__",Ue=({rules:e,options:a})=>{const t=(0,V.of)(te),o=a.groupBy,l=(0,y.useMemo)(()=>{const r=new Map,i=c=>o?$e(c,o):!0;e.forEach(c=>{const m=(0,R.TU)(c),d=i(c);(m?.alerts??[]).forEach(v=>{const h=d?Ge(o,v.labels):O,g=r.get(h)?.alerts??[];r.set(h,{rule:c,alerts:[...g,v]})})});const p=r.get(O)?.alerts??[];return r.delete(O),r.set(O,{alerts:p}),Array.from(r.entries()).reduce((c,[m,{rule:d,alerts:v}])=>{const h=ee(a,v);return h.length>0&&c.set(m,{rule:d,alerts:h}),c},new Map)},[o,e,a]);return(0,n.jsx)(n.Fragment,{children:Array.from(l).map(([r,{rule:i,alerts:p}])=>(0,n.jsx)("li",{className:t.alertRuleItem,"data-testid":r,children:(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:t.customGroupDetails,children:(0,n.jsxs)("div",{className:t.alertLabels,children:[r!==O&&Te(r).map(([x,c])=>(0,n.jsx)(Be.R,{labelKey:x,value:c},x)),r===O&&"No grouping"]})}),(0,n.jsx)(ue,{rule:i,alerts:p,options:a})]})},r))})};function Ge(e,a){return new URLSearchParams(e.map(t=>[t,a[t]])).toString()}function Te(e){return[...new URLSearchParams(e)]}function $e(e,a){const t=(0,R.TU)(e);return a.every(o=>(t?.alerts??[]).some(l=>l.labels[o]))}const Ye=Ue;var ze=s(87586),Ke=s(66102),We=s(7484),fe=s(68639),He=s(35874);function ge(e){return Object.values(e).filter(a=>a!==void 0).reduce((a,t)=>a+t,0)}const Ze=({rules:e,options:a,handleInstancesLimit:t,limitInstances:o,hideViewRuleLinkText:l})=>{const r=(0,V.of)(te),i=(0,V.of)(Je),{href:p}=(0,ze.A)(),x=e.length<=a.maxItems?e:e.slice(0,a.maxItems);return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("ol",{className:r.alertRuleList,children:x.map((c,m)=>{const{namespaceName:d,groupName:v,dataSourceName:h}=c,g=(0,R.Z8)(c.promRule)?c.promRule:void 0,b=(0,R.Om)(g),I=(0,fe.UP)(c.dataSourceName,c),B=(0,fe.$9)(I),M=c.dataSourceName===j.hY?ge(c.instanceTotals):void 0,G=c.dataSourceName===j.hY?ge(c.filteredInstanceTotals):void 0,L=(0,He.G)(`/alerting/${encodeURIComponent(h)}/${encodeURIComponent(B)}/view`,{returnTo:p??""});return g?(0,n.jsxs)("li",{className:r.alertRuleItem,children:[(0,n.jsx)("div",{className:i.icon,children:(0,n.jsx)(Y.I,{name:ie.A.getStateDisplayModel(g.state).iconClass,className:i[(0,R.Wy)(g.state)],size:"lg"})}),(0,n.jsxs)("div",{className:r.alertNameWrapper,children:[(0,n.jsxs)("div",{className:r.instanceDetails,children:[(0,n.jsxs)($.B,{direction:"row",gap:1,children:[(0,n.jsx)("div",{className:r.alertName,title:c.name,children:c.name}),(0,n.jsx)(We.h,{}),L&&(0,n.jsxs)("a",{href:L,target:"__blank",className:r.link,rel:"noopener","aria-label":"View alert rule",children:[(0,n.jsx)("span",{className:(0,u.cx)({[r.hidden]:l}),children:"View alert rule"}),(0,n.jsx)(Y.I,{name:"external-link-alt",size:"sm"})]})]}),(0,n.jsxs)("div",{className:r.alertDuration,children:[(0,n.jsx)("span",{className:i[(0,R.Wy)(g.state)],children:(0,R.XI)(g.state)})," ",b&&g.state!==A.cF.Inactive&&(0,n.jsxs)(n.Fragment,{children:["for"," ",(0,n.jsx)("span",{children:(0,Ke.dU)({start:b,end:Date.now()})})]})]})]}),(0,n.jsx)(ue,{rule:c,alerts:g.alerts??[],options:a,grafanaTotalInstances:M,grafanaFilteredInstancesTotal:G,handleInstancesLimit:t,limitInstances:o})]})]},`alert-${d}-${v}-${c.name}-${m}`):null})})})},Je=e=>({icon:(0,u.css)({marginTop:e.spacing(2.5),alignSelf:"flex-start"}),good:(0,u.css)({color:e.colors.success.main}),bad:(0,u.css)({color:e.colors.error.main}),warning:(0,u.css)({color:e.colors.warning.main}),neutral:(0,u.css)({color:e.colors.secondary.main}),info:(0,u.css)({color:e.colors.primary.main})}),Qe=Ze;function Xe(e){const a=(t,[o,l])=>l?[...t,o]:t;return Object.entries(e).reduce(a,[])}const W=({dispatch:e,limitInstances:a,matcherList:t,dataSourceName:o,stateList:l})=>{e(o?(0,z.Lc)({rulesSourceName:o,limitAlerts:a?C.Ys:void 0,matcher:t,state:l}):(0,z.yo)(!1,{limitAlerts:a?C.Ys:void 0,matcher:t,state:l}))};function ke(e){const a=(0,S.useDispatch)(),[t,o]=(0,xe.A)(!0),[,l]=(0,P.Ej)(P.RY.ViewAlertRule),{usePrometheusRulesByNamespaceQuery:r}=be.hK,i=(0,_.$)(D=>D.promRules),p=(0,_.$)(D=>D.rulerRules),x=(0,E.t4)(i),c=e.width<320;(0,y.useEffect)(()=>{e.options.stateFilter.inactive===!0&&(e.options.stateFilter.normal=!0),e.options.stateFilter.inactive=void 0},[e.options.stateFilter]);let m;(0,Ae.A)(()=>{m=(0,de.UA)().getCurrent()});const d=(0,y.useMemo)(()=>Xe(e.options.stateFilter),[e.options.stateFilter]),{options:v,replaceVariables:h}=e,g=v.datasource===j.vv?j.hY:v.datasource,b={...e.options,alertName:h(v.alertName),alertInstanceLabelFilter:h(v.alertInstanceLabelFilter)},I=(0,y.useMemo)(()=>(0,ce.Zc)(b.alertInstanceLabelFilter),[b.alertInstanceLabelFilter]),B=(!g||g===j.hY)&&l,{currentData:M=[],isLoading:G,refetch:L}=r({limitAlerts:t?C.Ys:void 0,matcher:I,state:d},{skip:!B});(0,y.useEffect)(()=>{i.loading||W({dispatch:a,limitInstances:t,matcherList:I,dataSourceName:g,stateList:d});const D=m?.events.subscribe(Re.sR,()=>{B&&L(),(!g||g!==j.hY)&&W({dispatch:a,limitInstances:t,matcherList:I,dataSourceName:g,stateList:d})});return()=>{D?.unsubscribe()}},[a,m,I,d,t,g,L,B,i.loading]);const ae=D=>{D?(W({dispatch:a,limitInstances:t,matcherList:I,dataSourceName:g,stateList:d}),o(!0)):(W({dispatch:a,limitInstances:!1,matcherList:I,dataSourceName:g,stateList:d}),o(!1))},se=(0,De.dy)(void 0,M),ne=(0,E.t4)(p),H=(0,E.BU)(i),le=x||ne,re=(0,E.Vf)(i),oe=(0,V.of)(te),Z=(0,R.dS)(se),J=e.options.sortOrder,w=(0,y.useMemo)(()=>_e(e,qe(J,Z)),[Z,J,e]),me=w.length===0?"No alerts matching filters":void 0,at=G||le&&re&&!H,he=Object.values(i).some(D=>D.result);return(0,n.jsxs)(Se.P,{minHeight:"100%",children:[he&&me&&(0,n.jsx)("div",{className:oe.noAlertsMessage,children:me}),he&&(0,n.jsxs)("section",{children:[e.options.viewMode===f.nE.Stat&&(0,n.jsx)(K.yV,{width:e.width,height:e.height,graphMode:K.$p.None,textMode:K.SV.Auto,justifyMode:K.F8.Auto,theme:Ie.$W.theme2,value:{text:`${w.length}`,numeric:w.length}}),e.options.viewMode===f.nE.List&&e.options.groupMode===f.r6.Custom&&(0,n.jsx)(Ye,{rules:w,options:b}),e.options.viewMode===f.nE.List&&e.options.groupMode===f.r6.Default&&(0,n.jsx)(Qe,{rules:w,options:b,handleInstancesLimit:ae,limitInstances:t,hideViewRuleLinkText:c})]}),at&&(0,n.jsx)(je._,{text:"Loading..."})]})}function qe(e,a){if(e===f.xB.Importance)return(0,F.sortBy)(a,o=>ie.A.alertStateSortScore[o.state]);if(e===f.xB.TimeAsc)return(0,F.sortBy)(a,o=>{const l=(0,R.TU)(o)??void 0;return(0,R.Om)(l)||new Date});if(e===f.xB.TimeDesc)return(0,F.sortBy)(a,o=>{const l=(0,R.TU)(o)??void 0;return(0,R.Om)(l)||new Date}).reverse();const t=(0,F.sortBy)(a,o=>o.name.toLowerCase());return e===f.xB.AlphaDesc&&t.reverse(),t}function _e(e,a){const{options:t,replaceVariables:o}=e;let l=[...a];if(t.dashboardAlerts){const r=(0,de.UA)().getCurrent()?.uid;l=l.filter(({annotations:i={}})=>Object.entries(i).some(([p,x])=>p===Ne.YH.dashboardUID&&x===r))}if(t.alertName){const r=o(t.alertName);l=l.filter(({name:i})=>i.toLocaleLowerCase().includes(r.toLocaleLowerCase()))}if(l=l.filter(r=>{const i=(0,R.TU)(r);return i?t.stateFilter.firing&&i.state===A.cF.Firing||t.stateFilter.pending&&i.state===A.cF.Pending||t.stateFilter.normal&&i.state===A.cF.Inactive:!1}),t.folder&&(l=l.filter(r=>r.namespaceName===t.folder.title)),t.datasource){const r=t.datasource===j.vv;l=l.filter(r?({dataSourceName:i})=>i===j.hY:({dataSourceName:i})=>i===t.datasource)}return l=l.reduce((r,i)=>{const p=(0,R.TU)(i);return((p?ee({stateFilter:t.stateFilter,alertInstanceLabelFilter:o(t.alertInstanceLabelFilter)},p.alerts??[]):[]).length||p?.state===A.cF.Inactive&&t.showInactiveAlerts&&!t.alertInstanceLabelFilter.length)&&r.push(i),r},[]),l}const te=e=>({cardContainer:(0,u.css)({padding:e.spacing(.5,0,.25,0),lineHeight:e.typography.body.lineHeight,marginBottom:0}),alertRuleList:(0,u.css)({display:"flex",flexWrap:"wrap",justifyContent:"space-between",listStyleType:"none"}),alertRuleItem:(0,u.css)({display:"flex",alignItems:"center",width:"100%",height:"100%",background:e.colors.background.secondary,padding:e.spacing(.5,1),borderRadius:e.shape.radius.default,marginBottom:e.spacing(.5),gap:e.spacing(2)}),alertName:(0,u.css)({fontSize:e.typography.h6.fontSize,fontWeight:e.typography.fontWeightBold,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}),alertNameWrapper:(0,u.css)({display:"flex",flex:1,flexWrap:"nowrap",flexDirection:"column",minWidth:"100px"}),alertLabels:(0,u.css)({"> *":{marginRight:e.spacing(.5)}}),alertDuration:(0,u.css)({fontSize:e.typography.bodySmall.fontSize}),alertRuleItemText:(0,u.css)({fontWeight:e.typography.fontWeightBold,fontSize:e.typography.bodySmall.fontSize,margin:0}),alertRuleItemTime:(0,u.css)({color:e.colors.text.secondary,fontWeight:"normal",whiteSpace:"nowrap"}),alertRuleItemInfo:(0,u.css)({fontWeight:"normal",flexGrow:2,display:"flex",alignItems:"flex-end"}),noAlertsMessage:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}),alertIcon:(0,u.css)({marginRight:e.spacing(.5)}),instanceDetails:(0,u.css)({minWidth:"1px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}),customGroupDetails:(0,u.css)({marginBottom:e.spacing(.5)}),link:(0,u.css)({wordBreak:"break-all",color:e.colors.primary.text,display:"flex",alignItems:"center",gap:e.spacing(1)}),hidden:(0,u.css)({display:"none"})});function et(e){const[,a]=(0,P.Ej)(P.RY.ViewAlertRule),[,t]=(0,P.Ej)(P.RY.ViewExternalAlertRule);return!a&&!t?(0,n.jsx)(Fe.F,{title:"Permission required",children:"Sorry, you do not have the required permissions to read alert rules"}):(0,n.jsx)(ke,{...e})}const tt=new Q.m(et).setPanelOptions(e=>{e.addRadio({path:"viewMode",name:"View mode",description:"Toggle between list view and stat view",defaultValue:f.nE.List,settings:{options:[{label:"List",value:f.nE.List},{label:"Stat",value:f.nE.Stat}]},category:["Options"]}).addRadio({path:"groupMode",name:"Group mode",description:"How alert instances should be grouped",defaultValue:f.r6.Default,settings:{options:[{value:f.r6.Default,label:"Default grouping"},{value:f.r6.Custom,label:"Custom grouping"}]},category:["Options"]}).addCustomEditor({path:"groupBy",name:"Group by",description:"Filter alerts using label querying",id:"groupBy",defaultValue:[],showIf:a=>a.groupMode===f.r6.Custom,category:["Options"],editor:a=>(0,n.jsx)(ye,{id:a.id??"groupBy",defaultValue:a.value.map(t=>({label:t,value:t})),onChange:a.onChange,dataSource:a.context.options.datasource})}).addNumberInput({name:"Max items",path:"maxItems",description:"Maximum alerts to display",defaultValue:20,category:["Options"]}).addSelect({name:"Sort order",path:"sortOrder",description:"Sort order of alerts and alert instances",settings:{options:[{label:"Alphabetical (asc)",value:f.xB.AlphaAsc},{label:"Alphabetical (desc)",value:f.xB.AlphaDesc},{label:"Importance",value:f.xB.Importance},{label:"Time (asc)",value:f.xB.TimeAsc},{label:"Time (desc)",value:f.xB.TimeDesc}]},defaultValue:f.xB.AlphaAsc,category:["Options"]}).addBooleanSwitch({path:"dashboardAlerts",name:"Alerts linked to this dashboard",description:"Only show alerts linked to this dashboard",defaultValue:!1,category:["Options"]}).addTextInput({path:"alertName",name:"Alert name",description:"Filter for alerts containing this text",defaultValue:"",category:["Filter"]}).addTextInput({path:"alertInstanceLabelFilter",name:"Alert instance label",description:'Filter alert instances using label querying, ex: {severity="critical", instance=~"cluster-us-.+"}',defaultValue:"",category:["Filter"]}).addCustomEditor({path:"datasource",name:"Datasource",description:"Filter from alert source",id:"datasource",defaultValue:null,editor:function(t){return(0,n.jsxs)($.B,{gap:1,children:[(0,n.jsx)(k.s,{...t,type:["prometheus","loki","grafana"],noDefault:!0,current:t.value,onChange:o=>t.onChange(o.name)}),(0,n.jsx)(U.$n,{variant:"secondary",onClick:()=>t.onChange(null),children:"Clear"})]})},category:["Filter"]}).addCustomEditor({showIf:a=>a.datasource===j.vv||!a.datasource,path:"folder",name:"Folder",description:"Filter for alerts in the selected folder (for Grafana-managed alert rules only)",id:"folder",defaultValue:null,editor:function(t){return(0,n.jsx)(X.sR,{enableReset:!0,showRoot:!1,allowEmpty:!0,initialTitle:t.value?.title,initialFolderUid:t.value?.uid,permissionLevel:S.PermissionLevelString.View,onClear:()=>t.onChange(""),...t})},category:["Filter"]}).addBooleanSwitch({path:"showInactiveAlerts",name:"Show alerts with 0 instances",description:"Include alert rules which have 0 (zero) instances. Because these rules have no instances, they remain hidden if the Alert instance label filter is configured.",defaultValue:!1,category:["Filter"]}).addBooleanSwitch({path:"stateFilter.firing",name:"Alerting / Firing",defaultValue:!0,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.pending",name:"Pending",defaultValue:!0,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.noData",name:"No Data",defaultValue:!1,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.normal",name:"Normal",defaultValue:!1,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.error",name:"Error",defaultValue:!0,category:["Alert state filter"]})})}}]);

//# sourceMappingURL=alertListPanel.2f4a016f34c43dd1b27d.js.map