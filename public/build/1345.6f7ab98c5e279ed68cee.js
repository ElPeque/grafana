"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1345],{77066:(Ie,oe,t)=>{t.d(oe,{B:()=>me});var e=t(74848),y=t(96540),b=t(53027),re=t(37e3),_=t(9365),M=t(35626),ee=t(2473),S=t(88214),K=t(72897),N=t(49785),le=t(86489),ce=t(81942);const z=({pathPrefix:j,className:O,readOnly:B=!1})=>{const{register:L}=(0,N.xW)();return(0,e.jsx)("div",{className:O,children:(0,e.jsx)(le.D,{disabled:B,children:(0,e.jsx)(ce.S,{...L(`${j}sendResolved`),label:"Send resolved",disabled:B,description:"Whether or not to notify about resolved alerts."})})})};var te=t(90114);const H=Object.freeze({__id:"",sendResolved:!0,secureSettings:{},settings:{},secureFields:{},type:"email"}),de=ee.r.map(j=>({dto:j})),{useGetAlertmanagerConfigurationQuery:J}=_.m,me=({contactPoint:j,alertManagerSourceName:O,readOnly:B=!1,editMode:L})=>{const{isLoading:D,data:ne}=J(O),Q=(0,S.AL)(O),[ue]=(0,M.Kt)({alertmanager:O}),[se]=(0,M.Pm)({alertmanager:O}),[ge]=(0,y.useMemo)(()=>j?(0,K.Iq)(j,ee.r):[void 0,{}],[j]),ve=async P=>{const ae=(0,K.QX)(P,H);try{L&&j?await se.execute({contactPoint:ae,originalName:j.name}):await ue.execute({contactPoint:ae}),b.Ny.push("/alerting/notifications")}catch{}},X=!B&&!Q;return(0,e.jsxs)(e.Fragment,{children:[!Q&&(0,e.jsx)(re.F,{title:"Info",severity:"info",children:"Note that empty string values will be replaced with global defaults where appropriate."}),(0,e.jsx)(te.k,{showDefaultRouteWarning:!D&&!ne?.alertmanager_config.route,isEditable:X,isTestable:X,onSubmit:ve,initialValues:ge,notifiers:de,alertManagerSourceName:O,defaultItem:H,commonSettingsComponent:z})]})}},85946:(Ie,oe,t)=>{t.d(oe,{a:()=>Fe});var e=t(74848),y=t(96540),b=t(53027),re=t(81876),_=t(37e3),M=t(35626),ee=t(80681),S=t(88214),K=t(13693),N=t(61491),le=t(9365),ce=t(48542),z=t(72897),te=t(27219),H=t(94736),de=t(17209),J=t(49785),me=t(86489),j=t(81942);const O=({pathPrefix:s,className:W,readOnly:n=!1})=>{const{register:a}=(0,J.xW)();return(0,e.jsx)("div",{className:W,children:(0,e.jsx)(me.D,{children:(0,e.jsx)(j.S,{...a(`${s}disableResolveMessage`),label:"Disable resolved message",description:"Disable the resolve message [OK] that is sent when alerting state returns to false",disabled:n})})})};var B=t(90114),L=t(22803),D=t(29675),ne=t(25356),Q=t(40271),ue=t(60641),se=t(54594),ge=t(83466),ve=t(1530),X=t(30378),P=(s=>(s.predefined="Predefined",s.custom="Custom",s))(P||{});const ae=Object.values(P).map(s=>({label:s,value:s})),xe={annotations:[...ge.kl],labels:[{key:"",value:""}]},pe=({isOpen:s,onDismiss:W,onTest:n})=>{const[a,r]=(0,y.useState)("Predefined"),u=(0,D.of)(je),C=(0,J.mN)({defaultValues:xe,mode:"onBlur"}),F=p=>{if(a==="Custom"){const f={annotations:p.annotations.filter(({key:h,value:c})=>!!h&&!!c).reduce((h,{key:c,value:i})=>({...h,[c]:i}),{}),labels:p.labels.filter(({key:h,value:c})=>!!h&&!!c).reduce((h,{key:c,value:i})=>({...h,[c]:i}),{})};n(f)}else n()};return(0,e.jsxs)(ne.a,{onDismiss:W,isOpen:s,title:"Test contact point",children:[(0,e.jsxs)("div",{className:u.section,children:[(0,e.jsx)(Q.J,{children:"Notification message"}),(0,e.jsx)(ue.z,{options:ae,value:a,onChange:p=>r(p)})]}),(0,e.jsx)(J.Op,{...C,children:(0,e.jsxs)("form",{onSubmit:C.handleSubmit(F),children:[a==="Predefined"&&(0,e.jsxs)("div",{className:u.section,children:["You will send a test notification that uses a predefined alert. If you have defined a custom template or message, for better results switch to ",(0,e.jsx)("strong",{children:"custom"})," notification message, from above."]}),a==="Custom"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:u.section,children:"You will send a test notification that uses the annotations defined below. This is a good option if you use custom templates and messages."}),(0,e.jsx)("div",{className:u.section,children:(0,e.jsx)(ve.A,{})}),(0,e.jsx)("div",{className:u.section,children:(0,e.jsx)(X.Ay,{})})]}),(0,e.jsx)(ne.a.ButtonRow,{children:(0,e.jsx)(se.$n,{type:"submit",children:"Send test notification"})})]})})]})},je=s=>({flexRow:(0,L.css)({display:"flex",flexDirection:"row",alignItems:"flex-start",marginBottom:s.spacing(1)}),section:(0,L.css)({marginBottom:s.spacing(2)})}),fe=Object.freeze({__id:"",secureSettings:{},settings:{},secureFields:{},disableResolveMessage:!1,type:"email"}),{useGrafanaNotifiersQuery:Ce}=le.m,Fe=({contactPoint:s,readOnly:W=!1,editMode:n})=>{const a=(0,N.useDispatch)(),r=(0,K.dM)(S.hY),[u]=(0,M.Kt)({alertmanager:S.hY}),[C]=(0,M.Pm)({alertmanager:S.hY}),{onCallNotifierMeta:F,extendOnCallNotifierFeatures:p,extendOnCallReceivers:f,onCallFormValidators:h,isLoadingOnCallIntegration:c,hasOnCallError:i}=(0,de.VY)(),{data:T=[],isLoading:A}=Ce(),[x,d]=(0,y.useState)(),[Z,I]=(0,y.useMemo)(()=>!s||A||c?[void 0,{}]:(0,z.Xo)(f(s),T),[s,A,T,f,c]),w=async m=>{const U=(0,z.bB)(m,I,fe,T);try{n?r&&s&&s.id?await C.execute({contactPoint:U,id:s.id,resourceVersion:s?.metadata?.resourceVersion}):s&&await C.execute({contactPoint:U,originalName:s.name}):await u.execute({contactPoint:U}),b.Ny.push("/alerting/notifications")}catch{}},k=m=>{d(m)},he=m=>{if(x){const U=I[x.__id],q=(0,z.qg)(x,fe,"test",U),E={alertManagerSourceName:S.hY,receivers:[{name:"test",grafana_managed_receiver_configs:[q]}],alert:m};a((0,ce.bO)(E))}},Y=!!((!W||s&&(0,K.Au)(s))&&!s?.provisioned),V=!W;if(A||c)return(0,e.jsx)(re._,{text:"Loading notifiers..."});const G=T.map(m=>m.type===H.J4.OnCall?{dto:p(m),meta:F}:{dto:m});return(0,e.jsxs)(e.Fragment,{children:[i&&(0,e.jsx)(_.F,{severity:"error",title:"Loading OnCall integration failed",children:"Grafana OnCall plugin has been enabled in your Grafana instances but it is not reachable. Please check the plugin configuration"}),s?.provisioned&&(0,e.jsx)(te.Yi,{resource:te.hk.ContactPoint}),(0,e.jsx)(B.k,{contactPointId:s?.id,isEditable:Y,isTestable:V,onSubmit:w,initialValues:Z,onTestChannel:k,notifiers:G,alertManagerSourceName:S.hY,defaultItem:{...fe},commonSettingsComponent:O,customValidators:{[H.J4.OnCall]:h},canManagePermissions:n&&s&&(0,ee.T8)(S.hY,s)}),(0,e.jsx)(pe,{onDismiss:()=>d(void 0),isOpen:!!x,onTest:m=>he(m)})]})}},90114:(Ie,oe,t)=>{t.d(oe,{k:()=>Fe});var e=t(74848),y=t(22803),b=t(49785),re=t(28082),_=t(29675),M=t(37e3),ee=t(48583),S=t(86489),K=t(34128),N=t(54594),le=t(17687),ce=t(43269),z=t(11817),te=t(35626),H=t(41972),de=t(44608),J=t(83893),me=t(65333),j=t(63202),O=t(85651),B=t(4013),L=t(2543),D=t(96540),ne=t(44826),Q=t(45565),ue=t(9912),se=t(17209),ge=t(79232),ve=t(77207);function X({defaultValues:n,selectedChannelOptions:a,onResetSecureField:r,secureFields:u,errors:C,pathPrefix:F="",readOnly:p=!1,customValidators:f={}}){const{watch:h}=(0,b.xW)(),c=h();return(0,e.jsx)(e.Fragment,{children:a.map((i,T)=>{const A=`${i.label}-${T}`,x=F.split("."),d=x.length>=2?c.items?.[Number(x[1])].settings?.[i.showWhen.field]:void 0;if(i.showWhen.field&&d!==i.showWhen.is)return null;if(u&&u[i.propertyName])return(0,e.jsx)(S.D,{label:i.label,description:i.description,children:(0,e.jsx)(ge.L4,{onReset:()=>r(i.propertyName),isConfigured:!0})},A);const Z=(i.secure?C?.secureSettings:C?.settings)?.[i.propertyName],I=n?.settings?.[i.propertyName];return(0,e.jsx)(ve.e,{onResetSecureField:r,secureFields:u,defaultValue:I,readOnly:p,error:Z,pathPrefix:F,pathSuffix:i.secure?"secureSettings.":"settings.",option:i,customValidator:f[i.propertyName]},A)})})}var P=t(87441);function ae({defaultValues:n,initialValues:a,pathPrefix:r,onDuplicate:u,onDelete:C,onTest:F,notifiers:p,errors:f,secureFields:h,commonSettingsComponent:c,isEditable:i=!0,isTestable:T,customValidators:A={}}){const x=(0,_.of)(xe),d=(0,D.useCallback)(l=>`${r}${l}`,[r]),{control:Z,watch:I,register:w,trigger:k,formState:he,setValue:Y}=(0,b.xW)(),V=I(d("type"))??n.type,G=I(d("settings.parse_mode")),{loading:m}=(0,ue.$)(l=>l.testReceivers),q=I(d("settings.integration_type"))!==se.U0.NewIntegration;(0,D.useEffect)(()=>{w(`${r}.__id`),w(`${r}.secureFields`)},[w,r]),(0,D.useEffect)(()=>{const l=I(($,{name:R,type:Ae})=>{const Re=R?$[R]:"";a&&R===d("type")&&Re===a.type&&Ae==="change"&&Y(d("settings"),a.settings),a&&R===d("settings.integration_type")&&Re===se.U0.ExistingIntegration&&Y(d("settings.url"),a.settings.url)});return()=>l.unsubscribe()},[V,a,Y,d,I]);const[E,Se]=(0,D.useState)(h??{}),ye=l=>{if(E[l]){const $={...E};$[l]="",Se($),Y(`${r}.secureFields`,$)}},g=(0,D.useMemo)(()=>(0,L.sortBy)(p,({dto:l,meta:$})=>[$?.order??0,l.name]).map(({dto:{name:l,type:$},meta:R})=>({label:l,value:$,description:R?.description,isDisabled:R?!R.enabled:!1,imgUrl:R?.iconUrl})),[p]),o=async()=>{await k(),Object.keys(he.errors).length===0&&F&&F()},v=p.find(({dto:{type:l}})=>l===V),be=V==="telegram"&&!(G==="None"||!G),Oe=v?.dto.options.filter(l=>l.required),Te=v?.dto.options.filter(l=>!l.required),$e=`contact-point-type-${r}`;return(0,e.jsxs)("div",{className:x.wrapper,"data-testid":"item-container",children:[(0,e.jsxs)("div",{className:x.topRow,children:[(0,e.jsx)("div",{children:(0,e.jsx)(S.D,{label:"Integration",htmlFor:$e,"data-testid":`${r}type`,children:(0,e.jsx)(b.xI,{name:d("type"),defaultValue:n.type,render:({field:{ref:l,onChange:$,...R}})=>(0,e.jsx)(ne.l6,{disabled:!i,inputId:$e,...R,width:37,options:g,onChange:Ae=>$(Ae?.value)}),control:Z,rules:{required:!0}})})}),(0,e.jsxs)("div",{className:x.buttons,children:[T&&F&&q&&(0,e.jsx)(N.$n,{disabled:m,size:"xs",variant:"secondary",type:"button",onClick:()=>o(),icon:m?"spinner":"message",children:"Test"}),i&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(N.$n,{size:"xs",variant:"secondary",type:"button",onClick:()=>u(),icon:"copy",children:"Duplicate"}),C&&(0,e.jsx)(N.$n,{"data-testid":`${r}delete-button`,size:"xs",variant:"secondary",type:"button",onClick:()=>C(),icon:"trash-alt",children:"Delete"})]})]})]}),v&&(0,e.jsxs)("div",{className:x.innerContent,children:[be&&(0,e.jsx)(M.F,{title:(0,z.t)("alerting.contact-points.telegram.parse-mode-warning-title","Telegram messages are limited to 4096 UTF-8 characters."),severity:"warning",children:(0,e.jsxs)(z.x6,{i18nKey:"alerting.contact-points.telegram.parse-mode-warning-body",children:["If you use a ",(0,e.jsx)(Q.E,{variant:"code",children:"parse_mode"})," option other than ",(0,e.jsx)(Q.E,{variant:"code",children:"None"}),", truncation may result in an invalid message, causing the notification to fail. For longer messages, we recommend using an alternative contact method."]})}),(0,e.jsx)(X,{defaultValues:n,selectedChannelOptions:Oe?.length?Oe:Te,secureFields:E,errors:f,onResetSecureField:ye,pathPrefix:r,readOnly:!i,customValidators:A}),!!(Oe?.length&&Te?.length)&&(0,e.jsxs)(P.i,{label:`Optional ${v.dto.name} settings`,children:[v.dto.info!==""&&(0,e.jsx)(M.F,{title:"",severity:"info",children:v.dto.info}),(0,e.jsx)(X,{defaultValues:n,selectedChannelOptions:Te,secureFields:E,onResetSecureField:ye,errors:f,pathPrefix:r,readOnly:!i,customValidators:A})]}),(0,e.jsx)(P.i,{label:"Notification settings",children:(0,e.jsx)(c,{pathPrefix:r,readOnly:!i})})]})]})}const xe=n=>({buttons:(0,y.css)({"& > * + *":{marginLeft:n.spacing(1)}}),innerContent:(0,y.css)({maxWidth:"536px"}),wrapper:(0,y.css)({margin:n.spacing(2,0),padding:n.spacing(1),border:`solid 1px ${n.colors.border.medium}`,borderRadius:n.shape.radius.default}),topRow:(0,y.css)({display:"flex",flexDirection:"row",justifyContent:"space-between"}),channelSettingsHeader:(0,y.css)({marginTop:n.spacing(2)})});function pe({pathPrefix:n}){const{register:a}=(0,b.xW)();return(0,D.useEffect)(()=>{a(`${n}.__id`),a(`${n}.__deleted`)},[a,n]),(0,e.jsx)(e.Fragment,{})}function je(n){if(n)return{...n,items:n.items.map(a=>({...a,settings:{...a.settings,http_config:a.settings?.http_config?fe(a.settings?.http_config):void 0}}))}}function fe(n){return Ce(n)?n:{...(0,L.omit)(n,"authorization"),bearer_token:n.authorization?.credentials,bearer_token_file:n.authorization?.credentials_file}}function Ce(n){return["bearer_token","bearer_token_file"].some(a=>a in n)}function Fe({initialValues:n,defaultItem:a,notifiers:r,alertManagerSourceName:u,onSubmit:C,onTestChannel:F,commonSettingsComponent:p,isEditable:f,isTestable:h,customValidators:c,showDefaultRouteWarning:i,contactPointId:T,canManagePermissions:A}){const x=(0,le._2)(),d=(0,_.of)(s),Z=(0,te.cB)({alertmanager:u}),w=je(n)??{name:"",items:[{...a,__id:String(Math.random())}]},k=(0,b.mN)({defaultValues:structuredClone(w)});(0,ce.o)(g=>g.unifiedAlerting.saveAMConfig=B.jA);const{handleSubmit:he,register:Y,formState:{errors:V,isSubmitting:G},getValues:m}=k,{fields:U,append:q,remove:E}=(0,j.r)({name:"items",formAPI:k,softDelete:!0}),Se=async g=>{g.items.forEach(o=>{o.secureFields&&Object.keys(o.secureFields).forEach(v=>{(o.secureFields[v]===!0||o.secureFields[v]===!1)&&delete o.secureFields[v]})});try{await C({...g,items:g.items.filter(o=>!o.__deleted)})}catch(o){if(o instanceof Error||(0,re.NF)(o)){x.error("Failed to save the contact point",W(o));const v=new Error("Failed to save the contact point");v.cause=o,(0,J.vV)(v)}throw o}},ye=()=>{x.error("There are errors in the form. Please correct them and try again!")};return(0,e.jsxs)(b.Op,{...k,children:[i&&(0,e.jsx)(M.F,{severity:"warning",title:"Attention",children:"Because there is no default policy configured yet, this contact point will automatically be set as default."}),(0,e.jsxs)("form",{onSubmit:he(Se,ye),className:d.wrapper,children:[(0,e.jsxs)(ee.B,{justifyContent:"space-between",alignItems:"center",children:[(0,e.jsx)("h2",{className:d.heading,children:f?n?"Update contact point":"Create contact point":"Contact point"}),A&&T&&(0,e.jsx)(H.k,{resource:"receivers",resourceId:T,resourceName:n?.name,title:"Manage contact point permissions"})]}),(0,e.jsx)(S.D,{label:"Name",invalid:!!V.name,error:V.name&&V.name.message,required:!0,children:(0,e.jsx)(K.p,{readOnly:!f,id:"name",...Y("name",{required:"Name is required",validate:async g=>{const o=n?.name;return Z(g,o)}}),width:39,placeholder:"Name"})}),U.map((g,o)=>{const v=`items.${o}.`;if(g.__deleted)return(0,e.jsx)(pe,{pathPrefix:v},g.__id);const Ne=n?.items.find(({__id:ie})=>ie===g.__id);return(0,e.jsx)(ae,{defaultValues:g,initialValues:Ne,onDuplicate:()=>{const ie=m().items[o];q({...ie,__id:String(Math.random())})},onTest:F?()=>{const ie=m().items[o];F(ie)}:void 0,onDelete:()=>E(o),pathPrefix:v,notifiers:r,secureFields:Ne?.secureFields,errors:V?.items?.[o],commonSettingsComponent:p,isEditable:f,isTestable:h,customValidators:c?c[g.type]:void 0},g.__id)}),(0,e.jsxs)(e.Fragment,{children:[f&&(0,e.jsx)(N.$n,{type:"button",icon:"plus",variant:"secondary",onClick:()=>q({...a,__id:String(Math.random())}),children:"Add contact point integration"}),(0,e.jsxs)("div",{className:d.buttons,children:[f&&(0,e.jsxs)(e.Fragment,{children:[G&&(0,e.jsx)(N.$n,{disabled:!0,icon:"spinner",variant:"primary",children:"Saving..."}),!G&&(0,e.jsx)(N.$n,{type:"submit",children:"Save contact point"})]}),(0,e.jsx)(N.z9,{disabled:G,variant:"secondary","data-testid":"cancel-button",href:(0,O.nL)("/alerting/notifications",u),children:(0,e.jsx)(z.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})]})]})]})]})}const s=n=>({heading:(0,y.css)({margin:n.spacing(2,0,3,0)}),buttons:(0,y.css)({marginTop:n.spacing(4),"& > * + *":{marginLeft:n.spacing(1)}}),wrapper:(0,y.css)({maxWidth:`${n.breakpoints.values.xl}px`})});function W(n){return(0,me.uz)(n)?n.data.detail:(0,de.q6)(n)}}}]);

//# sourceMappingURL=1345.6f7ab98c5e279ed68cee.js.map