"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9404],{81647:(_,w,c)=>{c.d(w,{C:()=>i});var P=c(32370);const i=()=>!!P.$.featureToggles.sqlDatasourceDatabaseSelection},9114:(_,w,c)=>{c.d(w,{T:()=>T});var P=c(41778),i=c(1815),m=c(64327);function T(I){let D=I?.editorMode||P.lX.Builder;return I?.editorMode===void 0&&I?.rawSql!==void 0&&(D=P.lX.Code),{...I,refId:I?.refId||"A",format:I?.format!==void 0?I.format:i.gv.Table,rawSql:I?.rawSql||"",editorMode:D,sql:I?.sql??{columns:[(0,m.JD)()],groupBy:[(0,m.xG)()],limit:50}}}},41117:(_,w,c)=>{c.d(w,{D:()=>P,_:()=>i});var P=(m=>(m.String="string",m))(P||{}),i=(m=>(m.Property="property",m.Operator="operator",m.Or="or",m.And="and",m.GroupBy="groupBy",m.Function="function",m.FunctionParameter="functionParameter",m))(i||{})},1815:(_,w,c)=>{c.d(w,{cO:()=>m,gv:()=>i,zL:()=>I});var P=c(35095),i=(D=>(D.Timeseries="time_series",D.Table="table",D))(i||{});const m=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"}],T=D=>({label:D,value:D}),I=P.z??T},64327:(_,w,c)=>{c.d(w,{JD:()=>H,Kj:()=>D,YW:()=>T,oF:()=>m,oG:()=>B,xG:()=>I});var P=c(35095),i=c(41117);function m(O){return`SELECT ${O.map(S=>{let R="";return S.name&&S.alias?R+=`${S.name}(${S.parameters?.map(b=>`${b.name}`)}) AS ${S.alias}`:S.name?R+=`${S.name}(${S.parameters?.map(b=>`${b.name}`)})`:S.alias?R+=`${S.parameters?.map(b=>`${b.name}`)} AS ${S.alias}`:R+=`${S.parameters?.map(b=>`${b.name}`)}`,R}).join(", ")} `}const T=O=>{if(!O)return!1;const J=O.some(R=>R.parameters?.length||R.parameters?.some(b=>b.name)),S=O.some(R=>R.name);return J||S};function I(O){return{type:i._.GroupBy,property:{type:i.D.String,name:O}}}function D(O){return{type:i._.Property,property:{type:i.D.String,name:O}}}function H(O){return{type:i._.Function,name:O,parameters:[]}}function B(O){return O?.name?(0,P.z)(O.name):null}},4193:(_,w,c)=>{c.r(w),c.d(w,{plugin:()=>Qr});var P=c(29997),i=c(74848),m=c(2543),T=c(96540),I=c(61809),D=c(32370),H=c(44617),B=c(86489),O=c(44826),J=c(37e3),S=c(98378),R=c(60484),b=c(34128);const Fe="Direct browser access in the InfluxDB datasource is no longer available. Switch to server access mode.",X="default";var x=(a=>(a.InfluxQL="InfluxQL",a.Flux="Flux",a.SQL="SQL",a))(x||{}),ee=c(77222),xe=c(79232);const Q=20,ht=a=>{const{options:{jsonData:e,secureJsonData:t,secureJsonFields:r}}=a,n=(0,m.uniqueId)("influxdb-flux-config");return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ee.C,{children:(0,i.jsx)(R.I,{labelWidth:Q,label:"Organization",htmlFor:`${n}-org`,children:(0,i.jsx)(b.p,{id:`${n}-org`,className:"width-20",value:e.organization||"",onChange:(0,I.PG)(a,"organization")})})}),(0,i.jsx)(ee.C,{children:(0,i.jsx)(R.I,{labelWidth:Q,label:"Token",children:(0,i.jsx)(xe.L4,{isConfigured:!!(r&&r.token),value:t?.token||"",label:"Token","aria-label":"Token",className:"width-20",onReset:()=>(0,I.QP)(a,"token"),onChange:(0,I.mn)(a,"token")})})}),(0,i.jsx)(ee.C,{children:(0,i.jsx)(R.I,{labelWidth:Q,label:"Default Bucket",children:(0,i.jsx)(b.p,{className:"width-20",placeholder:"default bucket",value:e.defaultBucket||"",onChange:(0,I.PG)(a,"defaultBucket")})})}),(0,i.jsx)(ee.C,{children:(0,i.jsx)(R.I,{labelWidth:Q,label:"Min time interval",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`,children:(0,i.jsx)(b.p,{className:"width-20",placeholder:"10s",value:e.timeInterval||"",onChange:(0,I.PG)(a,"timeInterval")})})})]})};var A=c(22803),z=c(29675),M=c(76302);const Me=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],Be=a=>{const{options:e,onOptionsChange:t}=a,{database:r,jsonData:n,secureJsonData:s,secureJsonFields:o}=e,l=(0,z.of)(ft),u=(0,m.uniqueId)("influxdb-influxql-config");return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(J.F,{severity:"info",title:"Database Access",children:(0,i.jsxs)("p",{children:["Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",(0,i.jsx)("code",{children:"SHOW MEASUREMENTS ON _internal"})," or",(0,i.jsx)("code",{children:'SELECT * FROM "_internal".."database" LIMIT 10'}),(0,i.jsx)("br",{}),(0,i.jsx)("br",{}),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB."]})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(M.c,{width:Q,children:"Database"}),className:l.horizontalField,htmlFor:`${u}-db`,children:(0,i.jsx)(b.p,{id:`${u}-db`,className:"width-20",value:n.dbName??r,onChange:d=>{t({...e,database:"",jsonData:{...n,dbName:d.currentTarget.value}})}})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(M.c,{width:Q,children:"User"}),className:l.horizontalField,htmlFor:`${u}-user`,children:(0,i.jsx)(b.p,{id:`${u}-user`,className:"width-20",value:e.user||"",onChange:(0,I.zX)(a,"user")})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(M.c,{width:Q,children:"Password"}),className:l.horizontalField,children:(0,i.jsx)(xe.L4,{isConfigured:!!(o&&o.password),value:s?.password||"",label:"Password","aria-label":"Password",className:"width-20",onReset:()=>(0,I.QP)(a,"password"),onChange:(0,I.mn)(a,"password")})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(M.c,{width:Q,tooltip:`You can use either GET or POST HTTP method to query your InfluxDB database. The POST
          method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method
          will restrict you and return an error if the query is too large.`,children:"HTTP Method"}),htmlFor:`${u}-http-method`,className:l.horizontalField,children:(0,i.jsx)(O.l6,{inputId:`${u}-http-method`,className:"width-20",value:Me.find(d=>d.value===e.jsonData.httpMode),options:Me,defaultValue:e.jsonData.httpMode,onChange:(0,I.BD)(a,"httpMode")})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(M.c,{width:Q,tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute.",children:"Min time interval"}),className:l.horizontalField,children:(0,i.jsx)(b.p,{className:"width-20",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,I.PG)(a,"timeInterval")})})]})},ft=a=>({horizontalField:(0,A.css)({justifyContent:"initial",margin:`0 ${a.spacing(.5)} ${a.spacing(.5)} 0`})});var gt=c(29010);const yt=a=>{const{options:e,onOptionsChange:t}=a,{jsonData:r,secureJsonData:n,secureJsonFields:s}=e,o=(0,z.of)(xt),l=(0,m.uniqueId)("influxdb-sql-config");return(0,i.jsxs)("div",{children:[(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(M.c,{width:Q,children:"Database"}),className:o.horizontalField,htmlFor:`${l}-dbName`,children:(0,i.jsx)(b.p,{id:`${l}-dbName`,className:"width-20","aria-label":"Database or bucket name",value:r.dbName,onChange:u=>{t({...e,jsonData:{...r,dbName:u.currentTarget.value}})}})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(M.c,{width:Q,children:"Token"}),className:o.horizontalField,children:(0,i.jsx)(xe.L4,{label:"Token","aria-label":"Token",className:"width-20",value:n?.token||"",onReset:()=>(0,I.QP)(a,"token"),onChange:(0,I.mn)(a,"token"),isConfigured:!!(s&&s.token)})}),(0,i.jsx)(B.D,{horizontal:!0,label:(0,i.jsx)(M.c,{width:Q,children:"Insecure Connection"}),className:o.horizontalField,children:(0,i.jsx)(gt.K,{id:`${l}-insecure-grpc`,value:r.insecureGrpc??!1,onChange:u=>{t({...e,jsonData:{...r,insecureGrpc:u.currentTarget.checked}})}})})]})},xt=a=>({horizontalField:(0,A.css)({justifyContent:"initial",margin:`0 ${a.spacing(.5)} ${a.spacing(.5)} 0`})}),se={[x.InfluxQL]:{label:"InfluxQL",value:x.InfluxQL,description:"The InfluxDB SQL-like query language."},[x.SQL]:{label:"SQL",value:x.SQL,description:"Native SQL language. Supported in InfluxDB 3.0"},[x.Flux]:{label:"Flux",value:x.Flux,description:"Supported in InfluxDB 2.x and 1.8+"}},St=[se[x.InfluxQL],se[x.SQL],se[x.Flux]];class vt extends T.PureComponent{constructor(e){super(e),this.state={maxSeries:""},this.versionNotice={Flux:"Support for Flux in Grafana is currently in beta",SQL:"Support for SQL in Grafana is currently in alpha"},this.onVersionChanged=t=>{const{options:r,onOptionsChange:n}=this.props,s={...r,jsonData:{...r.jsonData,version:t.value}};if(t.value===x.Flux){s.access="proxy",s.basicAuth=!0,s.jsonData.httpMode="POST";const{user:o,database:l,...u}=s;n(u)}else n(s)},this.state.maxSeries=e.options.jsonData.maxSeries?.toString()||"",this.htmlPrefix=(0,m.uniqueId)("influxdb-config")}renderJsonDataOptions(){switch(this.props.options.jsonData.version){case x.InfluxQL:return(0,i.jsx)(Be,{...this.props});case x.Flux:return(0,i.jsx)(ht,{...this.props});case x.SQL:return(0,i.jsx)(yt,{...this.props});default:return(0,i.jsx)(Be,{...this.props})}}render(){const{options:e,onOptionsChange:t}=this.props,r=e.access==="direct";return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(H.n,{children:[(0,i.jsx)("h3",{className:"page-heading",children:"Query language"}),(0,i.jsx)(B.D,{children:(0,i.jsx)(O.l6,{"aria-label":"Query language",className:"width-30",value:se[e.jsonData.version??x.InfluxQL],options:St,defaultValue:se[x.InfluxQL],onChange:this.onVersionChanged})})]}),e.jsonData.version!==x.InfluxQL&&(0,i.jsx)(J.F,{severity:"info",title:this.versionNotice[e.jsonData.version],children:(0,i.jsxs)("p",{children:["Please report any issues to: ",(0,i.jsx)("br",{}),(0,i.jsx)("a",{href:"https://github.com/grafana/grafana/issues/new/choose",children:"https://github.com/grafana/grafana/issues"})]})}),r&&(0,i.jsx)(J.F,{title:"Error",severity:"error",children:Fe}),(0,i.jsx)(S.t,{showAccessOptions:r,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:t,secureSocksDSProxyEnabled:D.$.secureSocksDSProxyEnabled}),(0,i.jsxs)(H.n,{children:[(0,i.jsx)("h3",{className:"page-heading",children:"InfluxDB Details"}),this.renderJsonDataOptions(),(0,i.jsx)(R.I,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000.",children:(0,i.jsx)(b.p,{placeholder:"1000",type:"number",className:"width-20",value:this.state.maxSeries,onChange:n=>{this.setState({maxSeries:n.currentTarget.value});const s=parseInt(n.currentTarget.value,10);(0,I.lO)(this.props,"maxSeries",Number.isFinite(s)?s:void 0)}})})]})]})}}const Tt=vt;var Z=c(67793),C=c(6592);const Se=[],v={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function Qe(a){const e=Se[a.type];if(!e)throw{message:"Could not find query part "+a.type};return new C.kW(a,e)}function E(a){Se[a.type]=new C.tI(a),a.category.push(Se[a.type])}const ve=[];function Et(a,e){return e+' AS "'+a.params[0]+'"'}function $e(a){const e=a.params[0];if(e==="*")return"*";let t=`"${e}"`;return e.endsWith("::tag")&&(t=`"${e.slice(0,-5)}"::tag`),e.endsWith("::field")&&(t=`"${e.slice(0,-7)}"::field`),t}function j(a,e){for(let t=0;t<a.length;t++){const r=a[t];if(r.def.category===v.Aggregations){if(r.def.type===e.def.type)return;if(r.def.type==="count"&&e.def.type==="distinct")break;if(r.def.type==="distinct"){const n=a.length>=t+2;if(e.def.type!=="count"&&n)a[t+1].def.category===v.Aggregations&&a.splice(t+1,1);else if(e.def.type==="count"){(!n||a[t+1].def.type!=="count")&&a.splice(t+1,0,e);return}}a[t]=e;return}if(r.def.category===v.Selectors){a[t]=e;return}}a.splice(1,0,e)}function W(a,e){let t;for(t=0;t<a.length;t++){const r=a[t];if(r.def.category===v.Math||r.def.category===v.Aliasing)break}a.splice(t,0,e)}function It(a,e){const t=a.length;if(t>0){if(a[t-1].def.type==="math"){a[t-1]=e;return}if(t>1&&a[t-2].def.type==="math"){a[t-2]=e;return}else if(a[t-1].def.type==="alias"){a.splice(t-1,0,e);return}}a.push(e)}function Ct(a,e){const t=a.length;if(t>0&&a[t-1].def.type==="alias"){a[t-1]=e;return}a.push(e)}function bt(a,e,t){const r=(0,m.map)(a,n=>Qe({type:n.def.type,params:(0,m.clone)(n.params)}));t.selectModels.push(r)}E({type:"field",addStrategy:bt,category:v.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:$e}),E({type:"count",addStrategy:j,category:v.Aggregations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"distinct",addStrategy:j,category:v.Aggregations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"integral",addStrategy:j,category:v.Aggregations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"mean",addStrategy:j,category:v.Aggregations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"median",addStrategy:j,category:v.Aggregations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"mode",addStrategy:j,category:v.Aggregations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"sum",addStrategy:j,category:v.Aggregations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"derivative",addStrategy:W,category:v.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:C.Wn}),E({type:"spread",addStrategy:W,category:v.Transformations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"non_negative_derivative",addStrategy:W,category:v.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:C.Wn}),E({type:"difference",addStrategy:W,category:v.Transformations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"non_negative_difference",addStrategy:W,category:v.Transformations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"moving_average",addStrategy:W,category:v.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:C.Wn}),E({type:"cumulative_sum",addStrategy:W,category:v.Transformations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"stddev",addStrategy:W,category:v.Transformations,params:[],defaultParams:[],renderer:C.Wn}),E({type:"time",category:ve,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:C.Wn}),E({type:"fill",category:ve,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:C.Wn}),E({type:"elapsed",addStrategy:W,category:v.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:C.Wn}),E({type:"holt_winters",addStrategy:W,category:v.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:C.Wn}),E({type:"holt_winters_with_fit",addStrategy:W,category:v.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:C.Wn}),E({type:"bottom",addStrategy:j,category:v.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:C.Wn}),E({type:"first",addStrategy:j,category:v.Selectors,params:[],defaultParams:[],renderer:C.Wn}),E({type:"last",addStrategy:j,category:v.Selectors,params:[],defaultParams:[],renderer:C.Wn}),E({type:"max",addStrategy:j,category:v.Selectors,params:[],defaultParams:[],renderer:C.Wn}),E({type:"min",addStrategy:j,category:v.Selectors,params:[],defaultParams:[],renderer:C.Wn}),E({type:"percentile",addStrategy:j,category:v.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:C.Wn}),E({type:"top",addStrategy:j,category:v.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:C.Wn}),E({type:"tag",category:ve,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:$e}),E({type:"math",addStrategy:It,category:v.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:C.Dw}),E({type:"alias",addStrategy:Ct,category:v.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:Et});const K={create:Qe,getCategories:()=>v,replaceAggregationAdd:j};class k{constructor(e,t,r){this.selectModels=[],this.groupByParts=[],this.target=e,this.templateSrv=t,this.scopedVars=r,e.policy=e.policy||X,e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=(0,m.map)(this.target.select,e=>(0,m.map)(e,K.create)),this.groupByParts=(0,m.map)(this.target.groupBy,K.create)}updatePersistedParts(){this.target.select=(0,m.map)(this.selectModels,e=>(0,m.map)(e,t=>({type:t.def.type,params:t.params})))}hasGroupByTime(){return(0,m.find)(this.target.groupBy,e=>e.type==="time")}hasFill(){return(0,m.find)(this.target.groupBy,e=>e.type==="fill")}addGroupBy(e){let t=e.match(/^(\w+)\((.*)\)$/);if(!t||!this.target.groupBy)return;const r=t[1],n=t[2],s=K.create({type:r,params:[n]}),o=this.target.groupBy.length;o===0?this.target.groupBy.push(s.part):r==="time"?this.target.groupBy.splice(0,0,s.part):r==="tag"?this.target.groupBy[o-1].type==="fill"?this.target.groupBy.splice(o-1,0,s.part):this.target.groupBy.push(s.part):this.target.groupBy.push(s.part),this.updateProjection()}removeGroupByPart(e,t){const r=K.getCategories();e.def.type==="time"&&(this.target.groupBy=(0,m.filter)(this.target.groupBy,n=>n.type!=="fill"),this.target.select=(0,m.map)(this.target.select,n=>(0,m.filter)(n,s=>{const o=K.create(s);return!(o.def.category===r.Aggregations||o.def.category===r.Selectors)}))),this.target.groupBy.splice(t,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,t){if(t.def.type==="field"){if(this.selectModels.length>1){const r=(0,m.indexOf)(this.selectModels,e);this.selectModels.splice(r,1)}}else{const r=(0,m.indexOf)(e,t);e.splice(r,1)}this.updatePersistedParts()}addSelectPart(e,t){const r=K.create({type:t});r.def.addStrategy(e,r,this),this.updatePersistedParts()}isOperatorTypeHandler(e,t,r){let n;if(e==="Is Not"?e="!=":e="=",r.endsWith("::tag"))return n="'"+de(t.replace(/\\/g,"\\\\").replace(/\'/g,"\\'"))+"'",{operator:e,value:n};let s=t.toLowerCase();return isNaN(parseFloat(t))?["true","false"].includes(s)?n=s:n="'"+de(t.replace(/\\/g,"\\\\").replace(/\'/g,"\\'"))+"'":n=t,{operator:e,value:n}}renderTagCondition(e,t,r){let n="",s=e.operator,o=e.value;if(t>0&&(n=(e.condition||"AND")+" "),s||(/^\/.*\/$/.test(o)?s="=~":s="="),s!=="=~"&&s!=="!~")if(r&&(o=this.templateSrv.replace(o,this.scopedVars)),o=de(o),s.startsWith("Is")){let u=this.isOperatorTypeHandler(s,o,e.key);s=u.operator,o=u.value}else(!s.startsWith(">")&&!s.startsWith("<")||s==="<>")&&(o="'"+o.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'");else r&&(o=this.templateSrv.replace(o,this.scopedVars,"regex"));let l=`"${e.key}"`;return e.key.endsWith("::tag")&&(l=`"${e.key.slice(0,-5)}"::tag`),e.key.endsWith("::field")&&(l=`"${e.key.slice(0,-7)}"::field`),n+l+" "+s+" "+o}getMeasurementAndPolicy(e){let t=this.target.policy,r=this.target.measurement||"measurement";return r.match("^/.*/$")?e&&(r=this.templateSrv.replace(r,this.scopedVars,"regex")):r='"'+r+'"',t!==X?t='"'+this.target.policy+'".':t="",t+r}interpolateQueryStr(e,t){return!t.multi&&!t.includeAll?e:typeof e=="string"?(0,Z.$f)(e):"("+(0,m.map)(e,Z.$f).join("|")+")"}render(e){const t=this.target;if(t.rawQuery)return e?this.templateSrv.replace(t.query,this.scopedVars,this.interpolateQueryStr):t.query;let r="SELECT ",n,s;for(n=0;n<this.selectModels.length;n++){const u=this.selectModels[n];let d="";for(s=0;s<u.length;s++)d=u[s].render(d);n>0&&(r+=", "),r+=d}r+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const o=(0,m.map)(t.tags,(u,d)=>this.renderTagCondition(u,d,e));o.length>0&&(r+="("+o.join(" ")+") AND "),r+="$timeFilter";let l="";for(n=0;n<this.groupByParts.length;n++){const u=this.groupByParts[n];n>0&&(l+=u.def.type==="fill"?" ":", "),l+=u.render("")}return l.length&&(r+=" GROUP BY "+l),t.fill&&(r+=" fill("+t.fill+")"),t.orderByTime==="DESC"&&(r+=" ORDER BY time DESC"),t.limit&&(r+=" LIMIT "+t.limit),t.slimit&&(r+=" SLIMIT "+t.slimit),t.tz&&(r+=" tz('"+t.tz+"')"),r}renderAdhocFilters(e){return(0,m.map)(e,(r,n)=>this.renderTagCondition(r,n,!0)).join(" ")}}function Ue(a){const e=(0,m.cloneDeep)(a);return new k(e).render(!1)}function At(a){if(a.policy!==void 0&&a.resultFormat!==void 0&&a.orderByTime!==void 0&&a.tags!==void 0&&a.groupBy!==void 0&&a.select!==void 0)return a;const e=(0,m.cloneDeep)(a);return new k(e).target}function Ot(a,e,t){const r=(0,m.cloneDeep)(a),n=new k(r);return n.addSelectPart(n.selectModels[t],e),n.target}function Lt(a,e,t){const r=(0,m.cloneDeep)(a),n=new k(r),s=n.selectModels[t];return n.removeSelectPart(s,s[e]),n.target}function Rt(a,e,t,r){const n=[...a.select??[]];return n[e]=[...n[e]],n[e][t]={...n[e][t],params:r},{...a,select:n}}function Nt(a,e){const t=(0,m.cloneDeep)(a),r=new k(t);return r.addGroupBy(e),r.target}function Dt(a,e){const t=(0,m.cloneDeep)(a),r=new k(t);return r.removeGroupByPart(r.groupByParts[e],e),r.target}function jt(a,e,t){const r=[...a.groupBy??[]];return r[e]={...r[e],params:t},{...a,groupBy:r}}function de(a){const e=/\/\^(.*?)\$\//,t=a.match(e);return t&&t.length>1?t[1]:a}var te=c(39736),ae=c(34566),wt=c(3886),me=c(54594),Pt=c(67692),Y=c(79172);const Ft=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:`from(bucket: "db/rp")
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> filter(fn: (r) =>
    r._measurement == "example-measurement" and
    r._field == "example-field"
  )`},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:`// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)
  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)
  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)
  |> yield(name: "some-name")`},{label:"Filter by value",description:"Results between a min/max",value:`// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)`},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:`import "influxdata/influxdb/v1"
v1.measurements(bucket: v.bucket)`},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:`from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> keys()
  |> keep(columns: ["_value"])
  |> group()
  |> distinct()`},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:`import "influxdata/influxdb/v1"
v1.tagKeys(bucket: v.bucket)`},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:`import "influxdata/influxdb/v1"
v1.tagValues(
    bucket: v.bucket,
    tag: "host",
    predicate: (r) => true,
    start: -1d
)`}];class Mt extends T.PureComponent{constructor(){super(...arguments),this.onFluxQueryChange=e=>{this.props.onChange({...this.props.query,query:e})},this.onSampleChange=e=>{this.props.onChange({...this.props.query,query:e.value}),this.forceUpdate()},this.getSuggestions=()=>{const e=[{label:"v.timeRangeStart",kind:ae.q.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:ae.q.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:ae.q.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:ae.q.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:ae.q.Property,detail:"org configured for the datsource"}],t=(0,te.w)();return t.getVariables().forEach(r=>{const n="${"+r.name+"}";let s=t.replace(n);s===n&&(s=""),e.push({label:n,kind:ae.q.Text,detail:`(Template Variable) ${s}`})}),e},this.editorDidMountCallbackHack=e=>{setTimeout(()=>e.layout(),100)}}render(){const{query:e,theme:t}=this.props,r=Bt(t),n=(0,i.jsxs)("div",{children:["Type: ",(0,i.jsx)("i",{children:"ctrl+space"})," to show template variable suggestions ",(0,i.jsx)("br",{}),"Many queries can be copied from Chronograf"]});return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(wt.B,{height:"100%",containerStyles:r.editorContainerStyles,language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),(0,i.jsxs)("div",{className:(0,A.cx)("gf-form-inline",r.editorActions),children:[(0,i.jsx)(me.z9,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/",children:"Flux language syntax"}),(0,i.jsx)(Pt.Y,{options:Ft,value:"Sample query",onChange:this.onSampleChange,className:(0,A.css)({marginTop:t.spacing(-.5),marginLeft:t.spacing(.5)})}),(0,i.jsx)("div",{className:"gf-form gf-form--grow",children:(0,i.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}),(0,i.jsx)(Y.I,{width:5,tooltip:n,children:"Help"})]})]})}}const Bt=a=>({editorContainerStyles:(0,A.css)({height:"200px",maxWidth:"100%",resize:"vertical",overflow:"auto",backgroundColor:a.isDark?a.colors.background.canvas:a.colors.background.primary,paddingBottom:a.spacing(1)}),editorActions:(0,A.css)({marginTop:"6px"})}),Te=(0,z.cV)(Mt);var Ee=c(1815);const Qt=[{name:"AVG"},{name:"COUNT"},{name:"MAX"},{name:"MIN"},{name:"SUM"}],pe={name:"Interval",required:!0,options:()=>Promise.resolve([{label:"$__interval",value:"$__interval"}])},he={name:"Fill",required:!1,options:()=>Promise.resolve([{label:"0",value:"0"},{label:"NULL",value:"NULL"},{label:"previous",value:"previous"}])},Wr=a=>[{name:"$__timeGroup",description:"Time grouping function",parameters:[a,pe,he]},{name:"$__timeGroupAlias",description:"Time grouping function with time as alias",parameters:[a,pe,he]},{name:"$__time",description:"An expression to rename the column to time",parameters:[a]},{name:"$__timeEpoch",parameters:[a]},{name:"$__unixEpochGroup",parameters:[a,pe,he]},{name:"$__unixEpochGroupAlias",parameters:[a,pe,he]}],$t=["$__time","$__timeEpoch","$__timeFilter","$__timeFrom","$__timeTo","$__timeGroup","$__timeGroupAlias","$__unixEpochFilter","$__unixEpochNanoFilter","$__unixEpochNanoFrom","$__unixEpochNanoTo","$__unixEpochGroup","$__unixEpochGroupAlias"];var Ie=c(13288),re=c(75505),ie=c(81160),Ce=c(16753),Ut=c(34227),Wt=c(55801),Vt=c(94626),kt=c(41778),We=c(65502),Gt=c(56276),be=c(28082),Ve=c(23919);class Ht{transformMetricFindResponse(e){const t=[],r=e.fields.find(s=>s.name==="__text"),n=e.fields.find(s=>s.name==="__value");if(r&&n)for(let s=0;s<r.values.length;s++)t.push({text:""+r.values[s],value:""+n.values[s]});else for(const s of e.fields)for(const o of s.values)t.push({text:o});return(0,m.uniqBy)(t,"text")}}var zt=c(81876);const Kt=(0,T.lazy)(()=>c.e(168).then(c.bind(c,30801)));function ke(a){const e=(0,z.of)(Yt);return(0,i.jsx)(T.Suspense,{fallback:(0,i.jsx)(zt._,{text:"Loading editor",className:e.container}),children:(0,i.jsx)(Kt,{...a})})}const Yt=a=>({container:(0,A.css)({marginBottom:"unset",marginLeft:a.spacing(1)})});var Ge=c(9114);function qt(a){const e=typeof a.rawQuery=="string"?a.rawQuery:null;if(!e)return a;const t=(0,Ge.T)({refId:"Annotation",...a.target??{},rawSql:e});return{...a,rawQuery:void 0,workspace:void 0,subscription:void 0,queryType:void 0,target:t}}var Jt=c(81647);class Xt extends We.iy{constructor(e,t=(0,te.w)()){super(e),this.templateSrv=t,this.interpolateVariable=(n,s)=>typeof n=="string"?s.multi||s.includeAll?this.getQueryModel().quoteLiteral(n):String(n).replace(/'/g,"''"):typeof n=="number"?n:Array.isArray(n)?n.map(l=>this.getQueryModel().quoteLiteral(l)).join(","):n,this.name=e.name,this.responseParser=new Ht,this.id=e.id;const r=e.jsonData||{};this.interval=r.timeInterval||"1m",this.db=this.getDB(),this.preconfiguredDatabase=r.database??"",this.annotations={prepareAnnotation:qt,QueryEditor:ke}}getResponseParser(){return this.responseParser}interpolateVariablesInQueries(e,t){let r=e;return e&&e.length>0&&(r=e.map(n=>({...n,datasource:this.getRef(),rawSql:this.templateSrv.replace(n.rawSql,t,this.interpolateVariable),rawQuery:!0}))),r}filterQuery(e){return!e.hide}applyTemplateVariables(e,t){return{refId:e.refId,datasource:this.getRef(),rawSql:this.templateSrv.replace(e.rawSql,t,this.interpolateVariable),format:e.format}}query(e){if((0,Jt.C)()){const t=this.checkForDatabaseIssue(e);if(t){const r=new Error(t);return(0,Ie.$)(()=>r)}}return e.targets.forEach(t=>{e.app===Ce.Jk.Dashboard||e.app===Ce.Jk.PanelViewer||(0,Gt.rR)("grafana_sql_query_executed",{datasource:t.datasource?.type,editorMode:t.editorMode,format:t.format,app:e.app})}),super.query(e)}checkForDatabaseIssue(e){if(this.type==="postgres"&&!this.preconfiguredDatabase)return`You do not currently have a default database configured for this data source. Postgres requires a default
             database with which to connect. Please configure one through the Data Sources Configuration page, or if you
             are using a provisioning file, update that configuration file with a default database.`;if(e.app!==Ce.Jk.Explore&&this.preconfiguredDatabase){for(const t of e.targets)if(t.editorMode===kt.lX.Builder&&t.dataset!==this.preconfiguredDatabase)return`The configuration for this panel's data source has been modified. The previous database used in this panel's
                   saved query is no longer available. Please update the query to use the new database option.
                   Previous query parameters will be preserved until the query is updated.`}}async metricFindQuery(e,t){const r=t?.range;if(r==null)return[];let n="tempvar";t&&t.variable&&t.variable.name&&(n=t.variable.name);const s={...t?.scopedVars,...(0,Ut.c)({query:e,wildcardChar:"%",options:t})},o=this.templateSrv.replace(e,s,this.interpolateVariable),l={refId:n,datasource:this.getRef(),rawSql:o,format:Ee.gv.Table};let u;try{u=await this.runMetaQuery(l,r)}catch(d){throw console.error(d),new Error("error when executing the sql query")}return this.getResponseParser().transformMetricFindResponse(u)}async runSql(e,t){const r=(0,Wt.E2)(),n=await this.runMetaQuery({rawSql:e,format:Ee.gv.Table,refId:t?.refId},r);return new Vt.R(n)}runMetaQuery(e,t){const r=e.refId||"meta",n=[{...e,datasource:e.datasource||this.getRef(),refId:r}];return(0,re.s)((0,be.AI)().fetch({url:"/api/ds/query",method:"POST",headers:this.getRequestHeaders(),data:{from:t.from.valueOf().toString(),to:t.to.valueOf().toString(),queries:n},requestId:r}).pipe((0,ie.T)(s=>(0,Ve.bE)(s,n).data[0]??{fields:[]})))}targetContainsTemplate(e){let t=e.rawSql;return $t.forEach(r=>{t=t?.replace(r,"")||""}),this.templateSrv.containsTemplate(t)}}var Zt=c(12597);function Vr({value:a,defaultValue:e,onChange:t,width:r}){const[n,s]=useState(!1);return jsx(Input,{type:"number",placeholder:String(e),value:n?"":a,onChange:o=>{if(o.currentTarget.value?.trim()==="")s(!0),t(e);else{s(!1);const l=Number(o.currentTarget.value);Number.isNaN(l)||t(l)}},width:r})}const kr=a=>{const{onOptionsChange:e,options:t}=a,r=t.jsonData,n=r.maxIdleConnsAuto!==void 0?r.maxIdleConnsAuto:!1,s=p=>{const h={...t,jsonData:{...r,...p}};return e(h)},o=p=>h=>{s({[p]:h})},l=p=>{s(n&&p?{maxOpenConns:p,maxIdleConns:p}:{maxOpenConns:p})},u=()=>{let p,h;n?(h=r.maxOpenConns,p=r.maxIdleConns):r.maxOpenConns!==void 0&&(h=r.maxOpenConns,p=r.maxOpenConns),s({maxIdleConnsAuto:!n,maxIdleConns:p,maxOpenConns:h})},d=40;return jsxs(ConfigSubSection,{title:"Connection limits",children:[jsx(Field,{label:jsx(Label,{children:jsxs(Stack,{gap:.5,children:[jsx("span",{children:"Max open"}),jsx(Tooltip,{content:jsxs("span",{children:["The maximum number of open connections to the database. If ",jsx("i",{children:"Max idle connections"})," is greater than 0 and the ",jsx("i",{children:"Max open connections"})," is less than ",jsx("i",{children:"Max idle connections"}),", then",jsx("i",{children:"Max idle connections"})," will be reduced to match the ",jsx("i",{children:"Max open connections"})," limit. If set to 0, there is no limit on the number of open connections."]}),children:jsx(Icon,{name:"info-circle",size:"sm"})})]})}),children:jsx(NumberInput,{value:r.maxOpenConns,defaultValue:config.sqlConnectionLimits.maxOpenConns,onChange:p=>{l(p)},width:d})}),jsx(Field,{label:jsx(Label,{children:jsxs(Stack,{gap:.5,children:[jsx("span",{children:"Auto max idle"}),jsx(Tooltip,{content:jsxs("span",{children:["If enabled, automatically set the number of ",jsx("i",{children:"Maximum idle connections"})," to the same value as",jsx("i",{children:" Max open connections"}),". If the number of maximum open connections is not set it will be set to the default (",config.sqlConnectionLimits.maxIdleConns,")."]}),children:jsx(Icon,{name:"info-circle",size:"sm"})})]})}),children:jsx(Switch,{value:n,onChange:u})}),jsx(Field,{label:jsx(Label,{children:jsxs(Stack,{gap:.5,children:[jsx("span",{children:"Max idle"}),jsx(Tooltip,{content:jsxs("span",{children:["The maximum number of connections in the idle connection pool.If ",jsx("i",{children:"Max open connections"})," is greater than 0 but less than the ",jsx("i",{children:"Max idle connections"}),", then the ",jsx("i",{children:"Max idle connections"})," ","will be reduced to match the ",jsx("i",{children:"Max open connections"})," limit. If set to 0, no idle connections are retained."]}),children:jsx(Icon,{name:"info-circle",size:"sm"})})]})}),children:n?jsx(InlineLabel,{width:d,children:t.jsonData.maxIdleConns}):jsx(NumberInput,{value:r.maxIdleConns,defaultValue:config.sqlConnectionLimits.maxIdleConns,onChange:p=>{o("maxIdleConns")(p)},width:d})}),jsx(Field,{label:jsx(Label,{children:jsxs(Stack,{gap:.5,children:[jsx("span",{children:"Max lifetime"}),jsx(Tooltip,{content:jsx("span",{children:"The maximum amount of time in seconds a connection may be reused. If set to 0, connections are reused forever."}),children:jsx(Icon,{name:"info-circle",size:"sm"})})]})}),children:jsx(NumberInput,{value:r.connMaxLifetime,defaultValue:config.sqlConnectionLimits.connMaxLifetime,onChange:p=>{o("connMaxLifetime")(p)},width:d})})]})},Gr=()=>{const a=useStyles2(_t);return jsx("hr",{className:a.horizontalDivider})},_t=a=>({horizontalDivider:css({borderTop:`1px solid ${a.colors.border.weak}`,margin:a.spacing(2,0),width:"100%"})}),Hr=a=>{const{editorProps:e,showCACert:t,showKeyPair:r=!0}=a,{secureJsonFields:n}=e.options;return jsxs(Fragment,{children:[r?jsx(Field,{label:jsx(Label,{children:jsxs(Stack,{gap:.5,children:[jsx("span",{children:"TLS/SSL Client Certificate"}),jsx(Tooltip,{content:jsx("span",{children:"To authenticate with an TLS/SSL client certificate, provide the client certificate here."}),children:jsx(Icon,{name:"info-circle",size:"sm"})})]})}),children:jsx(SecretTextArea,{placeholder:"-----BEGIN CERTIFICATE-----",cols:45,rows:7,isConfigured:n&&n.tlsClientCert,onChange:onUpdateDatasourceSecureJsonDataOption(e,"tlsClientCert"),onReset:()=>{updateDatasourcePluginResetOption(e,"tlsClientCert")}})}):null,t?jsx(Field,{label:jsx(Label,{children:jsxs(Stack,{gap:.5,children:[jsx("span",{children:"TLS/SSL Root Certificate"}),jsx(Tooltip,{content:jsx("span",{children:"If the selected TLS/SSL mode requires a server root certificate, provide it here."}),children:jsx(Icon,{name:"info-circle",size:"sm"})})]})}),children:jsx(SecretTextArea,{placeholder:"-----BEGIN CERTIFICATE-----",cols:45,rows:7,isConfigured:n&&n.tlsCACert,onChange:onUpdateDatasourceSecureJsonDataOption(e,"tlsCACert"),onReset:()=>{updateDatasourcePluginResetOption(e,"tlsCACert")}})}):null,r?jsx(Field,{label:jsx(Label,{children:jsxs(Stack,{gap:.5,children:[jsx("span",{children:"TLS/SSL Client Key"}),jsx(Tooltip,{content:jsx("span",{children:"To authenticate with a client TLS/SSL certificate, provide the key here."}),children:jsx(Icon,{name:"info-circle",size:"sm"})})]})}),children:jsx(SecretTextArea,{placeholder:"-----BEGIN RSA PRIVATE KEY-----",cols:45,rows:7,isConfigured:n&&n.tlsClientKey,onChange:onUpdateDatasourceSecureJsonDataOption(e,"tlsClientKey"),onReset:()=>{updateDatasourcePluginResetOption(e,"tlsClientKey")}})}):null]})};var ea=c(18729);const zr=(0,ea.DW)("features.plugins.sql");function Kr({onOptionsChange:a,options:e}){useEffect(()=>{const t=e.jsonData;let r={...e},n=!1;if(e.database&&(sqlPluginLogger.logDebug(`Migrating from options.database with value ${e.database} for ${e.name}`),r.database="",r.jsonData={...t,database:e.database},n=!0),t.maxOpenConns===void 0&&t.maxIdleConns===void 0&&t.maxIdleConnsAuto===void 0){const{maxOpenConns:s,maxIdleConns:o}=config.sqlConnectionLimits;sqlPluginLogger.logDebug(`Setting default max open connections to ${s} and setting max idle connection to ${o}`),r.jsonData={...r.jsonData,maxOpenConns:s,maxIdleConns:o,maxIdleConnsAuto:!0},n=!0}if(t.connMaxLifetime===void 0){const{connMaxLifetime:s}=config.sqlConnectionLimits;r.jsonData={...r.jsonData,connMaxLifetime:s},n=!0}n&&a(r)},[a,e])}var He=c(64327),Yr=c(41117),ta=c(24726),L=c(1578);function aa(a){const e=[];for(const t of a){let r="text";switch(t.type?.toUpperCase()){case"BOOLEAN":case"BOOL":{r="boolean";break}case"BYTES":case"VARCHAR":{r="text";break}case"FLOAT":case"FLOAT64":case"INT":case"INTEGER":case"INT64":case"NUMERIC":case"BIGNUMERIC":{r="number";break}case"DATE":{r="date";break}case"TIMESTAMP(NANOSECOND, NONE)":case"DATETIME":{r="datetime";break}case"TIME":{r="time";break}case"TIMESTAMP":{r="datetime";break}case"GEOGRAPHY":{r="text";break}default:break}e.push({...t,raqbFieldType:r,icon:ra(t.type.toUpperCase())})}return e}function ra(a){switch(a){case"TIME":case"DATETIME":case"TIMESTAMP":return"clock-nine";case"BOOLEAN":return"toggle-off";case"INTEGER":case"FLOAT":case"FLOAT64":case"INT":case"SMALLINT":case"BIGINT":case"TINYINT":case"BYTEINT":case"INT64":case"NUMERIC":case"DECIMAL":return"calculator-alt";case"CHAR":case"VARCHAR":case"STRING":case"BYTES":case"TEXT":case"TINYTEXT":case"MEDIUMTEXT":case"LONGTEXT":return"text";case"GEOGRAPHY":return"map";default:return}}function na(a){return a[0]==='"'&&a[a.length-1]==='"'?a.substring(1,a.length-1).replace(/""/g,'"'):a[0]==="`"&&a[a.length-1]==="`"?a.substring(1,a.length-1):a}function ze(a){return"'"+a.replace(/'/g,"''")+"'"}function Ke({sql:a,table:e}){let t="";if(!a||!(0,He.YW)(a.columns))return t;const r=a.columns.map(n=>({...n,parameters:n.parameters?.map(s=>({...s,name:sa(s.name)}))}));if(t+=(0,He.oF)(r),e&&(t+=`FROM "${e}" `),t+='WHERE "time" >= $__timeFrom AND "time" <= $__timeTo ',a.whereString){const n=new RegExp("(\\s?)([^\\(]\\S+)(\\s?=)","g"),o=a.whereString.replace(n,'$1"$2"$3');t+=`AND ${o} `}if(a.groupBy?.[0]?.property.name){const n=a.groupBy.map(s=>`"${s.property.name}"`).filter(s=>!(0,m.isEmpty)(s));t+=`GROUP BY ${n.join(", ")} `}return a.orderBy?.property.name&&(t+=`ORDER BY "${a.orderBy.property.name}" `),a.orderBy?.property.name&&a.orderByDirection&&(t+=`${a.orderByDirection} `),ia(a.limit)&&(t+=`LIMIT ${a.limit}`),t}function sa(a){return a==="*"?a:`"${a}"`}const ia=a=>a!==void 0&&a>=0;function Ae(a){return oa(a)?a:`"${a}"`}function oa(a){const e=/^[a-zA-Z_][a-zA-Z0-9_$]*$/g.test(a);return!la.includes(a.toUpperCase())&&e}const la=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CUBE","CUME_DIST","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DENSE_RANK","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","EMPTY","ENCLOSED","ESCAPED","EXCEPT","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FIRST_VALUE","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","FUNCTION","GENERATED","GET","GRANT","GROUP","GROUPING","GROUPS","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERSECT","INTERVAL","INTO","IO_AFTER_GTIDS","IO_BEFORE_GTIDS","IS","ITERATE","JOIN","JSON_TABLE","KEY","KEYS","KILL","LAG","LAST_VALUE","LATERAL","LEAD","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_BIND","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MAXVALUE","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NTH_VALUE","NTILE","NULL","NUMERIC","OF","ON","OPTIMIZE","OPTIMIZER_COSTS","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","OVER","PARTITION","PERCENT_RANK","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","RANK","READ","READS","READ_WRITE","REAL","RECURSIVE","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESIGNAL","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","ROW","ROWS","ROW_NUMBER","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SIGNAL","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STORED","STRAIGHT_JOIN","SYSTEM","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","VIRTUAL","WHEN","WHERE","WHILE","WINDOW","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"];function ua(a){return`SELECT table_name FROM information_schema.tables WHERE table_schema = ${a!==void 0?oe(a):"database()"} ORDER BY table_name`}function qr(){return"SELECT DISTINCT TABLE_SCHEMA from information_schema.TABLES where TABLE_TYPE != 'SYSTEM VIEW' ORDER BY TABLE_SCHEMA"}function ca(a,e){let t="SELECT column_name, data_type FROM information_schema.columns WHERE ";return t+=da(a,e),t+=" ORDER BY column_name",t}function da(a,e){let t="";if(a.includes(".")){const r=a.split(".");return t="table_schema = "+oe(r[0]),t+=" AND table_name = "+oe(r[1]),t}else return t=`table_schema = ${e!==void 0?oe(e):"database()"} AND table_name = `+oe(a),t}function oe(a){return ze(na(a))}var ma=c(64237);const pa=({getMeta:a})=>(e,t)=>({...t&&(0,ma.N)(e,t),customStatementPlacement:fa,customSuggestionKinds:ga(a)}),Ye={afterDatabase:"afterDatabase"},ha={tablesWithinDatabase:"tablesWithinDatabase"},Oe="FROM",fa=()=>[{id:Ye.afterDatabase,resolve:(a,e,t)=>!!(a?.is(L.ks.Delimiter,".")&&e?.value===Oe&&(t?.is(L.ks.IdentifierQuote)||t?.isIdentifier())&&a?.getPreviousUntil(L.ks.Keyword,[L.ks.IdentifierQuote],Oe)?.filter(r=>r.isIdentifier()).length===1)}],ga=a=>()=>[{id:L.ng.Tables,overrideDefault:!0,suggestionsResolver:async e=>{const t=Re(e.currentToken);return(await a({schema:t})).map(Le(e))}},{id:L.ng.Columns,overrideDefault:!0,suggestionsResolver:async e=>{const t=Sa(e.currentToken),r=Re(t),n=ya(t);return!r||!n?[]:(await a({schema:r,table:n})).map(Le(e))}},{id:ha.tablesWithinDatabase,applyTo:[Ye.afterDatabase],suggestionsResolver:async e=>{const t=Re(e.currentToken);return(await a({schema:t})).map(Le(e))}}];function Le(a){return function(e){return{label:e.name,insertText:e.completion??e.name,command:{id:"editor.action.triggerSuggest",title:""},kind:L.Io.Field,sortText:L.mY.High,range:{...a.range,startColumn:a.range.endColumn,endColumn:a.range.endColumn}}}}function Re(a){if(a?.isIdentifier()&&a.value[a.value.length-1]!==".")return a.value;if(a?.is(L.ks.Delimiter,"."))return a.getPreviousOfType(L.ks.Identifier)?.value;if(a?.is(L.ks.IdentifierQuote))return a.getPreviousOfType(L.ks.Identifier)?.value||a.getNextOfType(L.ks.Identifier)?.value}function ya(a){return a?.getNextOfType(L.ks.Identifier)?.value}const xa=a=>(a?.getPreviousOfType(L.ks.Keyword,"SELECT")??null)?.getNextOfType(L.ks.Keyword,Oe),Sa=a=>{const t=xa(a)?.getNextOfType(L.ks.Identifier);return t?.isKeyword()&&t.next?.is(L.ks.Parenthesis,"(")?null:t};class va extends Xt{constructor(e,t=(0,te.w)()){super(e),this.instanceSettings=e,this.templateSrv=t,this.getFunctions=()=>{const r=[...Qt,{name:"VARIANCE"},{name:"STDDEV"}],n={name:"Column",required:!0,options:o=>this.fetchFields(o)},s={name:"Interval",required:!0,options:()=>Promise.resolve([{label:"$__interval",value:"$__interval"}])};return[...r.map(o=>({...o,parameters:[n]})),{name:"$__timeGroup",description:"Time grouping function",parameters:[n,s]},{name:"$__timeGroupAlias",description:"Time grouping function with time as alias",parameters:[n,s]}]}}getQueryModel(){return{quoteLiteral:ze}}getSqlLanguageDefinition(){if(this.sqlLanguageDefinition!==void 0)return this.sqlLanguageDefinition;const e={getMeta:t=>this.fetchMeta(t)};return this.sqlLanguageDefinition={id:"flightsql",completionProvider:pa(e),formatter:Zt.s},this.sqlLanguageDefinition}async fetchDatasets(){return Promise.resolve(["iox"])}async fetchTables(e){const t=ua(e),n=(await this.runSql(t,{refId:"tables"})).map(s=>Ae(s[0]));return n.unshift(...this.getTemplateVariables()),n}async fetchFields(e){if(!e.dataset||!e.table)return[];const t=this.templateSrv.replace(e.table),r=ca(t,e.dataset),s=(await this.runSql(r,{refId:`fields-${ta.A}`})).map(o=>({name:o[0],text:o[0],value:Ae(o[0]),type:o[1],label:o[0]}));return s.unshift(...this.getTemplateVariables().map(o=>({name:o,text:o,value:Ae(o),type:"",label:o}))),aa(s)}getTemplateVariables(){return this.templateSrv.getVariables().map(e=>`$${e.name}`)}async fetchMeta(e){const t=this.instanceSettings.jsonData.database;return!e?.schema&&t?(await this.fetchTables(t)).map(n=>({name:n,completion:`${t}.${n}`,kind:L.Io.Class})):!e?.schema&&!t?(await this.fetchDatasets()).map(n=>({name:n,completion:`${n}.`,kind:L.Io.Module})):!e?.table&&(!t||e?.schema)?(await this.fetchTables(e?.schema)).map(n=>({name:n,completion:n,kind:L.Io.Class})):e?.table&&e.schema?(await this.fetchFields({dataset:e.schema,table:e.table})).map(n=>({name:n.name,completion:n.value,kind:L.Io.Field})):[]}getDB(){return this.db!==void 0?this.db:{datasets:()=>this.fetchDatasets(),tables:e=>this.fetchTables(e),fields:e=>this.fetchFields(e),validateQuery:(e,t)=>Promise.resolve({query:e,error:"",isError:!1,isValid:!0}),dsID:()=>this.id,toRawSql:Ke,functions:()=>this.getFunctions(),getEditorLanguageDefinition:()=>this.getSqlLanguageDefinition()}}}class Ta extends T.PureComponent{constructor(e){super(e);const{datasource:t}=e;this.datasource=new va({url:t.urls[0],access:t.access,id:t.id,jsonData:{allowCleartextPasswords:!1,tlsAuth:!1,tlsAuthWithCACert:!1,tlsSkipVerify:!1,maxIdleConns:1,maxOpenConns:1,maxIdleConnsAuto:!0,connMaxLifetime:1,timezone:"",user:"",database:"",url:t.urls[0],timeInterval:""},meta:t.meta,name:t.name,readOnly:!1,type:t.type,uid:t.uid},t.templateSrv)}transformQuery(e){const t=(0,Ge.T)(e);return{...t,dataset:"iox",sql:{...t.sql,limit:void 0}}}render(){const{query:e,theme:t,onRunQuery:r,onChange:n}=this.props,s=Ea(t),o=()=>r(),l=d=>{n({...d})},u=(0,i.jsxs)("div",{children:["Type: ",(0,i.jsx)("i",{children:"ctrl+space"})," to show template variable suggestions ",(0,i.jsx)("br",{}),"Many queries can be copied from Chronograf"]});return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ke,{datasource:this.datasource,query:this.transformQuery(e),onRunQuery:o,onChange:l,queryHeaderProps:{dialect:"influx"}}),(0,i.jsxs)("div",{className:(0,A.cx)("gf-form-inline",s.editorActions),children:[(0,i.jsx)(me.z9,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/cloud-serverless/query-data/sql/",children:"SQL language syntax"}),(0,i.jsx)("div",{className:"gf-form gf-form--grow",children:(0,i.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}),(0,i.jsx)(Y.I,{width:5,tooltip:u,children:"Help"})]})]})}}const Ea=a=>({editorContainerStyles:(0,A.css)({height:"200px",maxWidth:"100%",resize:"vertical",overflow:"auto",backgroundColor:a.isDark?a.colors.background.canvas:a.colors.background.primary,paddingBottom:a.spacing(1)}),editorActions:(0,A.css)({marginTop:"6px"})}),Ia=(0,z.cV)(Ta);var Ca=c(65164);const ba=({isRaw:a,onChange:e})=>{const[t,r]=(0,T.useState)(!1);return(0,T.useEffect)(()=>{r(!1)},[a]),a?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(me.$n,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{r(!0)}}),(0,i.jsx)(Ca.u,{isOpen:t,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{e(!1)},onDismiss:()=>{r(!1)}})]}):(0,i.jsx)(me.$n,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{e(!0)}})};var G=c(48583),qe=c(50926);const Je=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}],Xe="time_series";var Aa=c(84596);function fe(a){const[e,t]=(0,T.useState)(a),r=(0,Aa.A)(a);return(0,T.useEffect)(()=>{r!==a&&e!==a&&t(a)},[a,e,r]),[e,t]}const Oa=({query:a,onChange:e,onRunQuery:t})=>{const[r,n]=fe(a.query),[s,o]=fe(a.alias),l=(0,T.useId)(),u=(0,T.useId)(),d=a.resultFormat??Xe,p=()=>{e({...a,query:r,alias:s,resultFormat:d}),t()};return(0,i.jsxs)(G.B,{direction:"column",children:[(0,i.jsx)(qe.f,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:p,onChange:h=>{n(h.currentTarget.value)},value:r??""}),(0,i.jsxs)(G.B,{children:[(0,i.jsx)(R.I,{htmlFor:u,label:"Format as",children:(0,i.jsx)(O.l6,{inputId:u,onChange:h=>{e({...a,resultFormat:h.value}),t()},value:d,options:Je})}),(0,i.jsx)(R.I,{htmlFor:l,label:"Alias by",children:(0,i.jsx)(b.p,{id:l,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:p,onChange:h=>{o(h.currentTarget.value)},value:s??""})})]})]})};var ne=c(94479),Ze=c(88023);const Ne=a=>{let e="",{type:t,templateService:r,scopedVars:n,database:s,measurement:o,retentionPolicy:l,tags:u,withKey:d,withMeasurementFilter:p}=a;switch(t){case"RETENTION_POLICIES":return'SHOW RETENTION POLICIES on "'+s+'"';case"FIELDS":return!o||o===""?"SHOW FIELD KEYS":(o&&!o.match(/^\/.*\/|^$/)&&(o='"'+o+'"',l&&l!==X&&(l='"'+l+'"',o=l+"."+o)),"SHOW FIELD KEYS FROM "+o);case"TAG_KEYS":e="SHOW TAG KEYS";break;case"TAG_VALUES":e="SHOW TAG VALUES";break;case"MEASUREMENTS":e="SHOW MEASUREMENTS",p&&(e+=" WITH MEASUREMENT =~ /(?i)"+(0,Z.$f)(p)+"/");break;default:return e}if(o&&(!o.match("^/.*/")&&!o.match(/^merge\(.*\)/)&&(o='"'+o+'"'),l&&l!==X&&(l='"'+l+'"',o=l+"."+o),o!==""&&(e+=" FROM "+o)),d){let h=d;h.endsWith("::tag")&&(h=h.slice(0,-5)),e+=' WITH KEY = "'+h+'"'}if(u&&u.length>0){const h=(0,m.reduce)(u,(f,g)=>(g.key&&g.key===d||g.operator===">"||g.operator==="<"||f.push(La(g,f.length,r,n,!0)),f),[]);h.length>0&&(e+=" WHERE "+h.join(" "))}return t==="MEASUREMENTS"&&(e+=" LIMIT 100"),e};function La(a,e,t,r,n){let s="",o=a.operator,l=a.value;e>0&&(s=(a.condition||"AND")+" "),o||(/^\/.*\/$/.test(a.value)?o="=~":o="="),(l===""||o!=="=~"&&o!=="!~")&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"),o!=="=~"&&o!=="!~"?n?l=t.replace(l,r):o!==">"&&o!=="<"&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"):n&&(l=t.replace(l,r,"regex"));let u=`"${a.key}"`;return a.key.endsWith("::tag")&&(u=`"${a.key.slice(0,-5)}"::tag`),a.key.endsWith("::field")&&(u=`"${a.key.slice(0,-7)}"::field`),s+u+" "+o+" "+l}const le=async a=>{const{type:e,datasource:t,scopedVars:r,measurement:n,retentionPolicy:s,tags:o,withKey:l,withMeasurementFilter:u}=a,d=Ne({type:e,scopedVars:r,measurement:n,retentionPolicy:s,tags:o,withKey:l,withMeasurementFilter:u,templateService:t.templateSrv,database:t.database}),p=s?t.templateSrv.replace(s,{},"regex"):"",h={query:d,policy:p,rawQuery:!0,refId:"metadataQuery"};if(Ze.Ay.featureToggles.influxdbBackendMigration)return t.runMetadataQuery(h);{const f={policy:h.policy};return t.metricFindQuery({refId:"run-explore-query",query:d},f)}};async function Ra(a){return(await le({type:"RETENTION_POLICIES",datasource:a})).map(t=>t.text)}async function Na(a,e,t){return(await le({type:"MEASUREMENTS",datasource:a,tags:e,withMeasurementFilter:t})).map(n=>n.text)}async function Da(a,e,t){return(await le({type:"TAG_KEYS",datasource:a,measurement:e,retentionPolicy:t})).map(n=>n.text)}async function ja(a,e,t,r,n){return t.endsWith("::field")?[]:(await le({type:"TAG_VALUES",tags:e,withKey:t,datasource:a,measurement:r,retentionPolicy:n})).map(o=>o.text)}async function _e(a,e,t){return(await le({type:"FIELDS",datasource:a,measurement:e,retentionPolicy:t})).map(n=>n.text)}function et(a,e){return a.filter(t=>t.key.endsWith("::tag")||e.has(t.key+"::tag"))}function $(a){return{label:a,value:a}}function ue(a){if(a==null)throw new Error("value must not be nullish");return a}function wa(){const a=K.getCategories(),e=[];return Object.keys(a).forEach(r=>{const n=a[r].map(s=>$(s.type));e.push({label:r,options:n})}),e}async function Pa(a,e){const t=await e(),r={...a},n=new k(r),s=[];return n.hasFill()||s.push($("fill(null)")),n.hasGroupByTime()||s.push($("time($interval)")),t.forEach(o=>{s.push($(`tag(${o})`))}),s}function Fa(a,e){const t=K.create(a).def,r=(a.params??[]).map(n=>n.toString());if(r.length!==t.params.length)throw new Error("Invalid query-segment");return r.map((n,s)=>{const o=t.params[s];return o.dynamicLookup?{value:n,options:ue(e.get(`${t.type}_${s}`))}:o.options!=null?{value:n,options:()=>Promise.resolve(o.options)}:{value:n,options:null}})}function tt(a,e){return a.map(t=>({name:t.type,params:Fa(t,e)}))}function Ma(a){return(0,te.w)().getVariables().map(a)}function De(a,e,t){let r=Ma(e);return t&&(r=r.filter(n=>n.indexOf(t)>-1)),a.then(n=>[...r,...n])}function at(a){return`/^$${a.name}$/`}function Ba(a){return`$${a.name}`}const je=(0,A.css)({paddingRight:"4px"}),Qa=(0,A.cx)("width-8",je),$a=({format:a,inputId:e,onChange:t})=>(0,i.jsx)(O.l6,{inputId:e,className:Qa,onChange:r=>{t(ue(r.value))},value:a,options:Je});var we=c(20301),Ua=c(76459),Wa=c.n(Ua),Va=c(41053);const rt=(0,A.css)({minWidth:"160px"}),nt=a=>a,ka=({loadOptions:a,allowCustomValue:e,onChange:t,onClose:r})=>{const n=Wa()(a,1e3,{leading:!0});return(0,i.jsx)("div",{className:rt,children:(0,i.jsx)(O.DW,{formatCreateLabel:nt,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:r,allowCustomValue:e,loadOptions:n,onChange:t,createOptionPosition:"first"})})},Ga=({loadOptions:a,allowCustomValue:e,onChange:t,onClose:r})=>{const[n,s]=(0,Va.A)(a,[a]);return(0,T.useEffect)(()=>{s("")},[s,a]),(0,i.jsx)("div",{className:rt,children:(0,i.jsx)(O.l6,{isLoading:n.loading,formatCreateLabel:nt,autoFocus:!0,isOpen:!n.loading,onCloseMenu:r,allowCustomValue:e,options:n.value??[],onChange:t,createOptionPosition:"first"})})},Ha=({loadOptions:a,filterByLoadOptions:e,allowCustomValue:t,onChange:r,onClose:n})=>e?(0,i.jsx)(ka,{loadOptions:a,allowCustomValue:t,onChange:r,onClose:n}):(0,i.jsx)(Ga,{loadOptions:a,allowCustomValue:t,onChange:r,onClose:n}),za=({initialValue:a,onChange:e,onClose:t})=>{const[r,n]=fe(a);return(0,i.jsx)(b.p,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:t,onKeyDown:s=>{s.key==="Enter"&&e(r)},onChange:s=>{n(s.currentTarget.value)},value:r})},Ka=(0,A.css)({width:"auto",cursor:"pointer"}),q=({value:a,buttonClassName:e,loadOptions:t,filterByLoadOptions:r,allowCustomValue:n,onChange:s})=>{const[o,l]=(0,T.useState)(!1);if(o)return t!==void 0?(0,i.jsx)(Ha,{loadOptions:t,filterByLoadOptions:r??!1,allowCustomValue:n,onChange:u=>{l(!1),s(u)},onClose:()=>{l(!1)}}):(0,i.jsx)(za,{initialValue:a,onClose:()=>{l(!1)},onChange:u=>{l(!1),s({value:u,label:u})}});{const u=(0,A.cx)(Ka,e);return(0,i.jsx)(M.c,{as:"button",className:u,onClick:()=>{l(!0)},children:a})}},Ya=({policy:a,measurement:e,onChange:t,getPolicyOptions:r,getMeasurementOptions:n})=>{const s=async()=>{const l=await r();return(l.some(d=>d===X)?l:[X,...l]).map($)},o=async l=>(await n(l)).map($);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(q,{allowCustomValue:!0,value:a??"using default policy",loadOptions:s,onChange:l=>{t(l.value,e)}}),(0,i.jsx)(q,{allowCustomValue:!0,value:e??"select measurement",loadOptions:o,filterByLoadOptions:!0,onChange:l=>{t(a,l.value)}}),e&&(0,i.jsx)(we.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{t(a,void 0)}})]})},ge=({value:a,onChange:e,isWide:t,placeholder:r})=>{const[n,s]=fe(a),o=()=>{e(n===""?void 0:n)};return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(b.p,{placeholder:r,className:(0,A.cx)(t??!1?"width-14":"width-8",je),type:"text",spellCheck:!1,onBlur:o,onChange:l=>{s(l.currentTarget.value)},value:n??""})})},qa=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],Ja=(0,A.cx)("width-9",je),Xa=({value:a,onChange:e,inputId:t})=>(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(O.l6,{inputId:t,className:Ja,onChange:r=>{e(ue(r.value))},value:a,options:qa})}),st=({loadOptions:a,allowCustomValue:e,onAdd:t})=>(0,i.jsx)(q,{value:"+",loadOptions:a,allowCustomValue:e,onChange:r=>{t(ue(r.value))}}),Za=(0,A.css)({paddingRight:"0",marginRight:"0"}),_a=(0,A.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),er=a=>(0,A.cx)("gf-form-label",(0,A.css)({paddingLeft:"0",lineHeight:a.typography.body.lineHeight,fontSize:a.typography.body.fontSize})),tr=({name:a,params:e,onChange:t})=>{const r=(0,z.$j)(),n=(0,T.useMemo)(()=>er(r),[r]),s=(o,l)=>{const u=e.map(d=>d.value);u[l]=o,t(u)};return(0,i.jsxs)("div",{className:n,children:[(0,i.jsx)("button",{className:(0,A.cx)("gf-form-label",Za),children:a}),"(",e.map((o,l)=>{const{value:u,options:d}=o,p=l===e.length-1,h=d!==null?()=>d().then(f=>f.map($)):void 0;return(0,i.jsxs)(T.Fragment,{children:[(0,i.jsx)(q,{allowCustomValue:!0,value:u,buttonClassName:_a,loadOptions:h,onChange:f=>{s(ue(f.value),l)}}),!p&&","]},l)}),")"]})},it=({parts:a,getNewPartOptions:e,onAddNewPart:t,onRemovePart:r,onChange:n})=>(0,i.jsxs)(i.Fragment,{children:[a.map((s,o)=>(0,i.jsxs)(T.Fragment,{children:[(0,i.jsx)(tr,{name:s.name,params:s.params,onRemove:()=>{r(o)},onChange:l=>{n(o,l)}}),(0,i.jsx)(we.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{r(o)}})]},o)),(0,i.jsx)(st,{loadOptions:e,onAdd:t})]});function ot(a){return/^\/.*\/$/.test(a)}function lt(a){return a.operator??(ot(a.value)?"=~":"=")}function ut(a,e){return e?void 0:a.condition??"AND"}function ar(a,e){const t=a==="=~"||a==="!~";return ot(e)?t?a:"=~":t?"=":a}const rr=["=","!=","<>","<",">",">=","<=","=~","!~","Is","Is Not"],nr=["AND","OR"],sr=rr.map($),ir=nr.map($),or=()=>Promise.resolve(ir),lr=()=>Promise.resolve(sr),ur=({tag:a,isFirst:e,onRemove:t,onChange:r,getTagKeyOptions:n,getTagValueOptions:s})=>{const o=lt(a),l=ut(a,e),u=()=>n().catch(p=>(console.error(p),[])).then(p=>p.map($)),d=()=>s(a.key).then(p=>p.map($));return(0,i.jsxs)("div",{className:"gf-form",children:[l!=null&&(0,i.jsx)(q,{value:l,loadOptions:or,onChange:p=>{r({...a,condition:p.value})}}),(0,i.jsx)(q,{allowCustomValue:!0,value:a.key,loadOptions:u,onChange:p=>{const{value:h}=p;h===void 0?t():r({...a,key:h??""})}}),(0,i.jsx)(q,{value:o,loadOptions:lr,onChange:p=>{r({...a,operator:p.value})}}),(0,i.jsx)(q,{allowCustomValue:!0,value:a.value,loadOptions:d,onChange:p=>{const h=p.value??"";r({...a,value:h,operator:ar(o,h)})}}),(0,i.jsx)(we.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{t()}})]})},cr=({tags:a,onChange:e,getTagKeyOptions:t,getTagValueOptions:r})=>{const n=(u,d)=>{const p=a.map((h,f)=>d===f?u:h);e(p)},s=u=>{const d=a.filter((p,h)=>h!==u);e(d)},o=()=>t().then(u=>u.map($)),l=(u,d)=>{const p={key:u,value:"select tag value"},h={key:p.key,value:p.value,operator:lt(p),condition:ut(p,d)};e([...a,h])};return(0,i.jsxs)(i.Fragment,{children:[a.map((u,d)=>(0,i.jsx)(ur,{tag:u,isFirst:d===0,onChange:p=>{n(p,d)},onRemove:()=>{s(d)},getTagKeyOptions:t,getTagValueOptions:r},d)),(0,i.jsx)(st,{allowCustomValue:!0,loadOptions:o,onAdd:u=>{l(u,a.length===0)}})]})},dr=a=>{const e=(0,T.useId)(),t=`influxdb-qe-format-as-${e}`,r=`influxdb-qe-order-by${e}`,n=(0,z.of)(mr),s=At(a.query),{datasource:o}=a,{measurement:l,policy:u}=s,d=(0,T.useMemo)(async()=>{const y=(await Da(o,l,u)).map(F=>`${F}::tag`),N=(await _e(o,l||"",u)).map(F=>`${F}::field`);return new Set([...y,...N])},[l,u,o]),p=(0,T.useMemo)(()=>{const y=new Map([["field_0",()=>l!==void 0?_e(o,l,u):Promise.resolve([])]]);return(s.select??[]).map(N=>tt(N,y))},[l,u,s.select,o]),h=(0,T.useMemo)(()=>async()=>[...await d],[d]),f=(0,T.useMemo)(()=>{const y=new Map([["tag_0",h]]);return tt(s.groupBy??[],y)},[h,s.groupBy]),g=y=>{a.onChange(y),a.onRunQuery()},U=(y,N)=>{g({...s,policy:y,measurement:N})},ce=y=>{g({...s,tags:y.length===0?void 0:y})};return(0,i.jsxs)("div",{children:[(0,i.jsxs)(ne.L,{label:"FROM",fill:!0,children:[(0,i.jsx)(Ya,{policy:u,measurement:l,getPolicyOptions:()=>De(Ra(o),Ba),getMeasurementOptions:y=>De(d.then(N=>Na(o,et(s.tags??[],N),y===""?void 0:y)),at,y),onChange:U}),(0,i.jsx)(M.c,{width:"auto",className:n.inlineLabel,children:"WHERE"}),(0,i.jsx)(cr,{tags:s.tags??[],onChange:ce,getTagKeyOptions:h,getTagValueOptions:y=>De(d.then(N=>ja(o,et(s.tags??[],N),y,l)),at)})]}),p.map((y,N)=>(0,i.jsx)(ne.L,{label:N===0?"SELECT":"",fill:!0,children:(0,i.jsx)(it,{parts:y,getNewPartOptions:()=>Promise.resolve(wa()),onChange:(F,$r)=>{const Ur=Rt(s,N,F,$r);g(Ur)},onAddNewPart:F=>{g(Ot(s,F,N))},onRemovePart:F=>{g(Lt(s,F,N))}})},N)),(0,i.jsx)(ne.L,{label:"GROUP BY",fill:!0,children:(0,i.jsx)(it,{parts:f,getNewPartOptions:()=>Pa(s,h),onChange:(y,N)=>{const F=jt(s,y,N);g(F)},onAddNewPart:y=>{g(Nt(s,y))},onRemovePart:y=>{g(Dt(s,y))}})}),(0,i.jsxs)(ne.L,{label:"TIMEZONE",fill:!0,children:[(0,i.jsx)(ge,{placeholder:"(optional)",value:s.tz,onChange:y=>{g({...s,tz:y})}}),(0,i.jsx)(M.c,{htmlFor:r,width:"auto",className:n.inlineLabel,children:"ORDER BY TIME"}),(0,i.jsx)(Xa,{inputId:r,value:s.orderByTime==="DESC"?"DESC":"ASC",onChange:y=>{g({...s,orderByTime:y})}})]}),(0,i.jsxs)(ne.L,{label:"LIMIT",fill:!0,children:[(0,i.jsx)(ge,{placeholder:"(optional)",value:s.limit?.toString(),onChange:y=>{g({...s,limit:y})}}),(0,i.jsx)(M.c,{width:"auto",className:n.inlineLabel,children:"SLIMIT"}),(0,i.jsx)(ge,{placeholder:"(optional)",value:s.slimit?.toString(),onChange:y=>{g({...s,slimit:y})}})]}),(0,i.jsxs)(ne.L,{htmlFor:t,label:"FORMAT AS",fill:!0,children:[(0,i.jsx)($a,{inputId:t,format:s.resultFormat??Xe,onChange:y=>{g({...s,resultFormat:y})}}),s.resultFormat!=="table"&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(M.c,{width:"auto",className:n.inlineLabel,children:"ALIAS"}),(0,i.jsx)(ge,{isWide:!0,placeholder:"Naming pattern",value:s.alias,onChange:y=>{g({...s,alias:y})}})]})]})]})};function mr(a){return{inlineLabel:(0,A.css)({color:a.colors.primary.text})}}const pr=({query:a,onChange:e,onRunQuery:t,datasource:r})=>{switch(r.version){case x.Flux:return(0,i.jsx)("div",{className:"gf-form-query-content",children:(0,i.jsx)(Te,{query:a,onChange:e,datasource:r})});case x.SQL:return(0,i.jsx)(Ia,{datasource:r,query:a,onChange:e,onRunQuery:t});case x.InfluxQL:default:return(0,i.jsxs)("div",{className:(0,A.css)({display:"flex"}),children:[(0,i.jsx)("div",{className:(0,A.css)({flexGrow:1}),children:a.rawQuery?(0,i.jsx)(Oa,{query:a,onChange:e,onRunQuery:t}):(0,i.jsx)(dr,{query:a,onChange:e,onRunQuery:t,datasource:r})}),(0,i.jsx)(ba,{isRaw:a.rawQuery??!1,onChange:n=>{e({...a,query:Ue(a),rawQuery:n}),t()}})]})}},hr=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}],fr=()=>{const a=(0,z.of)(gr);return(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{children:"InfluxDB Cheat Sheet"}),hr.map(e=>(0,i.jsxs)("div",{className:a.cheatSheetItem,children:[(0,i.jsx)("div",{className:a.cheatSheetItemTitle,children:e.title}),e.label]},e.title))]})},gr=a=>({cheatSheetItem:(0,A.css)({margin:a.spacing(3,0)}),cheatSheetItemTitle:(0,A.css)({fontSize:a.typography.h3.fontSize})});function yr(){return(0,i.jsx)(fr,{})}var xr=c(88483),Sr=c(44240),ye=c(62467),vr=c(66847),Tr=c(4038),V=c(63739),Er=c(30468);const Ir=a=>{const{query:e,onChange:t}=a,[r,n]=(0,T.useState)(e.query??""),[s,o]=(0,T.useState)(e.textColumn??""),[l,u]=(0,T.useState)(e.tagsColumn??""),[d,p]=(0,T.useState)(e?.timeEndColumn??""),[h]=(0,T.useState)(e?.titleColumn??""),f=(g,U)=>{t({...e,[g]:U,rawQuery:!0,fromAnnotations:!0,textEditor:!0})};return(0,i.jsxs)(G.B,{gap:5,direction:"column",children:[(0,i.jsxs)(G.B,{gap:.5,direction:"column",children:[(0,i.jsxs)(G.B,{gap:0,children:[(0,i.jsx)(Y.I,{width:12,children:"InfluxQL Query"}),(0,i.jsx)(b.p,{value:r,onChange:g=>n(g.currentTarget.value??""),onBlur:()=>f("query",r),placeholder:"select text from events where $timeFilter limit 1000"})]}),(0,i.jsx)(Y.I,{width:12,tooltip:(0,i.jsx)("div",{children:"If your influxdb query returns more than one field you need to specify the column names below. An annotation event is composed of a title, tags, and an additional text field. Optionally you can map the timeEnd column for region annotation usage."}),children:"Field mappings"}),(0,i.jsxs)(G.B,{gap:.5,alignItems:"flex-start",wrap:"wrap",children:[(0,i.jsxs)(G.B,{gap:0,children:[(0,i.jsx)(Y.I,{width:12,children:"Text"}),(0,i.jsx)(b.p,{value:s,onChange:g=>o(g.currentTarget.value??""),onBlur:()=>f("textColumn",s)})]}),(0,i.jsxs)(G.B,{gap:0,children:[(0,i.jsx)(Y.I,{width:12,children:"Tags"}),(0,i.jsx)(b.p,{value:l,onChange:g=>u(g.currentTarget.value??""),onBlur:()=>f("tagsColumn",l)})]}),(0,i.jsxs)(G.B,{gap:0,children:[(0,i.jsx)(Y.I,{width:12,children:"TimeEnd"}),(0,i.jsx)(b.p,{value:d,onChange:g=>p(g.currentTarget.value??""),onBlur:()=>f("timeEndColumn",d)})]}),(0,i.jsxs)("div",{className:"gf-form ng-hide",children:[(0,i.jsx)(Y.I,{width:12,children:"Title"}),(0,i.jsx)(b.p,{defaultValue:h})]})]})]}),(0,i.jsx)("div",{})]})};var ct=c(12248);class dt{constructor(e){this.series=e.series,this.alias=e.alias,this.annotation=e.annotation,this.meta=e.meta,this.refId=e.refId}getTimeSeries(){const e=[];let t,r;return this.series.length===0||(0,m.each)(this.series,n=>{const s=n.columns.length,o=(0,m.map)(n.tags,(l,u)=>u+": "+l);for(r=1;r<s;r++){let l=n.name;const u=n.columns[r];u!=="value"&&(l=l+"."+u),this.alias?l=this._getSeriesName(n,r):n.tags&&(l=l+" {"+o.join(", ")+"}");const d=[];if(n.values)for(t=0;t<n.values.length;t++)d[t]=[n.values[t][r],n.values[t][0]];e.push({title:l,target:l,datapoints:d,tags:n.tags,meta:this.meta,refId:this.refId})}}),e}_getSeriesName(e,t){const r=/\$(\w+)|\[\[([\s\S]+?)\]\]/g,n=e.name.split(".");return this.alias?.replace(r,(s,o,l)=>{const u=o||l,d=parseInt(u,10);if(u==="m"||u==="measurement")return e.name;if(u==="col")return e.columns[t];if(!isNaN(d))return n[d]??s;if(u.indexOf("tag_")!==0)return s;const p=u.replace("tag_","");return e.tags?e.tags[p]:s})}getAnnotations(){const e=[];return(0,m.each)(this.series,t=>{let r=null,n=null,s=null;const o=[];let l=null;(0,m.each)(t.columns,(u,d)=>{if(u==="time"){n=d;return}if(u!=="sequence_number"){if(u===this.annotation?.titleColumn){r=d;return}if((0,m.includes)((this.annotation?.tagsColumn||"").replace(" ","").split(","),u)){o.push(d);return}if(u===this.annotation?.textColumn){l=d;return}if(u===this.annotation?.timeEndColumn){s=d;return}!r&&l!==d&&(r=d)}}),(0,m.each)(t.values,u=>{const d={annotation:this.annotation,time:+new Date(u[n]),title:u[r],timeEnd:u[s],tags:(0,m.flatten)(o.filter(p=>u[p]).map(p=>u[p].split(","))),text:u[l]};e.push(d)})}),e}getTable(){const e=new ct.A;let t,r;return e.refId=this.refId,e.meta=this.meta,this.series.length===0||(0,m.each)(this.series,(n,s)=>{if(s===0){const o=n.columns[0],l=o==="time"?{text:"Time",type:V.PU.time}:{text:o};for(e.columns.push(l),(0,m.each)((0,m.keys)(n.tags),u=>{e.columns.push({text:u})}),r=1;r<n.columns.length;r++)e.columns.push({text:n.columns[r]})}if(n.values)for(t=0;t<n.values.length;t++){const o=n.values[t],l=[o[0]];if(n.tags)for(const u in n.tags)n.tags.hasOwnProperty(u)&&l.push(n.tags[u]);for(r=1;r<o.length;r++)l.push(o[r]);e.rows.push(l)}}),e}}const Cr=a=>{const e={refId:"",query:a.query??"",queryType:"tags",fromAnnotations:!0,tagsColumn:a.tagsColumn??"",textColumn:a.textColumn??"",timeEndColumn:a.timeEndColumn??"",titleColumn:a.titleColumn??"",name:a.name??""};return a.target&&a.target.limit&&(e.limit=a.target.limit),a.target&&a.target.matchAny&&(e.matchAny=a.target.matchAny),a.target&&a.target.tags&&(e.tags=a.target.tags),a.target&&a.target.type&&(e.type=a.target.type),e},br=a=>(a.target=a.target&&!a.target?.query?Cr(a):a.target,a);class Ar{parse(e,t){if(!t?.results||t.results.length===0)return[];const r=t.results[0];if(!r.series)return[];const n=e.toLowerCase(),s=n.indexOf("show retention policies")>=0,o=n.indexOf("show field keys")>=0||s,l=new Set;return(0,m.each)(r.series,u=>{(0,m.each)(u.values,d=>{(0,m.isArray)(d)?o?l.add(d[0].toString()):d[1]!==void 0?l.add(d[1].toString()):l.add(d[0].toString()):l.add(d.toString())})}),Array.from(l).map(u=>({text:u}))}getTable(e,t,r){let n=new ct.A;if(e.length>0)if(n.meta={...r,executedQueryString:e[0].meta?.executedQueryString},n.refId=t.refId,n=Lr(e,n,t),e[0].fields[1]&&e[0].fields[1].labels){let s=(0,m.groupBy)(e,u=>u.fields[1].labels?Object.values(u.fields[1].labels):null);const o=Object.keys(s),l=Object.values(s);for(let u=0;u<l.length;u++)n=mt(l[u],n,[...o[u].split(",")])}else n=mt(e,n,[]);return n}async transformAnnotationResponse(e,t,r){const n=(0,Ve.bE)(t,[r]);if(!n)return[];const s=this.getTable(n.data,r,{}),o=[];let l=0,u=0,d=0,p=0;const h=[];return(0,m.each)(s.columns,(f,g)=>{if(f.text.toLowerCase()==="time"){u=g;return}if(f.text===e.titleColumn){l=g;return}if(Or(f.text,e.tagsColumn)){h.push(g);return}if(e.textColumn&&f.text.includes(e.textColumn)){p=g;return}if(f.text===e.timeEndColumn){d=g;return}!l&&p!==g&&(l=g)}),(0,m.each)(s.rows,f=>{const g={annotation:e,time:+new Date(f[u]),title:f[l],timeEnd:f[d],tags:(0,m.flatten)(h.filter(U=>f[U]).map(U=>f[U].split(","))),text:f[p]};o.push(g)}),o}}function Or(a,e){const t=(e||"").replace(" ","").split(",");for(const r of t)if(r!==""&&a.includes(r))return!0;return!1}function Lr(a,e,t){const r=Rr(t);a[0].fields.forEach(n=>{n.name.toLowerCase()==="time"?e.columns.push({text:"Time",type:V.PU.time}):n.name.toLowerCase()==="value"&&n.labels&&Object.keys(n.labels).forEach(s=>{e.columns.push({text:s})})}),a[0].refId==="metricFindQuery"&&a.forEach(n=>{n.name&&e.columns.push({text:n.name})});for(let n=0;n<r.length;n++)e.columns.push({text:r[n]});return t.rawQuery&&r.length===0&&Nr(t.query,a)&&a[0].refId!=="metricFindQuery"&&a.map(n=>{n.name&&e.columns.push({text:n.name})}),e}function mt(a,e,t){const r=a[0].fields[0].values;for(let n=0;n<r.length;n++){const s=r[n],o=a.map(l=>l.fields[1]?l.fields[1].values[n]:null);o.indexOf(null)<0&&e.rows.push([s,...t,...o])}return e}function Rr(a){let e=[];a.select?.forEach(r=>{const n=r.filter(s=>s.type!=="field");if(n.length>0){const s=n.find(o=>o.type==="alias");s?e.push(s.params?.[0].toString()??""):e.push(n[0].type)}else r[0]&&r[0].params&&r[0].params[0]&&e.push(r[0].params[0].toString())});let t=[];return e.forEach(r=>{t.push(pt(r,r,t,0))}),t}function pt(a,e,t,r){return t.indexOf(e)>-1?(r++,pt(a,a+"_"+r,t,r)):e}function Nr(a,e){const r=e.map(o=>o.name).every(o=>o&&a?o.split(".").every(u=>a.toLowerCase().includes(u.toLowerCase())):!1),s=["*","SHOW"].some(o=>a?a.toLowerCase().includes(o.toLowerCase()):!1);return r||s}var Dr=c(65474),jr=c(50471);const Pe="InfluxVariableQueryEditor-VariableQuery",wr=({onChange:a,datasource:e,query:t})=>{const r=n=>typeof n!="string"?n:{refId:Pe,query:n,...e.version===x.Flux?{maxDataPoints:1e3}:{}};switch(e.version){case x.Flux:return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(Te,{datasource:e,query:r(t),onChange:n=>{a({...t,query:n.query??""})}}),(0,i.jsx)(ee.C,{children:(0,i.jsx)(R.I,{label:"Max Data Points",labelWidth:20,required:!0,grow:!0,"aria-labelledby":"flux-maxdatapoints",tooltip:(0,i.jsx)("div",{children:"Upper boundary of data points will return for the variable query."}),children:(0,i.jsx)(b.p,{id:"influx-sql-variable-maxdatapoints","aria-label":"flux-maxdatapoints",type:"number",defaultValue:t.maxDataPoints??1e3,placeholder:"Default is 1000",onBlur:n=>{a({refId:Pe,query:t.query,maxDataPoints:Number.parseInt(n.currentTarget.value,10)})}})})})]});default:return(0,i.jsx)(ee.C,{children:(0,i.jsx)(R.I,{label:"Query",labelWidth:20,required:!0,grow:!0,"aria-labelledby":"influx-variable-query",children:(0,i.jsx)(qe.f,{"aria-label":"influx-variable-query",defaultValue:r(t).query,placeholder:"metric name or tags query",rows:1,onBlur:n=>{a({refId:Pe,query:n.currentTarget.value??""})}})})})}};class Pr extends jr.f5{constructor(e,t=(0,te.w)()){super(),this.datasource=e,this.templateSrv=t,this.editor=wr}query(e){let t;if(typeof e.targets[0]=="string"?t=e.targets[0]:t=e.targets[0].query,!t)return(0,ye.of)({data:[]});const r=this.templateSrv.replace(t,e.scopedVars,this.datasource.interpolateQueryExpr),n=this.datasource.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone}),s=r.replace("$timeFilter",n);return(0,Dr.H)(this.datasource.metricFindQuery({refId:e.targets[0].refId,query:s,maxDataPoints:e.targets[0].maxDataPoints??1e3},{range:e.range})).pipe((0,ie.T)(l=>({data:l})))}}class Fr extends We.iy{constructor(e,t=(0,te.w)()){super(e),this.templateSrv=t,this.type="influxdb",this.urls=(e.url??"").split(",").map(n=>n.trim()),this.username=e.username??"",this.password=e.password??"",this.name=e.name,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.access=e.access;const r=e.jsonData??{};this.database=r.dbName??e.database,this.interval=r.timeInterval,this.httpMode=r.httpMode||"GET",this.responseParser=new Ar,this.version=r.version??x.InfluxQL,this.isProxyAccess=e.access==="proxy",this.variables=new Pr(this,this.templateSrv),this.version===x.Flux?this.annotations={QueryEditor:Te}:this.annotations={QueryEditor:Ir,prepareAnnotation:br}}query(e){if(!this.isProxyAccess){const t=new Error(Fe);return(0,Ie.$)(()=>t)}return this._query(e)}_query(e){const t={...e,targets:e.targets.filter(r=>r.hide!==!0)};if(t.targets.some(r=>r.fromAnnotations)){const r=[];for(const n of t.targets)n.query&&r.push(new xr.c(s=>{this.annotationEvents(t,n).then(o=>s.next({data:[(0,Tr.Vc)(o)]})).catch(o=>s.error(new Error(o))).finally(()=>s.complete())}));return(0,Sr.h)(...r)}return this.version===x.InfluxQL&&!this.isMigrationToggleOnAndIsAccessProxy()?this.classicQuery(e):super.query(t)}getQueryDisplayText(e){switch(this.version){case x.Flux:return e.query;case x.SQL:return Ke(e);case x.InfluxQL:return new k(e).render(!1);default:return""}}filterQuery(e){return this.version===x.Flux?!!e.query:!0}applyTemplateVariables(e,t,r){const n=t||{};if(n.__interval={value:"$__interval"},n.__interval_ms={value:"$__interval_ms"},this.version===x.Flux)return{...e,query:this.templateSrv.replace(e.query??"",n)};if((this.version===x.SQL||this.isMigrationToggleOnAndIsAccessProxy())&&(e=this.applyVariables(e,n,r),e.adhocFilters?.length)){const s=(e.adhocFilters??[]).map(o=>{const{condition:l,...u}=o;return u.value=this.templateSrv.replace(u.value??"",n),u});e.tags=[...e.tags??[],...s]}return e}targetContainsTemplate(e){const t=this.version===x.Flux?e.query:Ue(e);return this.templateSrv.containsTemplate(t)}interpolateVariablesInQueries(e,t){return!e||e.length===0?[]:e.map(r=>this.version===x.Flux?{...r,datasource:this.getRef(),query:this.templateSrv.replace(r.query??"",t,(n=[],s)=>this.interpolateQueryExpr(n,s,r.query))}:{...r,datasource:this.getRef(),...this.applyVariables(r,t)})}applyVariables(e,t,r){const n={...e};return e.groupBy&&(n.groupBy=e.groupBy.map(s=>({...s,params:s.params?.map(o=>this.templateSrv.replace(o.toString(),void 0))}))),e.select&&(n.select=e.select.map(s=>s.map(o=>({...o,params:o.params?.map(l=>this.templateSrv.replace(l.toString(),t))})))),e.tags&&(n.tags=e.tags.map(s=>(s.operator!=="=~"&&s.operator!=="!~"&&(s.value=de(s.value)),{...s,key:this.templateSrv.replace(s.key,t),value:this.templateSrv.replace(s.value??"",t,(o=[],l)=>this.interpolateQueryExpr(o,l,s.value))}))),{...n,adhocFilters:r??[],query:this.templateSrv.replace(e.query??"",t,(s=[],o)=>this.interpolateQueryExpr(s,o,e.query)),rawSql:this.templateSrv.replace(e.rawSql??"",t,(s=[],o)=>this.interpolateQueryExpr(s,o,e.rawSql)),alias:this.templateSrv.replace(e.alias??"",t),limit:this.templateSrv.replace(e.limit?.toString()??"",t),measurement:this.templateSrv.replace(e.measurement??"",t,(s=[],o)=>this.interpolateQueryExpr(s,o,e.measurement)),policy:this.templateSrv.replace(e.policy??"",t),slimit:this.templateSrv.replace(e.slimit?.toString()??"",t),tz:this.templateSrv.replace(e.tz??"",t)}}interpolateQueryExpr(e=[],t,r){if(typeof e=="string"&&!isNaN(parseFloat(e)))return e;if(t.multi)return typeof e=="string"?isNaN(parseFloat(e))?(0,Z.$f)(e):e:`(${e.map(l=>(0,Z.$f)(l)).join("|")})`;const n=new RegExp(/\/((?![*+?])(?:[^\r\n\[/\\]|\\.|\[(?:[^\r\n\]\\]|\\.)*\])+)\/((?:g(?:im?|mi?)?|i(?:gm?|mg?)?|m(?:gi?|ig?)?)?)/,"gm"),s=new RegExp(`\\/(?:\\^)?(.*)(\\$${t.name})(.*)(?:\\$)?\\/`,"gm");if(!r)return e;const o=r.match(n);if(!o)return e;for(const l of o)if(l.match(s))return typeof e=="string"?(0,Z.$f)(e):`(${e.map(u=>(0,Z.$f)(u)).join("|")})`;return e}async runMetadataQuery(e){return(0,re.s)(super.query({targets:[e]})).then(this.toMetricFindValue)}async metricFindQuery(e,t){if(this.version===x.Flux||this.version===x.SQL||this.isMigrationToggleOnAndIsAccessProxy()){const n={refId:"metricFindQuery",query:e.query,rawQuery:!0,...this.version===x.SQL?{rawSql:e.query,format:Ee.gv.Table}:{}};return(0,re.s)(super.query({...t??{},maxDataPoints:e.maxDataPoints,targets:[n]})).then(this.toMetricFindValue)}const r=this.templateSrv.replace(e.query,t?.scopedVars,(n=[],s)=>this.interpolateQueryExpr(n,s,e.query));return(0,re.s)(this._seriesQuery(r,t)).then(n=>this.responseParser.parse(e.query,n))}toMetricFindValue(e){const t=new Map;return e?.data?.forEach(r=>{if(r&&r.length>0){let n=r.fields.find(s=>s.type===V.PU.string);n||(n=r.fields.find(s=>s.type!==V.PU.time)),n&&n.values.forEach(s=>{t.set(s.toString(),{text:s.toString()})})}}),Array.from(t.values())}getTagKeys(e){const t=Ne({type:"TAG_KEYS",templateService:this.templateSrv,database:this.database});return this.metricFindQuery({refId:"get-tag-keys",query:t})}getTagValues(e){const t=Ne({type:"TAG_VALUES",templateService:this.templateSrv,database:this.database,withKey:e.key});return this.metricFindQuery({refId:"get-tag-values",query:t})}_seriesQuery(e,t){if(!e)return(0,ye.of)({results:[]});if(t&&t.range){const r=this.getTimeFilter({rangeRaw:t.range,timezone:t.timezone});e=e.replace("$timeFilter",r)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},t)}serializeParams(e){return e?(0,m.reduce)(e,(t,r,n)=>(r==null||t.push(encodeURIComponent(n)+"="+encodeURIComponent(r)),t),[]).join("&"):""}_influxRequest(e,t,r,n){const s=this.urls.shift();this.urls.push(s);const o={};this.username&&(o.u=this.username,o.p=this.password),n&&n.database?o.db=n.database:this.database&&(o.db=this.database),n?.policy&&n.policy!==X&&(o.rp=n.policy);const{q:l}=r;e==="POST"&&(0,m.has)(r,"q")?((0,m.extend)(o,(0,m.omit)(r,["q"])),r=this.serializeParams((0,m.pick)(r,["q"]))):(e==="GET"||e==="POST")&&((0,m.extend)(o,r),r=null);const u={method:e,url:s+t,params:o,data:r,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return u.headers=u.headers||{},(this.basicAuth||this.withCredentials)&&(u.withCredentials=!0),this.basicAuth&&(u.headers.Authorization=this.basicAuth),e==="POST"&&(u.headers["Content-type"]="application/x-www-form-urlencoded"),(0,be.AI)().fetch(u).pipe((0,ie.T)(d=>{const{data:p}=d;if(p&&(p.executedQueryString=l,p.results)){const h=d.data.results.filter(f=>f.error);if(h.length>0)throw{message:"InfluxDB Error: "+h[0].error,data:p}}return p}),(0,vr.W)(d=>d.cancelled?(0,ye.of)(d):(0,Ie.$)(this.handleErrors(d))))}handleErrors(e){const t={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&e.status!==0||e.status>=300)&&(e.data&&e.data.error?(t.message="InfluxDB Error: "+e.data.error,t.data=e.data,t.config=e.config):(t.message="Network Error: "+e.statusText+"("+e.status+")",t.data=e.data,t.config=e.config)),t}getTimeFilter(e){const t=this.getInfluxTime(e.rangeRaw.from,!1,e.timezone),r=this.getInfluxTime(e.rangeRaw.to,!0,e.timezone);return"time >= "+t+" and time <= "+r}getInfluxTime(e,t,r){let n;if((0,m.isString)(e)){if(e==="now")return"now()";const s=/^now-(\d+)([dhms])$/.exec(e);if(s){const o=parseInt(s[1],10),l=s[2];return"now() - "+o+l}if(n=Er.parse(e,t,r),!n)throw new Error("unable to parse date");e=n}return e.valueOf()+"ms"}isMigrationToggleOnAndIsAccessProxy(){return Ze.Ay.featureToggles.influxdbBackendMigration&&this.access==="proxy"}classicQuery(e){let t=this.getTimeFilter(e);const r=e.scopedVars,n=(0,m.cloneDeep)(e.targets),s=[];let o,l,u=(0,m.map)(n,h=>h.hide?"":(s.push(h),r.interval=r.__interval,new k(h,this.templateSrv,r).render(!0))).reduce((h,f)=>(f!==""&&(h+=";"+f),h));if(u==="")return(0,ye.of)({data:[]});const d=e.filters,p=e.targets.flatMap(h=>h.adhocFilters??[]);if(d?.length||p?.length){const h=d?.length?d:p,f=new k({refId:"A"},this.templateSrv,r);t+=" AND "+f.renderAdhocFilters(h)}return r.timeFilter={value:t},u=this.templateSrv.replace(u,r),this._seriesQuery(u,e).pipe((0,ie.T)(h=>{if(!h||!h.results)return{data:[]};const f=[];for(o=0;o<h.results.length;o++){const g=h.results[o];if(!g||!g.series)continue;const U=s[o];let ce=U.alias;ce&&(ce=this.templateSrv.replace(U.alias,e.scopedVars));const y={executedQueryString:h.executedQueryString},N=new dt({refId:U.refId,series:h.results[o].series,alias:ce,meta:y});switch(U.resultFormat){case"logs":y.preferredVisualisationType="logs";case"table":{f.push(N.getTable());break}default:{const F=N.getTimeSeries();for(l=0;l<F.length;l++)f.push(Br(F[l]));break}}}return{data:f}}))}async annotationEvents(e,t){if(this.version===x.Flux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!t.query)return Promise.reject({message:"Query missing in annotation definition"});if(this.isMigrationToggleOnAndIsAccessProxy()){const s={refId:"metricFindQuery",datasource:this.getRef(),query:this.templateSrv.replace(t.query,void 0,(o=[],l)=>this.interpolateQueryExpr(o,l,t.query)),rawQuery:!0};return(0,re.s)((0,be.AI)().fetch({url:"/api/ds/query",method:"POST",headers:this.getRequestHeaders(),data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[s]},requestId:t.name}).pipe((0,ie.T)(async o=>await this.responseParser.transformAnnotationResponse(t,o,s))))}const r=this.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone});let n=t.query.replace("$timeFilter",r);return n=this.templateSrv.replace(n,void 0,(s=[],o)=>this.interpolateQueryExpr(s,o,n)),(0,re.s)(this._seriesQuery(n,e)).then(s=>{if(!s||!s.results||!s.results[0])throw{message:"No results in response from InfluxDB"};return new dt({series:s.results[0].series,annotation:t}).getAnnotations()})}}function Mr(a){const e=a.find(r=>r!==null);if(e===void 0)return V.PU.number;const t=typeof e;switch(t){case"string":return V.PU.string;case"boolean":return V.PU.boolean;case"number":return V.PU.number;default:throw new Error(`InfluxQL: invalid value type ${t}`)}}function Br(a){const e=[],t=[],r=a.datapoints;for(const l of r)t.push(l[0]),e.push(l[1]);const n={name:V.LE,type:V.PU.time,config:{},values:e},s={name:V.Bc,type:Mr(t),config:{displayNameFromDS:a.title},values:t,labels:a.tags},o=[n,s];return{name:a.target,refId:a.refId,meta:a.meta,fields:o,length:t.length}}const Qr=new P.tD(Fr).setConfigEditor(Tt).setQueryEditor(pr).setQueryEditorHelp(yr)},41778:(_,w,c)=>{c.d(w,{lX:()=>H});var P=c(94541),i=c(35095),m=c(2543),T=c(96540),I,D=(S=>(S[S.Timeseries=0]="Timeseries",S[S.Table=1]="Table",S[S.Logs=2]="Logs",S[S.Trace=3]="Trace",S[S.OptionMulti=4]="OptionMulti",S))(D||{}),H=(S=>(S.Builder="builder",S.Code="code",S))(H||{});const B=[{label:"Time series",value:0},{label:"Table",value:1}],O=S=>({label:S,value:S}),J=(I=i.z)!=null?I:O}}]);

//# sourceMappingURL=influxdbPlugin.d6baf57e0c604cc21899.js.map