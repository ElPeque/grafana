"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3461],{1530:(ge,X,s)=>{s.d(X,{A:()=>h});var e=s(74848),n=s(22803),C=s(1932),m=s(96540),P=s(49785),T=s(42941),N=s(29675),O=s(48583),k=s(45565),U=s(34128),S=s(50926),Y=s(86489),W=s(54594),H=s(11817),d=s(83466),I=s(82700);const p=({field:t})=>{const a=(0,N.of)(v);return(0,e.jsxs)("div",{children:[(0,e.jsx)("span",{className:a.annotationTitle,children:"Custom annotation name and content"}),(0,e.jsx)(U.p,{placeholder:"Enter custom annotation name...",width:18,...t,className:a.customAnnotationInput})]})},v=t=>({annotationTitle:(0,n.css)({color:t.colors.text.primary,marginBottom:"3px"}),customAnnotationInput:(0,n.css)({marginTop:"5px",width:"100%"})}),b=p,$=({annotationField:t,annotations:a,annotation:c,index:f})=>{const{control:u}=(0,P.xW)();return(0,e.jsxs)(O.B,{direction:"column",gap:0,children:[(0,e.jsx)("label",{children:(0,e.jsx)(P.xI,{name:`annotations.${f}.key`,defaultValue:t.key,render:({field:{ref:i,...l}})=>{if(!d.J3[c])return(0,e.jsx)(b,{field:l});let R;switch(t.key){case d.YH.dashboardUID:R="Dashboard and panel";break;case d.YH.panelID:R="";break;default:R=d.J3[c]&&d.J3[c]+" (optional)"}return(0,e.jsx)("span",{"data-testid":`annotation-key-${f}`,children:(0,e.jsx)(k.E,{color:"primary",variant:"bodySmall",children:R})})},control:u,rules:{required:{value:!!a[f]?.value,message:"Required."}}})}),(0,e.jsx)(k.E,{variant:"bodySmall",color:"secondary",children:d.H8[c]})]})};var L=s(79784),oe=s(85651);const ie=({dashboard:t,panel:a,dashboardUid:c,panelId:f,onEditClick:u,onDeleteClick:i})=>{const l=(0,N.of)(Ae),R=(0,oe.JM)(t?.uid||c),x=(0,oe.D2)(t?.uid||c,a?.id?.toString()||f);return(0,e.jsxs)("div",{className:l.container,children:[t&&(0,e.jsxs)("a",{href:R,className:l.link,target:"_blank",rel:"noreferrer","data-testid":"dashboard-annotation",children:[t.title," ",(0,e.jsx)(L.I,{name:"external-link-alt"})]}),!t&&(0,e.jsxs)("span",{className:l.noLink,children:["Dashboard ",c," "]}),a&&(0,e.jsxs)("a",{href:x,className:l.link,target:"_blank",rel:"noreferrer","data-testid":"panel-annotation",children:[a.title||"<No title>"," ",(0,e.jsx)(L.I,{name:"external-link-alt"})]}),!a&&(0,e.jsxs)("span",{className:l.noLink,children:[" - Panel ",f]}),(t||a)&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(L.I,{name:"pen",onClick:u,className:l.icon}),(0,e.jsx)(L.I,{name:"trash-alt",onClick:i,className:l.icon})]})]})},Ae=t=>({container:(0,n.css)({marginTop:"5px"}),noLink:(0,n.css)({color:t.colors.text.secondary}),link:(0,n.css)({color:t.colors.text.link,marginRight:t.spacing(1.5)}),icon:(0,n.css)({marginRight:t.spacing(1),cursor:"pointer"})}),Ee=ie;var Le=s(2543),Pe=s(40996),ce=s(70713),fe=s(91793),xe=s(6736),ve=s(25356),ye=s(37e3),de=s(22560),je=s(81876),se=s(79120);const ue=se.H.injectEndpoints({endpoints:t=>({search:t.query({query:({query:a})=>{const c=new URLSearchParams({type:"dash-db",limit:"1000",page:"1",sort:"name_sort"});return a&&c.set("query",a),{url:`/api/search?${c.toString()}`}}}),dashboard:t.query({query:({uid:a})=>({url:`/api/dashboards/uid/${a}`})})})});var Re=s(41811),me=s(36503);const Me=(0,Re.default)(t=>{const{dashboard:a,meta:c}=structuredClone(t);return new me.G(a,c)});function be(t){return ue.endpoints.dashboard.useQuery({uid:t??""},{skip:!t,selectFromResult:({currentData:c,data:f,...u})=>({dashboardModel:c?Me(c):void 0,...u})})}function Be(t,a){return t.title&&a.title?t.title.localeCompare(a.title):t.title&&!a.title?1:!t.title&&a.title?-1:0}const Te=({dashboardUid:t,panelId:a,isOpen:c,onChange:f,onDismiss:u})=>{const i=(0,N.of)(Ne),[l,R]=(0,m.useState)(t),[x,ee]=(0,m.useState)(a),[q,ne]=(0,m.useState)(""),[J,Q]=(0,m.useState)(""),[K,w]=(0,m.useState)(""),{useSearchQuery:A}=ue,{currentData:E=[],isFetching:Z}=A({query:J}),{dashboardModel:M,isFetching:V}=be(l),Oe=(0,m.useCallback)(j=>{R(j),ee(void 0)},[]),De=he(M),Se=De.filter(j=>j.title?.toLowerCase().includes(K.toLowerCase())).sort(Be)??[],pe=De.find(j=>le(j)&&j.id?.toString()===x),re=(0,m.useMemo)(()=>E.map(j=>j.uid).indexOf(l??""),[E,l]),D=t&&t===l,B=re>=0,_=(0,m.useCallback)(j=>{const z=re>=0;D&&z&&j?.scrollToItem(re,"smart")},[D,re]);(0,Pe.A)(()=>{Q(q)},500,[q]);const te=({index:j,style:z})=>{const G=E[j],Ie=l===G.uid;return(0,e.jsxs)("button",{type:"button",title:G.title,style:z,className:(0,n.cx)(i.rowButton,{[i.rowOdd]:j%2===1,[i.rowSelected]:Ie}),onClick:()=>Oe(G.uid),children:[(0,e.jsx)("div",{className:(0,n.cx)(i.dashboardTitle,i.rowButtonTitle),children:G.title}),(0,e.jsxs)("div",{className:i.dashboardFolder,children:[(0,e.jsx)(L.I,{name:"folder"})," ",G.folderTitle??"Dashboards"]})]})},ae=({index:j,style:z})=>{const G=Se[j],Ie=G.title||"<No title>",Fe=!!G.id&&x===G.id,We=G.type==="graph"||G.type==="timeseries",Ce=!le(G);return(0,e.jsxs)("button",{type:"button",style:z,disabled:Ce,className:(0,n.cx)(i.rowButton,i.panelButton,{[i.rowOdd]:j%2===1,[i.rowSelected]:Fe}),onClick:()=>Ce?Le.noop:ee(G.id),children:[(0,e.jsx)("div",{className:i.rowButtonTitle,title:Ie,children:Ie}),!We&&!Ce&&(0,e.jsx)(xe.m,{content:"The alert tab and alert annotations are only supported on graph and timeseries panels.",children:(0,e.jsx)(L.I,{name:"exclamation-triangle",className:i.warnIcon,"data-testid":"warning-icon"})}),Ce&&(0,e.jsx)(xe.m,{content:"This panel does not have a valid identifier.",children:(0,e.jsx)(L.I,{name:"info-circle","data-testid":"info-icon"})})]})};return(0,e.jsxs)(ve.a,{title:"Select dashboard and panel",closeOnEscape:!0,isOpen:c,onDismiss:u,className:i.modal,contentClassName:i.modalContent,children:[!B&&t&&M&&(0,e.jsxs)(ye.F,{title:"Current selection",severity:"info",topSpacing:0,bottomSpacing:1,className:i.modalAlert,children:[(0,e.jsxs)("div",{children:["Dashboard: ",M.title," (",M.uid,") in folder"," ",M.meta?.folderTitle??"Dashboards"]}),pe&&(0,e.jsxs)("div",{children:["Panel: ",pe.title," (",pe.id,")"]})]}),(0,e.jsxs)("div",{className:i.container,children:[(0,e.jsx)(de.Z,{value:q,onChange:ne,title:"Search dashboard",placeholder:"Search dashboard",autoFocus:!0}),(0,e.jsx)(de.Z,{value:K,onChange:w,title:"Search panel",placeholder:"Search panel"}),(0,e.jsxs)("div",{className:i.column,children:[Z&&(0,e.jsx)(je._,{text:"Loading dashboards...",className:i.loadingPlaceholder}),!Z&&(0,e.jsx)(ce.default,{children:({height:j,width:z})=>(0,e.jsx)(fe.Y1,{ref:_,itemSize:50,height:j,width:z,itemCount:E.length,children:te})})]}),(0,e.jsxs)("div",{className:i.column,children:[!l&&!V&&(0,e.jsx)("div",{className:i.selectDashboardPlaceholder,children:(0,e.jsx)("div",{children:"Select a dashboard to get a list of available panels"})}),V&&(0,e.jsx)(je._,{text:"Loading dashboard...",className:i.loadingPlaceholder}),l&&!V&&(0,e.jsx)(ce.default,{children:({width:j,height:z})=>(0,e.jsx)(fe.Y1,{itemSize:32,height:z,width:j,itemCount:Se.length,children:ae})})]})]}),(0,e.jsxs)(ve.a.ButtonRow,{children:[(0,e.jsx)(W.$n,{type:"button",variant:"secondary",onClick:u,fill:"text",children:(0,e.jsx)(H.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)(W.$n,{type:"button",variant:"primary",disabled:!(l&&x),onClick:()=>{l&&x&&f(l,x)},children:"Confirm"})]})]})};function he(t){if(!t)return[];const a=t.panels.filter(u=>u.type!=="row"),c=t.panels.filter(u=>u.collapsed).flatMap(u=>u.panels??[]);return[...a,...c]}const le=t=>{const a=typeof t.id=="number",c=typeof t.type=="string",f="libraryPanel"in t;return a&&(c||f)},Ne=t=>{const a=(0,W.my)(t);return{container:(0,n.css)({display:"grid",gridTemplateColumns:"1fr 1fr",gridTemplateRows:"min-content auto",gap:t.spacing(2),flex:1}),column:(0,n.css)({flex:"1 1 auto"}),dashboardTitle:(0,n.css)({height:"22px",fontWeight:t.typography.fontWeightBold}),dashboardFolder:(0,n.css)({height:"20px",fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary,display:"flex",flexDirection:"row",justifyContent:"flex-start",columnGap:t.spacing(1),alignItems:"center"}),rowButton:(0,n.css)(a,{padding:t.spacing(.5),overflow:"hidden",textOverflow:"ellipsis",textAlign:"left",whiteSpace:"nowrap",cursor:"pointer",border:"2px solid transparent","&:disabled":{cursor:"not-allowed",color:t.colors.text.disabled}}),rowButtonTitle:(0,n.css)({textOverflow:"ellipsis",overflow:"hidden"}),rowSelected:(0,n.css)({borderColor:t.colors.primary.border}),rowOdd:(0,n.css)({backgroundColor:t.colors.background.secondary}),panelButton:(0,n.css)({display:"flex",gap:t.spacing(1),justifyContent:"space-between",alignItems:"center"}),loadingPlaceholder:(0,n.css)({height:"100%",display:"flex",justifyContent:"center",alignItems:"center"}),selectDashboardPlaceholder:(0,n.css)({width:"100%",height:"100%",display:"flex",flexDirection:"column",justifyContent:"center",textAlign:"center",fontWeight:t.typography.fontWeightBold}),modal:(0,n.css)({height:"100%"}),modalContent:(0,n.css)({flex:1,display:"flex",flexDirection:"column"}),modalAlert:(0,n.css)({flexGrow:0}),warnIcon:(0,n.css)({fill:t.colors.warning.main})}};var o=s(3538),r=s(16213);const y=()=>{const t=(0,N.of)(g),[a,c]=(0,T.A)(!1),{control:f,register:u,watch:i,formState:{errors:l},setValue:R}=(0,P.xW)(),x=i("annotations"),ee=i("type"),{fields:q,append:ne,remove:J}=(0,P.jz)({control:f,name:"annotations"}),Q=x.find(D=>D.key===d.YH.dashboardUID)?.value,K=Number(x.find(D=>D.key===d.YH.panelID)?.value),[w,A]=(0,m.useState)(void 0),[E,Z]=(0,m.useState)(void 0),{dashboardModel:M,isFetching:V}=be(Q);(0,m.useEffect)(()=>{if(V||!M)return;A(M);const B=he(M).find(_=>_.id===K);Z(B)},[K,M,V]);const Oe=(D,B)=>{const _=(0,C.jM)(x,te=>{const ae=te.find(z=>z.key===d.YH.dashboardUID),j=te.find(z=>z.key===d.YH.panelID);ae?ae.value=D:te.push({key:d.YH.dashboardUID,value:D}),j?j.value=B.toString():te.push({key:d.YH.panelID,value:B.toString()})});R("annotations",_),c(!1)},De=()=>{const D=x.filter(B=>B.key!==d.YH.dashboardUID&&B.key!==d.YH.panelID);R("annotations",D),A(void 0),Z(void 0)},Se=()=>{c(!0)};function pe(){return(0,e.jsxs)(O.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)(k.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(H.x6,{i18nKey:"alerting.annotations.description",children:"Add more context to your alert notifications."})}),(0,e.jsx)(o.G,{contentText:`Annotations add metadata to provide more information on the alert in your alert notification messages.
          For example, add a Summary annotation to tell you which value caused the alert to fire or which server it happened on.
          Annotations can contain a combination of text and template code.`,title:"Annotations"})]})}const re=(0,I.H2)(ee)?6:5;return(0,e.jsx)(r.P,{stepNo:re,title:(0,H.t)("alerting.annotations.title","Configure notification message"),description:pe(),fullWidth:!0,children:(0,e.jsxs)(O.B,{direction:"column",gap:1,children:[q.map((D,B)=>{const _=x[B]?.key?.toLocaleLowerCase().endsWith("url"),te=_?U.p:S.f,ae=D.key;return(0,e.jsx)("div",{className:t.flexRow,children:(0,e.jsxs)("div",{children:[(0,e.jsx)($,{annotationField:D,annotations:x,annotation:ae,index:B}),Q&&K&&D.key===d.YH.dashboardUID&&(0,e.jsx)(Ee,{dashboard:w,panel:E,dashboardUid:Q.toString(),panelId:K.toString(),onEditClick:Se,onDeleteClick:De}),(0,e.jsxs)("div",{className:t.annotationValueContainer,children:[(0,e.jsx)(Y.D,{hidden:D.key===d.YH.dashboardUID||D.key===d.YH.panelID,className:(0,n.cx)(t.flexRowItemMargin,t.field),invalid:!!l.annotations?.[B]?.value?.message,error:l.annotations?.[B]?.value?.message,children:(0,e.jsx)(te,{"data-testid":`annotation-value-${B}`,className:(0,n.cx)(t.annotationValueInput,{[t.textarea]:!_}),...u(`annotations.${B}.value`),placeholder:_?"https://":D.key&&`Enter a ${D.key}...`||"Enter custom annotation content...",defaultValue:D.value})}),!d.J3[ae]&&(0,e.jsx)(W.$n,{type:"button",className:t.deleteAnnotationButton,"aria-label":"delete annotation",icon:"trash-alt",variant:"secondary",onClick:()=>J(B)})]})]})},D.id)}),(0,e.jsx)(O.B,{direction:"row",gap:1,children:(0,e.jsxs)("div",{className:t.addAnnotationsButtonContainer,children:[(0,e.jsx)(W.$n,{icon:"plus",type:"button",variant:"secondary",onClick:()=>{ne({key:"",value:""})},children:"Add custom annotation"}),!w&&(0,e.jsx)(W.$n,{type:"button",variant:"secondary",icon:"dashboard",onClick:()=>c(!0),children:"Link dashboard and panel"})]})}),a&&(0,e.jsx)(Te,{isOpen:!0,dashboardUid:Q,panelId:K,onChange:Oe,onDismiss:()=>c(!1)})]})})},g=t=>({annotationValueInput:(0,n.css)({width:"394px"}),textarea:(0,n.css)({height:"76px"}),addAnnotationsButtonContainer:(0,n.css)({marginTop:t.spacing(1),gap:t.spacing(1),display:"flex"}),field:(0,n.css)({marginBottom:t.spacing(.5)}),flexRow:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"}),flexRowItemMargin:(0,n.css)({marginTop:t.spacing(1)}),deleteAnnotationButton:(0,n.css)({display:"inline-block",marginTop:"10px",marginLeft:"10px"}),annotationTitle:(0,n.css)({color:t.colors.text.primary,marginBottom:"3px"}),annotationContainer:(0,n.css)({marginTop:"5px"}),annotationDescription:(0,n.css)({color:t.colors.text.secondary}),annotationValueContainer:(0,n.css)({display:"flex"})}),h=y},3538:(ge,X,s)=>{s.d(X,{G:()=>O});var e=s(74848),n=s(22803),C=s(29675),m=s(26676),P=s(48583),T=s(79784),N=s(45565);function O({contentText:U,externalLink:S,linkText:Y,title:W="Need help?"}){const H=(0,C.of)(k);return(0,e.jsx)(m.G,{content:(0,e.jsx)("div",{className:H.mutedText,children:U}),title:(0,e.jsxs)(P.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(T.I,{name:"question-circle"}),W]}),footer:S?(0,e.jsx)("a",{href:S,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(P.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(N.E,{color:"link",children:[Y," ",(0,e.jsx)(T.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:H.helpInfo,children:(0,e.jsxs)(P.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(T.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(N.E,{variant:"bodySmall",color:"primary",children:"Need help?"})]})})})}const k=U=>({mutedText:(0,n.css)({color:U.colors.text.secondary,fontSize:U.typography.size.sm}),helpInfo:(0,n.css)({cursor:"pointer",textDecoration:"underline"})})},16213:(ge,X,s)=>{s.d(X,{P:()=>k});var e=s(74848),n=s(22803),C=s(58779),m=s(29675),P=s(44617),T=s(48583),N=s(45565),O=s(29010);const k=({title:S,stepNo:Y,children:W,fullWidth:H=!1,description:d,switchMode:I})=>{const p=(0,m.of)(U),v=C.Tp.components.AlertRules;return(0,e.jsx)("div",{className:p.parent,"data-testid":v.step(Y.toString()),children:(0,e.jsx)(P.n,{className:(0,n.cx)(H&&p.fullWidth),label:(0,e.jsxs)(T.B,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[(0,e.jsxs)(N.E,{variant:"h3",children:[Y,". ",S]}),I&&(0,e.jsx)(N.E,{variant:"bodySmall",children:(0,e.jsx)(O.K,{"data-testid":v.stepAdvancedModeSwitch(Y.toString()),value:I.isAdvancedMode,onChange:b=>{I.setAdvancedMode(b.currentTarget.checked)},label:"Advanced options",showLabel:!0,transparent:!0,className:p.reverse})})]}),children:(0,e.jsxs)(T.B,{direction:"column",children:[d&&(0,e.jsx)("div",{className:p.description,children:d}),W]})})})},U=S=>({parent:(0,n.css)({display:"flex",flexDirection:"row",border:`solid 1px ${S.colors.border.weak}`,borderRadius:S.shape.radius.default,padding:`${S.spacing(2)} ${S.spacing(3)}`}),description:(0,n.css)({marginTop:`-${S.spacing(2)}`}),fullWidth:(0,n.css)({width:"100%"}),reverse:(0,n.css)({flexDirection:"row-reverse",gap:S.spacing(1)})})},30378:(ge,X,s)=>{s.d(X,{DI:()=>ue,C1:()=>Re,Ay:()=>Ne});var e=s(74848),n=s(22803),C=s(96540),m=s(49785),P=s(29675),T=s(48583),N=s(45565),O=s(9968),k=s(54594),U=s(81876),S=s(86489),Y=s(76302),W=s(34128),H=s(11817),d=s(10148),I=s(79120);const p=I.H.injectEndpoints({endpoints:o=>({getLabels:o.query({query:()=>({url:`/api/plugins/${d.W.Labels}/resources/v1/labels/keys`}),providesTags:["GrafanaLabels"]}),getLabelValues:o.query({query:({key:r})=>({url:`/api/plugins/${d.W.Labels}/resources/v1/labels/name/${r}`}),providesTags:["GrafanaLabels"]})})});var v=s(51311),b=s(39180),F=s(70584),$=s(82700),L=s(52866),oe=s(44826);const ie=(0,L.c)({ignoreCase:!1});function Ae(o,r){return ie({label:o.label??"",value:o.value??"",data:{}},r)}const Ee=(o,r,y)=>{const g=y.some(t=>t.label===o),h=o.trim().length;return!g&&!!h},Le=(0,C.forwardRef)(function({onChange:r,options:y,defaultValue:g,type:h,onOpenMenu:t=()=>{}},a){const c=(0,P.of)(Pe);return(0,e.jsx)("div",{ref:a,children:(0,e.jsx)(S.D,{disabled:!1,"data-testid":`alertlabel-${h}-picker`,className:c.resetMargin,children:(0,e.jsx)(oe.l6,{placeholder:`Choose ${h}`,width:29,className:"ds-picker select-container",backspaceRemovesValue:!1,onChange:r,onOpenMenu:t,filterOption:Ae,isValidNewOption:Ee,options:y,maxMenuHeight:500,noOptionsMessage:"No labels found",defaultValue:g,allowCustomValue:!0})})})}),Pe=()=>({resetMargin:(0,n.css)({marginBottom:0})}),ce=Le;var fe=s(3429),xe=s(3538),ve=s(59873);function ye({remove:o,index:r}){return(0,e.jsx)(k.$n,{"aria-label":"delete label",icon:"trash-alt","data-testid":`delete-label-${r}`,variant:"secondary",onClick:()=>{o(r)}})}function de({append:o}){return(0,e.jsx)(k.$n,{icon:"plus",type:"button",variant:"secondary",onClick:o,children:"Add more"})}const je=o=>{const{currentData:r,isLoading:y}=p.endpoints.getLabels.useQuery(void 0,{skip:o});return{loading:y,labelsOpsKeys:r}};function se(o=[],r){const y=new Set(r?r.map(g=>g.key):[]);return Array.from(o,g=>({label:g,value:g,isDisabled:y.has(g)}))}const ue=({labels:o})=>{const r=o.reduce((y,g)=>(g.key&&(y[g.key]=g.value),y),{});return(0,e.jsx)(fe.m,{labels:r})};function Re({dataSourceName:o,onClose:r,initialLabels:y}){const g=(0,P.of)(le),{watch:h}=(0,m.xW)(),t=h("type")??b.Z.grafana,a=i=>{r(i.labelsInSubform)},c=()=>{r()},f=(0,C.useMemo)(()=>({labelsInSubform:y}),[y]),u=(0,m.mN)({defaultValues:f});return(0,e.jsx)(m.Op,{...u,children:(0,e.jsx)("form",{onSubmit:u.handleSubmit(a),children:(0,e.jsxs)(T.B,{direction:"column",gap:4,children:[(0,e.jsx)(N.E,{children:he(t)}),(0,e.jsxs)(T.B,{direction:"column",gap:1,children:[(0,e.jsx)(be,{dataSourceName:o}),(0,e.jsx)(O.$,{v:2}),(0,e.jsx)(ue,{labels:u.watch("labelsInSubform")}),(0,e.jsx)(O.$,{v:1}),(0,e.jsxs)("div",{className:g.confirmButton,children:[(0,e.jsx)(k.$n,{type:"button",variant:"secondary",onClick:c,children:(0,e.jsx)(H.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)(k.$n,{type:"submit",children:"Save"})]})]})]})})})}const me=o=>!(0,F.F2)(o);function Me(o,r,y,g,h){const{isLoading:t,labels:a}=(0,ve.V)(o),{loading:c,labelsOpsKeys:f=[]}=je(!r||y),u=(0,C.useMemo)(()=>f.reduce((E,Z)=>(E[Z.name]=new Set,E),{}),[f]),i=(0,C.useMemo)(()=>se(Object.keys(u).filter(me),g),[u,g]),l=(0,C.useMemo)(()=>se(Array.from(a.keys()).filter(me),g),[a,g]),R=[{label:"From alerts",options:l,expanded:!0},{label:"From system",options:i,expanded:!0}],x=a.has(h),ee=u[h]!==void 0&&u[h]?.size>0,q=!x&&!ee,ne=!x&&u[h]?.size>0,{currentData:J,isLoading:Q=!1,error:K}=p.endpoints.getLabelValues.useQuery({key:h},{skip:!r||!h||x||ne||q}),w=(0,C.useMemo)(()=>{if(x)return[];const E=u[h];if(E?.size>0)return se(E);if(!Q&&J?.values?.length&&!K){const M=J?.values.map(V=>V.name);return u[h]=new Set(M),se(M)}return[]},[x,u,h,Q,J,K]),A=(0,C.useCallback)(E=>me(E)?x||!r?se(a.get(E)):w:[],[a,r,w,x]);return{loading:t||c,keysFromExistingAlerts:l,groupedOptions:R,getValuesForLabel:A}}function be({dataSourceName:o}){const r=(0,P.of)(le),{control:y,watch:g,formState:{errors:h}}=(0,m.xW)(),t=g("labelsInSubform"),{fields:a,remove:c,append:f}=(0,m.jz)({control:y,name:"labelsInSubform"}),u=(0,C.useCallback)(()=>{f({key:"",value:""})},[f]),{installed:i=!1,loading:l}=(0,v._)(d.W.Labels),[R,x]=(0,C.useState)(""),{loading:ee,keysFromExistingAlerts:q,groupedOptions:ne,getValuesForLabel:J}=Me(o,i,l,t,R),Q=(0,C.useMemo)(()=>J(R),[R,J]),K=ee||l;return(0,e.jsxs)(e.Fragment,{children:[K&&(0,e.jsx)(U._,{text:"Loading existing labels"}),!K&&(0,e.jsxs)(T.B,{direction:"column",gap:1,alignItems:"flex-start",children:[a.map((w,A)=>(0,e.jsxs)("div",{className:(0,n.cx)(r.flexRow,r.centerAlignRow),children:[(0,e.jsx)(S.D,{className:r.labelInput,invalid:!!h.labelsInSubform?.[A]?.key?.message,error:h.labelsInSubform?.[A]?.key?.message,"data-testid":`labelsInSubform-key-${A}`,children:(0,e.jsx)(m.xI,{name:`labelsInSubform.${A}.key`,control:y,rules:{required:t[A]?.value?"Required.":!1},render:({field:{onChange:E,ref:Z,...M}})=>(0,e.jsx)(ce,{...M,defaultValue:w.key?{label:w.key,value:w.key}:void 0,options:i?ne:q,onChange:V=>{E(V.value),x(V.value)},type:"key"})})}),(0,e.jsx)(Y.c,{className:r.equalSign,children:"="}),(0,e.jsx)(S.D,{className:r.labelInput,invalid:!!h.labelsInSubform?.[A]?.value?.message,error:h.labelsInSubform?.[A]?.value?.message,"data-testid":`labelsInSubform-value-${A}`,children:(0,e.jsx)(m.xI,{control:y,name:`labelsInSubform.${A}.value`,rules:{required:t[A]?.value?"Required.":!1},render:({field:{onChange:E,ref:Z,...M}})=>(0,e.jsx)(ce,{...M,defaultValue:w.value?{label:w.value,value:w.value}:void 0,options:Q,onChange:V=>{E(V.value)},onOpenMenu:()=>{x(t[A].key)},type:"value"})})}),(0,e.jsx)(ye,{index:A,remove:c})]},w.id)),(0,e.jsx)(de,{append:u})]})]})}const Be=()=>{const o=(0,P.of)(le),{register:r,control:y,watch:g,formState:{errors:h}}=(0,m.xW)(),t=g("labels"),{fields:a,remove:c,append:f}=(0,m.jz)({control:y,name:"labels"}),u=(0,C.useCallback)(()=>{f({key:"",value:""})},[f]);return(0,e.jsxs)(e.Fragment,{children:[a.map((i,l)=>(0,e.jsx)("div",{children:(0,e.jsxs)("div",{className:(0,n.cx)(o.flexRow,o.centerAlignRow),"data-testid":"alertlabel-input-wrapper",children:[(0,e.jsx)(S.D,{className:o.labelInput,invalid:!!h.labels?.[l]?.key?.message,error:h.labels?.[l]?.key?.message,children:(0,e.jsx)(W.p,{...r(`labels.${l}.key`,{required:{value:!!t[l]?.value,message:"Required."}}),placeholder:"key","data-testid":`label-key-${l}`,defaultValue:i.key})}),(0,e.jsx)(Y.c,{className:o.equalSign,children:"="}),(0,e.jsx)(S.D,{className:o.labelInput,invalid:!!h.labels?.[l]?.value?.message,error:h.labels?.[l]?.value?.message,children:(0,e.jsx)(W.p,{...r(`labels.${l}.value`,{required:{value:!!t[l]?.key,message:"Required."}}),placeholder:"value","data-testid":`label-value-${l}`,defaultValue:i.value})}),(0,e.jsx)(ye,{index:l,remove:c})]})},i.id)),(0,e.jsx)(de,{append:u})]})};function Te(){const{watch:o}=(0,m.xW)(),r=o("type")??b.Z.grafana;return(0,e.jsxs)("div",{children:[(0,e.jsxs)(T.B,{direction:"column",gap:1,children:[(0,e.jsx)(N.E,{element:"h5",children:"Labels"}),(0,e.jsxs)(T.B,{direction:"row",gap:1,children:[(0,e.jsx)(N.E,{variant:"bodySmall",color:"secondary",children:he(r)}),(0,e.jsx)(xe.G,{contentText:`The dropdown only displays labels that you have previously used for alerts.
            Select a label from the options below or type in a new one.`,title:"Labels"})]})]}),(0,e.jsx)(Be,{})]})}function he(o){return(o?(0,$.vE)(o):!1)?(0,H.t)("alerting.alertform.labels.recording","Add labels to your rule."):(0,H.t)("alerting.alertform.labels.alerting","Add labels to your rule for searching, silencing, or routing to a notification policy.")}const le=o=>({flexColumn:(0,n.css)({display:"flex",flexDirection:"column"}),flexRow:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"}),centerAlignRow:(0,n.css)({alignItems:"center",gap:o.spacing(.5)}),equalSign:(0,n.css)({alignSelf:"flex-start",width:"28px",justifyContent:"center",margin:0}),labelInput:(0,n.css)({width:"175px",margin:0}),confirmButton:(0,n.css)({display:"flex",flexDirection:"row",gap:o.spacing(1),marginLeft:"auto"})}),Ne=Te},59873:(ge,X,s)=>{s.d(X,{V:()=>U});var e=s(96540),n=s(5240),C=s(27106),m=s(3674);const{usePrometheusRuleNamespacesQuery:P,useLazyRulerRulesQuery:T}=n.hK,{useDiscoverDsFeaturesQuery:N}=C.L,O=(0,m.w)(),k={};function U(d){const{data:I,isLoading:p}=N({rulesSourceName:d}),[v,{data:b=k,isLoading:F}]=T(),{data:$=[],isLoading:L}=P({ruleSourceName:d},{skip:!O});(0,e.useEffect)(()=>{I?.rulerConfig&&!O&&v({rulerConfig:I.rulerConfig})},[I?.rulerConfig,v]);const oe=(0,e.useMemo)(()=>L||F?new Map:O?S($):Y(b),[$,b,L,F]),ie=(0,e.useMemo)(()=>L||F?new Map:O?W($):H(b),[$,b,L,F]);return{namespaceGroups:oe,labels:ie,isLoading:L||F||p}}function S(d){const I=new Map;return d.forEach(p=>{I.set(p.name,p.groups.map(v=>v.name))}),I}function Y(d){const I=new Map;return Object.entries(d).forEach(([p,v])=>{I.set(p,v.map(b=>b.name))}),I}function W(d){return d.flatMap(p=>p.groups).flatMap(p=>p.rules).reduce((p,v)=>(v.labels&&Object.entries(v.labels).forEach(([b,F])=>{if(!b||!F)return;const $=p.get(b);$?$.add(F):p.set(b,new Set([F]))}),p),new Map)}function H(d){const I=new Map;return Object.entries(d).flatMap(([v,b])=>b).flatMap(v=>v.rules).reduce((v,b)=>(b.labels&&Object.entries(b.labels).forEach(([F,$])=>{if(!F||!$)return;const L=v.get(F);L?L.add($):v.set(F,new Set([$]))}),v),I)}}}]);

//# sourceMappingURL=3461.af6d2a4a2ad83ed8614c.js.map