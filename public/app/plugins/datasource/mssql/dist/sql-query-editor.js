"use strict";(globalThis.webpackChunkmssql=globalThis.webpackChunkmssql||[]).push([[168],{3792:(e,t,n)=>{n.r(t),n.d(t,{default:()=>yt});var r=n(9728),o=n(5959),l=n(5489),a=n(624),i=n(2007),s=n(136),u=n(3277),c=n(4519),d=n(9467),p=n(45),v=n(4364),y=n(2961),f=n(8442),m=n(4326),b=n(8531),g=n(9453),h=n(6089);function j({isOpen:e,onCancel:t,onDiscard:n,onCopy:l}){const a=(0,o.useRef)(null),s=(0,i.useStyles2)(O);return(0,o.useEffect)((()=>{var t;e&&(null===(t=a.current)||void 0===t||t.focus())}),[e]),(0,r.jsxs)(i.Modal,{title:(0,r.jsxs)("div",{className:s.modalHeaderTitle,children:[(0,r.jsx)(i.Icon,{name:"exclamation-triangle",size:"lg"}),(0,r.jsx)("span",{className:s.titleText,children:"Warning"})]}),onDismiss:t,isOpen:e,children:[(0,r.jsx)("p",{children:"Builder mode does not display changes made in code. The query builder will display the last changes you made in builder mode."}),(0,r.jsx)("p",{children:"Do you want to copy your code to the clipboard?"}),(0,r.jsxs)(i.Modal.ButtonRow,{children:[(0,r.jsx)(i.Button,{type:"button",variant:"secondary",onClick:t,fill:"outline",children:"Cancel"}),(0,r.jsx)(i.Button,{variant:"destructive",type:"button",onClick:n,ref:a,children:"Discard code and switch"}),(0,r.jsx)(i.Button,{variant:"primary",onClick:l,children:"Copy code and switch"})]})]})}const O=e=>({titleText:(0,h.css)({paddingLeft:e.spacing(2)}),modalHeaderTitle:(0,h.css)({fontSize:e.typography.size.lg,float:"left",paddingTop:e.spacing(1),margin:e.spacing(0,2)})});var w=n(9953);function x(e,t,n,r,o,l,a){try{var i=e[l](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,o)}function S(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var l=e.apply(t,n);function a(e){x(l,r,o,a,i,"next",e)}function i(e){x(l,r,o,a,i,"throw",e)}a(void 0)}))}}const P=({dataset:e,db:t,dialect:n,onChange:a,inputId:s,preconfiguredDataset:u})=>{const c=!!u||"postgres"===n,d=(0,l.A)(S((function*(){return(0,w.C)()&&c?(a((0,g.zL)(u)),[(0,g.zL)(u)]):(e&&a((0,g.zL)(e)),(yield t.datasets()).map(g.zL))})),[]);return(0,o.useEffect)((()=>{(0,w.C)()||(e?d.value&&void 0===d.value.find((t=>t.value===e))&&d.value.length>0&&a(d.value[0]):d.value&&d.value[0]&&a(d.value[0]))}),[d.value,a,e]),(0,r.jsx)(i.Select,{"aria-label":"Dataset selector",inputId:s,value:e,options:d.value,onChange:a,disabled:d.loading,isLoading:d.loading,menuShouldPortal:!0})};var q=n(7781);function C(e,t,n,r,o,l,a){try{var i=e[l](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,o)}function k(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var l=e.apply(t,n);function a(e){C(l,r,o,a,i,"next",e)}function i(e){C(l,r,o,a,i,"throw",e)}a(void 0)}))}}const D=({db:e,dataset:t,table:n,className:o,onChange:a,inputId:s})=>{const u=(0,l.A)(k((function*(){return t?(yield e.tables(t)).map(q.toOption):[]})),[t]);return(0,r.jsx)(i.Select,{className:o,disabled:u.loading,"aria-label":"Table selector",inputId:s,"data-testid":d.Tp.components.SQLQueryEditor.headerTableSelector,value:n,options:u.value,onChange:a,isLoading:u.loading,menuShouldPortal:!0,placeholder:u.loading?"Loading tables":"Select table"})};function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function T(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){I(e,t,n[t])}))}return e}function E(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const _=[{label:"Builder",value:a.lX.Builder},{label:"Code",value:a.lX.Code}];function F({db:e,dialect:t,isQueryRunnable:n,onChange:l,onQueryRowChange:s,onRunQuery:u,preconfiguredDataset:h,query:O,queryRowFilter:x}){const{editorMode:S}=O,[q,C]=(0,c.A)(),[k,I]=(0,o.useState)(!1),F=e.toRawSql,Q=(0,o.useId)(),$=(0,o.useCallback)((e=>{var t;e===a.lX.Code&&(0,b.reportInteraction)("grafana_sql_editor_mode_changed",{datasource:null===(t=O.datasource)||void 0===t?void 0:t.type,selectedEditorMode:a.lX.Code}),S!==a.lX.Code?l(E(T({},O),{editorMode:e})):I(!0)}),[S,l,O]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(p.X,{children:[(0,r.jsx)(v.W,{label:"Format",value:O.format,placeholder:"Select format",menuShouldPortal:!0,onChange:e=>{var t;const n=E(T({},O),{format:void 0!==e.value?e.value:g.gv.Table});(0,b.reportInteraction)("grafana_sql_format_changed",{datasource:null===(t=O.datasource)||void 0===t?void 0:t.type,selectedFormat:n.format}),l(n)},options:g.cO}),S===a.lX.Builder&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.InlineSwitch,{id:`sql-filter-${Q}`,label:"Filter","data-testid":d.Tp.components.SQLQueryEditor.headerFilterSwitch,transparent:!0,showLabel:!0,value:x.filter,onChange:e=>{var t;e.target instanceof HTMLInputElement&&((0,b.reportInteraction)("grafana_sql_filter_toggled",{datasource:null===(t=O.datasource)||void 0===t?void 0:t.type,displayed:e.target.checked}),s(E(T({},x),{filter:e.target.checked})))}}),(0,r.jsx)(i.InlineSwitch,{id:`sql-group-${Q}`,label:"Group","data-testid":d.Tp.components.SQLQueryEditor.headerGroupSwitch,transparent:!0,showLabel:!0,value:x.group,onChange:e=>{var t;e.target instanceof HTMLInputElement&&((0,b.reportInteraction)("grafana_sql_group_toggled",{datasource:null===(t=O.datasource)||void 0===t?void 0:t.type,displayed:e.target.checked}),s(E(T({},x),{group:e.target.checked})))}}),(0,r.jsx)(i.InlineSwitch,{id:`sql-order-${Q}`,label:"Order","data-testid":d.Tp.components.SQLQueryEditor.headerOrderSwitch,transparent:!0,showLabel:!0,value:x.order,onChange:e=>{var t;e.target instanceof HTMLInputElement&&((0,b.reportInteraction)("grafana_sql_order_toggled",{datasource:null===(t=O.datasource)||void 0===t?void 0:t.type,displayed:e.target.checked}),s(E(T({},x),{order:e.target.checked})))}}),(0,r.jsx)(i.InlineSwitch,{id:`sql-preview-${Q}`,label:"Preview","data-testid":d.Tp.components.SQLQueryEditor.headerPreviewSwitch,transparent:!0,showLabel:!0,value:x.preview,onChange:e=>{var t;e.target instanceof HTMLInputElement&&((0,b.reportInteraction)("grafana_sql_preview_toggled",{datasource:null===(t=O.datasource)||void 0===t?void 0:t.type,displayed:e.target.checked}),s(E(T({},x),{preview:e.target.checked})))}})]}),(0,r.jsx)(y.Z,{grow:1}),n?(0,r.jsx)(i.Button,{icon:"play",variant:"primary",size:"sm",onClick:()=>u(),children:"Run query"}):(0,r.jsx)(i.Tooltip,{theme:"error",content:(0,r.jsxs)(r.Fragment,{children:["Your query is invalid. Check below for details. ",(0,r.jsx)("br",{}),"However, you can still run this query."]}),placement:"top",children:(0,r.jsx)(i.Button,{icon:"exclamation-triangle",variant:"secondary",size:"sm",onClick:()=>u(),children:"Run query"})}),(0,r.jsx)(i.RadioButtonGroup,{options:_,size:"sm",value:S,onChange:$}),(0,r.jsx)(j,{isOpen:k,onCopy:()=>{var e;(0,b.reportInteraction)("grafana_sql_editor_mode_changed",{datasource:null===(e=O.datasource)||void 0===e?void 0:e.type,selectedEditorMode:a.lX.Builder,type:"copy"}),I(!1),C(O.rawSql),l(E(T({},O),{rawSql:F(O),editorMode:a.lX.Builder}))},onDiscard:()=>{var e;(0,b.reportInteraction)("grafana_sql_editor_mode_changed",{datasource:null===(e=O.datasource)||void 0===e?void 0:e.type,selectedEditorMode:a.lX.Builder,type:"discard"}),I(!1),l(E(T({},O),{rawSql:F(O),editorMode:a.lX.Builder}))},onCancel:()=>{var e;(0,b.reportInteraction)("grafana_sql_editor_mode_changed",{datasource:null===(e=O.datasource)||void 0===e?void 0:e.type,selectedEditorMode:a.lX.Builder,type:"cancel"}),I(!1)}})]}),S===a.lX.Builder&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.Space,{v:.5}),(0,r.jsxs)(f.U,{children:["influx"!==t&&!(!(0,w.C)()&&"postgres"===t)&&(0,r.jsx)(m.c,{label:"Dataset",width:25,children:(0,r.jsx)(P,{db:e,inputId:`sql-dataset-${Q}`,dataset:O.dataset,dialect:t,preconfiguredDataset:h,onChange:e=>{if(e.value===O.dataset)return;const t=E(T({},O),{dataset:e.value,table:void 0,sql:void 0,rawSql:""});l(t)}})}),(0,r.jsx)(m.c,{label:"Table",width:25,children:(0,r.jsx)(D,{db:e,inputId:`sql-tableselect-${Q}`,dataset:O.dataset||h,table:O.table,onChange:e=>{if(e.value===O.table)return;const t=E(T({},O),{table:e.value,sql:void 0,rawSql:""});l(t)}})})]})]})]})}var Q=n(8722),$=n(4889),B=n(7893);function L(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function M({children:e,onChange:t,query:n,width:l,height:a,editorLanguageDefinition:i}){const s=(0,o.useRef)(n);(0,o.useEffect)((()=>{s.current=n}),[n]);const u=(0,o.useCallback)(((e,n)=>{const r=(o=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){L(e,t,n[t])}))}return e}({},s.current),l=null!=(l={rawQuery:!0,rawSql:e})?l:{},Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(l)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(l)).forEach((function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(l,e))})),o);var o,l;t(r,n)}),[t]);return(0,r.jsx)(B.Y,{width:l,height:a,query:n.rawSql,onChange:u,language:i,children:e})}var A=n(9389),R=n(990);function V(e,t,n,r,o,l,a){try{var i=e[l](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,o)}function N(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var l=e.apply(t,n);function a(e){V(l,r,o,a,i,"next",e)}function i(e){V(l,r,o,a,i,"throw",e)}a(void 0)}))}}function z({db:e,query:t,onValidate:n,range:l}){var a;const[s,u]=(0,o.useState)(),c=(0,i.useTheme2)(),d=(0,o.useMemo)((()=>(0,q.getValueFormat)("bytes")),[]),p=(0,o.useMemo)((()=>({error:(0,h.css)({color:c.colors.error.text,fontSize:c.typography.bodySmall.fontSize,fontFamily:c.typography.fontFamilyMonospace}),valid:(0,h.css)({color:c.colors.success.text}),info:(0,h.css)({color:c.colors.text.secondary})})),[c]),[v,y]=(0,A.A)(function(){var t=N((function*(t){var n;return""===(null===(n=t.rawSql)||void 0===n?void 0:n.trim())?null:yield e.validateQuery(t,l)}));return function(e){return t.apply(this,arguments)}}(),[e]),[]=(0,R.A)(N((function*(){const e=yield y(t);return e&&u(e),null})),1e3,[t,y]);if((0,o.useEffect)((()=>{(null==s?void 0:s.isError)&&n(!1),(null==s?void 0:s.isValid)&&n(!0)}),[s,n]),!v.value&&!v.loading)return null;const f=(null===(a=v.value)||void 0===a?void 0:a.error)?function(e){const t=e.split(":");return t.length>2?t.slice(2).join(":"):e}(v.value.error):"";return(0,r.jsxs)(r.Fragment,{children:[v.loading&&(0,r.jsxs)("div",{className:p.info,children:[(0,r.jsx)(i.Spinner,{inline:!0,size:"xs"})," Validating query..."]}),!v.loading&&v.value&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(r.Fragment,{children:v.value.isValid&&v.value.statistics&&(0,r.jsxs)("div",{className:p.valid,children:[(0,r.jsx)(i.Icon,{name:"check"})," This query will process"," ",(0,r.jsx)("strong",{children:(0,q.formattedValueToString)(d(v.value.statistics.TotalBytesProcessed))})," ","when run."]})}),(0,r.jsx)(r.Fragment,{children:v.value.isError&&(0,r.jsx)("div",{className:p.error,children:f})})]})]})}function X(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function G(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){X(e,t,n[t])}))}return e}function H(e){var{showTools:t,onFormatCode:n,onExpand:l,isExpanded:a}=e,s=function(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}(e,["showTools","onFormatCode","onExpand","isExpanded"]);const u=(0,i.useTheme2)(),[c,d]=(0,o.useState)(),p=(0,o.useMemo)((()=>({container:(0,h.css)({border:`1px solid ${u.colors.border.medium}`,borderTop:"none",padding:u.spacing(.5,.5,.5,.5),display:"flex",flexGrow:1,justifyContent:"space-between",fontSize:u.typography.bodySmall.fontSize}),error:(0,h.css)({color:u.colors.error.text,fontSize:u.typography.bodySmall.fontSize,fontFamily:u.typography.fontFamilyMonospace}),valid:(0,h.css)({color:u.colors.success.text}),info:(0,h.css)({color:u.colors.text.secondary}),hint:(0,h.css)({color:u.colors.text.disabled,whiteSpace:"nowrap",cursor:"help"})})),[u]);let v={};return t||void 0!==c||(v={height:0,padding:0,visibility:"hidden"}),(0,r.jsxs)("div",{className:p.container,style:v,children:[(0,r.jsx)("div",{children:s.onValidate&&(0,r.jsx)(z,(y=G({},s),f={onValidate:e=>{d(e),s.onValidate(e)}},f=null!=f?f:{},Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(f)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(f)).forEach((function(e){Object.defineProperty(y,e,Object.getOwnPropertyDescriptor(f,e))})),y))}),t&&(0,r.jsx)("div",{children:(0,r.jsxs)(i.HorizontalGroup,{spacing:"sm",children:[n&&(0,r.jsx)(i.IconButton,{onClick:()=>{var e;(0,b.reportInteraction)("grafana_sql_query_formatted",{datasource:null===(e=s.query.datasource)||void 0===e?void 0:e.type}),n()},name:"brackets-curly",size:"xs",tooltip:"Format query"}),l&&(0,r.jsx)(i.IconButton,{onClick:()=>{var e;(0,b.reportInteraction)("grafana_sql_editor_expand",{datasource:null===(e=s.query.datasource)||void 0===e?void 0:e.type,expanded:!a}),l(!a)},name:a?"angle-up":"angle-down",size:"xs",tooltip:a?"Collapse editor":"Expand editor"}),(0,r.jsx)(i.Tooltip,{content:"Hit CTRL/CMD+Return to run query",children:(0,r.jsx)(i.Icon,{className:p.hint,name:"keyboard"})})]})})]});var y,f}function W({db:e,query:t,onChange:n,onRunQuery:l,onValidate:a,queryToValidate:s,range:u}){const c=(0,i.useTheme2)(),d=(0,i.useStyles2)(J),[p,v]=(0,o.useState)(!1),[y,f]=(0,Q.A)(),[m,g]=(0,Q.A)(),h=(0,o.useMemo)((()=>e.getEditorLanguageDefinition()),[e]),j=(o,l)=>(0,r.jsx)(M,{editorLanguageDefinition:h,query:t,width:o,height:l?l-f.height:void 0,onChange:n,children:({formatQuery:t})=>(0,r.jsx)("div",{ref:y,children:(0,r.jsx)(H,{db:e,query:s,onValidate:a,onFormatCode:t,showTools:!0,range:u,onExpand:v,isExpanded:p})})}),O=(e=!1)=>e?(0,r.jsx)($.Ay,{children:({width:e,height:t})=>j(e,t)}):(0,r.jsx)("div",{ref:m,children:j()});return(0,r.jsxs)(r.Fragment,{children:[p?(0,r.jsx)("div",{style:{width:g.width,height:g.height,background:c.colors.background.primary,display:"flex",alignItems:"center",justifyContent:"center"},children:"Editing in expanded code editor"}):O(),p&&(0,r.jsx)(i.Modal,{title:`Query ${t.refId}`,closeOnBackdropClick:!1,closeOnEscape:!1,className:d.modal,contentClassName:d.modalContent,isOpen:p,onDismiss:()=>{var e;(0,b.reportInteraction)("grafana_sql_editor_expand",{datasource:null===(e=t.datasource)||void 0===e?void 0:e.type,expanded:!1}),v(!1)},children:O(!0)})]})}function J(e){return{modal:(0,h.css)({width:"95vw",height:"95vh"}),modalContent:(0,h.css)({height:"100%",paddingTop:0})}}var U=n(3769),K=n(3031);function Y({rawSql:e,datasourceType:t}){const[n,o]=(0,c.A)(),l=(0,i.useStyles2)(Z),a=(0,r.jsxs)("div",{className:l.labelWrapper,children:[(0,r.jsx)("span",{className:l.label,children:"Preview"}),(0,r.jsx)(i.IconButton,{tooltip:"Copy to clipboard",onClick:()=>(e=>{o(e),(0,b.reportInteraction)("grafana_sql_preview_copied",{datasource:t})})(e),name:"copy"})]});return(0,r.jsx)(i.Field,{label:a,className:l.grow,children:(0,r.jsx)(i.CodeEditor,{language:"sql",height:80,value:(0,K.s)(e),monacoOptions:{scrollbar:{vertical:"hidden"},scrollBeyondLastLine:!1},readOnly:!0,showMiniMap:!1})})}function Z(e){return{grow:(0,h.css)({flexGrow:1}),label:(0,h.css)({fontSize:12,fontWeight:e.typography.fontWeightMedium}),labelWrapper:(0,h.css)({display:"flex",justifyContent:"space-between",paddingBottom:e.spacing(.5)})}}function ee(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function te({query:e,onQueryChange:t,db:n}){const r=(0,o.useCallback)((r=>{const o=(0,n.toRawSql)({sql:r,dataset:e.dataset,table:e.table,refId:e.refId}),l=(a=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){ee(e,t,n[t])}))}return e}({},e),i=null!=(i={sql:r,rawSql:o})?i:{},Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(i)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(i)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(i,e))})),a);var a,i;t(l)}),[n,t,e]);return{onSqlChange:r}}var ne=n(7088),re=n(258),oe=n(2827);function le(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ae({sql:e,columns:t,onSqlChange:n}){const l=(0,o.useCallback)((t=>{const r=t.map((e=>{var t;return(0,u.xG)(null===(t=e.property)||void 0===t?void 0:t.name)})),o=(l=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){le(e,t,n[t])}))}return e}({},e),a=null!=(a={groupBy:r})?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(a)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(a)).forEach((function(e){Object.defineProperty(l,e,Object.getOwnPropertyDescriptor(a,e))})),l);var l,a;n(o)}),[n,e]);return(0,r.jsx)(ne.o,{items:e.groupBy,onChange:l,renderItem:ie({options:t})})}function ie({options:e}){return function(t,n,o){var l;return(0,r.jsxs)(re.M,{children:[(0,r.jsx)(i.Select,{value:(null===(l=t.property)||void 0===l?void 0:l.name)?(0,q.toOption)(t.property.name):null,"aria-label":"Group by",options:e,menuShouldPortal:!0,onChange:({value:e})=>e&&n((0,u.xG)(e))}),(0,r.jsx)(oe.Z,{title:"Remove group by column",icon:"times",variant:"secondary",onClick:o})]})}}function se({fields:e,query:t,onQueryChange:n,db:o}){const{onSqlChange:l}=te({query:t,onQueryChange:n,db:o});return(0,r.jsx)(ae,{columns:e,sql:t.sql,onSqlChange:l})}var ue=n(3241);function ce(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function de(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){ce(e,t,n[t])}))}return e}function pe(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const ve=[{description:"Sort by ascending",value:"ASC",icon:"sort-amount-up"},{description:"Sort by descending",value:"DESC",icon:"sort-amount-down"}];function ye({sql:e,onSqlChange:t,columns:n,showOffset:l}){var a,s;const c=(0,o.useCallback)((n=>{const r=pe(de({},e),{orderByDirection:n});t(r)}),[t,e]),d=(0,o.useCallback)((n=>{const r=pe(de({},e),{limit:Number.parseInt(n.currentTarget.value,10)});t(r)}),[t,e]),p=(0,o.useCallback)((n=>{const r=pe(de({},e),{offset:Number.parseInt(n.currentTarget.value,10)});t(r)}),[t,e]),v=(0,o.useCallback)((n=>{const r=pe(de({},e),{orderBy:(0,u.Kj)(null==n?void 0:n.value)});null===n&&(r.orderByDirection=void 0),t(r)}),[t,e]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(m.c,{label:"Order by",width:25,children:(0,r.jsxs)(re.M,{children:[(0,r.jsx)(i.Select,{"aria-label":"Order by",options:n,value:(null===(a=e.orderBy)||void 0===a?void 0:a.property.name)?(0,q.toOption)(e.orderBy.property.name):null,isClearable:!0,menuShouldPortal:!0,onChange:v}),(0,r.jsx)(i.Space,{h:1.5}),(0,r.jsx)(i.RadioButtonGroup,{options:ve,disabled:!(null==e||null===(s=e.orderBy)||void 0===s?void 0:s.property.name),value:e.orderByDirection,onChange:c})]})}),(0,r.jsx)(m.c,{label:"Limit",optional:!0,width:25,children:(0,r.jsx)(i.Input,{type:"number",min:0,id:(0,ue.uniqueId)("limit-"),value:e.limit||"",onChange:d})}),l&&(0,r.jsx)(m.c,{label:"Offset",optional:!0,width:25,children:(0,r.jsx)(i.Input,{type:"number",id:(0,ue.uniqueId)("offset-"),value:e.offset||"",onChange:p})})]})}function fe({fields:e,query:t,onQueryChange:n,db:o}){const{onSqlChange:l}=te({query:t,onQueryChange:n,db:o});let a=[];var i,s;e&&(a=[{value:"",label:"Selected columns",options:null===(s=t.sql)||void 0===s||null===(i=s.columns)||void 0===i?void 0:i.map(((e,t)=>{var n,r;const o=e.name?`${e.name}(${null===(n=e.parameters)||void 0===n?void 0:n.map((e=>e.name))})`:null===(r=e.parameters)||void 0===r?void 0:r.map((e=>e.name));return{value:o,label:`${t+1} - ${o}`}})),expanded:!0},...e]);return(0,r.jsx)(ye,{sql:t.sql,onSqlChange:l,columns:a})}var me=n(1777),be=n(2932);function ge(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function he(){return he=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},he.apply(this,arguments)}function je(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){ge(e,t,n[t])}))}return e}function Oe(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const we={id:be.Aq.uuid(),type:"group"},xe="timeFilter",Se=[xe],Pe=Oe(je({},be.d$.widgets),{text:Oe(je({},be.d$.widgets.text),{factory:function(e){return(0,r.jsx)(i.Input,{value:(null==e?void 0:e.value)||"",placeholder:null==e?void 0:e.placeholder,onChange:t=>null==e?void 0:e.setValue(t.currentTarget.value)})}}),number:Oe(je({},be.d$.widgets.number),{factory:function(e){return(0,r.jsx)(i.Input,{value:null==e?void 0:e.value,placeholder:null==e?void 0:e.placeholder,type:"number",onChange:t=>null==e?void 0:e.setValue(Number.parseInt(t.currentTarget.value,10))})}}),datetime:Oe(je({},be.d$.widgets.datetime),{factory:function(e){if("macros"===(null==e?void 0:e.operator))return(0,r.jsx)(i.Select,{id:e.id,"aria-label":"Macros value selector",menuShouldPortal:!0,options:Se.map(q.toOption),value:null==e?void 0:e.value,onChange:t=>e.setValue(t.value)});const t=(0,q.dateTime)(null==e?void 0:e.value).isValid()?(0,q.dateTime)(null==e?void 0:e.value).utc():void 0;return(0,r.jsx)(i.DateTimePicker,{onChange:t=>{null==e||e.setValue(null==t?void 0:t.format(be.d$.widgets.datetime.valueFormat))},date:t})},sqlFormatValue:(e,t,n,r,o,l)=>{if("macros"===r)return Se.includes(e)?e:void 0;if("string"==typeof be.d$.widgets.datetime.sqlFormatValue||"object"==typeof be.d$.widgets.datetime.sqlFormatValue)return;const a=be.d$.widgets.datetime.sqlFormatValue;return(null==a?void 0:a.call(be.d$.ctx,e,t,n,r,o,l))||""}})}),qe=Oe(je({},be.d$.settings),{canRegroup:!1,maxNesting:1,canReorder:!1,showNot:!1,addRuleLabel:"Add",deleteLabel:"Remove",renderConjs:function(e){return(0,r.jsx)(i.Select,{id:null==e?void 0:e.id,"aria-label":"Conjunction","data-testid":d.Tp.components.SQLQueryEditor.filterConjunction,menuShouldPortal:!0,options:(null==e?void 0:e.conjunctionOptions)?Object.keys(null==e?void 0:e.conjunctionOptions).map(q.toOption):void 0,value:null==e?void 0:e.selectedConjunction,onChange:t=>null==e?void 0:e.setConjunction(t.value)})},renderField:function(e){var t;const n=(null==e||null===(t=e.config)||void 0===t?void 0:t.fields)||{};return(0,r.jsx)(i.Select,{id:null==e?void 0:e.id,width:25,"aria-label":"Field","data-testid":d.Tp.components.SQLQueryEditor.filterField,menuShouldPortal:!0,options:null==e?void 0:e.items.map((e=>{var t,r;const o=null===(r=n[e.key].mainWidgetProps)||void 0===r||null===(t=r.customProps)||void 0===t?void 0:t.icon;return{label:e.label,value:e.key,icon:o}})),value:null==e?void 0:e.selectedKey,onChange:t=>{null==e||e.setField(t.label)}})},renderButton:function(e){return(0,r.jsx)(i.Button,{type:"button",title:`${null==e?void 0:e.label} filter`,onClick:null==e?void 0:e.onClick,variant:"secondary",size:"md",icon:"Add"===(null==e?void 0:e.label)?"plus":"times"})},renderOperator:function(e){return(0,r.jsx)(i.Select,{options:null==e?void 0:e.items.map((e=>({label:e.label,value:e.key}))),"aria-label":"Operator","data-testid":d.Tp.components.SQLQueryEditor.filterOperator,menuShouldPortal:!0,value:null==e?void 0:e.selectedKey,onChange:t=>{null==e||e.setField(t.value||"")}})}}),Ce=function(e){const t=he({},function(e){if(null==e)throw new TypeError("Cannot destructure "+e);return e}(e.operators));return Oe(je({},t),{select_any_in:Oe(je({},t.select_any_in),{sqlFormatOp:(e,n,r,o,l,a,i,s)=>(()=>{const e=t.select_any_in.sqlFormatOp;return Fe(e)?e:_e})()(e,n,Qe(r),o,l,a,i,s)}),select_not_any_in:Oe(je({},t.select_not_any_in),{sqlFormatOp:(e,n,r,o,l,a,i,s)=>(()=>{const e=t.select_not_any_in.sqlFormatOp;return Fe(e)?e:_e})()(e,n,Qe(r),o,l,a,i,s)}),macros:{label:"Macros",sqlFormatOp:(e,t,n)=>n===xe?`$__timeFilter(${e})`:n}})}(be.d$),ke=be.d$.types.text.widgets.text,De=[...ke.operators||[],"select_any_in","select_not_any_in"],Ie=Oe(je({},ke),{operators:De}),Te=Oe(je({},be.d$.types),{text:Oe(je({},be.d$.types.text),{widgets:Oe(je({},be.d$.types.text.widgets),{text:Ie})}),datetime:Oe(je({},be.d$.types.datetime),{widgets:Oe(je({},be.d$.types.datetime.widgets),{datetime:Oe(je({},be.d$.types.datetime.widgets.datetime),{operators:["macros",...be.d$.types.datetime.widgets.datetime.operators||[]]})})})}),Ee=Oe(je({},be.d$),{widgets:Pe,settings:qe,operators:Ce,types:Te}),_e=()=>"",Fe=e=>"function"==typeof e;function Qe(e){return(0,ue.isString)(e)?e.split(","):e}function $e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Be(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){$e(e,t,n[t])}))}return e}function Le(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function Me({sql:e,config:t,onSqlChange:n}){const[l,a]=(0,o.useState)(),i=(0,o.useMemo)((()=>Be({},Ee,t)),[t]);(0,o.useEffect)((()=>{if(!l){var t;const n=be.Aq.checkTree(be.Aq.loadTree(null!==(t=e.whereJsonTree)&&void 0!==t?t:we),i);a(n)}}),[i,e.whereJsonTree,l]),(0,o.useEffect)((()=>{e.whereJsonTree||a(be.Aq.checkTree(be.Aq.loadTree(we),i))}),[i,e.whereJsonTree]);const s=(0,o.useCallback)(((t,r)=>{a(t);const o=Le(Be({},e),{whereJsonTree:be.Aq.getTree(t),whereString:be.Aq.sqlFormat(t,r)});n(o)}),[n,e]);return l?(0,r.jsx)(be.XK,Le(Be({},i),{value:l,onChange:s,renderBuilder:e=>(0,r.jsx)(be.M$,Be({},e))})):null}function Ae(e){return`\n    display: flex;\n    gap: 8px;\n    flex-direction: ${e};`}function Re(e,t,n,r,o,l,a){try{var i=e[l](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,o)}function Ve(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var l=e.apply(t,n);function a(e){Re(l,r,o,a,i,"next",e)}function i(e){Re(l,r,o,a,i,"throw",e)}a(void 0)}))}}function Ne({query:e,fields:t,onQueryChange:n,db:o}){const l=(0,me.A)(Ve((function*(){return function(e){const t={};for(const n of e)t[n.value]={type:n.raqbFieldType||"text",valueSources:["value"],mainWidgetProps:{customProps:{icon:n.icon}}};return t}(t)})),[t]),{onSqlChange:a}=te({query:e,onQueryChange:n,db:o});return(0,r.jsx)(Me,{config:{fields:l.value||{}},sql:e.sql,onSqlChange:e=>{!function(e,t){var n,r;t.some((t=>(t=>{var n,r;return"multi"in t&&t.multi&&((null===(n=e.whereString)||void 0===n?void 0:n.includes(`\${${t.name}}`))||(null===(r=e.whereString)||void 0===r?void 0:r.includes(`$${t.name}`)))})(t)))&&(e.whereString=null===(n=e.whereString)||void 0===n?void 0:n.replaceAll("')",")"),e.whereString=null===(r=e.whereString)||void 0===r?void 0:r.replaceAll("('","("))}(e,(0,b.getTemplateSrv)().getVariables()),a(e)}},JSON.stringify(l.value))}h.injectGlobal`
  .group--header {
    ${Ae("row")}
  }

  .group-or-rule {
    ${Ae("column")}
    .rule {
      flex-direction: row;
    }
  }

  .rule--body {
    ${Ae("row")}
  }

  .group--children {
    ${Ae("column")}
  }

  .group--conjunctions:empty {
    display: none;
  }
`;var ze=n(6703);function Xe({columns:e,onParameterChange:t,value:n}){const l=(0,o.useId)();return(0,r.jsx)(m.c,{label:"Column",width:25,children:(0,r.jsx)(i.Select,{value:n,"data-testid":d.Tp.components.SQLQueryEditor.selectColumn,inputId:l,menuShouldPortal:!0,options:[{label:"*",value:"*"},...e],allowCustomValue:!0,onChange:e=>t(e.value)})})}function Ge(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function He(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Ge(e,t,n[t])}))}return e}function We(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function Je({columns:e,query:t,onSqlChange:n,onParameterChange:l,currentColumnIndex:a}){var s,c,p;const v=(0,i.useStyles2)(Ue),y=null===(c=t.sql)||void 0===c||null===(s=c.columns)||void 0===s?void 0:s[a],f=(0,o.useCallback)((e=>{var r,o,l,a;const i=null===(o=t.sql)||void 0===o||null===(r=o.columns)||void 0===r?void 0:r[e];if(!i)return;i.parameters=i.parameters?[...i.parameters,{type:ze._.FunctionParameter,name:""}]:[];const s=We(He({},t.sql),{columns:null===(a=t.sql)||void 0===a||null===(l=a.columns)||void 0===l?void 0:l.map(((t,n)=>n===e?i:t))});n(s)}),[n,t.sql]),m=(0,o.useCallback)(((e,r)=>{var o,l,a,i,s;const u=null===(l=t.sql)||void 0===l||null===(o=l.columns)||void 0===o?void 0:o[e];if(!(null==u?void 0:u.parameters))return;u.parameters=null===(a=u.parameters)||void 0===a?void 0:a.filter(((e,t)=>t!==r));const c=We(He({},t.sql),{columns:null===(s=t.sql)||void 0===s||null===(i=s.columns)||void 0===i?void 0:i.map(((t,n)=>n===e?u:t))});n(c)}),[n,t.sql]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.InlineLabel,{className:v.label,children:"("}),(0,r.jsx)(Xe,{columns:e,onParameterChange:e=>l(0)(e),value:(0,u.oG)(null==y||null===(p=y.parameters)||void 0===p?void 0:p[0])}),(b=a,!(null==y?void 0:y.parameters)||y.parameters.length<=1?null:y.parameters.map(((e,t)=>0===t?null:(0,r.jsxs)(i.Stack,{gap:2,children:[(0,r.jsx)(i.InlineLabel,{className:v.label,children:","}),(0,r.jsx)(i.Input,{onChange:e=>l(t)(e.currentTarget.value),value:e.name,"aria-label":`Parameter ${t} for column ${b}`,"data-testid":d.Tp.components.SQLQueryEditor.selectInputParameter,addonAfter:(0,r.jsx)(i.Button,{title:"Remove parameter",type:"button",icon:"times",variant:"secondary",size:"md",onClick:()=>m(b,t)})})]},t)))),(0,r.jsx)(i.Button,{type:"button",onClick:()=>f(a),variant:"secondary",size:"md",icon:"plus",title:"Add parameter"}),(0,r.jsx)(i.InlineLabel,{className:v.label,children:")"})]});var b}const Ue=()=>({label:(0,h.css)({padding:0,margin:0,width:"unset"})});function Ke(e,t,n,r,o,l,a){try{var i=e[l](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,o)}function Ye(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ze(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Ye(e,t,n[t])}))}return e}function et(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function tt({query:e,onSqlChange:t,currentColumnIndex:n,db:l,columns:a}){var s,c;const p=(0,o.useId)(),v=null===(c=e.sql)||void 0===c||null===(s=c.columns)||void 0===s?void 0:s[n],y=(0,i.useStyles2)(nt),f=l.functions().find((e=>e.name===(null==v?void 0:v.name))),[b,g]=(0,o.useState)([]);(0,o.useEffect)((()=>{const t=function(){var t,n=(t=function*(){if(!f)return;const t=[];var n;for(const r of null!==(n=f.parameters)&&void 0!==n?n:[])r.options?t.push(yield r.options(e)):t.push([]);g(t)},function(){var e=this,n=arguments;return new Promise((function(r,o){var l=t.apply(e,n);function a(e){Ke(l,r,o,a,i,"next",e)}function i(e){Ke(l,r,o,a,i,"throw",e)}a(void 0)}))});return function(){return n.apply(this,arguments)}}();t()}),[null==v?void 0:v.name]);const h=(0,o.useCallback)(((r,o)=>l=>{var a,i,s,u;const c=null===(i=e.sql)||void 0===i||null===(a=i.columns)||void 0===a?void 0:a[n];if(!c)return;if(c.parameters||(c.parameters=[]),void 0===c.parameters[r])c.parameters[r]={type:ze._.FunctionParameter,name:l};else if(null==l&&o){var d;c.parameters=c.parameters.map(((e,t)=>t===r?et(Ze({},e),{name:""}):e)),""===(null===(d=c.parameters[c.parameters.length-1])||void 0===d?void 0:d.name)&&(c.parameters=c.parameters.filter((e=>""!==e.name)))}else c.parameters=null==l?c.parameters.filter(((e,t)=>t!==r)):c.parameters.map(((e,t)=>t===r?et(Ze({},e),{name:l}):e));const p=et(Ze({},e.sql),{columns:null===(u=e.sql)||void 0===u||null===(s=u.columns)||void 0===s?void 0:s.map(((e,t)=>t===n?c:e))});t(p)}),[n,t,e.sql]);var j;return void 0===(null==v?void 0:v.name)?(0,r.jsx)(Xe,{columns:a,onParameterChange:e=>h(0)(e),value:(0,u.oG)(null==v||null===(j=v.parameters)||void 0===j?void 0:j[0])}):f?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.InlineLabel,{className:y.label,children:"("}),(null==f?void 0:f.parameters)?null==f?void 0:f.parameters.map(((e,t)=>{var n;return(0,r.jsxs)(i.Stack,{alignItems:"flex-end",gap:2,children:[(0,r.jsx)(m.c,{label:e.name,width:25,optional:!e.required,children:(0,r.jsx)(r.Fragment,{children:e.options?(0,r.jsx)(i.Select,{value:(0,u.oG)(null==v?void 0:v.parameters[t]),options:null==b?void 0:b[t],"data-testid":d.Tp.components.SQLQueryEditor.selectFunctionParameter(e.name),inputId:p,menuShouldPortal:!0,allowCustomValue:!0,isClearable:!0,onChange:e=>h(t,!0)(null==e?void 0:e.value)}):(0,r.jsx)(i.Input,{onChange:e=>h(t,!0)(e.currentTarget.value),value:null==v||null===(n=v.parameters[t])||void 0===n?void 0:n.name,"data-testid":d.Tp.components.SQLQueryEditor.selectInputParameter})})}),f.parameters.length!==t+1&&(0,r.jsx)(i.InlineLabel,{className:y.label,children:","})]},t)})):null,(0,r.jsx)(i.InlineLabel,{className:y.label,children:")"})]}):(0,r.jsx)(Je,{query:e,onSqlChange:t,currentColumnIndex:n,columns:a,onParameterChange:h})}const nt=()=>({label:(0,h.css)({padding:0,margin:0,width:"unset"})});function rt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ot(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){rt(e,t,n[t])}))}return e}function lt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function at({query:e,onQueryChange:t,db:n,columns:l}){var a,s;const c=(0,i.useStyles2)(it),{onSqlChange:p}=te({query:e,onQueryChange:t,db:n}),v=[];e.format===g.gv.Timeseries&&(v.push({label:"time",value:"time"}),v.push({label:"value",value:"value"}));const y=(0,o.useCallback)(((t,n)=>r=>{var o,l,a,i;const s=lt(ot({},t),{name:null==r?void 0:r.value,parameters:[{type:ze._.FunctionParameter,name:(null===(l=t.parameters)||void 0===l||null===(o=l[0])||void 0===o?void 0:o.name)||""}]}),u=lt(ot({},e.sql),{columns:null===(i=e.sql)||void 0===i||null===(a=i.columns)||void 0===a?void 0:a.map(((e,t)=>t===n?s:e))});p(u)}),[p,e.sql]),f=(0,o.useCallback)(((t,n)=>r=>{var o,l;let a=ot({},t);var i;null!==r?a=lt(ot({},t),{alias:`"${null==r||null===(i=r.value)||void 0===i?void 0:i.trim()}"`}):delete a.alias;const s=lt(ot({},e.sql),{columns:null===(l=e.sql)||void 0===l||null===(o=l.columns)||void 0===o?void 0:o.map(((e,t)=>t===n?a:e))});p(s)}),[p,e.sql]),b=(0,o.useCallback)((t=>()=>{var n;const r=[...(null===(n=e.sql)||void 0===n?void 0:n.columns)||[]];r.splice(t,1);const o=lt(ot({},e.sql),{columns:r});p(o)}),[p,e.sql]),h=(0,o.useCallback)((()=>{var t;const n=lt(ot({},e.sql),{columns:[...(null===(t=e.sql)||void 0===t?void 0:t.columns)||[],(0,u.JD)()]});p(n)}),[p,e.sql]),j=()=>{const e=[{label:"Aggregations",options:[]},{label:"Macros",options:[]}];for(const t of n.functions())t.name.startsWith("$__")?e[1].options.push({label:t.name,value:t.name}):e[0].options.push({label:t.name,value:t.name});return e};return(0,r.jsxs)(i.Stack,{gap:2,wrap:"wrap",direction:"column",children:[null===(s=e.sql)||void 0===s||null===(a=s.columns)||void 0===a?void 0:a.map(((t,o)=>(0,r.jsx)("div",{children:(0,r.jsxs)(i.Stack,{gap:2,alignItems:"end",children:[(0,r.jsx)(m.c,{label:"Data operations",optional:!0,width:25,children:(0,r.jsx)(i.Select,{value:t.name?(0,q.toOption)(t.name):null,inputId:`select-aggregation-${o}-${(0,ue.uniqueId)()}`,"data-testid":d.Tp.components.SQLQueryEditor.selectAggregation,isClearable:!0,menuShouldPortal:!0,allowCustomValue:!0,options:j(),onChange:y(t,o)})}),(0,r.jsx)(tt,{currentColumnIndex:o,columns:l,onSqlChange:p,query:e,db:n}),(0,r.jsx)(m.c,{label:"Alias",optional:!0,width:15,children:(0,r.jsx)(i.Select,{value:t.alias?(0,q.toOption)(t.alias):null,inputId:`select-alias-${o}-${(0,ue.uniqueId)()}`,"data-testid":d.Tp.components.SQLQueryEditor.selectAlias,options:v,onChange:f(t,o),isClearable:!0,menuShouldPortal:!0,allowCustomValue:!0})}),(0,r.jsx)(i.Button,{title:"Remove column",type:"button",icon:"trash-alt",variant:"secondary",size:"md",onClick:b(o)})]})},o))),(0,r.jsx)(i.Button,{type:"button",onClick:h,variant:"secondary",title:"Add column",size:"md",icon:"plus",className:c.addButton})]})}const it=()=>({addButton:(0,h.css)({alignSelf:"flex-start"}),label:(0,h.css)({padding:0,margin:0,width:"unset"})});function st(e,t,n,r,o,l,a){try{var i=e[l](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,o)}function ut(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var l=e.apply(t,n);function a(e){st(l,r,o,a,i,"next",e)}function i(e){st(l,r,o,a,i,"throw",e)}a(void 0)}))}}const ct=({query:e,db:t,queryRowFilter:n,onChange:o,onValidate:a,range:i})=>{var s;const u=(0,l.A)(ut((function*(){return yield t.fields(e)})),[t,e.dataset,e.table]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(U.D,{children:[(0,r.jsx)(f.U,{children:(0,r.jsx)(at,{columns:u.value||[],query:e,onQueryChange:o,db:t})}),n.filter&&(0,r.jsx)(f.U,{children:(0,r.jsx)(m.c,{label:"Filter by column value",optional:!0,children:(0,r.jsx)(Ne,{fields:u.value||[],query:e,onQueryChange:o,db:t})})}),n.group&&(0,r.jsx)(f.U,{children:(0,r.jsx)(m.c,{label:"Group by column",children:(0,r.jsx)(se,{fields:u.value||[],query:e,onQueryChange:o,db:t})})}),n.order&&(0,r.jsx)(f.U,{children:(0,r.jsx)(fe,{fields:u.value||[],query:e,onQueryChange:o,db:t})}),n.preview&&e.rawSql&&(0,r.jsx)(f.U,{children:(0,r.jsx)(Y,{rawSql:e.rawSql,datasourceType:null===(s=e.datasource)||void 0===s?void 0:s.type})})]}),(0,r.jsx)(H,{db:t,query:e,onValidate:a,range:i})]})};function dt(e,t,n,r,o,l,a){try{var i=e[l](a),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,o)}function pt(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var l=e.apply(t,n);function a(e){dt(l,r,o,a,i,"next",e)}function i(e){dt(l,r,o,a,i,"throw",e)}a(void 0)}))}}function vt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function yt({datasource:e,query:t,onChange:n,onRunQuery:c,range:d,queryHeaderProps:p}){var v,y,f,m,b,g;const[h,j]=(0,o.useState)(!0),O=e.getDB(),{preconfiguredDatabase:w}=e;var x;const S=null!==(x=null==p?void 0:p.dialect)&&void 0!==x?x:"other",{loading:P,error:q}=(0,l.A)(pt((function*(){return()=>{void 0!==e.getDB(e.id).init&&e.getDB(e.id).init()}})),[e]),C=(0,s.T)(t),[k,D]=(0,o.useState)({filter:!!(null===(v=C.sql)||void 0===v?void 0:v.whereString),group:!!(null===(m=C.sql)||void 0===m||null===(f=m.groupBy)||void 0===f||null===(y=f[0])||void 0===y?void 0:y.property.name),order:!!(null===(g=C.sql)||void 0===g||null===(b=g.orderBy)||void 0===b?void 0:b.property.name),preview:!0}),[I,T]=(0,o.useState)(C);(0,o.useEffect)((()=>()=>{void 0!==e.getDB(e.id).dispose&&e.getDB(e.id).dispose()}),[e]);const E=(0,o.useCallback)((e=>{ft(e)&&c&&c()}),[c]),_=(e,t=!0)=>{var r,o,l,a;T(e),n(e),(0,u.YW)(null===(r=e.sql)||void 0===r?void 0:r.columns)&&(null===(o=e.sql)||void 0===o?void 0:o.columns.some((e=>e.name)))&&!k.group&&D((l=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){vt(e,t,n[t])}))}return e}({},k),a=null!=(a={group:!0})?a:{},Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(a)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(a)).forEach((function(e){Object.defineProperty(l,e,Object.getOwnPropertyDescriptor(a,e))})),l)),t&&E(e)};return P||q?null:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(F,{db:O,preconfiguredDataset:w,onChange:e=>{T(e),n(e)},onRunQuery:c,onQueryRowChange:D,queryRowFilter:k,query:C,isQueryRunnable:h,dialect:S}),(0,r.jsx)(i.Space,{v:.5}),C.editorMode!==a.lX.Code&&(0,r.jsx)(ct,{db:O,query:C,onChange:e=>_(e,!1),queryRowFilter:k,onValidate:j,range:d}),C.editorMode===a.lX.Code&&(0,r.jsx)(W,{db:O,query:C,queryToValidate:I,onChange:_,onRunQuery:c,onValidate:j,range:d})]})}const ft=e=>Boolean(e.rawSql)}}]);
//# sourceMappingURL=sql-query-editor.js.map