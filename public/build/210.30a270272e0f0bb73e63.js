"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[210],{210:(bn,fe,o)=>{o.r(fe),o.d(fe,{default:()=>Wo});var t=o(74848),X=o(54148),te=o(16817),w=o(32370),g=o(96540),Ae=o(84596),ne=o(80426),ve=o(61034),se=o(90231),U=o(54122),ce=o(20337),W=o(37e3),Re=o(22961),v=o(11817),xe=o(44608);function he({error:e,type:n}){const s=(0,xe.do)(e),a=(0,xe.q6)(e),i=n==="snapshot"?"Snapshot":"Dashboard";return(0,t.jsx)(U.Y,{navId:"dashboards/browse",layout:ne.k.Canvas,pageNav:{text:"Not found"},children:(0,t.jsx)(se.a,{paddingY:4,display:"flex",direction:"column",alignItems:"center",children:s===404?(0,t.jsx)(Re.L,{entity:i}):(0,t.jsx)(W.F,{title:(0,v.t)("dashboard.errors.failed-to-load","Failed to load dashboard"),severity:"error","data-testid":"dashboard-page-error",children:a})})})}var E=o(61491),u=o(22803),y=o(53027),k=o(43908),P=o(29675),Z=o(25356),b=o(54594),ut=o(32027),K=o(61351),yn=o(28565),pt=o(2044);const gt=(0,g.memo)(({dashboard:e})=>{const n=(0,g.useMemo)(()=>y.Ny.getLocation().pathname,[e]),{showModal:s,hideModal:a}=(0,g.useContext)(k.wE);(0,g.useEffect)(()=>{const r=l=>{mt(e)||e.state.isDirty&&(l.preventDefault(),l.returnValue="")};return window.addEventListener("beforeunload",r),()=>window.removeEventListener("beforeunload",r)},[e]);const i=r=>{const l=e.state.editPanel,d=l?.getPanel(),c=new URLSearchParams(r.search);if(l&&d&&(0,pt.ME)(d)&&l.state.isDirty&&!c.has("editPanel")){const h=(0,pt.iL)(d);return s(yn.Z,{dashboard:e,isUnsavedPrompt:!0,libraryPanel:h,onConfirm:()=>{l.onConfirmSaveLibraryPanel(),a(),be(r)},onDiscard:()=>{l.onDiscard(),a(),be(r)},onDismiss:a}),!1}return n===r.pathname||mt(e)||!e.state.isDirty?!0:(s(jn,{dashboard:e,onSaveDashboardClick:()=>{a(),e.openSaveDrawer({onSaveSuccess:()=>{be(r)}})},onDiscard:()=>{e.exitEditMode({skipConfirm:!0}),a(),be(r)},onDismiss:a}),!1)};return(0,t.jsx)(ut.X,{when:!0,message:i})});gt.displayName="DashboardPrompt";function be(e){e&&setTimeout(()=>y.Ny.push(e),10)}const jn=({onDiscard:e,onDismiss:n,onSaveDashboardClick:s})=>{const a=(0,P.of)(Sn);return(0,t.jsxs)(Z.a,{isOpen:!0,title:"Unsaved changes",onDismiss:n,icon:"exclamation-triangle",className:a.modal,children:[(0,t.jsx)("h5",{children:"Do you want to save your changes?"}),(0,t.jsxs)(Z.a.ButtonRow,{children:[(0,t.jsx)(b.$n,{variant:"secondary",onClick:n,fill:"outline",children:"Cancel"}),(0,t.jsx)(b.$n,{variant:"destructive",onClick:e,children:"Discard"}),(0,t.jsx)(b.$n,{onClick:s,children:"Save dashboard"})]})]})},Sn=()=>({modal:(0,u.css)({width:"500px"})});function mt(e){if(!e?.getInitialSaveModel()||e?.state.meta.version===0||!K.TP.isSignedIn||!e)return!0;const{canSave:s,fromScript:a,fromFile:i}=e.state.meta;return!K.TP.isEditor&&!s?!0:!s||a||i}var Ue=o(44172);function Cn({route:e,queryParams:n,location:s}){const a=(0,X.g)(),{type:i,slug:r,uid:l}=a,d=(0,Ae.A)({params:a}),c=w.$.featureToggles.useV2DashboardsAPI?(0,Ue.sP)("v2"):(0,Ue.sP)(),{dashboard:h,isLoading:p,loadError:m}=c.useState(),f=s.state?.routeReloadCounter;if((0,g.useEffect)(()=>(e.routeName===E.DashboardRoutes.Normal&&i==="snapshot"?c.loadSnapshot(r):c.loadDashboard({type:i,slug:r,uid:l??"",route:e.routeName,urlFolderUid:n.folderUid}),()=>{c.clearState()}),[c,l,e.routeName,n.folderUid,f,r,i]),!h){let T;return m&&(T=(0,t.jsx)(he,{error:m,type:i})),T||(0,t.jsx)(U.Y,{navId:"dashboards/browse",layout:ne.k.Canvas,"data-testid":"dashboard-scene-page",children:(0,t.jsx)(se.a,{paddingY:4,display:"flex",direction:"column",alignItems:"center",children:p&&(0,t.jsx)(ce.A,{})})})}return i!=="snapshot"&&(!d||l!==d?.params.uid)?(console.log("skipping rendering"),null):(0,t.jsxs)(ve.$L,{scene:h,updateUrlOnInit:!0,createBrowserHistorySteps:!0,children:[(0,t.jsx)(h.Component,{model:h},h.state.key),(0,t.jsx)(gt,{dashboard:h})]})}const Oe=Cn;var q=o(71468),ye=o(2567),x=o(58779),ft=o(23737),Pn=o(95382),Be=o(17687);function Dn(e){switch(e.kiosk){case"1":case!0:return E.KioskMode.Full;default:return null}}var Tn=o(19606),Fe=o(12636),je=o(10474),Nn=o(67853),En=o(54414);const In=()=>{const e=new URL(window.location.toString()),n=new URLSearchParams(e.search);n.forEach((s,a)=>{if(a.startsWith("__feature.")){const i=a.substring(10);En.mz.has(i)&&n.delete(a)}}),window.location.href=new URL(e.origin+e.pathname+"?"+n.toString()).toString()},Mn=()=>{window.open("https://github.com/grafana/grafana/issues/new?assignees=&labels=&projects=&template=0-bug-report.yaml&title=Product+Area%3A+Short+description+of+bug")};function wn({dashboardUid:e}){const n=(0,P.of)(Vn),[s,a]=(0,g.useState)(!0);return s?(0,t.jsx)(W.F,{severity:"info",title:"This dashboard was migrated from Angular. Please make sure everything is behaving as expected and save and refresh this dashboard to persist the migration.",onRemove:()=>a(!1),children:(0,t.jsxs)("div",{className:"markdown-html",children:[(0,t.jsx)(b.$n,{fill:"outline",size:"sm",className:n.linkButton,onClick:Mn,children:"Report issue"}),(0,t.jsx)(b.$n,{fill:"outline",size:"sm",className:n.linkButton,onClick:In,children:"Revert migration"})]})}):null}const Vn=e=>({linkButton:(0,u.css)({marginRight:10})});var G=o(91830),$e=o(20138),I=o(2510),Ln=o(70973),An=o(50870),re=o(2543),Rn=o(22492),Un=o(40996),ze=o(34128),H=o(79784),On=o(81569),Bn=o(18949),Fn=o(72504);const vt=({panel:e,folderUid:n,isUnsavedPrompt:s,onDismiss:a,onConfirm:i,onDiscard:r})=>{const[l,d]=(0,g.useState)(""),c=(0,te.A)(async()=>{const S=await(0,On.xV)(e.libraryPanel.uid);return S.length>0?S.map(L=>L.title):[]},[e.libraryPanel.uid]),[h,p]=(0,g.useState)([]);(0,Un.A)(()=>c.value?p(c.value.filter(S=>S.toLowerCase().includes(l.toLowerCase()))):p([]),300,[c.value,l]);const{saveLibraryPanel:m}=(0,Fn.b)(),f=(0,P.of)(Bn.o),T=(0,g.useCallback)(()=>{r()},[r]),D=s?"Unsaved library panel changes":"Save library panel";return(0,t.jsx)(Z.a,{title:D,icon:"save",onDismiss:a,isOpen:!0,children:(0,t.jsxs)("div",{children:[(0,t.jsxs)("p",{className:f.textInfo,children:["This update will affect ",(0,t.jsxs)("strong",{children:[e.libraryPanel.meta?.connectedDashboards," ",e.libraryPanel.meta?.connectedDashboards===1?"dashboard":"dashboards","."]}),"The following dashboards using the panel will be affected:"]}),(0,t.jsx)(ze.p,{className:f.dashboardSearch,prefix:(0,t.jsx)(H.I,{name:"search"}),placeholder:"Search affected dashboards",value:l,onChange:S=>d(S.currentTarget.value)}),c.loading?(0,t.jsx)("p",{children:"Loading connected dashboards..."}):(0,t.jsxs)("table",{className:f.myTable,children:[(0,t.jsx)("thead",{children:(0,t.jsx)("tr",{children:(0,t.jsx)("th",{children:"Dashboard name"})})}),(0,t.jsx)("tbody",{children:h.map((S,L)=>(0,t.jsx)("tr",{children:(0,t.jsx)("td",{children:S})},`dashrow-${L}`))})]}),(0,t.jsxs)(Z.a.ButtonRow,{children:[(0,t.jsx)(b.$n,{variant:"secondary",onClick:a,fill:"outline",children:"Cancel"}),s&&(0,t.jsx)(b.$n,{variant:"destructive",onClick:T,children:"Discard"}),(0,t.jsx)(b.$n,{onClick:()=>{m(e,n).then(()=>{i()})},children:"Update all"})]})]})})};var xt=o(36503),$n=o(82856),bt=o(57398),ke=o(65305),yt=o(14297),Q=o(36608);function zn(e,n){return async s=>{const a=n.initEditPanel(e);s((0,Q.GU)({panel:a,sourcePanel:e}))}}function jt(){return async(e,n)=>{const{getPanel:s}=n().panelEditor;s().configRev=0,e((0,Q.MJ)(!0))}}function kn(e,n){return s=>{if(e.libraryPanel?.uid===void 0||!n)return;const a=e.getSaveModel();for(const i of n.panels){if(Gn(e,i))continue;i.restoreModel({...a,...(0,re.pick)(i,"gridPos","id")});const r=i.plugin?.meta.id!==e.plugin?.meta.id;i.plugin=e.plugin,i.configRev++,r&&(i.generateNewKey(),s((0,yt.XM)({key:i.key,plugin:i.plugin}))),setTimeout(()=>{i.getQueryRunner().useLastResultFrom(e.getQueryRunner())},20)}e.repeat&&setTimeout(()=>n.processRepeats(),20)}}function Gn(e,n){return!!(n.libraryPanel?.uid!==e.libraryPanel.uid||n.id&&n.id===e.id||n.repeatPanelId)}function Wn(){return async(e,n)=>{const s=n().dashboard.getModel(),{getPanel:a,getSourcePanel:i,shouldDiscardChanges:r}=n().panelEditor,l=a();s&&s.exitPanelEditor();const d=i();if(Kn(l)&&!r){const c=l.getSaveModel(),h=d.type!==l.type;e(kn(l,s)),d.restoreModel(c),d.configRev++,h&&(d.plugin=l.plugin,d.generateNewKey(),await e((0,yt.XM)({key:d.key,plugin:l.plugin}))),setTimeout(()=>{d.getQueryRunner().useLastResultFrom(l.getQueryRunner()),d.render(),l.hasSavedPanelEditChange&&!l.hasChanged&&(d.configRev=0)},20)}d.isNew&&(r?s&&(0,bt.FC)(s,d,!0):delete d.isNew),e((0,ke.O6)(l.key)),e((0,Q.Ox)())}}function Kn(e){return e.hasChanged||e.hasSavedPanelEditChange||e.isAngularPlugin()}function Ge(e){return(n,s)=>{const a={...s().panelEditor.ui,...e};n((0,Q.fR)(a));try{$n.A.setObject(Q.wi,a)}catch(i){console.error(i)}}}var We=o(43347);const Hn=({dashboard:e,onSaveSuccess:n,onDiscard:s,onDismiss:a})=>(0,t.jsxs)(Z.a,{isOpen:!0,title:"Unsaved changes",onDismiss:a,icon:"exclamation-triangle",className:(0,u.css)({width:"500px"}),children:[(0,t.jsx)("h5",{children:"Do you want to save your changes?"}),(0,t.jsxs)(Z.a.ButtonRow,{children:[(0,t.jsx)(b.$n,{variant:"secondary",onClick:a,fill:"outline",children:"Cancel"}),(0,t.jsx)(b.$n,{variant:"destructive",onClick:s,children:"Discard"}),(0,t.jsx)(We.C,{dashboard:e,onSaveSuccess:n})]})]}),St=(0,g.memo)(({dashboard:e})=>{const[n,s]=(0,g.useState)({original:null}),a=(0,E.useDispatch)(),{original:i,originalPath:r}=n,{showModal:l,hideModal:d}=(0,g.useContext)(k.wE);(0,g.useEffect)(()=>{const h=setTimeout(()=>{const m=y.Ny.getLocation().pathname,f=e.getSaveModelCloneOld();s({originalPath:m,original:f})},1e3),p=Rn.l.subscribe(G.Eu,()=>{const m=e.getSaveModelCloneOld();s({originalPath:r,original:m})});return()=>{clearTimeout(h),p.unsubscribe()}},[e,r]),(0,g.useEffect)(()=>{const h=p=>{Ct(e,i)||Dt(e,i)&&(p.preventDefault(),p.returnValue="")};return window.addEventListener("beforeunload",h),()=>window.removeEventListener("beforeunload",h)},[e,i]);const c=h=>{const p=e.panelInEdit,m=new URLSearchParams(h.search);return p&&p.libraryPanel&&p.hasChanged&&!m.has("editPanel")?(l(vt,{isUnsavedPrompt:!0,panel:e.panelInEdit,folderUid:e.meta.folderUid??"",onConfirm:()=>{d(),Se(h)},onDiscard:()=>{a(jt()),Se(h),d()},onDismiss:d}),!1):r===h.pathname||!i?(p&&!m.has("editPanel")&&a(Wn()),!0):Ct(e,i)||!Dt(e,i)?!0:(l(Hn,{dashboard:e,onSaveSuccess:()=>{d(),Se(h)},onDiscard:()=>{s({...n,original:null}),d(),Se(h)},onDismiss:d}),!1)};return(0,t.jsx)(ut.X,{when:!0,message:c})});St.displayName="DashboardPrompt";function Se(e){e&&setTimeout(()=>y.Ny.push(e),10)}function Ct(e,n){if(!n||n.version===0||!K.TP.isSignedIn||!e)return!0;const{canSave:s,fromScript:a,fromFile:i}=e.meta;return!K.TP.isEditor&&!s?!0:!s||a||i}function Pt(e){const n=new xt.G(e);n.expandRows();const s=n.getSaveModelClone();if(delete s.time,delete s.refresh,s.schemaVersion=0,delete s.timezone,s.panels=[],s.templating?.list)for(const a of s.templating.list)delete a.current,delete a.options,delete a.filters;return s}function Dt(e,n){if(e.hasUnsavedChanges())return!0;const s=Pt(e.getSaveModelCloneOld()),a=Pt(n),i=(0,re.find)(s.nav,{type:"timepicker"}),r=(0,re.find)(a.nav,{type:"timepicker"});i&&r&&(i.now=r.now);const l=JSON.stringify(s,null),d=JSON.stringify(a,null);return l!==d}var Tt=o(48194),V=o(48583),Ce=o(45565),Nt=o(91536),Et=o(14644),J=o(56276),Ke=o(91036),_=o(19550),He=o(20968),Pe=o(6736),le=o(99764),Qe=o(41079);const Qn=({id:e,usages:n})=>{const s=(0,g.useMemo)(()=>n.find(i=>i.variable.id===e),[e,n]);if(!s)return null;const a=s.nodes.map(i=>i.label.includes(`$${e}`)?{...i,color:"#FB7E81"}:i);return(0,t.jsx)(Qe.i,{show:!1,title:`Showing usages for: $${e}`,nodes:a,edges:s.edges,children:({showModal:i})=>(0,t.jsx)(le.K,{onClick:()=>i(),name:"code-branch",tooltip:"Show usages","data-testid":"VariablesUnknownButton"})})};var ae=o(66012);const Jn=1e3;function Yn({variables:e,dashboard:n}){const[s,a]=(0,g.useState)(!1),[i,r]=(0,g.useState)(0),[l,d]=(0,g.useState)([]),c=(0,P.of)(Je);(0,g.useEffect)(()=>r(m=>m+1),[e,n]);const{loading:h}=(0,te.A)(async()=>{if(s&&i>0){const m=Date.now(),f=await(0,ae.g0)(e,n),D=Date.now()-m;return D>=Jn&&(0,J.rR)("Slow unknown variables expansion",{elapsed:D}),r(0),d(f),f}return[]},[e,n,s,i]),p=m=>{m&&(0,J.rR)("Unknown variables section expanded"),a(m)};return(0,t.jsx)("div",{className:c.container,children:(0,t.jsxs)(Ke.M,{label:(0,t.jsx)(Xn,{}),isOpen:s,onToggle:p,children:[h&&(0,t.jsx)(_.gW,{justify:"center",children:(0,t.jsxs)(_.Gy,{justify:"center",children:[(0,t.jsx)("span",{children:"Loading..."}),(0,t.jsx)(He.y,{})]})}),!h&&l&&(0,t.jsxs)(t.Fragment,{children:[l.length===0&&(0,t.jsx)(Zn,{}),l.length>0&&(0,t.jsx)(qn,{usages:l})]})]})})}function Xn(){const e=(0,P.of)(Je);return(0,t.jsxs)("h5",{children:["Renamed or missing variables",(0,t.jsx)(Pe.m,{content:"Click to expand a list with all variable references that have been renamed or are missing from the dashboard.",children:(0,t.jsx)(H.I,{name:"info-circle",className:e.infoIcon})})]})}function Zn(){return(0,t.jsx)("span",{children:"No renamed or missing variables found."})}function qn({usages:e}){const n=(0,P.of)(Je);return(0,t.jsxs)("table",{className:"filter-table filter-table--hover",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Variable"}),(0,t.jsx)("th",{colSpan:5})]})}),(0,t.jsx)("tbody",{children:e.map(s=>{const{variable:a}=s,{id:i,name:r}=a;return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{className:n.firstColumn,children:(0,t.jsx)("span",{children:r})}),(0,t.jsx)("td",{className:n.defaultColumn}),(0,t.jsx)("td",{className:n.defaultColumn}),(0,t.jsx)("td",{className:n.defaultColumn}),(0,t.jsx)("td",{className:n.lastColumn,children:(0,t.jsx)(Qn,{id:a.id,usages:e})})]},i)})})]})}const Je=e=>({container:(0,u.css)({marginTop:e.spacing(4),paddingTop:e.spacing(4)}),infoIcon:(0,u.css)({marginLeft:e.spacing(1)}),defaultColumn:(0,u.css)({width:"1%"}),firstColumn:(0,u.css)({width:"1%",verticalAlign:"top",color:e.colors.text.maxContrast}),lastColumn:(0,u.css)({overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",width:"100%",textAlign:"right"})});var O=o(5636),F=o(58843),Y=o(30990),Ye=o(65164);function It({varName:e,isOpen:n=!1,onConfirm:s,onDismiss:a}){return(0,t.jsx)(Ye.u,{title:"Delete variable",isOpen:n,onConfirm:s,onDismiss:a,body:`
      Are you sure you want to delete variable "${e}"?
    `,modalClass:_n.modal,confirmText:"Delete"})}const _n={modal:(0,u.css)({width:"max-content",maxWidth:"80vw"})};var De=o(8392),es=o(92226),ts=o(17077),ns=o(36390),Mt=o(7807),ss=o(10666),Xe=o(19639),Ze=o(21658),as=o(99384);function is({onChange:e,type:n}){const s=(0,g.useMemo)(()=>(0,I.AX)(),[]),a=(0,g.useMemo)(()=>s.find(i=>i.value===n)??s[0],[s,n]);return(0,t.jsx)(as.v,{name:"Select variable type",value:a,options:s,onChange:e,testId:x.Tp.pages.Dashboard.Settings.Variables.Edit.General.generalTypeSelectV2})}var os=o(90604),ue=o(5353);const rs=e=>async n=>{const{rootStateKey:s}=e;n((0,O.kb)(s,(0,ue.sJ)({name:(0,F.dn)(e).name,id:e.id})))},ls=e=>async(n,s)=>{const{rootStateKey:a}=e;n((0,O.kb)(a,(0,ue.T7)((0,I.qD)(e))))},ds=(e,n)=>(s,a)=>{const{id:i,rootStateKey:r}=e;let l=null;if(n.match(/^(?!__).*$/)||(l="Template names cannot begin with '__', that's reserved for Grafana's global variables"),n.match(/^\w+$/)||(l="Only word characters are allowed in variable names"),(0,F.SS)(r,a()).filter(h=>h.name===n&&h.id!==i).length&&(l="Variable with the same name already exists"),l){s((0,O.kb)(r,(0,ue.DW)({newName:n,errorText:l})));return}s(cs(e,n))},cs=(e,n)=>(s,a)=>{const{rootStateKey:i}=e,r=(0,F.dn)(e,a());if(r.name===n){s((0,O.kb)(i,(0,ue.FN)((0,I.qD)(e,{newName:n}))));return}const l={...(0,re.cloneDeep)(r),name:n,id:n},d=r.global,c=r.index,h=(0,I.jX)(l);s((0,O.kb)(i,(0,Y.QV)((0,I.qD)(h,{global:d,index:c,model:l})))),s((0,O.kb)(i,(0,ue.FN)((0,I.qD)(h,{newName:n})))),s((0,O.kb)(i,(0,Y.Hr)((0,I.qD)(e,{reIndex:!1}))))},hs=(e,n="query")=>(s,a)=>{const i=(0,I.q4)(e),r=(0,F.SS)(i,a()),l=ps(n,r),d={type:n,id:l},c=!1,h=(0,F.hk)(i,a()),p=(0,re.cloneDeep)(Xe.B.get(n).initialState);p.id=l,p.name=l,p.rootStateKey=i,s((0,O.kb)(i,(0,Y.QV)((0,I.qD)(d,{global:c,model:p,index:h})))),y.Ny.partial({editIndex:r.length})},us=e=>(n,s)=>{const a=(0,I.q4)(e),i=s(),r=(0,F.nS)(a,i),l=i.dashboard.getModel(),{usages:d}=(0,ae.hM)(r,l),c=(0,ae.Ow)(d);n((0,O.kb)(a,(0,os.bX)({usages:d,usagesNetwork:c})))};function ps(e,n){let s=0,a=`${e}${s}`;for(;n.find(i=>i.id===a);)a=`${e}${++s}`;return a}var gs=o(86796);const ms=(e,n)=>({editor:(0,F.nx)(n.identifier.rootStateKey,e).editor,variable:(0,F.dn)(n.identifier,e)}),fs=e=>({...(0,Et.bindActionCreators)({variableEditorMount:rs,variableEditorUnMount:ls,changeVariableName:ds,updateOptions:$e.mZ},e),changeVariableProp:(n,s,a)=>e((0,O.kb)(n.rootStateKey,(0,Y.QP)((0,I.qD)(n,{propName:s,propValue:a})))),changeVariableType:(n,s)=>e((0,O.kb)(n.rootStateKey,(0,Y.l_)((0,I.qD)(n,{newType:s})))),removeVariable:n=>{e((0,O.kb)(n.rootStateKey,(0,Y.Hr)((0,I.qD)(n,{reIndex:!0}))))}}),vs=(0,q.connect)(ms,fs);class xs extends g.PureComponent{constructor(){super(...arguments),this.state={showDeleteModal:!1},this.onNameChange=n=>{n.preventDefault(),this.props.changeVariableName(this.props.identifier,n.currentTarget.value)},this.onTypeChange=n=>{n.value&&this.props.changeVariableType(this.props.identifier,n.value)},this.onLabelChange=n=>{n.preventDefault(),this.props.changeVariableProp(this.props.identifier,"label",n.currentTarget.value)},this.onDescriptionChange=n=>{this.props.changeVariableProp(this.props.identifier,"description",n.currentTarget.value)},this.onHideChange=n=>{this.props.changeVariableProp(this.props.identifier,"hide",n)},this.onPropChanged=({propName:n,propValue:s,updateOptions:a=!1})=>{this.props.changeVariableProp(this.props.identifier,n,s),a&&this.props.updateOptions((0,I.jX)(this.props.variable))},this.onHandleSubmit=async n=>{n.preventDefault(),this.props.editor.isValid&&this.props.updateOptions((0,I.jX)(this.props.variable))},this.onModalOpen=()=>{this.setState({showDeleteModal:!0})},this.onModalClose=()=>{this.setState({showDeleteModal:!1})},this.onDelete=()=>{this.props.removeVariable(this.props.identifier),this.onModalClose(),y.Ny.partial({editIndex:null})},this.onApply=()=>{y.Ny.partial({editIndex:null})},this.getVariableOptions=()=>{const{variable:n}=this.props;return(0,Ze.SP)(n)?n.options.map(s=>({label:String(s.text),value:String(s.value)})):[]}}componentDidMount(){this.props.variableEditorMount(this.props.identifier)}componentWillUnmount(){this.props.variableEditorUnMount(this.props.identifier)}render(){const{theme:n,variable:s}=this.props,a=Xe.B.get(this.props.variable.type).editor;if(!a)return null;const i=s.state===De.Gu.Loading,r=window.matchMedia("(prefers-reduced-motion: reduce)").matches,l=js(n);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("form",{"aria-label":"Variable editor Form",onSubmit:this.onHandleSubmit,children:[(0,t.jsx)(is,{onChange:this.onTypeChange,type:this.props.variable.type}),(0,t.jsx)(ts.Y,{children:"General"}),(0,t.jsx)(Mt._,{value:this.props.editor.name,onChange:this.onNameChange,name:"Name",placeholder:"Variable name",description:"The name of the template variable. (Max. 50 characters)",invalid:!!this.props.editor.errors.name,error:this.props.editor.errors.name,testId:x.Tp.pages.Dashboard.Settings.Variables.Edit.General.generalNameInputV2,maxLength:gs.M.MaxSize,required:!0}),(0,t.jsx)(Mt._,{name:"Label",description:"Optional display name",value:this.props.variable.label??"",placeholder:"Label name",onChange:this.onLabelChange,testId:x.Tp.pages.Dashboard.Settings.Variables.Edit.General.generalLabelInputV2}),(0,t.jsx)(ns.Z,{name:"Description",value:s.description??"",placeholder:"Descriptive text",onChange:this.onDescriptionChange,width:52}),(0,t.jsx)(es.D,{onChange:this.onHideChange,hide:this.props.variable.hide,type:this.props.variable.type}),a&&(0,t.jsx)(a,{variable:this.props.variable,onPropChange:this.onPropChanged}),(0,Ze.SP)(this.props.variable)?(0,t.jsx)(ss.j,{options:this.getVariableOptions()}):null,(0,t.jsx)("div",{style:{marginTop:"16px"},children:(0,t.jsxs)(_.Gy,{spacing:"md",height:"inherit",children:[(0,t.jsx)(b.$n,{variant:"destructive",fill:"outline",onClick:this.onModalOpen,children:"Delete"}),(0,t.jsxs)(b.$n,{type:"submit","data-testid":x.Tp.pages.Dashboard.Settings.Variables.Edit.General.submitButton,disabled:i,variant:"secondary",children:["Run query",i&&(0,t.jsx)(H.I,{className:l.spin,name:r?"hourglass":"sync",size:"sm",style:{marginLeft:"2px"}})]}),(0,t.jsx)(b.$n,{variant:"primary",onClick:this.onApply,"data-testid":x.Tp.pages.Dashboard.Settings.Variables.Edit.General.applyButton,children:"Apply"})]})})]}),(0,t.jsx)(It,{isOpen:this.state.showDeleteModal,varName:this.props.editor.name,onConfirm:this.onDelete,onDismiss:this.onModalClose})]})}}const bs=(0,P.cV)(vs(xs)),ys=(0,u.keyframes)({"0%":{transform:"rotate(0deg) scaleX(-1)"},"100%":{transform:"rotate(359deg) scaleX(-1)"}}),js=e=>({spin:(0,u.css)({[e.transitions.handleMotion("no-preference")]:{animation:`${ys} 3s linear infinite`}})});var qe=o(57095),wt=o(59830),_e=o(54731);const Ss=({variables:e})=>{const n=(0,g.useMemo)(()=>(0,ae.hI)(e),[e]),s=(0,g.useMemo)(()=>(0,ae.qJ)(e),[e]);return s.length?(0,t.jsx)(Qe.i,{show:!1,title:"Dependencies",nodes:(0,ae.H7)(n,s),edges:s,children:({showModal:a})=>(0,t.jsx)(b.$n,{onClick:()=>{(0,J.rR)("Show variable dependencies"),a()},icon:"channel-add",variant:"secondary",children:"Show dependencies"})}):null},Cs=({id:e,usages:n,isAdhoc:s})=>{const a=(0,g.useMemo)(()=>n.find(r=>r.variable.id===e),[n,e]);if(n.length===0||s||!a)return null;const i=a.nodes.map(r=>r.label.includes(`$${e}`)?{...r,color:"#FB7E81"}:r);return(0,t.jsx)(Qe.i,{show:!1,title:`Showing usages for: $${e}`,nodes:i,edges:a.edges,children:({showModal:r})=>(0,t.jsx)(le.K,{onClick:()=>{(0,J.rR)("Show variable usages"),r()},name:"code-branch",tooltip:"Show usages"})})};function Ps({index:e,variable:n,usageTree:s,usagesNetwork:a,onEdit:i,onDuplicate:r,onDelete:l}){const d=(0,P.$j)(),c=(0,P.of)(Vt),h=Ds(n),m=(0,ae.PK)(n.id,s)>0||n.type==="adhoc",f=(0,I.jX)(n);return(0,t.jsx)(qe.Draggable,{draggableId:JSON.stringify(f),index:e,children:(T,D)=>(0,t.jsxs)("tr",{ref:T.innerRef,...T.draggableProps,style:{userSelect:D.isDragging?"none":"auto",background:D.isDragging?d.colors.background.secondary:void 0,...T.draggableProps.style},children:[(0,t.jsx)("td",{role:"gridcell",className:c.column,children:(0,t.jsx)(b.$n,{size:"xs",fill:"text",onClick:S=>{S.preventDefault(),i(f)},className:c.nameLink,"aria-label":x.Tp.pages.Dashboard.Settings.Variables.List.tableRowNameFields(n.name),children:n.name})}),(0,t.jsx)("td",{role:"gridcell",className:c.definitionColumn,onClick:S=>{S.preventDefault(),i(f)},"aria-label":x.Tp.pages.Dashboard.Settings.Variables.List.tableRowDefinitionFields(n.name),children:h}),(0,t.jsx)("td",{role:"gridcell",className:c.column,children:(0,t.jsxs)("div",{className:c.icons,children:[(0,t.jsx)(Ts,{passed:m}),(0,t.jsx)(Cs,{id:n.id,isAdhoc:n.type==="adhoc",usages:a}),(0,t.jsx)(le.K,{onClick:S=>{S.preventDefault(),(0,J.rR)("Duplicate variable"),r(f)},name:"copy",tooltip:"Duplicate variable","aria-label":x.Tp.pages.Dashboard.Settings.Variables.List.tableRowDuplicateButtons(n.name)}),(0,t.jsx)(le.K,{onClick:S=>{S.preventDefault(),(0,J.rR)("Delete variable"),l(f)},name:"trash-alt",tooltip:"Remove variable","aria-label":x.Tp.pages.Dashboard.Settings.Variables.List.tableRowRemoveButtons(n.name)}),(0,t.jsx)("div",{...T.dragHandleProps,className:c.dragHandle,children:(0,t.jsx)(H.I,{name:"draggabledots",size:"lg"})})]})})]})})}function Ds(e){let n="";return e.type==="query"?e.definition?n=e.definition:typeof e.query=="string"&&(n=e.query):(0,Ze.SP)(e)&&(n=e.query),n}function Ts({passed:e}){const n=(0,P.of)(Vt);return e?(0,t.jsx)(H.I,{name:"check",className:n.iconPassed,title:"This variable is referenced by other variables or dashboard."}):(0,t.jsx)(H.I,{name:"exclamation-triangle",className:n.iconFailed,title:"This variable is not referenced by any variable or dashboard."})}function Vt(e){return{dragHandle:(0,u.css)({cursor:"grab",marginLeft:e.spacing(1)}),column:(0,u.css)({width:"1%"}),nameLink:(0,u.css)({cursor:"pointer",color:e.colors.primary.text}),definitionColumn:(0,u.css)({width:"100%",maxWidth:"200px",cursor:"pointer",overflow:"hidden",textOverflow:"ellipsis",OTextOverflow:"ellipsis",whiteSpace:"nowrap"}),iconPassed:(0,u.css)({color:e.v1.palette.greenBase,marginRight:e.spacing(2)}),iconFailed:(0,u.css)({color:e.v1.palette.orange,marginRight:e.spacing(2)}),icons:(0,u.css)({display:"flex",gap:e.spacing(2),alignItems:"center"})}}function Ns({variables:e,usages:n,usagesNetwork:s,onChangeOrder:a,onAdd:i,onEdit:r,onDelete:l,onDuplicate:d}){const c=(0,P.of)(Is),h=p=>{if(!p.destination||!p.source)return;(0,J.rR)("Variable drag and drop");const m=JSON.parse(p.draggableId);a(m,e[p.source.index].index,e[p.destination.index].index)};return(0,t.jsx)("div",{children:(0,t.jsxs)("div",{children:[e.length===0&&(0,t.jsx)(Es,{onAdd:i}),e.length>0&&(0,t.jsxs)(V.B,{direction:"column",gap:4,children:[(0,t.jsx)("div",{className:c.tableContainer,children:(0,t.jsxs)("table",{className:"filter-table filter-table--hover","aria-label":x.Tp.pages.Dashboard.Settings.Variables.List.table,role:"grid",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Variable"}),(0,t.jsx)("th",{children:"Definition"}),(0,t.jsx)("th",{colSpan:5})]})}),(0,t.jsx)(qe.DragDropContext,{onDragEnd:h,children:(0,t.jsx)(qe.Droppable,{droppableId:"variables-list",direction:"vertical",children:p=>(0,t.jsxs)("tbody",{ref:p.innerRef,...p.droppableProps,children:[e.map((m,f)=>(0,t.jsx)(Ps,{index:f,variable:m,usageTree:n,usagesNetwork:s,onDelete:l,onDuplicate:d,onEdit:r},`${m.name}-${f}`)),p.placeholder]})})})]})}),(0,t.jsxs)(V.B,{children:[(0,t.jsx)(Ss,{variables:e}),(0,t.jsx)(b.$n,{"aria-label":x.Tp.pages.Dashboard.Settings.Variables.List.newButton,onClick:i,icon:"plus",children:"New variable"})]})]})]})})}function Es({onAdd:e}){return(0,t.jsx)(V.B,{direction:"column",children:(0,t.jsxs)(wt.p,{variant:"call-to-action",button:(0,t.jsx)(b.$n,{"data-testid":x.Tp.components.CallToActionCard.buttonV2("Add variable"),icon:"calculator-alt",onClick:e,size:"lg",children:(0,t.jsx)(v.x6,{i18nKey:"variables.empty-state.button-title",children:"Add variable"})}),message:(0,v.t)("variables.empty-state.title","There are no variables added yet"),children:[(0,t.jsx)("p",{children:(0,t.jsx)(v.x6,{i18nKey:"variables.empty-state.info-box-content",children:"Variables enable more interactive and dynamic dashboards. Instead of hard-coding things like server or sensor names in your metric queries you can use variables in their place. Variables are shown as list boxes at the top of the dashboard. These drop-down lists make it easy to change the data being displayed in your dashboard."})}),(0,t.jsxs)(v.x6,{i18nKey:"variables.empty-state.info-box-content-2",children:["Check out the"," ",(0,t.jsx)(_e.Y,{external:!0,href:"https://grafana.com/docs/grafana/latest/variables/",children:"Templates and variables documentation"})," ","for more information."]})]})})}const Is=()=>({tableContainer:(0,u.css)({overflow:"scroll",width:"100%"})}),Ms=(e,n)=>{const{uid:s}=n.dashboard,a=(0,F.nx)(s,e);return{variables:(0,F.nS)(s,e),idInEditor:a.editor.id,usagesNetwork:a.inspect.usagesNetwork,usages:a.inspect.usages}},ws=e=>({...(0,Et.bindActionCreators)({createNewVariable:hs,initListMode:us},e),changeVariableOrder:(n,s,a)=>e((0,O.kb)(n.rootStateKey,(0,Y.hj)((0,I.qD)(n,{fromIndex:s,toIndex:a})))),duplicateVariable:n=>e((0,O.kb)(n.rootStateKey,(0,Y.ut)((0,I.qD)(n,{newId:void 0})))),removeVariable:n=>{e((0,O.kb)(n.rootStateKey,(0,Y.Hr)((0,I.qD)(n,{reIndex:!0}))))}}),Vs=(0,q.connect)(Ms,ws);class Ls extends g.PureComponent{constructor(){super(...arguments),this.state={variableId:void 0},this.onEditVariable=n=>{const s=this.props.variables.findIndex(a=>a.id===n.id);y.Ny.partial({editIndex:s})},this.onNewVariable=()=>{this.props.createNewVariable(this.props.dashboard.uid)},this.onChangeVariableOrder=(n,s,a)=>{this.props.changeVariableOrder(n,s,a)},this.onDuplicateVariable=n=>{this.props.duplicateVariable(n)},this.onModalOpen=n=>{this.setState({variableId:n})},this.onModalClose=()=>{this.setState({variableId:void 0})},this.onRemoveVariable=()=>{this.props.removeVariable(this.state.variableId),this.onModalClose()}}componentDidMount(){this.props.initListMode(this.props.dashboard.uid)}render(){const{editIndex:n,variables:s,sectionNav:a}=this.props,i=n!=null?s[n]:void 0,l=a.node.parentItem,d=i?{text:i.name,parentItem:l}:l;return(0,t.jsxs)(U.Y,{navModel:this.props.sectionNav,pageNav:d,children:[!i&&(0,t.jsx)(Ns,{variables:this.props.variables,onAdd:this.onNewVariable,onEdit:this.onEditVariable,onChangeOrder:this.onChangeVariableOrder,onDuplicate:this.onDuplicateVariable,onDelete:this.onModalOpen,usages:this.props.usages,usagesNetwork:this.props.usagesNetwork}),!i&&this.props.variables.length>0&&(0,t.jsx)(Yn,{variables:this.props.variables,dashboard:this.props.dashboard}),i&&(0,t.jsx)(bs,{identifier:(0,I.jX)(i)}),(0,t.jsx)(It,{isOpen:this.state.variableId!==void 0,varName:this.state.variableId?.id??"",onConfirm:this.onRemoveVariable,onDismiss:this.onModalClose})]})}}const As=Vs(Ls);var Rs=o(12590),Lt=o(87638);const Us=({dashboard:e,sectionNav:n})=>{const s=Lt.TP.hasPermission(E.AccessControlAction.DashboardsPermissionsWrite),a=n.node.parentItem;return(0,t.jsx)(U.Y,{navModel:n,pageNav:a,children:(0,t.jsx)(Rs.x,{resource:"dashboards",resourceId:e.uid,canSetPermissions:s})})};var Te=o(61809),Ne=o(98437),At=o(44617),A=o(86489),et=o(81942),tt=o(44826),Os=o(8106),nt=o(88023),Bs=o(68358),Fs=o(81208),$s=o(15773);const Rt="New annotation",zs=({editIdx:e,dashboard:n})=>{const s=(0,P.of)(ks),[a,i]=(0,g.useState)(n.annotations.list[e]),r=(0,g.useMemo)(()=>a.filter?a.filter.exclude?2:1:0,[a.filter]),{value:l}=(0,te.A)(()=>(0,Ne.l)().get(a.datasource),[a.datasource]),d=(0,Ne.l)().getInstanceSettings(a.datasource),c=j=>{const N=[...n.annotations.list];N.splice(e,1,j),i(j),n.annotations.list=N},h=j=>{c({...a,name:j.currentTarget.value})},p=j=>{const N=(0,Te.p$)(j);a.datasource?.type!==N.type?c({datasource:N,builtIn:a.builtIn,enable:a.enable,iconColor:a.iconColor,name:a.name,hide:a.hide,filter:a.filter,mappings:a.mappings,type:a.type}):c({...a,datasource:N})},m=j=>{const N=j.currentTarget;c({...a,[N.name]:N.type==="checkbox"?N.checked:N.value})},f=j=>{c({...a,iconColor:j})},T=j=>{let N=j.value===0?void 0:{exclude:j.value===2,ids:a.filter?.ids??[]};c({...a,filter:N})},D=j=>{if(!Array.isArray(j))return;const N={exclude:r===2,ids:[]};j.forEach(oe=>oe.value&&N.ids.push(oe.value)),c({...a,filter:N})},S=Ut,L=()=>{y.Ny.partial({editview:null,editIndex:null})},B=()=>{const j=n.annotations.list;n.annotations.list=[...j.slice(0,e),...j.slice(e+1)],Ut()},R=a.name===Rt,ie=(j,N)=>j.label&&N.label?j.label.toLowerCase().localeCompare(N.label.toLowerCase()):-1,z=(0,g.useMemo)(()=>n?.panels.filter(j=>nt.Ay.panels[j.type]).map(j=>({value:j.id,label:j.title??`Panel ${j.id}`,description:j.description,imgUrl:nt.Ay.panels[j.type].info.logos.small})).sort(ie)??[],[n]);return(0,t.jsxs)("div",{children:[(0,t.jsxs)(At.n,{className:s.settingsForm,children:[(0,t.jsx)(A.D,{label:"Name",children:(0,t.jsx)(ze.p,{"data-testid":x.Tp.pages.Dashboard.Settings.Annotations.Settings.name,name:"name",id:"name",autoFocus:R,value:a.name,onChange:h})}),(0,t.jsx)(A.D,{label:"Data source",htmlFor:"data-source-picker",children:(0,t.jsx)($s.s,{annotations:!0,variables:!0,current:a.datasource,onChange:p})}),!l?.meta.annotations&&(0,t.jsx)(W.F,{title:"No annotation support for this data source",severity:"error",children:(0,t.jsx)(v.x6,{i18nKey:"errors.dashboard-settings.annotations.datasource",children:"The selected data source does not support annotations. Please select a different data source."})}),(0,t.jsx)(A.D,{label:"Enabled",description:"When enabled the annotation query is issued every dashboard refresh",children:(0,t.jsx)(et.S,{name:"enable",id:"enable",value:a.enable,onChange:m})}),(0,t.jsx)(A.D,{label:"Hidden",description:"Annotation queries can be toggled on or off at the top of the dashboard. With this option checked this toggle will be hidden.",children:(0,t.jsx)(et.S,{name:"hide",id:"hide",value:a.hide,onChange:m})}),(0,t.jsx)(A.D,{label:"Color",description:"Color to use for the annotation event markers",children:(0,t.jsx)(_.Gy,{children:(0,t.jsx)(Os.a,{value:a?.iconColor,onChange:f})})}),(0,t.jsx)(A.D,{label:"Show in","data-testid":x.Tp.pages.Dashboard.Settings.Annotations.NewAnnotation.showInLabel,children:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(tt.l6,{options:Ws,value:r,onChange:T,"data-testid":x.Tp.components.Annotations.annotationsTypeInput}),r!==0&&(0,t.jsx)(tt.KF,{options:z,value:z.filter(j=>a.filter?.ids.includes(j.value)),onChange:D,isClearable:!0,placeholder:"Choose panels",width:100,closeMenuOnSelect:!1,className:s.select,"data-testid":x.Tp.components.Annotations.annotationsChoosePanelInput})]})})]}),(0,t.jsxs)(At.n,{children:[(0,t.jsx)("h3",{className:"page-heading",children:"Query"}),l?.annotations&&d&&(0,t.jsx)(Bs.A,{datasource:l,datasourceInstanceSettings:d,annotation:a,onChange:c}),l&&!l.annotations&&(0,t.jsx)(Fs.F,{datasource:l,annotation:a,onChange:c})]}),(0,t.jsxs)(V.B,{children:[!a.builtIn&&(0,t.jsx)(b.$n,{variant:"destructive",onClick:B,children:"Delete"}),(0,t.jsx)(b.$n,{variant:"secondary",onClick:L,"data-testid":x.Tp.pages.Dashboard.Settings.Annotations.NewAnnotation.previewInDashboard,children:"Preview in dashboard"}),(0,t.jsx)(b.$n,{variant:"primary",onClick:S,children:"Apply"})]})]})},ks=e=>({settingsForm:(0,u.css)({maxWidth:e.spacing(60),marginBottom:e.spacing(2)}),select:(0,u.css)({marginTop:"8px"})});function Ut(){y.Ny.partial({editIndex:null})}var Gs=(e=>(e[e.AllPanels=0]="AllPanels",e[e.IncludePanels=1]="IncludePanels",e[e.ExcludePanels=2]="ExcludePanels",e))(Gs||{});const Ws=[{label:"All panels",value:0,description:"Send the annotation data to all panels that support annotations"},{label:"Selected panels",value:1,description:"Send the annotations to the explicitly listed panels"},{label:"All panels except",value:2,description:"Do not send annotation data to the following panels"}];var Ot=o(6562),Ks=o(87731),Hs=o(64625);const Qs=({dashboard:e,onNew:n,onEdit:s})=>{const a=(0,P.of)(Js),[i,r]=(0,g.useState)(e.annotations.list),l=(m,f)=>{e.annotations.list=Ot.moveItemImmutably(i,m,m+f),r(e.annotations.list)},d=m=>{e.annotations.list=[...i.slice(0,m),...i.slice(m+1)],r(e.annotations.list)},c=i.length===0||i.length===1&&i[0].builtIn,h=m=>m.enable===!1?(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("em",{className:"muted",children:["(Disabled) \xA0 ",m.name]})}):m.builtIn?(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("em",{className:"muted",children:[m.name," \xA0 (Built-in)"]})}):(0,t.jsx)(t.Fragment,{children:m.name}),p=(0,Ne.l)();return(0,t.jsxs)(V.B,{direction:"column",children:[i.length>0&&(0,t.jsx)("div",{className:a.table,children:(0,t.jsxs)("table",{role:"grid",className:"filter-table filter-table--hover",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Query name"}),(0,t.jsx)("th",{children:"Data source"}),(0,t.jsx)("th",{colSpan:3})]})}),(0,t.jsx)("tbody",{children:e.annotations.list.map((m,f)=>(0,t.jsxs)("tr",{children:[m.builtIn?(0,t.jsx)("td",{role:"gridcell",style:{width:"90%"},className:"pointer",onClick:()=>s(f),children:(0,t.jsx)(b.$n,{size:"sm",fill:"text",variant:"secondary",children:h(m)})}):(0,t.jsx)("td",{role:"gridcell",className:"pointer",onClick:()=>s(f),children:(0,t.jsx)(b.$n,{size:"sm",fill:"text",variant:"secondary",children:h(m)})}),(0,t.jsx)("td",{role:"gridcell",className:"pointer",onClick:()=>s(f),children:p.getInstanceSettings(m.datasource)?.name||m.datasource?.uid}),(0,t.jsx)("td",{role:"gridcell",style:{width:"1%"},children:f!==0&&(0,t.jsx)(le.K,{name:"arrow-up",onClick:()=>l(f,-1),tooltip:"Move up"})}),(0,t.jsx)("td",{role:"gridcell",style:{width:"1%"},children:e.annotations.list.length>1&&f!==e.annotations.list.length-1?(0,t.jsx)(le.K,{name:"arrow-down",onClick:()=>l(f,1),tooltip:"Move down"}):null}),(0,t.jsx)("td",{role:"gridcell",style:{width:"1%"},children:!m.builtIn&&(0,t.jsx)(Ks.e,{size:"sm",onConfirm:()=>d(f),"aria-label":`Delete query with title "${m.name}"`})})]},`${m.name}-${f}`))})]})}),c&&(0,t.jsx)(V.B,{direction:"column",children:(0,t.jsxs)(wt.p,{variant:"call-to-action",button:(0,t.jsx)(b.$n,{"data-testid":x.Tp.components.CallToActionCard.buttonV2("Add annotation query"),icon:"comment-alt",onClick:n,size:"lg",children:(0,t.jsx)(v.x6,{i18nKey:"annotations.empty-state.button-title",children:"Add annotation query"})}),message:(0,v.t)("annotations.empty-state.title","There are no custom annotation queries added yet"),children:[(0,t.jsx)(v.x6,{i18nKey:"annotations.empty-state.info-box-content",children:(0,t.jsx)("p",{children:"Annotations provide a way to integrate event data into your graphs. They are visualized as vertical lines and icons on all graph panels. When you hover over an annotation icon you can get event text & tags for the event. You can add annotation events directly from grafana by holding CTRL or CMD + click on graph (or drag region). These will be stored in Grafana's annotation database."})}),(0,t.jsxs)(v.x6,{i18nKey:"annotations.empty-state.info-box-content-2",children:["Checkout the"," ",(0,t.jsx)(_e.Y,{external:!0,href:"http://docs.grafana.org/reference/annotations/",children:"Annotations documentation"})," ","for more information."]})]})}),!c&&(0,t.jsx)(Hs.d,{"data-testid":x.Tp.pages.Dashboard.Settings.Annotations.List.addAnnotationCTAV2,onClick:n,children:"New query"})]})},Js=()=>({table:(0,u.css)({width:"100%",overflowX:"scroll"})});function Ys({dashboard:e,editIndex:n,sectionNav:s}){const a=()=>{const l={name:Rt,enable:!0,datasource:(0,Te.p$)((0,Ne.l)().getInstanceSettings(null)),iconColor:"red"};e.annotations.list=[...e.annotations.list,{...l}],y.Ny.partial({editIndex:e.annotations.list.length-1})},i=l=>{y.Ny.partial({editIndex:l})},r=n!=null&&n<e.annotations.list.length;return(0,t.jsxs)(U.Y,{navModel:s,pageNav:Xs(e,n,s.node),children:[!r&&(0,t.jsx)(Qs,{dashboard:e,onNew:a,onEdit:i}),r&&(0,t.jsx)(zs,{dashboard:e,editIdx:n})]})}function Xs(e,n,s){const a=s.parentItem;if(n==null)return a;const i=e.annotations.list[n];if(i)return{text:i.name,parentItem:a}}var Bt=o(40271),Zs=o(50926),qs=o(32319),Ee=o(60641),_s=o(62851),Ie=o(64555),Me=o(16910),ea=o(5805),Ft=o(9968),ta=o(15664),na=o(4432);const sa={cleanUpDashboardAndVariables:Ie.Bz},aa=(0,q.connect)(null,sa),ia=({hideModal:e,cleanUpDashboardAndVariables:n,dashboard:s})=>{const a=s.meta.provisioned,[i]=(0,ta.uz)(),[,r]=(0,ea.default)(async()=>{(0,J.rR)("grafana_manage_dashboards_delete_clicked",{item_counts:{dashboard:1},source:"dashboard_settings",restore_enabled:!!w.$.featureToggles.dashboardRestore}),await i({selectedItems:{dashboard:{[s.uid]:!0},folder:{}}}),n(),e(),y.Ny.replace("/")},[e]);return a?(0,t.jsx)(oa,{hideModal:e,provisionedId:s.meta.provisionedExternalId}):(0,t.jsx)(na.h,{onConfirm:r,onClose:e,dashboardTitle:s.title})},oa=({hideModal:e,provisionedId:n})=>(0,t.jsxs)(Z.a,{isOpen:!0,title:(0,v.t)("dashboard-settings.provisioned-delete-modal.title","Cannot delete provisioned dashboard"),icon:"trash-alt",onDismiss:e,className:(0,u.css)({width:"500px"}),children:[(0,t.jsx)(Ce.E,{element:"p",children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.provisioned-delete-modal.text-1",children:"This dashboard is managed by Grafana provisioning and cannot be deleted. Remove the dashboard from the config file to delete it."})}),(0,t.jsx)(Ft.$,{v:1}),(0,t.jsxs)(Ce.E,{element:"p",children:[(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.provisioned-delete-modal.text-2",children:"See grafana documentation for more information about provisioning.\xA0"}),(0,t.jsx)(_e.Y,{href:"https://grafana.com/docs/grafana/latest/administration/provisioning/#dashboards",external:!0,children:(0,v.t)("dashboard-settings.provisioned-delete-modal.text-link","Go to docs page")})]}),(0,t.jsx)(Ft.$,{v:2}),(0,t.jsx)(Ce.E,{element:"p",children:(0,t.jsxs)(v.x6,{i18nKey:"dashboard-settings.provisioned-delete-modal.text-3",children:["File path: ",{provisionedId:n}]})}),(0,t.jsx)(Z.a.ButtonRow,{children:(0,t.jsx)(b.$n,{variant:"primary",onClick:e,children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.provisioned-delete-modal.confirm-button",children:"OK"})})})]}),ra=aa(ia),la=()=>{const e=(0,Me.UA)().getCurrent();return(0,t.jsx)(k.$s,{children:({showModal:n,hideModal:s})=>(0,t.jsx)(b.$n,{variant:"destructive",onClick:()=>{n(ra,{dashboard:e,hideModal:s})},"data-testid":x.Tp.pages.Dashboard.Settings.General.deleteDashBoard,children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.dashboard-delete-button",children:"Delete dashboard"})})})};var da=o(87156),ca=o(36180),ha=o(15832);const ua=[{value:0,label:"Default"},{value:1,label:"Shared crosshair"},{value:2,label:"Shared Tooltip"}];function pa({dashboard:e,updateTimeZone:n,updateWeekStart:s,sectionNav:a}){const[i,r]=(0,g.useState)(0),[l,d]=(0,g.useState)(e.title),[c,h]=(0,g.useState)(e.description),p=a.node.parentItem,m=(C,me)=>{e.meta.folderUid=C,e.meta.folderTitle=me,e.meta.hasUnsavedFolderChange=!0,r(i+1)},f=(0,g.useCallback)(C=>{e.title=C,d(C)},[d,e]),T=(0,g.useCallback)(C=>{e.description=C,h(C)},[h,e]),D=C=>{e.graphTooltip=C,r(i+1)},S=C=>{e.timepicker.refresh_intervals=C.filter(me=>me.trim()!=="")},L=C=>{e.timepicker.nowDelay=C},B=C=>{e.timepicker.hidden=C,r(i+1)},R=C=>{e.liveNow=C,r(i+1)},ie=C=>{e.timezone=C,r(i+1),n(C)},z=C=>{e.weekStart=C,r(i+1),s(C)},j=C=>{e.tags=C,r(i+1)},N=C=>{e.editable=C,r(i+1)},oe=[{label:"Editable",value:!0},{label:"Read-only",value:!1}];return(0,t.jsx)(U.Y,{navModel:a,pageNav:p,children:(0,t.jsxs)("div",{style:{maxWidth:"600px"},children:[(0,t.jsxs)(se.a,{marginBottom:5,children:[(0,t.jsx)(A.D,{label:(0,t.jsxs)(V.B,{justifyContent:"space-between",children:[(0,t.jsx)(Bt.J,{htmlFor:"title-input",children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.general.title-label",children:"Title"})}),w.$.featureToggles.dashgpt&&(0,t.jsx)(ca.Z,{onGenerate:f})]}),children:(0,t.jsx)(ze.p,{id:"title-input",name:"title",value:l,onChange:C=>f(C.target.value)})}),(0,t.jsx)(A.D,{label:(0,t.jsxs)(V.B,{justifyContent:"space-between",children:[(0,t.jsx)(Bt.J,{htmlFor:"description-input",children:(0,v.t)("dashboard-settings.general.description-label","Description")}),w.$.featureToggles.dashgpt&&(0,t.jsx)(da.V,{onGenerate:T})]}),children:(0,t.jsx)(Zs.f,{id:"description-input",name:"description",value:c,onChange:C=>T(C.target.value)})}),(0,t.jsx)(A.D,{label:(0,v.t)("dashboard-settings.general.tags-label","Tags"),children:(0,t.jsx)(qs.u,{id:"tags-input",tags:e.tags,onChange:j,width:40})}),(0,t.jsx)(A.D,{label:(0,v.t)("dashboard-settings.general.folder-label","Folder"),children:(0,t.jsx)(_s.d,{value:e.meta.folderUid,onChange:m,initialTitle:e.meta.folderTitle,inputId:"dashboard-folder-input",enableCreateNew:!0,dashboardId:e.id,skipInitialLoad:!0})}),(0,t.jsx)(A.D,{label:(0,v.t)("dashboard-settings.general.editable-label","Editable"),description:(0,v.t)("dashboard-settings.general.editable-description","Set to read-only to disable all editing. Reload the dashboard for changes to take effect"),children:(0,t.jsx)(Ee.z,{value:e.editable,options:oe,onChange:N})})]}),(0,t.jsx)(ha.p,{onTimeZoneChange:ie,onWeekStartChange:z,onRefreshIntervalChange:S,onNowDelayChange:L,onHideTimePickerChange:B,onLiveNowChange:R,refreshIntervals:e.timepicker.refresh_intervals,timePickerHidden:e.timepicker.hidden,nowDelay:e.timepicker.nowDelay,timezone:e.timezone,weekStart:e.weekStart,liveNow:e.liveNow}),(0,t.jsx)(Ke.M,{label:(0,v.t)("dashboard-settings.general.panel-options-label","Panel options"),isOpen:!0,children:(0,t.jsx)(A.D,{label:(0,v.t)("dashboard-settings.general.panel-options-graph-tooltip-label","Graph tooltip"),description:(0,v.t)("dashboard-settings.general.panel-options-graph-tooltip-description","Controls tooltip and hover highlight behavior across different panels. Reload the dashboard for changes to take effect"),children:(0,t.jsx)(Ee.z,{onChange:D,options:ua,value:e.graphTooltip})})}),(0,t.jsx)(se.a,{marginTop:3,children:e.meta.canDelete&&(0,t.jsx)(la,{})})]})})}const ga={updateTimeZone:Ie.lC,updateWeekStart:Ie.Ss},ma=(0,q.connect)(null,ga)(pa);var $t=o(3886);function fa({dashboard:e,sectionNav:n}){const s=e.getSaveModelClone(),[a,i]=(0,g.useState)(JSON.stringify(s,null,2)),r=n.node.parentItem,l=async()=>{await(0,Me.UA)().saveJSONDashboard(a),je.t.reloadPage()},d=(0,P.of)(va);return(0,t.jsx)(U.Y,{navModel:n,pageNav:r,children:(0,t.jsxs)("div",{className:d.wrapper,children:[(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.json-editor.subtitle",children:"The JSON model below is the data structure that defines the dashboard. This includes dashboard settings, panel settings, layout, queries, and so on."}),(0,t.jsx)($t.B,{value:a,language:"json",showMiniMap:!0,showLineNumbers:!0,onBlur:i,containerStyles:d.codeEditor}),e.meta.canSave&&(0,t.jsx)("div",{children:(0,t.jsx)(b.$n,{type:"submit",onClick:l,children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.json-editor.save-button",children:"Save changes"})})})]})})}const va=e=>({wrapper:(0,u.css)({display:"flex",height:"100%",flexDirection:"column",gap:e.spacing(2)}),codeEditor:(0,u.css)({flexGrow:1})});var st=o(80342),xa=o(575);const ba=({editLinkIdx:e,dashboard:n,onGoBack:s})=>{const[a,i]=(0,g.useState)(e!==null?n.links[e]:st.q),r=l=>{const d=[...n.links];d.splice(e,1,l),n.links=d,i(l)};return(0,t.jsx)(xa.d,{link:a,onUpdate:r,onGoBack:s})};var ya=o(69253);const ja=({dashboard:e,onNew:n,onEdit:s})=>{const[a,i]=(0,g.useState)(e.links),r=(c,h)=>{e.links=Ot.moveItemImmutably(a,c,c+h),i(e.links)},l=c=>{e.links=[...a,{...c}],i(e.links)},d=c=>{e.links=[...a.slice(0,c),...a.slice(c+1)],i(e.links)};return(0,t.jsx)(ya.X,{links:a,onNew:n,onEdit:s,onDuplicate:l,onDelete:d,onOrderChange:r})};function Sa({dashboard:e,sectionNav:n,editIndex:s}){const[a,i]=(0,g.useState)(!1),r=()=>{i(!1),y.Ny.partial({editIndex:void 0})},l=()=>{e.links=[...e.links,{...st.q}],i(!0),y.Ny.partial({editIndex:e.links.length-1})},d=p=>{i(!1),y.Ny.partial({editIndex:p})},c=s!==void 0;let h=n.node.parentItem;return c&&(h={text:a?"New link":"Edit link",subTitle:a?"Create a new link on your dashboard":"Edit a specific link of your dashboard",parentItem:n.node.parentItem}),(0,t.jsxs)(U.Y,{navModel:n,pageNav:h,children:[!c&&(0,t.jsx)(ja,{dashboard:e,onNew:l,onEdit:d}),c&&(0,t.jsx)(ba,{dashboard:e,editLinkIdx:s,onGoBack:r})]})}var ee=o(71857),Ca=o(6253),Pa=o(51738),Da=o(91354),Ta=o(41053);const Na=async(e,n)=>(je.t.ignoreNextSave(),await ee.wL.restoreDashboard(n.uid,e)),Ea=(e,n)=>{const s=(0,E.useSelector)(l=>l.dashboard.getModel()),[a,i]=(0,Ta.A)(async()=>await Na(w.$.featureToggles.kubernetesClientDashboardsFolders?e:n,s),[]),r=(0,Be._2)();return(0,g.useEffect)(()=>{if(a.value){const l=y.Ny.getLocation(),d=ye.I.stripBaseFromUrl(a.value.url),c=l.state?.routeReloadCounter;y.Ny.replace({...l,pathname:d,state:{routeReloadCounter:c?c+1:1}}),r.success("Dashboard restored",`Restored from version ${n}`)}},[a,n,r]),{state:a,onRestoreDashboard:i}},zt=({hideModal:e,id:n,version:s})=>{const{state:a,onRestoreDashboard:i}=Ea(n,s);return(0,g.useEffect)(()=>{!a.loading&&a.value&&e()},[a,e]),(0,t.jsx)(Ye.u,{isOpen:!0,title:"Restore Version",icon:"history",onDismiss:e,onConfirm:i,body:(0,t.jsxs)("p",{children:["Are you sure you want to restore the dashboard to version ",s,"? All unsaved changes will be lost."]}),confirmText:`Yes, restore to version ${s}`})},Ia=({baseInfo:e,newInfo:n,diffData:s,isNewLatest:a})=>{const i=(0,Da.G4)(s.lhs,s.rhs),r=(0,P.of)(Ma);return(0,t.jsxs)(V.B,{direction:"column",gap:1,children:[(0,t.jsxs)(V.B,{justifyContent:"space-between",alignItems:"center",children:[(0,t.jsxs)(V.B,{alignItems:"center",children:[(0,t.jsxs)("span",{className:(0,u.cx)(r.versionInfo,r.noMarginBottom),children:[(0,t.jsxs)("strong",{children:["Version ",e.version]})," updated by ",e.createdBy," ",e.ageString,e.message]}),(0,t.jsx)(H.I,{name:"arrow-right",size:"sm"}),(0,t.jsxs)("span",{className:r.versionInfo,children:[(0,t.jsxs)("strong",{children:["Version ",n.version]})," updated by ",n.createdBy," ",n.ageString,n.message]})]}),a&&(0,t.jsx)(k.$s,{children:({showModal:l,hideModal:d})=>(0,t.jsxs)(b.$n,{variant:"destructive",icon:"history",onClick:()=>{l(zt,{id:e.id,version:e.version,hideModal:d})},children:["Restore to version ",e.version]})})]}),Object.entries(i).map(([l,d])=>(0,t.jsx)(Ca.D,{diffs:d,title:l},l)),(0,t.jsx)(se.a,{paddingTop:2,children:(0,t.jsx)(Ke.M,{isOpen:!1,label:"View JSON Diff",children:(0,t.jsx)(Pa.M,{oldValue:JSON.stringify(s.lhs,null,2),newValue:JSON.stringify(s.rhs,null,2)})})})]})},Ma=e=>({versionInfo:(0,u.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize}),noMarginBottom:(0,u.css)({marginBottom:0})});var wa=o(73903);const Va=({versions:e,canCompare:n,onCheck:s})=>{const a=(0,P.of)(La);return(0,t.jsx)("div",{className:a.margin,children:(0,t.jsxs)("table",{className:"filter-table",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{className:"width-4"}),(0,t.jsx)("th",{className:"width-4",children:"Version"}),(0,t.jsx)("th",{className:"width-14",children:"Date"}),(0,t.jsx)("th",{className:"width-10",children:"Updated by"}),(0,t.jsx)("th",{children:"Notes"}),(0,t.jsx)("th",{})]})}),(0,t.jsx)("tbody",{children:e.map((i,r)=>(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:(0,t.jsx)(et.S,{"aria-label":`Toggle selection of version ${i.version}`,className:(0,u.css)({display:"inline"}),checked:i.checked,onChange:l=>s(l,i.id),disabled:!i.checked&&n})}),(0,t.jsx)("td",{children:i.version}),(0,t.jsx)("td",{children:i.createdDateString}),(0,t.jsx)("td",{children:i.createdBy}),(0,t.jsx)("td",{children:i.message}),(0,t.jsx)("td",{className:"text-right",children:r===0?(0,t.jsx)(wa.v,{name:"Latest",colorIndex:17}):(0,t.jsx)(k.$s,{children:({showModal:l,hideModal:d})=>(0,t.jsx)(b.$n,{variant:"secondary",size:"sm",icon:"history",onClick:()=>{l(zt,{id:i.id,version:i.version,hideModal:d})},children:"Restore"})})})]},i.id))})]})})};function La(e){return{margin:(0,u.css)({marginBottom:e.spacing(4)})}}const Aa=10;class Ra extends g.PureComponent{constructor(n){super(n),this.getVersions=(s=!1)=>{this.setState({isAppending:s});const a=this.continueToken?{limit:this.limit,start:this.start,continueToken:this.continueToken}:{limit:this.limit,start:this.start};ee.wL.getHistoryList(this.props.dashboard.uid,a).then(i=>{this.setState({isLoading:!1,versions:[...this.state.versions??[],...this.decorateVersions(i.versions)]}),this.start+=this.limit,this.continueToken=i.continueToken??""}).catch(i=>console.log(i)).finally(()=>this.setState({isAppending:!1}))},this.getDiff=async()=>{const s=this.state.versions.filter(c=>c.checked),[a,i]=s,r=a.version===this.props.dashboard.version;this.setState({isLoading:!0});let l,d;w.$.featureToggles.kubernetesClientDashboardsFolders?(l=await ee.wL.getDashboardVersion(this.props.dashboard.uid,i.id),d=await ee.wL.getDashboardVersion(this.props.dashboard.uid,a.id)):(l=await ee.wL.getDashboardVersion(this.props.dashboard.uid,i.version),d=await ee.wL.getDashboardVersion(this.props.dashboard.uid,a.version)),this.setState({baseInfo:i,isLoading:!1,isNewLatest:r,newInfo:a,viewMode:"compare",diffData:{lhs:l.data,rhs:d.data}})},this.decorateVersions=s=>s.map(a=>({...a,createdDateString:this.props.dashboard.formatDate(a.created),ageString:this.props.dashboard.getRelativeTime(a.created),checked:!1})),this.onCheck=(s,a)=>{this.setState({versions:this.state.versions.map(i=>i.id===a?{...i,checked:s.currentTarget.checked}:i)})},this.reset=()=>{this.continueToken="",this.setState({baseInfo:void 0,diffData:{lhs:"",rhs:""},isNewLatest:!1,newInfo:void 0,versions:this.state.versions.map(s=>({...s,checked:!1})),viewMode:"list"})},this.limit=Aa,this.start=0,this.continueToken="",this.state={isAppending:!0,isLoading:!0,versions:[],viewMode:"list",isNewLatest:!1,diffData:{lhs:"",rhs:""}}}componentDidMount(){this.getVersions()}isLastPage(){return this.state.versions.find(n=>n.version===1)}render(){const{versions:n,viewMode:s,baseInfo:a,newInfo:i,isNewLatest:r,isLoading:l,diffData:d}=this.state,c=n.filter(f=>f.checked).length===2,h=n.length>1,p=n.length>=this.limit,m=this.props.sectionNav.node.parentItem;return s==="compare"?(0,t.jsxs)(U.Y,{navModel:this.props.sectionNav,pageNav:m,children:[(0,t.jsx)(ee.me,{onClick:this.reset,baseVersion:a?.version,newVersion:i?.version,isNewLatest:r}),l?(0,t.jsx)(at,{msg:"Fetching changes\u2026"}):(0,t.jsx)(Ia,{newInfo:i,baseInfo:a,isNewLatest:r,diffData:d})]}):(0,t.jsxs)(U.Y,{navModel:this.props.sectionNav,pageNav:m,children:[l?(0,t.jsx)(at,{msg:"Fetching history list\u2026"}):(0,t.jsx)(Va,{versions:n,onCheck:this.onCheck,canCompare:c}),this.state.isAppending&&(0,t.jsx)(at,{msg:"Fetching more entries\u2026"}),h&&(0,t.jsx)(ee.rJ,{hasMore:p,canCompare:c,getVersions:this.getVersions,getDiff:this.getDiff,isLastPage:!!this.isLastPage()})]})}}const at=({msg:e})=>(0,t.jsxs)(_.Gy,{children:[(0,t.jsx)(He.y,{}),(0,t.jsx)("em",{children:e})]}),Ua=()=>y.Ny.partial({editview:null,editIndex:null});function Oa({dashboard:e,editview:n,pageNav:s,sectionNav:a}){const[i,r]=(0,g.useState)(0);(0,g.useEffect)(()=>{e.events.subscribe(G.Cf,()=>r(L=>L+1))},[e]);const l=(0,g.useMemo)(()=>Ba(e),[e,i]),d=()=>{e.meta.hasUnsavedFolderChange=!1},c=l.find(L=>L.id===n)??l[0],h=K.TP.hasEditPermissionInFolders,p=e.meta.canSave,m=(0,X.zy)(),f=za(m),T=Fa(s,a,l,c,m,e.uid),D="sm",S=[(0,t.jsx)(b.$n,{"data-testid":x.Tp.pages.Dashboard.Settings.Actions.close,variant:"secondary",fill:"outline",size:D,onClick:Ua,children:"Close"},"close"),h&&(0,t.jsx)(We.m,{dashboard:e,onSaveSuccess:d,variant:"secondary",size:D},"save as"),p&&(0,t.jsx)(We.C,{dashboard:e,onSaveSuccess:d,size:D},"Save")];return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Nt.H,{actions:(0,t.jsx)(Tt.U,{alignment:"right",children:S})}),(0,t.jsx)(c.component,{sectionNav:T,dashboard:e,editIndex:f})]})}function Ba(e){const n=[],s=(0,v.t)("dashboard-settings.general.title","General");e.meta.canEdit&&(n.push({title:s,id:"settings",icon:"sliders-v-alt",component:ma}),n.push({title:(0,v.t)("dashboard-settings.annotations.title","Annotations"),id:"annotations",icon:"comment-alt",component:Ys,subTitle:"Annotation queries return events that can be visualized as event markers in graphs across the dashboard."}),n.push({title:(0,v.t)("dashboard-settings.variables.title","Variables"),id:"templating",icon:"calculator-alt",component:As,subTitle:"Variables can make your dashboard more dynamic and act as global filters."}),n.push({title:(0,v.t)("dashboard-settings.links.title","Links"),id:"links",icon:"link",component:Sa})),e.meta.canMakeEditable&&n.push({title:s,icon:"sliders-v-alt",id:"settings",component:$a}),e.uid&&e.meta.canSave&&n.push({title:(0,v.t)("dashboard-settings.versions.title","Versions"),id:"versions",icon:"history",component:Ra});const a=(0,v.t)("dashboard-settings.permissions.title","Permissions");return e.uid&&e.meta.canAdmin&&K.TP.hasPermission(E.AccessControlAction.DashboardsPermissionsRead)&&n.push({title:a,id:"permissions",icon:"lock",component:Us}),n.push({title:(0,v.t)("dashboard-settings.json-editor.title","JSON Model"),id:"dashboard_json",icon:"arrow",component:fa}),n}function kt(e,n){return{...e,parentItem:e.parentItem?kt(e.parentItem,n):n}}function Fa(e,n,s,a,i,r){const l={text:(0,v.t)("dashboard-settings.settings.title","Settings"),children:[],icon:"apps",hideFromBreadcrumbs:!1,url:ye.I.getUrlForPartial(i,{editview:"settings",editIndex:null})};l.children=s.map(c=>({text:c.title,icon:c.icon,id:`${r}/${c.id}`,url:ye.I.getUrlForPartial(i,{editview:c.id,editIndex:null}),active:c===a,parentItem:l,subTitle:c.subTitle}));const d=kt(e,n.main);return l.parentItem=d,{main:l,node:l.children.find(c=>c.active)}}function $a({dashboard:e,sectionNav:n}){return(0,t.jsx)(U.Y,{navModel:n,children:(0,t.jsxs)(V.B,{direction:"column",gap:2,alignItems:"flex-start",children:[(0,t.jsx)(Ce.E,{variant:"h3",children:"Dashboard not editable"}),(0,t.jsx)(b.$n,{type:"submit",onClick:()=>e.makeEditable(),children:"Make editable"})]})})}function za(e){const n=new URLSearchParams(e.search).get("editIndex");if(n!=null)return parseInt(n,10)}var $=o(76530),Gt=o(56152),it=o(70713),Wt=o(58528),ot=o(10247),we=o(88849),Kt=o(93604),pe=o(29010),ka=o(4213),Ga=o.n(ka),Wa=o(88090),Ve=o(59141),Ka=o(5761),Ha=o(47506),de=o(80757),Ht=o(5573),ge=(e=>(e[e.Support=0]="Support",e[e.Data=1]="Data",e))(ge||{}),Le=(e=>(e[e.PanelSnapshot=0]="PanelSnapshot",e[e.GithubComment=1]="GithubComment",e))(Le||{});class Qa extends Ka.Q{constructor(n){super({panel:n,panelTitle:n.replaceVariables(n.title,void 0,"text")||"Panel",currentTab:0,showMessage:1,snapshotText:"",markdownText:"",randomize:{},snapshotUpdate:0,options:[{label:"GitHub comment",description:"Copy and paste this message into a GitHub issue or comment",value:1},{label:"Panel support snapshot",description:"Dashboard JSON used to help troubleshoot visualization issues",value:0}]}),this.onCurrentTabChange=s=>{this.setState({currentTab:s})},this.onShowMessageChange=s=>{this.setState({showMessage:s.value})},this.onGetMarkdownForClipboard=()=>{const{markdownText:s}=this.state,a=Math.pow(1024,2)*1.5;return s.length>a?(this.setState({error:{title:"Copy to clipboard failed",message:"Snapshot is too large, consider download and attaching a file instead"}}),""):s},this.onDownloadDashboard=()=>{const{snapshotText:s,panelTitle:a}=this.state,i=new Blob([s],{type:"text/plain"}),r=`debug-${a}-${(0,Wa.LE)(new Date)}.json.txt`;Ga()(i,r)},this.onSetSnapshotText=s=>{this.setState({snapshotText:s})},this.onToggleRandomize=s=>{const{randomize:a}=this.state;this.setState({randomize:{...a,[s]:!a[s]}})}}async buildDebugDashboard(){const{panel:n,randomize:s,snapshotUpdate:a}=this.state,i=await(0,Ht.E_)(n,s,(0,de.jG)().timeRange()),r=JSON.stringify(i,null,2),l=(0,Ht.jD)(n,r),d=(0,Ve.cN)((0,Ve.j_)("bytes")(r?.length??0));let c;if(!n.isAngularPlugin())try{const h=new xt.G(i,{isEmbedded:!0});c=(0,Ha.EH)(h,i).state.body}catch(h){console.log("Error creating scene:",h)}this.setState({snapshot:i,snapshotText:r,markdownText:l,snapshotSize:d,snapshotUpdate:a+1,scene:c})}}function Ja({panel:e,plugin:n,onClose:s}){const a=(0,P.of)(Ya),i=(0,g.useMemo)(()=>new Qa(e),[e]),{currentTab:r,loading:l,error:d,options:c,showMessage:h,snapshotSize:p,markdownText:m,snapshotText:f,randomize:T,panelTitle:D,scene:S}=i.useState();if((0,g.useEffect)(()=>{i.buildDebugDashboard()},[i,n,T]),!n)return null;const L=[{label:"Snapshot",value:ge.Support},{label:"Data",value:ge.Data}],B=w.$.supportBundlesEnabled&&K.TP.hasPermission(E.AccessControlAction.ActionSupportBundlesCreate);return(0,t.jsxs)(Wt._,{title:"Get help with this panel",size:"lg",onClose:s,subtitle:(0,t.jsxs)(V.B,{direction:"column",gap:1,children:[(0,t.jsx)(V.B,{direction:"row",gap:1,children:(0,t.jsxs)("a",{href:"https://grafana.com/docs/grafana/latest/troubleshooting/",target:"blank",className:"external-link",rel:"noopener noreferrer",children:["Troubleshooting docs ",(0,t.jsx)(H.I,{name:"external-link-alt"})]})}),(0,t.jsx)("span",{className:"muted",children:(0,t.jsx)(v.x6,{i18nKey:"help-wizard.troubleshooting-help",children:"To request troubleshooting help, send a snapshot of this panel to Grafana Labs Technical Support. The snapshot contains query response data and panel settings."})}),B&&(0,t.jsx)("span",{className:"muted",children:(0,t.jsxs)(v.x6,{i18nKey:"help-wizard.support-bundle",children:["You can also retrieve a support bundle containing information concerning your Grafana instance and configured datasources in the ",(0,t.jsx)("a",{href:"/support-bundles",children:"support bundles section"}),"."]})})]}),tabs:(0,t.jsx)(ot.U,{children:L.map((R,ie)=>(0,t.jsx)(we.o,{label:R.label,active:R.value===r,onChangeTab:()=>i.onCurrentTabChange(R.value)},`${R.value}-${ie}`))}),children:[l&&(0,t.jsx)(He.y,{}),d&&(0,t.jsx)(W.F,{title:d.title,children:d.message}),r===ge.Data&&(0,t.jsxs)("div",{className:a.code,children:[(0,t.jsxs)("div",{className:a.opts,children:[(0,t.jsx)(A.D,{label:"Template",className:a.field,children:(0,t.jsx)(tt.l6,{options:c,value:h,onChange:i.onShowMessageChange})}),h===Le.GithubComment?(0,t.jsx)(Kt.b,{icon:"copy",getText:i.onGetMarkdownForClipboard,children:"Copy to clipboard"}):(0,t.jsxs)(b.$n,{icon:"download-alt",onClick:i.onDownloadDashboard,children:["Download (",p,")"]})]}),(0,t.jsx)(it.default,{disableWidth:!0,children:({height:R})=>(0,t.jsx)($t.B,{width:"100%",height:R,language:h===Le.GithubComment?"markdown":"json",showLineNumbers:!0,showMiniMap:!0,value:h===Le.GithubComment?m:f,readOnly:!1,onBlur:i.onSetSnapshotText})})]}),r===ge.Support&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(A.D,{label:"Obfuscate data",description:"Modify the original data to hide sensitve information.  Note the lengths will stay the same, and duplicate values will be equal.",children:(0,t.jsxs)(V.B,{direction:"row",gap:1,children:[(0,t.jsx)(pe.K,{label:"Labels",id:"randomize-labels",showLabel:!0,value:!!T.labels,onChange:()=>i.onToggleRandomize("labels")}),(0,t.jsx)(pe.K,{label:"Field names",id:"randomize-field-names",showLabel:!0,value:!!T.names,onChange:()=>i.onToggleRandomize("names")}),(0,t.jsx)(pe.K,{label:"String values",id:"randomize-string-values",showLabel:!0,value:!!T.values,onChange:()=>i.onToggleRandomize("values")})]})}),(0,t.jsx)(A.D,{label:"Support snapshot",description:`Panel: ${D}`,children:(0,t.jsxs)(V.B,{children:[(0,t.jsxs)(b.$n,{icon:"download-alt",onClick:i.onDownloadDashboard,children:[(0,t.jsx)(v.x6,{i18nKey:"help-wizard.download-snapshot",children:"Download snapshot"})," (",p,")"]}),(0,t.jsx)(Kt.b,{icon:"github",getText:i.onGetMarkdownForClipboard,title:"Copy a complete GitHub comment to the clipboard",children:(0,t.jsx)(v.x6,{i18nKey:"help-wizard.github-comment",children:"Copy Github comment"})})]})}),(0,t.jsx)(it.default,{disableWidth:!0,children:({height:R})=>(0,t.jsx)("div",{style:{height:R,overflow:"auto"},children:S&&(0,t.jsx)(S.Component,{model:S})})})]})]})}const Ya=e=>({code:(0,u.css)({flexGrow:1,height:"100%",overflow:"scroll"}),field:(0,u.css)({width:"100%"}),opts:(0,u.css)({display:"flex",width:"100%",flexGrow:0,alignItems:"center",justifyContent:"flex-end",button:{marginLeft:"8px"}})}),rt=(e,n,s)=>{const a=(0,g.useRef)(),[i,r]=(0,g.useState)();return(0,g.useEffect)(()=>{let l=-1,d=0;return a.current=e.getQueryRunner().getData({withTransforms:n.withTransforms,withFieldConfig:!1}).subscribe({next:c=>{if(s){if(l===c.structureRev){const h=Date.now();if(h-d<1e4)return;d=h}l=c.structureRev??-1}r(c)}}),()=>{a.current&&a.current.unsubscribe()}},[e,n.withTransforms]),{data:i,isLoading:i?.state===De.Gu.Loading,hasSeries:i?!!i.series:!1,hasError:!!(i&&(i.error||i?.errors?.length||i.state===De.Gu.Error))}};var Xa=o(16753),Qt=o(39736),Za=o(16568),qa=o(67042),_a=o(96226);const ei=({data:e,metadataDatasource:n})=>!n||!n.components?.MetadataInspector?(0,t.jsx)(v.x6,{i18nKey:"dashboard.inspect-meta.no-inspector",children:"No Metadata Inspector"}):(0,t.jsx)(n.components.MetadataInspector,{datasource:n,data:e.series});var ti=o(94681),ni=o(64050);const si=({panel:e,plugin:n,dashboard:s,tabs:a,data:i,isDataLoading:r,dataOptions:l,metadataDatasource:d,defaultTab:c,onDataOptionsChange:h,onClose:p})=>{const[m,f]=(0,g.useState)(c??$.q.Data);if(!n)return null;let T=ai(i),D=m;a.find(B=>B.value===m)||(D=$.q.JSON);const S=(0,Qt.w)().replace(e.title,e.scopedVars,"text")||"Panel",L=(0,v.t)("dashboard.inspect.title","Inspect: {{panelTitle}}",{panelTitle:S});return(0,t.jsxs)(Wt._,{title:L,subtitle:i&&ii(i),onClose:p,tabs:(0,t.jsx)(ot.U,{children:a.map((B,R)=>(0,t.jsx)(we.o,{label:B.label,active:B.value===D,onChangeTab:()=>f(B.value||$.q.Data)},`${B.value}-${R}`))}),children:[D===$.q.Data&&(0,t.jsx)(Za.q,{dataName:S,panelPluginId:e.type,fieldConfig:e.fieldConfig,hasTransformations:!!e.transformations?.length,data:i&&i.series,isLoading:r,options:l,onOptionsChange:h,timeZone:s.timezone,app:Xa.Jk.Dashboard}),i&&D===$.q.Meta&&(0,t.jsx)(ei,{data:i,metadataDatasource:d}),D===$.q.JSON&&(0,t.jsx)(_a.w,{panel:e,dashboard:s,data:i,onClose:p}),D===$.q.Error&&(0,t.jsx)(qa.y,{errors:T}),i&&D===$.q.Stats&&(0,t.jsx)(ti.N,{data:i,timeZone:s.getTimezone()}),i&&D===$.q.Query&&(0,t.jsx)(ni.e,{data:i,onRefreshQuery:()=>e.refresh()})]})};function ai(e){let n=e?.errors??[];return e?.error&&!n.includes(e.error)&&(n=[e.error,...n]),!n.length&&e?.state===De.Gu.Error?[{message:"Error loading data"}]:n}function ii(e){const{request:n}=e;if(!n||(0,re.isEmpty)(n))return"";const s=n.targets.length,a=n.endTime?n.endTime-n.startTime:0,i=(0,Ve.cN)((0,Ve.j_)("ms")(a));return(0,t.jsxs)(v.x6,{i18nKey:"dashboard.inspect.subtitle",children:[{queryCount:s}," queries with total query time of ",{formatted:i}]})}var Jt=o(52933);const oi=({panel:e,dashboard:n,plugin:s})=>{const a=(0,X.zy)(),i=new URLSearchParams(a.search).get("inspectTab"),[r,l]=(0,g.useState)({withTransforms:i===$.q.Error,withFieldConfig:!0}),{data:d,isLoading:c,hasError:h}=rt(e,r,!1),p=(0,Jt.sd)(d),m=(0,Jt.kx)(e,n,s,h,p),f=()=>{y.Ny.partial({inspect:null,inspectTab:null})};return s?i===$.q.Help?(0,t.jsx)(Ja,{panel:e,plugin:s,onClose:f}):(0,t.jsx)(si,{dashboard:n,panel:e,plugin:s,defaultTab:i,tabs:m,data:d,isDataLoading:c,dataOptions:r,onDataOptionsChange:l,metadataDatasource:p,onClose:f}):null},ri=(e,n)=>{const s=(0,Gt.U)(e,n.panel);return s?{plugin:s.plugin}:{plugin:null}},li=(0,q.connect)(ri)(oi);var Yt=o(64423),lt=o(52120),Xt=o(90617),Zt=o(68717),dt=o(14964),di=o(44690);const ci=e=>{const n=(0,g.useMemo)(()=>Xe.B.get(e.variable.type).picker,[e.variable]);return e.variable?(0,t.jsxs)(V.B,{gap:0,children:[(0,t.jsx)(hi,{variable:e.variable}),e.variable.hide!==dt.zL.hideVariable&&n&&(0,t.jsx)(n,{variable:e.variable,readOnly:e.readOnly??!1})]}):(0,t.jsx)("div",{children:"Couldn't load variable"})};function hi({variable:e}){const n=(0,g.useMemo)(()=>e.label||e.name,[e]);if(e.hide!==dt.zL.dontHide)return null;const s=di.qz+e.id;return e.description?(0,t.jsx)(Pe.m,{content:e.description,placement:"bottom",children:(0,t.jsx)("label",{className:"gf-form-label gf-form-label--variable","data-testid":x.Tp.pages.Dashboard.SubMenu.submenuItemLabels(n),htmlFor:s,children:n})}):(0,t.jsx)("label",{className:"gf-form-label gf-form-label--variable","data-testid":x.Tp.pages.Dashboard.SubMenu.submenuItemLabels(n),htmlFor:s,children:n})}const qt=({variables:e,readOnly:n})=>{const[s,a]=(0,g.useState)([]),i=(0,P.of)(ui);return(0,g.useEffect)(()=>{a(e.filter(r=>r.hide!==dt.zL.hideVariable))},[e]),s.length===0?null:(0,t.jsx)(t.Fragment,{children:s.map(r=>(0,t.jsx)("div",{className:i.submenuItem,"data-testid":x.Tp.pages.Dashboard.SubMenu.submenuItem,children:(0,t.jsx)(ci,{variable:r,readOnly:n})},r.id))})},ui=e=>({submenuItem:(0,u.css)({display:"inline-block",".fa-caret-down":{fontSize:"75%",paddingLeft:e.spacing(1)},".gf-form":{marginBottom:0}})});var pi=o(89880),gi=o(46888),_t=o(54506),mi=o(59051),fi=o(39601),vi=o(23040),xi=o(91098),bi=o(90333),yi=o(84132);const en=e=>n=>n.plugins.panels[e]||(0,yi.$)(`Panel plugin not found (${e})`,!0),ct=({panel:e})=>{const n=(0,E.useDispatch)(),s=(0,E.useSelector)(en(e.type)),a=(0,E.useSelector)(d=>d.panelEditor.ui.isPanelOptionsVisible),i=(0,E.useSelector)(d=>d.panelEditor.isVizPickerOpen),r=()=>{n((0,Q.eK)(!i))},l=()=>{n(Ge({isPanelOptionsVisible:!a}))};return s?(0,t.jsx)("div",{className:tn.wrapper,children:(0,t.jsxs)(bi.e,{children:[(0,t.jsx)(lt.I,{className:tn.vizButton,tooltip:"Click to change visualization",imgSrc:s.meta.info.logos.small,isOpen:i,onClick:r,"data-testid":x.Tp.components.PanelEditor.toggleVizPicker,"aria-label":"Change Visualization",variant:"canvas",fullWidth:!0,children:s.meta.name}),(0,t.jsx)(lt.I,{tooltip:a?"Close options pane":"Show options pane",icon:a?"angle-right":"angle-left",onClick:l,variant:"canvas","data-testid":x.Tp.components.PanelEditor.toggleVizOptions,"aria-label":a?"Close options pane":"Show options pane"})]})}):null};ct.displayName="VisualizationTab";const tn={wrapper:(0,u.css)({display:"flex",flexDirection:"column"}),vizButton:(0,u.css)({textAlign:"left"})};var ji=o(78685),Si=o(22560),nn=o(99134),Ci=o(40828),Pi=o(90935),Di=o(34741);const Ti=({onConfirm:e,onDismiss:n,panel:s})=>{const a=(0,_t.X)(s),i=`${a?"Changing":"Replace with"} library panel`,r=`${a?"Changing":"Replacing with a"} library panel will remove any changes since last save.`;return(0,t.jsx)(Ye.u,{onConfirm:e,onDismiss:n,confirmText:a?"Change":"Replace",title:i,body:r,dismissText:"Cancel",isOpen:!0})};var Ni=o(89081);const Ei=({panel:e,searchQuery:n})=>{const[s,a]=(0,g.useState)(!1),[i,r]=(0,g.useState)(void 0),[l,d]=(0,g.useState)([]),c=(0,g.useCallback)(D=>{d(D.map(S=>S.id))},[d]),h=(0,Me.UA)().getCurrent(),p=(0,E.useDispatch)(),m=async()=>{i&&(r(void 0),p((0,ke.Xk)(e,i)))},f=()=>a(!0),T=()=>r(void 0);return(0,t.jsxs)(_.gW,{spacing:"md",children:[!e.libraryPanel&&(0,t.jsx)(_.gW,{align:"center",children:(0,t.jsx)(b.$n,{icon:"plus",onClick:f,variant:"secondary",fullWidth:!0,children:"Create new library panel"})}),(0,t.jsx)(Pi.$,{onChange:c}),(0,t.jsx)("div",{className:Ii.libraryPanelsView,children:(0,t.jsx)(Ni.y,{currentPanelId:e.libraryPanel?.uid,searchString:n,panelFilter:l,onClickCard:r,showSecondaryActions:!0})}),s&&(0,t.jsx)(Di.o,{panel:e,onDismiss:()=>a(!1),initialFolderUid:h?.meta.folderUid,isOpen:s}),i&&(0,t.jsx)(Ti,{panel:e,onDismiss:T,onConfirm:m})]})},Ii={libraryPanelsView:(0,u.css)({width:"100%"})};var Mi=o(31099),wi=o(74201),M=o(75342);const sn=({panel:e,data:n})=>{const s=(0,E.useSelector)(en(e.type)),[a,i]=(0,g.useState)(""),r=Ci.wV,l=M.__.Visualizations,[d,c]=(0,ji.A)(r,l),h=(0,E.useDispatch)(),p=(0,P.of)(Vi),m=(0,g.useRef)(null),f=(0,g.useCallback)(S=>{h((0,ke.gW)({panel:e,...S})),S.withModKey||h((0,Q.eK)(!1))},[h,e]),T=()=>{h((0,Q.eK)(!1))};if(!s)return null;const D=[{label:"Visualizations",value:M.__.Visualizations},{label:"Suggestions",value:M.__.Suggestions},{label:"Library panels",value:M.__.LibraryPanels,description:"Reusable panels you can share between multiple dashboards."}];return(0,t.jsxs)("div",{className:p.openWrapper,children:[(0,t.jsxs)("div",{className:p.formBox,children:[(0,t.jsxs)("div",{className:p.searchRow,children:[(0,t.jsx)(Si.Z,{value:a,onChange:i,ref:m,autoFocus:!0,placeholder:"Search for..."}),(0,t.jsx)(b.$n,{title:"Close",variant:"secondary",icon:"angle-up",className:p.closeButton,"aria-label":x.Tp.components.PanelEditor.toggleVizPicker,onClick:T})]}),(0,t.jsx)(A.D,{className:p.customFieldMargin,children:(0,t.jsx)(Ee.z,{options:D,value:d,onChange:c,fullWidth:!0})})]}),(0,t.jsx)("div",{className:p.scrollWrapper,children:(0,t.jsx)(nn.P,{children:(0,t.jsxs)("div",{className:p.scrollContent,children:[d===M.__.Visualizations&&(0,t.jsx)(wi.G,{pluginId:s.meta.id,onChange:f,searchQuery:a}),d===M.__.Suggestions&&(0,t.jsx)(Mi.a,{onChange:f,searchQuery:a,panel:e,data:n}),d===M.__.LibraryPanels&&(0,t.jsx)(Ei,{searchQuery:a,panel:e},"Panel Library")]})})})]})};sn.displayName="VisualizationSelectPane";const Vi=e=>({icon:(0,u.css)({color:e.v1.palette.gray33}),wrapper:(0,u.css)({display:"flex",flexDirection:"column",flex:"1 1 0",height:"100%"}),vizButton:(0,u.css)({textAlign:"left"}),scrollWrapper:(0,u.css)({flexGrow:1,minHeight:0}),scrollContent:(0,u.css)({padding:e.spacing(1)}),openWrapper:(0,u.css)({display:"flex",flexDirection:"column",flex:"1 1 100%",height:"100%",background:e.colors.background.primary,border:`1px solid ${e.colors.border.weak}`}),searchRow:(0,u.css)({display:"flex",marginBottom:e.spacing(1)}),closeButton:(0,u.css)({marginLeft:e.spacing(1)}),customFieldMargin:(0,u.css)({marginBottom:e.spacing(1)}),formBox:(0,u.css)({padding:e.spacing(1),paddingBottom:0})}),Li=({plugin:e,panel:n,onFieldConfigsChange:s,onPanelOptionsChanged:a,onPanelConfigChange:i,dashboard:r,instanceState:l})=>{const d=(0,P.of)(Ai),c=(0,E.useSelector)(p=>p.panelEditor.isVizPickerOpen),{data:h}=rt(n,{withTransforms:!0,withFieldConfig:!1},!0);return(0,t.jsxs)("div",{className:d.wrapper,"data-testid":x.Tp.components.PanelEditor.OptionsPane.content,children:[!c&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:d.vizButtonWrapper,children:(0,t.jsx)(ct,{panel:n})}),(0,t.jsx)("div",{className:d.optionsWrapper,children:(0,t.jsx)(xi.Ff,{panel:n,dashboard:r,plugin:e,instanceState:l,data:h,onFieldConfigsChange:s,onPanelOptionsChanged:a,onPanelConfigChange:i})})]}),c&&(0,t.jsx)(sn,{panel:n,data:h})]})},Ai=e=>({wrapper:(0,u.css)({height:"100%",width:"100%",display:"flex",flex:"1 1 0",flexDirection:"column",padding:0}),optionsWrapper:(0,u.css)({flexGrow:1,minHeight:0}),vizButtonWrapper:(0,u.css)({padding:`0 ${e.spacing(2,2)} 0`}),legacyOptions:(0,u.css)({label:"legacy-options",".panel-options-grid":{display:"flex",flexDirection:"column"},".panel-options-group":{marginBottom:0},".panel-options-group__body":{padding:`${e.spacing(2)} 0`},".section":{display:"block",margin:`${e.spacing(2)} 0`,"&:first-child":{marginTop:0}}})});var an=o(86833),Ri=o(96325),Ui=o(35884),Oi=o(60997),Bi=(e=>(e.Error="Error",e.Info="Info",e.Links="Links",e))(Bi||{});class Fi extends g.Component{constructor(){super(...arguments),this.timeSrv=(0,de.jG)(),this.getInfoMode=()=>{const{panel:n,error:s}=this.props;if(s)return"Error";if(n.description)return"Info";if(n.links&&n.links.length)return"Links"},this.getInfoContent=()=>{const{panel:n,theme:s}=this.props,a=n.description||"",i=(0,Qt.w)().replace(a,n.scopedVars),r=(0,Oi.G)(i),l=this.props.links&&this.props.links.getLinks(n.replaceVariables),d=ki(s);return(0,t.jsxs)("div",{className:d.content,children:[(0,t.jsx)("div",{dangerouslySetInnerHTML:{__html:r}}),l&&l.length>0&&(0,t.jsx)("ul",{className:d.cornerLinks,children:l.map((c,h)=>(0,t.jsx)("li",{children:(0,t.jsx)("a",{href:c.href,target:c.target,children:c.title})},h))})]})},this.onClickError=()=>{y.Ny.partial({inspect:this.props.panel.id,inspectTab:$.q.Error})}}render(){const{error:n}=this.props,s=this.getInfoMode();return s?s==="Error"&&n?(0,t.jsx)(on,{infoMode:s,content:n,onClick:this.onClickError}):s==="Info"||s==="Links"?(0,t.jsx)(on,{infoMode:s,content:this.getInfoContent}):null:null}}const $i=(0,P.cV)(Fi);function on({infoMode:e,content:n,onClick:s}){const a=e==="Error"?"error":"info",i=x.Tp.components.Panels.Panel.headerCornerInfo(e.toLowerCase()),r=(0,P.of)(Gi);return(0,t.jsx)(Pe.m,{content:n,placement:"top-start",theme:a,interactive:!0,children:(0,t.jsxs)("button",{type:"button",className:r.infoCorner,onClick:s,"aria-label":i,children:[(0,t.jsx)(H.I,{name:zi[e],size:e==="Links"?"sm":"lg",className:(0,u.cx)(r.icon,{[r.iconLinks]:e==="Links"})}),(0,t.jsx)("span",{className:(0,u.cx)(r.inner,{[r.error]:e==="Error"})})]})})}const zi={Error:"exclamation",Info:"info",Links:"external-link-alt"},ki=e=>({content:(0,u.css)({overflow:"auto",code:{whiteSpace:"normal",wordWrap:"break-word"},"pre > code":{display:"block"}}),cornerLinks:(0,u.css)({listStyle:"none",paddingLeft:0})}),Gi=e=>({icon:(0,u.css)({position:"absolute",top:0,left:0,zIndex:2,fill:e.colors.text.maxContrast}),iconLinks:(0,u.css)({left:e.spacing(.5),top:e.spacing(.25)}),inner:(0,u.css)({width:0,height:0,position:"absolute",left:0,bottom:0,borderBottom:`${e.spacing(4)} solid transparent`,borderLeft:`${e.spacing(4)} solid ${e.colors.background.secondary}`}),error:(0,u.css)({borderLeftColor:e.colors.error.main}),infoCorner:(0,u.css)({background:"none",border:"none",color:e.colors.text.secondary,cursor:"pointer",position:"absolute",left:0,top:0,width:e.spacing(4),height:e.spacing(4),zIndex:3})});function Wi({width:e,height:n,panel:s,dashboard:a}){const{data:i}=rt(s,{withTransforms:!0,withFieldConfig:!1},!1),[r,l]=(0,g.useState)({frameIndex:0,showHeader:!0,showTypeIcons:!0});if((0,g.useEffect)(()=>{const c=(0,de.jG)(),h=s.events.subscribe(an._,()=>{const p=(0,bt.nk)(s,c.timeRange());s.runAllPanelQueries({dashboardUID:a.uid,dashboardTimezone:a.getTimezone(),timeData:p,width:e})});return()=>{h.unsubscribe()}},[s,a,e]),!i)return null;const d=i?.errors?i.errors.length>1?"Multiple errors found. Click for more details":i.errors[0].message:i?.error?.message;return(0,t.jsx)(Ri.NR,{width:e,height:n,padding:"none",children:(c,h)=>(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)($i,{panel:s,error:d}),(0,t.jsx)(Ui.m,{title:"Raw data",pluginId:"table",width:c,height:h,data:i,options:r,onOptionsChange:l})]})})}var rn=o(34798),ln=o(5005),Ki=o(11238),dn=o(32757);const Hi=({panel:e,dashboard:n,...s})=>{const{rules:a,loading:i}=(0,dn.S)({panelId:e.id,dashboardUID:n.uid});return(0,t.jsx)(we.o,{...s,counter:i?null:a.length})};var Qi=o(81876),Ji=o(93407),cn=o(83893),Yi=o(82096);const hn=({dashboard:e,panel:n,className:s})=>{const a=(0,E.useSelector)(c=>c.templating),i=(0,X.zy)(),{loading:r,value:l}=(0,te.A)(()=>(0,Yi.mp)(n,e),[n,e,a]);if(r)return(0,t.jsx)(b.$n,{disabled:!0,children:"New alert rule"});if(!l)return(0,t.jsx)(W.F,{severity:"info",title:"No alerting capable query found",children:"Cannot create alerts from this panel because no query to an alerting capable datasource is found."});const d=Ji.kM.renderUrl("alerting/new",{defaults:JSON.stringify(l),returnTo:i.pathname+i.search});return(0,t.jsx)(b.z9,{icon:"bell",onClick:()=>(0,cn.fH)(cn.le.alertRuleFromPanel),href:d,className:s,"data-testid":"create-alert-rule-button",children:"New alert rule"})};var Xi=o(88755),un=o(96621),Zi=o(85651);const qi=({dashboard:e,panel:n})=>{const s=(0,P.of)(_i),{errors:a,loading:i,rules:r}=(0,dn.S)({dashboardUID:e.uid,panelId:n.id,poll:!0}),l=(0,un.Wd)("grafana"),d=w.$.unifiedAlertingEnabled&&K.TP.hasPermission(l.create),c=a.length?(0,t.jsx)(W.F,{title:"Errors loading rules",severity:"error",children:a.map((p,m)=>(0,t.jsxs)("div",{children:["Failed to load Grafana rules state: ",(0,Zi.JZ)(p)]},m))}):null;if(i&&!r.length)return(0,t.jsxs)("div",{className:s.innerWrapper,children:[c,(0,t.jsx)(Qi._,{text:"Loading rules..."})]});if(r.length)return(0,t.jsx)(nn.P,{minHeight:"100%",children:(0,t.jsxs)("div",{className:s.innerWrapper,children:[c,(0,t.jsx)(Xi.sF,{rules:r}),!!e.meta.canSave&&d&&(0,t.jsx)(hn,{className:s.newButton,panel:n,dashboard:e})]})});const h=!e.uid;return(0,t.jsxs)("div",{"data-testid":x.Tp.components.PanelAlertTabContent.content,className:s.noRulesWrapper,children:[c,!h&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{children:(0,t.jsx)(v.x6,{i18nKey:"dashboard.panel-edit.alerting-tab.no-rules",children:"There are no alert rules linked to this panel."})}),!!e.meta.canSave&&d&&(0,t.jsx)(hn,{panel:n,dashboard:e})]}),h&&!!e.meta.canSave&&(0,t.jsx)(W.F,{severity:"info",title:"Dashboard not saved",children:(0,t.jsx)(v.x6,{i18nKey:"dashboard.panel-edit.alerting-tab.dashboard-not-saved",children:"Dashboard must be saved before alerts can be added."})})]})},_i=e=>({newButton:(0,u.css)({marginTop:e.spacing(3)}),innerWrapper:(0,u.css)({padding:e.spacing(2)}),noRulesWrapper:(0,u.css)({margin:e.spacing(2),backgroundColor:e.colors.background.secondary,padding:e.spacing(3)})});var eo=o(45177),to=o(37485),ht=o(10059),no=o(61648),so=o(61976);class ao extends g.PureComponent{constructor(n){super(n),this.updateLastUsedDatasource=s=>{(0,to.tw)(s)},this.onRunQueries=()=>{this.props.panel.refresh()},this.onOpenQueryInspector=()=>{y.Ny.partial({inspect:this.props.panel.id,inspectTab:"query"})},this.onOptionsChange=s=>{const{panel:a}=this.props;a.updateQueries(s),s.dataSource.uid!==a.datasource?.uid&&setTimeout(this.onRunQueries,10),this.forceUpdate()}}buildQueryOptions(n){const s=n.datasource??{default:!0},a=(0,ht.tR)().getInstanceSettings(s);return this.updateLastUsedDatasource(s),{cacheTimeout:a?.meta.queryOptions?.cacheTimeout?n.cacheTimeout:void 0,dataSource:{default:a?.isDefault,...a?(0,Te.p$)(a):{type:void 0,uid:void 0}},queryCachingTTL:a?.cachingConfig?.enabled?n.queryCachingTTL:void 0,queries:n.targets,maxDataPoints:n.maxDataPoints,minInterval:n.interval,timeRange:{from:n.timeFrom,shift:n.timeShift,hide:n.hideTimeOverride}}}async componentDidMount(){const{panel:n}=this.props;if(!n.datasource){let s;const a=(0,Me.UA)().getCurrent()?.uid??"",i=(0,so.CW)(a);i?.datasourceUid!==null&&(s=(0,ht.tR)().getInstanceSettings(i?.datasourceUid)),s||(s=(0,ht.tR)().getInstanceSettings(null)),n.datasource=(0,Te.p$)(s),this.forceUpdate()}}render(){const{panel:n}=this.props;if(!n.datasource)return null;const s=this.buildQueryOptions(n);return(0,t.jsx)(no.g,{options:s,queryRunner:n.getQueryRunner(),onRunQueries:this.onRunQueries,onOpenQueryInspector:this.onOpenQueryInspector,onOptionsChange:this.onOptionsChange})}}const pn=(0,g.memo)(({panel:e,dashboard:n,tabs:s,onChangeTab:a})=>{const i=(0,rn.C)(),r=(0,P.of)(oo),l=(0,g.useCallback)(h=>{let p="panel_editor_tabs_changed";w.$.featureToggles.transformationsRedesign&&(p="transformations_redesign_"+p),h.active||(0,J.rR)(p,{tab_id:h.id}),a(h)},[a]);(0,g.useEffect)(()=>{const h=new Yt.yU;return h.add(e.events.subscribe(G.zq,i)),h.add(e.events.subscribe(G.JI,i)),()=>h.unsubscribe()},[e,n,i]);const d=s.find(h=>h.active);if(s.length===0)return null;const c=w.$.unifiedAlertingEnabled;return(0,t.jsxs)("div",{className:r.wrapper,children:[(0,t.jsx)(ot.U,{className:r.tabBar,hideBorder:!0,children:s.map(h=>h.id===M.M8.Alert&&c?(0,t.jsx)(Hi,{label:h.text,active:h.active,onChangeTab:()=>a(h),icon:(0,ln.Uo)(h.icon),panel:e,dashboard:n},h.id):(0,t.jsx)(we.o,{label:h.text,active:h.active,onChangeTab:()=>l(h),icon:(0,ln.Uo)(h.icon),counter:io(e,h)},h.id))}),(0,t.jsxs)(Ki.J,{className:r.tabContent,children:[d.id===M.M8.Query&&(0,t.jsx)(ao,{panel:e,queries:e.targets}),d.id===M.M8.Alert&&(0,t.jsx)(qi,{panel:e,dashboard:n}),d.id===M.M8.Transform&&(0,t.jsx)(eo.o,{panel:e})]})]})});pn.displayName="PanelEditorTabs";function io(e,n){switch(n.id){case M.M8.Query:return e.targets.length;case M.M8.Alert:return e.alert?1:0;case M.M8.Transform:return(e.getTransformations()??[]).length}return null}const oo=e=>({wrapper:(0,u.css)({display:"flex",flexDirection:"column",height:"100%"}),tabBar:(0,u.css)({paddingLeft:e.spacing(2)}),tabContent:(0,u.css)({padding:0,display:"flex",flexDirection:"column",flex:1,minHeight:0,background:e.colors.background.primary,border:`1px solid ${e.components.panel.borderColor}`,borderLeft:"none",borderBottom:"none",borderTopRightRadius:e.shape.borderRadius(1.5)})});var ro=o(41811),lo=o(88214);const co=(0,ro.default)((e,n)=>{const s=[];if(!n)return s;let a=M.M8.Visualize;if(n.meta.skipDataQuery)return[];n.meta.skipDataQuery||(a=M.M8.Query,s.push({id:M.M8.Query,text:"Query",icon:"database",active:!1}),s.push({id:M.M8.Transform,text:"Transform data",icon:"process",active:!1})),ho(n)&&s.push({id:M.M8.Alert,text:"Alert",icon:"bell",active:!1});const i=s.find(r=>r.id===(e||a))??s[0];return i.active=!0,s});function ho(e){const{unifiedAlertingEnabled:n=!1}=(0,nt.zj)(),s=K.TP.hasPermission((0,un.Wd)(lo.hY).read);if(!(n&&s))return!1;const i=e.meta.id==="graph",r=e.meta.id==="timeseries";return i||r}var uo=o(14770);const po=(e,n)=>{const s=e.panelEditor.getPanel(),a=(0,Gt.U)(e,s);return{panel:s,plugin:a?.plugin,instanceState:a?.instanceState,initDone:e.panelEditor.initDone,uiState:e.panelEditor.ui,tableViewEnabled:e.panelEditor.tableViewEnabled,variables:(0,F.SS)(n.dashboard.uid,e)}},go={initPanelEditor:zn,discardPanelChanges:jt,updatePanelEditorUIState:Ge,updateTimeZoneForSession:pi.Cj,toggleTableView:Q.kw,notifyApp:ft.dx},mo=(0,q.connect)(po,go);class fo extends g.PureComponent{constructor(){super(...arguments),this.state={showSaveLibraryPanelModal:!1},this.triggerForceUpdate=()=>{this.forceUpdate()},this.onBack=()=>{y.Ny.partial({editPanel:null,tab:null,showCategory:null})},this.onDiscard=()=>{this.props.discardPanelChanges(),this.onBack()},this.onSaveDashboard=()=>{Lt.lE.publish(new G.S8({component:vi.$,props:{dashboard:this.props.dashboard}}))},this.onSaveLibraryPanel=async()=>{(0,_t.X)(this.props.panel)&&this.setState({showSaveLibraryPanelModal:!0})},this.onChangeTab=n=>{y.Ny.partial({tab:n.id})},this.onFieldConfigChange=n=>{this.props.panel.updateFieldConfig({...n})},this.onPanelOptionsChanged=n=>{this.props.panel.updateOptions(n)},this.onPanelConfigChanged=(n,s)=>{this.props.panel.setProperty(n,s),this.props.panel.render(),this.forceUpdate()},this.onDisplayModeChange=n=>{const{updatePanelEditorUIState:s}=this.props;this.props.tableViewEnabled&&this.props.toggleTableView(),s({mode:n})},this.onToggleTableView=()=>{this.props.toggleTableView()},this.onGoBackToDashboard=()=>{y.Ny.partial({editPanel:null,tab:null,showCategory:null})},this.onConfirmAndDismissLibarayPanelModel=()=>{this.setState({showSaveLibraryPanelModal:!1})}}componentDidMount(){this.props.initPanelEditor(this.props.sourcePanel,this.props.dashboard)}componentDidUpdate(){const{panel:n,initDone:s}=this.props;s&&!this.eventSubs&&(this.eventSubs=new Yt.yU,this.eventSubs.add(n.events.subscribe(G.PR,this.triggerForceUpdate)))}componentWillUnmount(){this.eventSubs?.unsubscribe()}renderPanel(n,s){const{dashboard:a,panel:i,uiState:r,tableViewEnabled:l,theme:d}=this.props;return(0,t.jsxs)("div",{className:n.mainPaneWrapper,children:[this.renderPanelToolbar(n),(0,t.jsx)("div",{className:n.panelWrapper,children:(0,t.jsx)(it.default,{children:({width:c,height:h})=>{if(c<3||h<3)return null;if(s&&(h-=d.spacing.gridSize*2),l)return(0,t.jsx)(Wi,{width:c,height:h,panel:i,dashboard:a});const p=(0,uo.A)(r.mode,c,h,i);return(0,t.jsx)("div",{className:n.centeringContainer,style:{width:c,height:h},children:(0,t.jsx)("div",{style:p,"data-panelid":i.id,children:(0,t.jsx)(mi.L,{stateKey:i.key,dashboard:a,panel:i,isEditing:!0,isViewing:!1,lazy:!1,width:p.width,height:p.height},i.key)})})}})})]},"panel")}renderPanelAndEditor(n,s){const{panel:a,dashboard:i,plugin:r,tab:l}=this.props,d=co(l,r),c=d.length===0,h=this.renderPanel(s,c);return d.length===0?(0,t.jsx)("div",{className:s.onlyPanel,children:h}):(0,t.jsxs)(Zt.g,{splitOrientation:"horizontal",maxSize:-200,paneSize:n.topPaneSize,primary:"first",secondaryPaneStyle:{minHeight:0},onDragFinished:p=>{p&&Ge({topPaneSize:p/window.innerHeight})},children:[h,(0,t.jsx)("div",{className:s.tabsWrapper,"data-testid":x.Tp.components.PanelEditor.DataPane.content,children:(0,t.jsx)(pn,{panel:a,dashboard:i,tabs:d,onChangeTab:this.onChangeTab},a.key)},"panel-editor-tabs")]})}renderTemplateVariables(n){const{variables:s}=this.props;return s.length?(0,t.jsx)("div",{className:n.variablesWrapper,children:(0,t.jsx)(qt,{variables:s})}):null}renderPanelToolbar(n){const{dashboard:s,uiState:a,variables:i,updateTimeZoneForSession:r,panel:l,tableViewEnabled:d}=this.props;return(0,t.jsx)("div",{className:n.panelToolbar,children:(0,t.jsxs)(_.Gy,{justify:i.length>0?"space-between":"flex-end",align:"flex-start",children:[this.renderTemplateVariables(n),(0,t.jsxs)(V.B,{gap:1,children:[(0,t.jsx)(pe.K,{label:"Table view",showLabel:!0,id:"table-view",value:d,onClick:this.onToggleTableView,"data-testid":x.Tp.components.PanelEditor.toggleTableView}),(0,t.jsx)(Ee.z,{value:a.mode,options:M.Nt,onChange:this.onDisplayModeChange}),(0,t.jsx)(fi.$,{dashboard:s,onChangeTimeZone:r,isOnCanvas:!0}),!a.isPanelOptionsVisible&&(0,t.jsx)(ct,{panel:l})]})]})})}renderEditorActions(){const n="sm";let s=[(0,t.jsx)(b.$n,{onClick:this.onDiscard,title:"Undo all changes",size:n,variant:"destructive",fill:"outline",children:"Discard"},"discard"),this.props.dashboard.meta.canSave&&(this.props.panel.libraryPanel?(0,t.jsx)(b.$n,{onClick:this.onSaveLibraryPanel,variant:"primary",size:n,title:"Apply changes and save library panel",children:"Save library panel"},"save-panel"):(0,t.jsx)(b.$n,{onClick:this.onSaveDashboard,title:"Apply changes and save dashboard",size:n,variant:"secondary",children:"Save"},"save")),(0,t.jsx)(b.$n,{onClick:this.onBack,variant:"primary",title:"Apply changes and go back to dashboard","data-testid":x.Tp.components.PanelEditor.applyButton,size:n,children:"Apply"},"apply")];return this.props.panel.libraryPanel&&(s.splice(1,0,(0,t.jsx)(k.$s,{children:({showModal:a,hideModal:i})=>(0,t.jsx)(lt.I,{onClick:()=>{a(gi.l,{onConfirm:()=>{this.props.panel.unlinkLibraryPanel(),this.forceUpdate()},onDismiss:i,isOpen:!0})},title:"Disconnects this panel from the library panel so that you can edit it regularly.",children:"Unlink"},"unlink")},"unlink-controller")),s.pop()),s}renderOptionsPane(){const{plugin:n,dashboard:s,panel:a,instanceState:i}=this.props;return n?(0,t.jsx)(Li,{plugin:n,dashboard:s,panel:a,instanceState:i,onFieldConfigsChange:this.onFieldConfigChange,onPanelOptionsChanged:this.onPanelOptionsChanged,onPanelConfigChange:this.onPanelConfigChanged}):(0,t.jsx)("div",{})}render(){const{initDone:n,uiState:s,theme:a,sectionNav:i,pageNav:r,className:l,updatePanelEditorUIState:d}=this.props,c=xo(a,this.props);return n?(0,t.jsxs)(U.Y,{navModel:i,pageNav:r,"data-testid":x.Tp.components.PanelEditor.General.content,layout:ne.k.Custom,className:l,children:[(0,t.jsx)(Nt.H,{actions:(0,t.jsx)(Tt.U,{alignment:"right",children:this.renderEditorActions()})}),(0,t.jsxs)("div",{className:c.wrapper,children:[(0,t.jsx)("div",{className:c.verticalSplitPanesWrapper,children:s.isPanelOptionsVisible?(0,t.jsxs)(Zt.g,{splitOrientation:"vertical",maxSize:-300,paneSize:s.rightPaneSize,primary:"second",onDragFinished:h=>{h&&d({rightPaneSize:h/window.innerWidth})},children:[this.renderPanelAndEditor(s,c),this.renderOptionsPane()]}):this.renderPanelAndEditor(s,c)}),this.state.showSaveLibraryPanelModal&&(0,t.jsx)(vt,{panel:this.props.panel,folderUid:this.props.dashboard.meta.folderUid??"",onConfirm:this.onConfirmAndDismissLibarayPanelModel,onDiscard:this.onDiscard,onDismiss:this.onConfirmAndDismissLibarayPanelModel})]})]}):null}}const vo=(0,P.cV)(mo(fo)),xo=(0,Xt.N)((e,n)=>{const{uiState:s}=n,a=e.spacing(2);return{wrapper:(0,u.css)({width:"100%",flexGrow:1,minHeight:0,display:"flex",paddingTop:e.spacing(2)}),verticalSplitPanesWrapper:(0,u.css)({display:"flex",flexDirection:"column",height:"100%",width:"100%",position:"relative"}),mainPaneWrapper:(0,u.css)({display:"flex",flexDirection:"column",height:"100%",width:"100%",paddingRight:`${s.isPanelOptionsVisible?0:a}`}),variablesWrapper:(0,u.css)({label:"variablesWrapper",display:"flex",flexGrow:1,flexWrap:"wrap",gap:e.spacing(1,2)}),panelWrapper:(0,u.css)({flex:"1 1 0",minHeight:0,width:"100%",paddingLeft:a}),tabsWrapper:(0,u.css)({height:"100%",width:"100%"}),panelToolbar:(0,u.css)({display:"flex",padding:`0 0 ${a} ${a}`,justifyContent:"space-between",flexWrap:"wrap"}),angularWarning:(0,u.css)({display:"flex",height:e.spacing(4),alignItems:"center"}),toolbarLeft:(0,u.css)({paddingLeft:e.spacing(1)}),centeringContainer:(0,u.css)({display:"flex",justifyContent:"center",alignItems:"center",position:"relative",flexDirection:"column"}),onlyPanel:(0,u.css)({height:"100%",position:"absolute",overflow:"hidden",width:"100%"})}});var bo=o(96464),yo=o(77222),jo=o(60484),So=o(28065),Co=o(85754);const Po=({annotation:e,events:n,onEnabledChanged:s})=>{const[a,i]=(0,g.useState)(!1),r=(0,P.of)(Do),l=()=>(0,Co.Dh)().cancel(e);return(0,g.useEffect)(()=>{const d=n.getStream(G.xc).subscribe({next:h=>{h.payload===e&&i(!0)}}),c=n.getStream(G.yj).subscribe({next:h=>{h.payload===e&&i(!1)}});return()=>{d.unsubscribe(),c.unsubscribe()}}),(0,t.jsx)("div",{className:r.annotation,children:(0,t.jsxs)(yo.C,{children:[(0,t.jsx)(jo.I,{label:e.name,disabled:a,"data-testid":x.Tp.pages.Dashboard.SubMenu.Annotations.annotationLabel(e.name),children:(0,t.jsx)(pe.K,{label:e.name,value:e.enable,onChange:()=>s(e),disabled:a,"data-testid":x.Tp.pages.Dashboard.SubMenu.Annotations.annotationToggle(e.name)})}),(0,t.jsx)("div",{className:r.indicator,children:(0,t.jsx)(So.I,{loading:a,onCancel:l})})]})},e.name)};function Do(e){return{annotation:(0,u.css)({display:"inline-block",marginRight:e.spacing(1),".fa-caret-down":{fontSize:"75%",paddingLeft:e.spacing(1)},".gf-form-inline .gf-form":{marginBottom:0}}),indicator:(0,u.css)({alignSelf:"center",padding:`0 ${e.spacing(.5)}`})}}const To=({annotations:e,onAnnotationChanged:n,events:s})=>{const[a,i]=(0,g.useState)([]);return(0,g.useEffect)(()=>{i(e.filter(r=>r.hide!==!0))},[e]),a.length===0?null:(0,t.jsx)("div",{"data-testid":x.Tp.pages.Dashboard.SubMenu.Annotations.annotationsWrapper,children:a.map(r=>(0,t.jsx)(Po,{events:s,annotation:r,onEnabledChanged:n},r.name))})};var No=o(94701),Eo=o(84099),Io=o(89146),gn=o(92498);const Mo=({dashboard:e,links:n})=>{const s=(0,rn.C)();return(0,No.A)(()=>{const a=e.events.subscribe(an.sR,s);return()=>a.unsubscribe()}),n.length?(0,t.jsx)(t.Fragment,{children:n.map((a,i)=>{const r=(0,Io.mQ)().getAnchorInfo(a),l=`${a.title}-$${i}`;if(a.type==="dashboards")return(0,t.jsx)(gn.aK,{link:a,linkInfo:r,dashboardUID:e.uid},l);const d=st.G[a.icon],c=(0,t.jsx)(gn.Zx,{href:(0,Eo.Jf)(r.href),target:a.targetBlank?"_blank":void 0,rel:"noreferrer","data-testid":x.Tp.components.DashboardLinks.link,icon:d,children:r.title});return(0,t.jsx)("div",{"data-testid":x.Tp.components.DashboardLinks.container,children:a.tooltip?(0,t.jsx)(Pe.m,{content:r.tooltip,children:c}):c},l)})}):null};class wo extends g.PureComponent{constructor(){super(...arguments),this.onAnnotationStateChanged=n=>{for(let s=0;s<this.props.dashboard.annotations.list.length;s++){const a=this.props.dashboard.annotations.list[s];if(a.name===n.name){a.enable=!a.enable;break}}this.props.dashboard.startRefresh(),this.forceUpdate()},this.disableSubmitOnEnter=n=>{n.preventDefault()}}render(){const{dashboard:n,variables:s,links:a,annotations:i,theme:r}=this.props,l=Lo(r),d=n.meta.isSnapshot??!1;return(0,t.jsxs)("div",{className:l.submenu,children:[(0,t.jsx)("form",{"aria-label":"Template variables",className:l.formStyles,onSubmit:this.disableSubmitOnEnter,children:(0,t.jsx)(qt,{variables:s,readOnly:d})}),(0,t.jsx)(To,{annotations:i,onAnnotationChanged:this.onAnnotationStateChanged,events:n.events}),(0,t.jsx)("div",{className:l.spacer}),n&&(0,t.jsx)(Mo,{dashboard:n,links:a})]})}}const Vo=(e,n)=>{const{uid:s}=n.dashboard,a=(0,F.nx)(s,e);return{variables:(0,F.pi)(s,a.variables)}},Lo=(0,Xt.N)(e=>({formStyles:(0,u.css)({display:"contents",flexWrap:"wrap"}),submenu:(0,u.css)({display:"flex",flexDirection:"row",flexWrap:"wrap",alignContent:"flex-start",alignItems:"flex-start",gap:`${e.spacing(1)} ${e.spacing(2)}`,padding:`0 0 ${e.spacing(1)} 0`}),spacer:(0,u.css)({flexGrow:1})})),mn=(0,P.cV)((0,q.connect)(Vo)(wo));mn.displayName="SubMenu";var Ao=o(1877),Ro=o(5468),fn=o(63845),Uo=o(83241);const Oo=e=>({initPhase:e.dashboard.initPhase,initError:e.dashboard.initError,dashboard:e.dashboard.getModel(),navIndex:e.navIndex}),Bo={initDashboard:Uo.v,cleanUpDashboardAndVariables:Ie.Bz,notifyApp:ft.dx,cancelVariables:$e.Y7,templateVarsChangedInUrl:$e.Hn},Fo=(0,q.connect)(Oo,Bo),$o=e=>({fullScreenPanel:(0,u.css)({".react-grid-layout":{height:"auto !important",transitionProperty:"none"},".react-grid-item":{display:"none !important",transitionProperty:"none !important","&--fullscreen":{display:"block !important",position:"unset !important",transform:"translate(0px, 0px) !important"}},".panel-header:hover":{backgroundColor:"inherit"},".panel-title-container":{cursor:"pointer"},".react-resizable-handle":{display:"none"}})});class zo extends g.PureComponent{constructor(){super(...arguments),this.forceRouteReloadCounter=0,this.state=this.getCleanState(),this.updateLiveTimer=()=>{let n;this.props.dashboard?.liveNow&&(n=(0,de.jG)().timeRange()),Ro.a.setLiveTimeRange(n)},this.setScrollRef=n=>{this.setState({scrollElement:n})},this.onCloseShareModal=()=>{y.Ny.partial({shareView:null})}}static{this.contextType=Pn.YE}getCleanState(){return{editView:null,editPanel:null,viewPanel:null,showLoadingState:!1,panelNotFound:!1,editPanelAccessDenied:!1}}componentDidMount(){this.initDashboard(),this.forceRouteReloadCounter=this.props.location.state?.routeReloadCounter||0}componentWillUnmount(){this.closeDashboard()}closeDashboard(){this.props.cleanUpDashboardAndVariables(),this.setState(this.getCleanState())}initDashboard(){const{dashboard:n,params:s,queryParams:a}=this.props;n&&this.closeDashboard(),this.props.initDashboard({urlSlug:s.slug,urlUid:s.uid,urlType:s.type,urlFolderUid:a.folderUid,panelType:a.panelType,routeName:this.props.route.routeName,fixUrl:!0,accessToken:s.accessToken,keybindingSrv:this.context.keybindings}),setTimeout(this.updateLiveTimer,250)}componentDidUpdate(n,s){const{dashboard:a,params:i,templateVarsChangedInUrl:r}=this.props,l=this.props.location.state?.routeReloadCounter;if(a){if(n.params.uid!==i.uid||l!==void 0&&this.forceRouteReloadCounter!==l){this.initDashboard(),this.forceRouteReloadCounter=l;return}if(n.location.search!==this.props.location.search){const d=n.queryParams,c=this.props.queryParams;(c?.from!==d?.from||c?.to!==d?.to)&&((0,de.jG)().updateTimeRangeFromUrl(),this.updateLiveTimer()),!d?.refresh&&c?.refresh&&(0,de.jG)().setAutoRefresh(c.refresh);const h=(0,I.Wz)(this.props.queryParams,n.queryParams);h&&r(a.uid,h)}this.state.editPanel&&!s.editPanel&&(je.t.setEditingState(!0),this.props.dashboard?.events.publish(new G.sL(this.state.editPanel.id))),!this.state.editPanel&&s.editPanel&&(je.t.setEditingState(!1),this.props.dashboard?.events.publish(new G.i0(s.editPanel.id))),this.state.editPanelAccessDenied&&(this.props.notifyApp((0,Be.gi)("Permission to edit panel denied")),y.Ny.partial({editPanel:null})),this.state.panelNotFound&&(this.props.notifyApp((0,Be.gi)("Panel not found")),y.Ny.partial({editPanel:null,viewPanel:null})),this.state.updateScrollTop!==void 0&&this.state.updateScrollTop!==s.updateScrollTop&&this.state.scrollElement?.scrollTo(0,this.state.updateScrollTop)}}static getDerivedStateFromProps(n,s){const{dashboard:a,queryParams:i}=n,r=i.editPanel,l=i.viewPanel,d=i.editview;if(!a)return s;const c={...s};if(!s.editView&&d?(c.editView=d,c.rememberScrollTop=s.scrollElement?.scrollTop,c.updateScrollTop=0):s.editView&&!d&&(c.updateScrollTop=s.rememberScrollTop,c.editView=null),!s.editPanel&&r){const h=a.getPanelByUrlId(r);h?a.canEditPanel(h)?(c.editPanel=h,c.rememberScrollTop=s.scrollElement?.scrollTop):c.editPanelAccessDenied=!0:c.panelNotFound=!0}else s.editPanel&&!r&&(c.editPanel=null,c.updateScrollTop=s.rememberScrollTop);if(!s.viewPanel&&l){const h=a.getPanelByUrlId(l);h?(a.initViewPanel(h),c.viewPanel=h,c.rememberScrollTop=s.scrollElement?.scrollTop,c.updateScrollTop=0):c.panelNotFound=!0}else s.viewPanel&&!l&&(a.exitViewPanel(s.viewPanel),c.viewPanel=null,c.updateScrollTop=s.rememberScrollTop);return(s.panelNotFound||s.editPanelAccessDenied&&!r)&&(c.panelNotFound=!1,c.editPanelAccessDenied=!1),ko(n,c)}getInspectPanel(){const{dashboard:n,queryParams:s}=this.props,a=s.inspect;if(!n||!a)return null;const i=n.getPanelById(parseInt(a,10));return i||null}render(){const{dashboard:n,initError:s,queryParams:a,theme:i,params:r}=this.props,{editPanel:l,viewPanel:d,pageNav:c,sectionNav:h}=this.state,p=Dn(this.props.queryParams),m=$o(i);if(!n||!c||!h)return(0,t.jsx)(An.P,{initPhase:this.props.initPhase});const f=this.getInspectPanel(),T=!l&&!p&&!this.props.queryParams.editview&&n.isSubMenuVisible(),D=p!==E.KioskMode.Full&&!a.editview&&!s,S=(0,u.cx)({[m.fullScreenPanel]:!!d,"page-hidden":!!(a.editview||l)}),L=new Set(["autoMigrateOldPanels","autoMigrateGraphPanel","autoMigrateTablePanel","autoMigratePiechartPanel","autoMigrateWorldmapPanel","autoMigrateStatPanel","disableAngular"]),B=()=>{const z=new URLSearchParams(window.location.search);let j=!1;return z.forEach((N,oe)=>{if(oe.startsWith("__feature.")){const C=oe.substring(10),me=N==="true"||N==="";if(w.$.featureToggles[C])return;if(L.has(C)&&me){j=!0;return}}}),j},R=n.panels.some(z=>z.autoMigrateFrom&&fn.NB[z.autoMigrateFrom]!=null),ie=w.$.featureToggles.angularDeprecationUI&&R&&B()&&n.uid!==null;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(U.Y,{navModel:h,pageNav:c,layout:ne.k.Canvas,className:S,onSetScrollRef:this.setScrollRef,children:[D&&(0,t.jsx)("header",{"data-testid":x.Tp.pages.Dashboard.DashNav.navV2,children:(0,t.jsx)(Ln.Ay,{dashboard:n,title:n.title,folderTitle:n.meta.folderTitle,isFullscreen:!!d,kioskMode:p,hideTimePicker:n.timepicker.hidden})}),(0,t.jsx)(St,{dashboard:n}),s&&(0,t.jsx)(he,{error:s.error,type:r.type}),T&&(0,t.jsx)("section",{"aria-label":x.Tp.pages.Dashboard.SubMenu.submenu,children:(0,t.jsx)(mn,{dashboard:n,annotations:n.annotations.list,links:n.links})}),w.$.featureToggles.angularDeprecationUI&&n.hasAngularPlugins()&&n.uid!==null&&(0,t.jsx)(Nn.j,{dashboardUid:n.uid,showAutoMigrateLink:n.panels.some(z=>fn.vI.includes(z.type))}),ie&&(0,t.jsx)(wn,{dashboardUid:n.uid}),!s&&(0,t.jsx)(Ao.N,{dashboard:n,isEditable:!!n.meta.canEdit,viewPanel:d,editPanel:l}),f&&(0,t.jsx)(li,{dashboard:n,panel:f}),a.shareView&&(0,t.jsx)(bo.Zy,{dashboard:n,onDismiss:this.onCloseShareModal,activeTab:a.shareView})]}),l&&(0,t.jsx)(vo,{dashboard:n,sourcePanel:l,tab:this.props.queryParams.tab,sectionNav:h,pageNav:c}),a.editview&&(0,t.jsx)(Oa,{dashboard:n,editview:a.editview,pageNav:c,sectionNav:h})]})}}function ko(e,n){const{dashboard:s,navIndex:a}=e;if(!s)return n;let i=n.pageNav,r=n.sectionNav;(!i||s.title!==i.text||s.meta.folderUrl!==i.parentItem?.url)&&(i={text:s.title,url:ye.I.getUrlForPartial(e.location,{editview:null,editPanel:null,viewPanel:null})}),r=(0,Fe.tc)(e.navIndex,Tn.L1+s.uid,(0,Fe.tc)(e.navIndex,"dashboards/browse"));const{folderUid:l}=s.meta;if(l&&i&&r.main.id!=="starred"){const d=(0,Fe.tc)(a,`folder-dashboards-${l}`).main;d.id!=="not-found"&&(i={...i,parentItem:d})}return(n.editPanel||n.viewPanel)&&(i={...i,text:`${n.editPanel?"Edit":"View"} panel`,parentItem:i,url:void 0}),n.pageNav===i&&n.sectionNav===r?n:{...n,pageNav:i,sectionNav:r}}const vn=(0,P.cV)(zo);vn.displayName="DashboardPage";const xn=Fo(vn);function Go(e){const n=e.queryParams.scenes===!0,s=e.queryParams.scenes===!1,a=(0,X.g)(),i=(0,X.zy)();if(w.$.featureToggles.useV2DashboardsAPI&&w.$.featureToggles.dashboardScene&&!s)return console.log("DashboardPageProxy: forcing scenes because of v2 api"),(0,t.jsx)(Oe,{...e});if(n||w.$.featureToggles.dashboardScene&&!s)return(0,t.jsx)(Oe,{...e});const r=(0,Ue.sP)(),l=!!(e.route.routeName===E.DashboardRoutes.Home||e.route.routeName===E.DashboardRoutes.Normal&&a.uid),d=(0,te.A)(async()=>a.type==="snapshot"?null:r.fetchDashboard({route:e.route.routeName,uid:a.uid??"",type:a.type,slug:a.slug}),[a.uid,e.route.routeName]);return d.error?(0,t.jsx)(he,{error:d.error}):d.loading||d?.value?.dashboard?.uid!==a.uid&&d.value?.meta?.isNew!==!0?null:w.$.featureToggles.dashboardSceneForViewers?d.value&&!(d.value.meta?.canEdit||d.value.meta?.canMakeEditable)&&l?(0,t.jsx)(Oe,{...e}):(0,t.jsx)(xn,{...e,params:a,location:i}):(0,t.jsx)(xn,{...e,params:a,location:i})}const Wo=Go},64555:(bn,fe,o)=>{o.d(fe,{Bz:()=>xe,Q9:()=>Re,Ss:()=>E,TA:()=>v,lC:()=>he});var t=o(28082),X=o(23737),te=o(17687),w=o(15543),g=o(10474),Ae=o(14297),ne=o(89880),ve=o(34547),se=o(20138),U=o(16910),ce=o(80757),W=o(86983);function Re(u,y){return async k=>{await(0,t.AI)().post("/api/dashboards/import",u),k((0,X.dx)((0,te.tZ)("Dashboard Imported",y))),k((0,ve.h9)())}}function v(u){return async y=>{await(0,w.n)().deleteDashboard(u,!1),y((0,ve.h9)())}}const xe=()=>(u,y)=>{const P=y().dashboard.getModel();P&&(P.destroy(),u((0,se.Y7)(P.uid))),(0,ce.jG)().stopAutoRefresh(),u((0,W.p0)()),u((0,Ae.rG)()),g.t.leave(),(0,U.UA)().setCurrent(void 0)},he=u=>y=>{y((0,ne.Cj)(u)),(0,ce.jG)().refreshTimeModel()},E=u=>y=>{y((0,ne.xu)(u)),(0,ce.jG)().refreshTimeModel()}}}]);

//# sourceMappingURL=210.30a270272e0f0bb73e63.js.map