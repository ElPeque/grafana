"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9069],{71839:($,R,e)=>{e.d(R,{o:()=>o});var t=e(74848),g=e(96540),M=e(40462),c=e(38075),L=e(63739),f=e(47286),T=e(85832),I=e(87579),D=e(7257),r=e(6248);function d(m,s,a=[]){for(const n of a)if(typeof n=="function"){if(!n(m,s))return!1}else if(s[n]!==m[n])return!1;return!0}const h={x:M.sJ.get(c.Ct.firstTimeField).get({}),y:M.sJ.get(c.Ct.byTypes).get(new Set([L.PU.number,L.PU.enum]))};class o extends g.Component{constructor(s){super(s),this.getTimeRange=()=>this.props.timeRange;let a=this.prepState(s);a.alignedData=a.config.prepData([a.alignedFrame]),this.state=a,this.plotInstance=g.createRef()}prepState(s,a=!0){let n=null;const{frames:u,fields:l=h,preparePlotFrame:A,replaceVariables:j,dataLinkPostProcessor:O}=s,U=A??r.m,F=u.some(P=>P.fields.some(N=>(N.config.links?.length??0)>0)),p=U(u,{...l,y:F?()=>!0:l.y},s.timeRange);if((0,D.uY)("GraphNG",!1,"data aligned",p),p){let P=p;if(F){const G=Array.isArray(this.props.timeZone)?this.props.timeZone[0]:this.props.timeZone;let b=u.map((E,S)=>({...E,fields:p.fields.filter((K,z)=>z===0||K.state?.origin?.frameIndex===S),length:p.length}));b.forEach((E,S)=>{E.fields.forEach(K=>{K.getLinks=(0,f._M)(E,K,{...K.state?.scopedVars,__dataContext:{value:{data:b,field:K,frame:E,frameIndex:S}}},j,G,O)})}),P={...p,fields:p.fields.filter((E,S)=>S===0||l.y(E,p,[p]))}}if(s.omitHideFromViz){const G=P.fields.filter(b=>b.config.custom?.hideFrom?.viz!==!0);P={...P,fields:G,length:G.length}}let N=this.state?.config;a&&(N=s.prepConfig(P,this.props.frames,this.getTimeRange),(0,D.uY)("GraphNG",!1,"config prepared",N)),n={alignedFrame:P,config:N},(0,D.uY)("GraphNG",!1,"data prepared",n.alignedData)}return n}componentDidUpdate(s){const{frames:a,structureRev:n,timeZone:u,cursorSync:l,propsToDiff:A}=this.props,j=!d(s,this.props,A);if(a!==s.frames||j||u!==s.timeZone||l!==s.cursorSync){let O=this.prepState(this.props,!1);O&&((this.state.config===void 0||u!==s.timeZone||l!==s.cursorSync||n!==s.structureRev||!n||j)&&(O.config=this.props.prepConfig(O.alignedFrame,this.props.frames,this.getTimeRange),(0,D.uY)("GraphNG",!1,"config recreated",O.config)),O.alignedData=O.config.prepData([O.alignedFrame]),this.setState(O))}}render(){const{width:s,height:a,children:n,renderLegend:u}=this.props,{config:l,alignedFrame:A,alignedData:j}=this.state;return l?(0,t.jsx)(T.KU,{width:s,height:a,legend:u(l),children:(O,U)=>(0,t.jsx)(I.Z,{config:l,data:j,width:O,height:U,plotRef:F=>this.plotInstance.current=F,children:n?n(l,A):null})}):null}}},6248:($,R,e)=>{e.d(R,{m:()=>D});var t=e(63739),g=e(77230),M=e(66380);function c(r,d,h){let o,m;for(let s=0;s<d.length;s++)if(d[s]==null)m==null&&o!=null&&(m=s);else{if(m!=null&&o!=null){if(r[s]-o<h)for(;m<s;)d[m++]=void 0;m=null}o=r[s]}return d}var L=e(7500);function f(r){return r.type===t.PU.number&&r.config.custom?.drawStyle===L.GR.Bars&&!r.config.custom?.hideFrom?.viz}function T(r,d){return r.fields.find(h=>d!=null?h.name===d:h.type===t.PU.time)}function I(r,d){const h=T(r,d);let o=h?.values;for(let m=0;m<r.fields.length;m++){let s=r.fields[m];if(s===h||f(s))continue;let a=s.config.custom?.spanNulls;typeof a=="number"&&a!==-1&&o&&(s.values=c(o,s.values,a))}return r}function D(r,d,h){let o;e:for(let n of r)for(let u of n.fields)if(d.x(u,n,r)){o=u;break e}r=r.map(n=>o?.state?.nullThresholdApplied?n:(0,M.M)({frame:n,refFieldName:o.name,refFieldPseudoMin:h?.from.valueOf(),refFieldPseudoMax:h?.to.valueOf()}));let m=r.reduce((n,u)=>n+u.fields.reduce((l,A)=>l+(f(A)?1:0),0),0),s=1/0;m>1&&r.forEach(n=>{if(!n.fields.some(f))return;const u=o.values;for(let l=0;l<u.length;l++)l>0&&(s=Math.min(s,u[l]-u[l-1]))});let a=(0,g.Fd)({frames:r,joinBy:d.x,keep:d.y,keepOriginIndices:!0,keepDisplayNames:!0,nullMode:n=>{if(f(n))return g.WO;let u=n.config.custom?.spanNulls;return u===!0?g.RC:u===-1?g.WO:g.JI}});return a?(a=I(a,o.name),s!==1/0&&(a.fields.forEach((n,u)=>{let l=n.values;if(u===0){let A=l[l.length-1];l.push(A+s,A+2*s)}else f(n)?l.push(null,null):l.push(void 0,void 0)}),a.length+=2),a):null}},42515:($,R,e)=>{e.d(R,{I:()=>d});var t=e(74848),g=e(96540),M=e(62931),c=e(63739),L=e(7500),f=e(85832),T=e(43987),I=e(71839),D=e(90825);const r=["rowHeight","colWidth","showValue","mergeValues","alignValue","tooltip","paginationRev"];class d extends g.Component{constructor(){super(...arguments),this.getValueColor=(o,m,s)=>{const a=this.props.frames[o]?.fields[m];if(a?.display){const n=a.display(s);if(n.color)return n.color}return M.F},this.prepConfig=(o,m,s)=>(0,D.iE)({frame:o,getTimeRange:s,allFrames:this.props.frames,...this.props,timeZones:Array.isArray(this.props.timeZone)?this.props.timeZone:[this.props.timeZone],rowHeight:o.fields.length>2?this.props.rowHeight:1,getValueColor:this.getValueColor,hoverMulti:this.props.tooltip?.mode===L.$N.Multi}),this.renderLegend=o=>{const{legend:m,legendItems:s}=this.props;return!o||!s||!m||m.showLegend===!1?null:(0,t.jsx)(f.KU.Legend,{placement:m.placement,children:(0,t.jsx)(T.t,{placement:m.placement,items:s,displayMode:m.displayMode,readonly:!0})})}}render(){return(0,t.jsx)(I.o,{...this.props,fields:{x:o=>o.type===c.PU.time,y:o=>o.type===c.PU.number||o.type===c.PU.boolean||o.type===c.PU.string||o.type===c.PU.enum},prepConfig:this.prepConfig,propsToDiff:r,renderLegend:this.renderLegend,omitHideFromViz:!0})}}},10399:($,R,e)=>{e.d(R,{U:()=>g});var t=e(79120);const g=t.H.injectEndpoints({endpoints:M=>({getRuleHistory:M.query({query:({ruleUid:c,from:L,to:f,limit:T=100})=>({url:"/api/v1/rules/history",params:{ruleUID:c,from:L,to:f,limit:T}})})})})},19354:($,R,e)=>{e.d(R,{A:()=>D});var t=e(74848),g=e(96540),M=e(70713),c=e(7500),L=e(29675),f=e(42515),T=e(90825);const I=r=>r,D=(0,g.memo)(({frames:r,timeRange:d})=>{const h=(0,L.$j)();return(0,t.jsx)(M.default,{disableHeight:!0,children:({width:o})=>(0,t.jsx)(f.I,{frames:r,timeRange:d,timeZone:"browser",mode:T.pm.Changes,height:18*r.length+50,width:o,showValue:c.yL.Never,theme:h,rowHeight:.8,legend:{calcs:[],displayMode:c.lm.List,placement:"bottom",showLegend:!0},legendItems:[{label:"Normal",color:h.colors.success.main,yAxis:1},{label:"Pending",color:h.colors.warning.main,yAxis:1},{label:"Firing",color:h.colors.error.main,yAxis:1},{label:"No Data",color:h.colors.info.main,yAxis:1},{label:"Mixed",color:h.colors.text.secondary,yAxis:1}],replaceVariables:I})})});D.displayName="LogTimelineViewer"},19069:($,R,e)=>{e.r(R),e.d(R,{default:()=>ce,getStyles:()=>te,useFrameSubset:()=>q});var t=e(74848),g=e(22803),M=e(2543),c=e(96540),L=e(49785),f=e(3202),T=e(29675),I=e(37e3),D=e(48583),r=e(6736),d=e(79784),h=e(54594),o=e(86489),m=e(40271),s=e(34128),a=e(10399),n=e(1814),u=e(3429),l=e(2178),A=e(74226),j=e(88090),O=e(95015),U=e(36692),F=e(17025),p=e(88663);function P(i){const y=i.reduce((x,v)=>{const B=x.get(v.timestamp);return B?B.push(v):x.set(v.timestamp,[v]),x},new Map);return new Map([...y].sort((x,v)=>v[0]-x[0]))}const N=(0,c.memo)(({records:i,commonLabels:y,onLabelClick:x,onRecordsRendered:v})=>{const B=(0,T.of)(S),V=P(i),C=new Map;return(0,c.useEffect)(()=>{v&&v(C)}),(0,t.jsx)("ul",{className:B.logsScrollable,"aria-label":"State history by timestamp",children:Array.from(V.entries()).map(([W,H])=>(0,t.jsxs)("li",{id:W.toString(10),"data-testid":W,ref:_=>_&&C.set(W,_),className:B.listItemWrapper,children:[(0,t.jsx)(b,{time:W}),(0,t.jsx)("div",{className:B.logsContainer,children:H.map(({line:_})=>(0,t.jsxs)(c.Fragment,{children:[(0,t.jsx)(F.C,{state:_.previous,size:"sm",muted:!0}),(0,t.jsx)(d.I,{name:"arrow-right",size:"sm"}),(0,t.jsx)(F.C,{state:_.current}),(0,t.jsx)(D.B,{children:_.values&&(0,t.jsx)(E,{record:_.values})}),(0,t.jsx)("div",{children:_.labels&&(0,t.jsx)(O.L,{tags:(0,p.$)(Object.entries(_.labels),y).map(([Z,Y])=>`${Z}=${Y}`),onClick:x})})]},(0,M.uniqueId)()))})]},W))})});N.displayName="LogRecordViewerByTimestamp";function G({records:i,commonLabels:y}){const x=useStyles2(S),v=groupBy(i,B=>JSON.stringify(B.line.labels));return jsx(Fragment,{children:Object.entries(v).map(([B,V])=>jsxs(Stack,{direction:"column",children:[jsx("h4",{children:jsx(TagList,{tags:omitLabels(Object.entries(V[0].line.labels??{}),y).map(([C,W])=>`${C}=${W}`)})}),jsx("div",{className:x.logsContainer,children:V.map(({line:C,timestamp:W})=>jsxs("div",{children:[jsx(AlertStateTag,{state:C.previous,size:"sm",muted:!0}),jsx(Icon,{name:"arrow-right",size:"sm"}),jsx(AlertStateTag,{state:C.current}),jsx(Stack,{children:C.values&&jsx(E,{record:C.values})}),jsx("div",{children:dateTimeFormat(W)})]},uniqueId()))})]},B))})}const b=({time:i})=>{const y=new Date(i),x=(0,T.of)(S);return(0,t.jsx)("div",{className:x.timestampWrapper,children:(0,t.jsxs)(D.B,{alignItems:"center",gap:1,children:[(0,t.jsx)(d.I,{name:"clock-nine",size:"sm"}),(0,t.jsx)("span",{className:x.timestampText,children:(0,j.LE)(y)}),(0,t.jsxs)("small",{children:["(",(0,A.B)(y)," ago)"]})]})})},E=(0,c.memo)(({record:i})=>{const y=Object.entries(i);return(0,t.jsx)(t.Fragment,{children:y.map(([x,v])=>(0,t.jsx)(U.J,{label:x,value:v},x))})});E.displayName="AlertInstanceValues";const S=i=>({logsContainer:(0,g.css)({display:"grid",gridTemplateColumns:"max-content max-content max-content auto max-content",gap:i.spacing(2,1),alignItems:"center"}),logsScrollable:(0,g.css)({height:"500px",overflow:"scroll",flex:1}),timestampWrapper:(0,g.css)({color:i.colors.text.secondary}),timestampText:(0,g.css)({color:i.colors.text.primary,fontSize:i.typography.bodySmall.fontSize,fontWeight:i.typography.fontWeightBold}),listItemWrapper:(0,g.css)({background:"transparent",outline:"1px solid transparent",padding:`${i.spacing(1)} ${i.spacing(1.5)}`,[i.transitions.handleMotion("no-preference","reduce")]:{transition:"background 150ms, outline 150ms"}})});var K=e(19354),z=e(31006);const re=10*1e3,oe=12,le=({ruleUID:i})=>{const y=(0,T.of)(te),[x,v]=(0,c.useState)(""),B=(0,c.useRef)(new Map),{getValues:V,setValue:C,register:W,handleSubmit:H}=(0,L.mN)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:_}=a.U,Z=(0,c.useMemo)(()=>ie(),[]),{currentData:Y,isLoading:me,isError:de,error:se}=_({ruleUid:i,from:Z.from.unix(),to:Z.to.unix(),limit:250},{refetchOnFocus:!0,refetchOnReconnect:!0,pollingInterval:re}),{dataFrames:X,historyRecords:ue,commonLabels:w,totalRecordsCount:k}=(0,z.mW)(Y,x),{frameSubset:Q,frameTimeRange:ge}=q(X),fe=(0,c.useCallback)(J=>{const ae=(0,n.EU)(V("query"),J);v(ae),C("query",ae)},[v,C,V]),ne=(0,c.useCallback)(()=>{v(""),C("query","")},[v,C]);if(me)return(0,t.jsx)("div",{children:"Loading..."});if(de)return(0,t.jsx)(I.F,{title:"Error fetching the state history",severity:"error",children:se instanceof Error?se.message:"Unable to fetch alert state history"});const he=Q.length<X.length,pe=k>0?`No matches were found for the given filters among the ${k} instances`:"No state transitions have occurred in the last 30 days";return(0,t.jsxs)("div",{className:y.fullSize,children:[(0,t.jsxs)("form",{onSubmit:H(J=>v(J.query)),children:[(0,t.jsx)(ee,{...W("query"),showClearFilterSuffix:!!x,onClearFilterClick:ne}),(0,t.jsx)("input",{type:"submit",hidden:!0})]}),!(0,M.isEmpty)(w)&&(0,t.jsx)("div",{className:y.commonLabels,children:(0,t.jsxs)(D.B,{gap:1,alignItems:"center",children:[(0,t.jsx)("strong",{children:"Common labels"}),(0,t.jsx)(r.m,{content:"Common labels are the ones attached to all of the alert instances",children:(0,t.jsx)(d.I,{name:"info-circle"})}),(0,t.jsx)(u.m,{labels:(0,M.fromPairs)(w),size:"sm"})]})}),(0,M.isEmpty)(Q)?(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("div",{className:y.emptyState,children:[pe,k>0&&(0,t.jsx)(h.$n,{variant:"secondary",type:"button",onClick:ne,children:"Clear filters"})]})}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:y.graphWrapper,children:(0,t.jsx)(K.A,{frames:Q,timeRange:ge})}),he&&(0,t.jsx)("div",{className:y.moreInstancesWarning,children:(0,t.jsxs)(D.B,{direction:"row",alignItems:"center",gap:1,children:[(0,t.jsx)(d.I,{name:"exclamation-triangle",size:"sm"}),(0,t.jsx)("small",{children:`Only showing ${Q.length} out of ${X.length} instances. Click on the labels to narrow down the results`})]})}),(0,t.jsx)(N,{records:ue,commonLabels:w,onRecordsRendered:J=>B.current=J,onLabelClick:fe})]})]})};function q(i){return(0,c.useMemo)(()=>{const y=(0,M.take)(i,oe),x=(0,M.sortBy)((0,M.uniq)(y.flatMap(H=>H.fields[0].values))),v=Math.min(...x),B=Math.max(...x),V=(0,f.KQ)(v),C=(0,f.KQ)(B);return{frameSubset:y,frameSubsetTimestamps:x,frameTimeRange:{from:V,to:C,raw:{from:V,to:C}}}},[i])}const ee=c.forwardRef(({showClearFilterSuffix:i,onClearFilterClick:y,...x},v)=>(0,t.jsx)(o.D,{label:(0,t.jsx)(m.J,{htmlFor:"instancesSearchInput",children:(0,t.jsxs)(D.B,{gap:.5,children:[(0,t.jsx)("span",{children:"Filter instances"}),(0,t.jsx)(l.B,{content:(0,t.jsxs)(t.Fragment,{children:["Use label matcher expression (like ",(0,t.jsx)("code",{children:"{foo=bar}"}),") or click on an instance label to filter instances"]}),children:(0,t.jsx)(d.I,{name:"info-circle",size:"sm"})})]})}),children:(0,t.jsx)(s.p,{id:"instancesSearchInput",prefix:(0,t.jsx)(d.I,{name:"search"}),suffix:i&&(0,t.jsx)(h.$n,{fill:"text",icon:"times",size:"sm",onClick:y,children:"Clear"}),placeholder:"Filter instances",ref:v,...x})}));ee.displayName="SearchFieldInput";function ie(){const i=(0,f.KQ)().subtract(30,"days"),y=(0,f.KQ)();return{from:i,to:y,raw:{from:i,to:y}}}const te=i=>({fullSize:(0,g.css)({minWidth:"100%",height:"100%",display:"flex",flexDirection:"column"}),graphWrapper:(0,g.css)({padding:`${i.spacing()} 0`}),emptyState:(0,g.css)({color:i.colors.text.secondary,display:"flex",flexDirection:"column",gap:i.spacing(2),alignItems:"center",margin:"auto auto"}),moreInstancesWarning:(0,g.css)({color:i.colors.warning.text,padding:i.spacing()}),commonLabels:(0,g.css)({display:"grid",gridTemplateColumns:"max-content auto"}),highlightedLogRecord:(0,g.css)({background:`${i.colors.primary.transparent} !important`,outline:`1px solid ${i.colors.primary.shade} !important`})}),ce=le},88663:($,R,e)=>{e.d(R,{$:()=>M,Q:()=>c});var t=e(2543),g=e.n(t);function M(L,f){return L.filter(T=>!f.find(I=>JSON.stringify(I)===JSON.stringify(T)))}function c(L){const f=L.flatMap(I=>I);return(0,t.uniqBy)(f.filter(I=>f.filter(r=>(0,t.isEqual)(I,r)).length===Object.keys(L).length),I=>JSON.stringify(I))}},31006:($,R,e)=>{e.d(R,{PA:()=>m,bF:()=>o,mW:()=>h});var t=e(2543),g=e.n(t),M=e(96540),c=e(63739),L=e(16869),f=e(53539),T=e(13076),I=e(29675),D=e(1814),r=e(55936),d=e(88663);function h(a,n){const u=(0,I.$j)();return(0,M.useMemo)(()=>{const l=a?.data?.values[0]??[],A=o(l)?l:[],j=a?.data?.values[1]??[],O=A.reduce((E,S,K)=>{const z=j[K];return m(z)&&E.push({timestamp:S,line:z}),E},[]),U=(0,t.groupBy)(O,E=>JSON.stringify(E.line.labels)),p=Object.keys(U).map(E=>Object.entries(JSON.parse(E))),P=(0,d.Q)(p),N=n?(0,r.Zc)(n):[],b=Object.entries(U).filter(([E])=>{const S=JSON.parse(E);return(0,D.Av)(S,N)}).map(([E,S])=>s(E,S,P,u));return{historyRecords:O.filter(({line:E})=>E.labels&&(0,D.Av)(E.labels,N)),dataFrames:b,commonLabels:P,totalRecordsCount:O.length}},[a,n,u])}function o(a){return a.every(n=>typeof n=="number")}function m(a){return typeof a=="object"&&a!==null&&"current"in a&&"previous"in a}function s(a,n,u,l){const A=Object.entries(JSON.parse(a)),j={name:"time",type:c.PU.time,values:[...n.map(p=>p.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},O=j.values.map((p,P)=>P);O.sort((0,f.i)(j));const U=[...n.map(p=>p.line.current),n.at(-1)?.line.current],F={fields:[{...j,values:j.values.map((p,P)=>j.values[O[P]])},{name:"State",type:c.PU.string,values:U.map((p,P)=>U[O[P]]),config:{displayName:(0,d.$)(A,u).map(([p,P])=>`${p}=${P}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:T.dM.ValueToText,options:{Alerting:{color:l.colors.error.main},Pending:{color:l.colors.warning.main},Normal:{color:l.colors.success.main},NoData:{color:l.colors.info.main}}}],thresholds:{mode:T.Ol.Absolute,steps:[]}}}],length:j.values.length,name:a};return F.fields.forEach(p=>{p.display=(0,L.J)({field:p,theme:l})}),F}}}]);

//# sourceMappingURL=9069.90f3f30a5016dafd9ecf.js.map