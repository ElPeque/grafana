"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6979],{16979:(L,I,t)=>{t.r(I),t.d(I,{plugin:()=>dt});var P=t(29997),s=t(74848),T=t(22803),S=t(92145),A=t(55127),O=t.n(A),f=t(96540),m=t(16817),v=t(7500),d=t(62955),r=t(29675),C=t(48583),g=t(86489),V=t(44826),X=t(60641),Y=t(29010),H=t(20968),W=t(88023),K=t(16910),J=t(11997),M=t(10059),b=t(52869),F=t(5956),$=t(11747);function Z(c){return JSON.stringify(c)}function w(c,n){let e=n;return window.__grafanaSceneContext&&window.__grafanaSceneContext instanceof J.H$&&(e=window.__grafanaSceneContext.state.editPanel?.getPanelId()),c===e}const k=[{label:"All data",value:!1},{label:"Annotations",value:!0,description:"Include annotations as regular data"}],q="Contains a shared dashboard query";function _({data:c,query:n,onChange:e,onRunQuery:i}){const{value:o}=(0,m.A)(()=>(0,M.tR)().get()),h=(0,f.useMemo)(()=>(0,K.UA)().getCurrent()?.getPanelById(n.panelId??-124134),[n.panelId]),{value:x,loading:u}=(0,m.A)(async()=>{if(!h||!c)return[];const a=await(0,M.tR)().get(h.datasource);return Promise.all(h.targets.map(async l=>{const E=l.datasource?await(0,M.tR)().get(l.datasource):a,B=E.getQueryDisplayText||Z,G=(0,b.E)(c,l.refId)??c;return{refId:l.refId,query:B(l),name:E.name,img:E.meta.info.logos.small,data:G.series,error:G.error}}))},[c,h]),D=(0,f.useCallback)(a=>{e(a),i()},[e,i]),p=(0,f.useCallback)(a=>{D({...n,panelId:a})},[n,D]),it=(0,f.useCallback)(()=>{D({...n,withTransforms:!n.withTransforms})},[n,D]),ut=(0,f.useCallback)(a=>{D({...n,topic:a?v.QR.Annotations:void 0})},[n,D]),ct=a=>a.datasource?.uid===F.uv&&a.targets.some(l=>l.datasource?.uid===$.K),z=(0,f.useCallback)(a=>{const l=a.datasource??o,E=(0,M.tR)().getInstanceSettings(l)?.name,B=a.targets.length;return`${B} ${O()("query",B)} to ${E}`},[o]),j=(0,K.UA)().getCurrent(),ft=!!(n.withTransforms||h?.transformations?.length),Q=(0,f.useMemo)(()=>j?.panels.filter(a=>W.Ay.panels[a.type]&&a.targets&&!w(a.id,j.panelInEdit?.id)).map(a=>{let l=z(a),E=!1;return(a.datasource?.uid===$.K||ct(a))&&(l=q,E=!0),{value:a.id,label:a.title??"Panel "+a.id,imgUrl:W.Ay.panels[a.type].info.logos.small,description:l,isDisabled:E}})??[],[j,z]),vt=(0,r.of)(tt),mt=(0,S.Bi)();if(!j)return null;if(Q.length<1)return(0,s.jsx)("p",{className:vt.noQueriesText,children:"This dashboard does not have any other panels. Add queries to other panels and try again."});const gt=Q.find(a=>a.value===n.panelId);return(0,s.jsx)(d.i,{children:(0,s.jsxs)(C.B,{direction:"column",children:[(0,s.jsxs)(C.B,{gap:3,children:[(0,s.jsx)(g.D,{label:"Source panel",description:"Use query results from another panel",children:(0,s.jsx)(V.l6,{inputId:mt,placeholder:"Choose panel",isSearchable:!0,options:Q,value:gt,onChange:a=>p(a.value)})}),(0,s.jsx)(g.D,{label:"Data",description:"Use data or annotations from the panel",children:(0,s.jsx)(X.z,{options:k,value:n.topic===v.QR.Annotations,onChange:ut})}),ft&&(0,s.jsx)(g.D,{label:"Transform",description:"Apply transformations from the source panel",children:(0,s.jsx)(Y.K,{value:!!n.withTransforms,onChange:it})})]}),u?(0,s.jsx)(H.y,{}):(0,s.jsx)(s.Fragment,{children:x&&!!x.length&&(0,s.jsx)(g.D,{label:"Queries from panel",children:(0,s.jsx)(C.B,{direction:"column",children:x.map((a,l)=>(0,s.jsxs)(C.B,{alignItems:"center",gap:1,children:[(0,s.jsx)("div",{children:a.refId}),(0,s.jsx)("img",{src:a.img,alt:a.name,title:a.name,width:16}),(0,s.jsx)("div",{children:a.query})]},l))})})})]})})}function tt(c){return{noQueriesText:(0,T.css)({padding:c.spacing(1.25)})}}var R=t(62467),at=t(72316),nt=t(81160),st=t(69850),et=t(51575),N=t(96083),ot=t(57532),y=t(8392),rt=t(61034),U=t(2044);class lt extends P.mA{constructor(n){super(n)}getCollapsedText(n){return`Dashboard Reference: ${n.panelId}`}query(n){const e=n.scopedVars?.__sceneObject;let i=e?e.value.valueOf():void 0;if(!i)throw new Error("Can only be called from a scene");const o=n.targets[0];if(!o)return(0,R.of)({data:[]});const h=o.panelId;if(!h)return(0,R.of)({data:[]});let x=this.findSourcePanel(i,h);if(!x)return(0,R.of)({data:[],error:{message:"Could not find source panel"}});let u=x.state.$data;return!o.withTransforms&&u instanceof rt.Es&&(u=u.state.$data),!u||!u.getResultsStream?(0,R.of)({data:[]}):(0,at.v)(()=>{!u.isActive&&u?.setContainerWidth&&u?.setContainerWidth(500);const D=(0,U.sf)(u);return u.getResultsStream().pipe((0,nt.T)(p=>({data:this.getDataFramesForQueryTopic(p.data,o),state:p.data.state,errors:p.data.errors,error:p.data.error,key:"source-ds-provider"})),this.emitFirstLoadedDataIfMixedDS(n.requestId),(0,st.j)(()=>D?.()))})}getDataFramesForQueryTopic(n,e){const i=n.annotations??[];return e.topic===v.QR.Annotations?i.map(o=>({...o,meta:{...o.meta,dataTopic:v.QR.Series}})):[...n.series,...i]}findSourcePanel(n,e){return(0,U.EX)(n,(0,U.XA)(e))}emitFirstLoadedDataIfMixedDS(n){return e=>{if(n.includes(F.bG)){let i=0;return e.pipe((0,et.s)(o=>[y.Gu.Done,y.Gu.Error].includes(o.state)&&i===0?(i++,(0,N.Y)(400)):(i++,(0,N.Y)(0))),(0,ot.$)(o=>o.state===y.Gu.Done||o.state===y.Gu.Error))}return e}}testDatasource(){return Promise.resolve({message:"",status:""})}}const dt=new P.tD(lt).setQueryEditor(_)},51575:(L,I,t)=>{t.d(I,{s:()=>A});var P=t(92908),s=t(92357),T=t(64878),S=t(15964);function A(O){return(0,P.N)(function(f,m){var v=!1,d=null,r=null,C=function(){if(r?.unsubscribe(),r=null,v){v=!1;var g=d;d=null,m.next(g)}};f.subscribe((0,T._)(m,function(g){r?.unsubscribe(),v=!0,d=g,r=(0,T._)(m,C,s.l),(0,S.Tg)(O(g)).subscribe(r)},function(){C(),m.complete()},void 0,function(){d=r=null}))})}},62955:(L,I,t)=>{t.d(I,{i:()=>m});var P=t(22803),s=t(96540),T=t(29675),S=t(2543),A=t(46936),O=t(70713),f=t(27633);function m({children:d}){const r=(0,T.of)(v);return s.createElement("div",{className:r.root},s.createElement(A.C,{gap:1},d))}const v=d=>({root:(0,P.css)({padding:d.spacing(1,1,0,1),backgroundColor:d.colors.background.secondary,borderRadius:d.shape.radius.default})})}}]);

//# sourceMappingURL=6979.e406cead7f83ab7bdda6.js.map