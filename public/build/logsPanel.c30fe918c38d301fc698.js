"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7884],{30900:(N,O,e)=>{e.d(O,{g:()=>Z,q:()=>Ie});var o=e(74848),i=e(22803),f=e(2543),T=e.n(f),t=e(96540),M=e(50832),v=e(75505),S=e(7500),d=e(18163),g=e(35383),s=e(16753),B=e(8392),fe=e(93407),V=e(3202),ge=e(59577),_e=e(86833),Ee=e(32370),pe=e(29675),me=e(90415),Pe=e(99134),Ce=e(97414),Oe=e(88231),Me=e(59878),ve=e(55514),De=e(6e3),q=e(65552),Le=e(28445),he=e(10069),Y=e(55909),E=e(58886),Re=e(31216);const Se={},Ie=({data:l,timeZone:c,fieldConfig:m,options:{showLabels:U,showTime:P,wrapLogMessage:x,showCommonLabels:K,prettifyLogMessage:w,sortOrder:D,dedupStrategy:L,enableLogDetails:I,showLogContextToggle:h,onClickFilterLabel:ee,onClickFilterOutLabel:te,onClickFilterOutString:ae,onClickFilterString:ne,isFilterLabelActive:se,logRowMenuIconsBefore:oe,logRowMenuIconsAfter:re,enableInfiniteScrolling:Te,onNewLogsReceived:Q,...R},id:Be})=>{const y=D===S.uH.Ascending,k=(0,pe.of)(ye),G=(0,t.useRef)(null),[j,le]=(0,t.useState)(null),[F,Ue]=(0,t.useState)(null),[C,z]=(0,t.useState)(R.displayedFields??[]),[xe,ie]=(0,t.useState)(!1),$=(0,t.useRef)(!1),[n,ce]=(0,t.useState)(l),_=(0,Re.O)(n.request?.targets),X=(0,t.useRef)(!1);let b=(0,t.useRef)();const{eventBus:H,onAddAdHocFilter:W}=(0,me.d2)();(0,t.useEffect)(()=>{(0,_e.J7)().publish(new d.Df({order:D}))},[D]);const We=(0,t.useCallback)(a=>{a&&H.publish(new g.b_({point:{time:a.timeEpochMs}}))},[H]),Ke=(0,t.useCallback)(()=>{H.publish(new g.ql)},[H]),be=(0,t.useCallback)(()=>{le(null),b.current&&b.current()},[b]),Ve=(0,t.useCallback)((a,r)=>{le(a),b.current=r},[b]),we=(0,t.useCallback)(a=>{if(!a.dataFrame.refId||!_||!h&&n.request?.app!==s.Jk.Dashboard&&n.request?.app!==s.Jk.PanelEditor&&n.request?.app!==s.Jk.PanelViewer)return!1;const r=_.get(a.dataFrame.refId);return(0,d.Ol)(r)},[_,h,n.request?.app]),ke=(0,t.useCallback)(()=>!(n.request?.app!==s.Jk.Dashboard&&n.request?.app!==s.Jk.PanelEditor&&n.request?.app!==s.Jk.PanelViewer),[n.request?.app]),je=(0,t.useCallback)(async(a,r,u)=>{if(!r.dataFrame.refId||!_)return Promise.resolve({data:[]});const p=n.request?.targets[0];if(!p)return Promise.resolve({data:[]});const J=_.get(r.dataFrame.refId);return(0,d.Ol)(J)?(u.scopedVars=n.request?.scopedVars,J.getLogRowContext(a,u,p)):Promise.resolve({data:[]})},[n.request?.targets,n.request?.scopedVars,_]),He=(0,t.useCallback)((a,r)=>{if(!a.dataFrame.refId||!_)return(0,o.jsx)(o.Fragment,{});const u=n.request?.targets[0];if(!u)return(0,o.jsx)(o.Fragment,{});const p=_.get(a.dataFrame.refId);return(0,d.wj)(p)?p.getLogRowContextUi?p.getLogRowContextUi(a,r,u,n.request?.scopedVars):(0,o.jsx)(o.Fragment,{}):(0,o.jsx)(o.Fragment,{})},[n.request?.targets,n.request?.scopedVars,_]),[A,Je,de]=(0,t.useMemo)(()=>{const a=n?(0,Y.HT)(n.series,n.request?.intervalMs,void 0,n.request?.targets):null,r=a?.rows||[],u=a?.meta?.find(J=>J.label===Y.yR),p=(0,Y.M0)(r,L);return[r,p,u]},[L,n]),Ne=(0,t.useCallback)(async a=>await Ae(a,A,n.timeRange),[n.timeRange,A]);(0,t.useEffect)(()=>{l.state!==B.Gu.Loading&&ce(l)},[l]),(0,t.useLayoutEffect)(()=>{if(!G.current||!F||X.current){X.current=!1;return}(n.request?.app===s.Jk.Dashboard||n.request?.app===s.Jk.PanelEditor)&&F.scrollTo(0,y?G.current.scrollHeight:0)},[n.request?.app,y,F,A]);const Ye=(0,t.useCallback)((a,r)=>(0,Ce.QL)({field:a,rowIndex:r,range:n.timeRange}),[n]),Qe=(0,t.useCallback)(a=>{F?.scrollTo({top:a.offsetTop,behavior:"smooth"})},[F]),Ge=(0,t.useCallback)((a,r)=>{W?.({key:a,value:r,operator:"="})},[W]),ze=(0,t.useCallback)((a,r)=>{W?.({key:a,value:r,operator:"!="})},[W]),$e=(0,t.useCallback)(a=>{C?.indexOf(a)===-1&&z(C?.concat(a))},[C]),Xe=(0,t.useCallback)(a=>{const r=C?.indexOf(a);r!==void 0&&r>-1&&z(C?.filter(u=>a!==u))},[C]);(0,t.useEffect)(()=>{R.displayedFields&&z(R.displayedFields)},[R.displayedFields]);const qe=(0,t.useCallback)(async a=>{if(!l.request||!Ee.$.featureToggles.logsInfiniteScrolling||$.current)return;$.current=!0,ie(!0);const r=(0,E.IU)(Q)?Q:void 0;let u=[];try{u=await Z(_,n,a,c,r)}catch(p){console.error(p)}finally{ie(!1),$.current=!1}X.current=!0,ce({...n,series:u})},[l.request,_,Q,n,c]);if(!l||A.length===0)return(0,o.jsx)(ve.a,{fieldConfig:m,panelId:Be,data:l,needsStringField:!0});const ue=()=>(0,o.jsxs)("div",{className:(0,i.cx)(k.labelContainer,y&&k.labelContainerAscending),children:[(0,o.jsx)("span",{className:k.label,children:"Common labels:"}),(0,o.jsx)(Le.h,{labels:typeof de?.value=="object"?de?.value:Se,emptyMessage:"(no common labels)"})]}),Ze=W?Ge:void 0,et=W?ze:void 0,tt=(0,E.F7)(R.onClickShowField)?R.onClickShowField:$e,at=(0,E.Qd)(R.onClickHideField)?R.onClickHideField:Xe;return(0,o.jsxs)(o.Fragment,{children:[j&&(0,o.jsx)(Me.V,{open:j!==null,row:j,onClose:be,getRowContext:(a,r)=>je(a,j,r),logsSortOrder:D,timeZone:c,getLogRowContextUi:He}),(0,o.jsx)(Pe.P,{ref:a=>Ue(a),children:(0,o.jsxs)("div",{onMouseLeave:Ke,className:k.container,ref:G,children:[K&&!y&&ue(),(0,o.jsx)(Oe.u8,{loading:xe,loadMoreLogs:Te?qe:void 0,range:l.timeRange,timeZone:c,rows:A,scrollElement:F,sortOrder:D,children:(0,o.jsx)(he.k,{scrollElement:F,scrollIntoView:Qe,permalinkedRowId:Fe()?.logs?.id??void 0,onPermalinkClick:ke()?Ne:void 0,logRows:A,showContextToggle:we,deduplicatedRows:Je,dedupStrategy:L,showLabels:U,showTime:P,wrapLogMessage:x,prettifyLogMessage:w,timeZone:c,getFieldLinks:Ye,logsSortOrder:D,enableLogDetails:I,previewLimit:y?A.length:void 0,onLogRowHover:We,app:s.Jk.Dashboard,onOpenContext:Ve,onClickFilterLabel:(0,E.wF)(ee)?ee:Ze,onClickFilterOutLabel:(0,E.Gc)(te)?te:et,onClickFilterString:(0,E.Fp)(ne)?ne:void 0,onClickFilterOutString:(0,E.FL)(ae)?ae:void 0,isFilterLabelActive:(0,E.xQ)(se)?se:void 0,displayedFields:C,onClickShowField:C!==void 0?tt:void 0,onClickHideField:C!==void 0?at:void 0,logRowMenuIconsBefore:(0,E.VW)(oe)?oe:void 0,logRowMenuIconsAfter:(0,E.VW)(re)?re:void 0,renderPreview:!y})}),K&&y&&ue()]})})]})},ye=l=>({container:(0,i.css)({marginBottom:l.spacing(1.5)}),labelContainer:(0,i.css)({margin:l.spacing(0,0,.5,.5),display:"flex",alignItems:"center"}),labelContainerAscending:(0,i.css)({margin:l.spacing(.5,0,.5,0)}),label:(0,i.css)({marginRight:l.spacing(.5),fontSize:l.typography.bodySmall.fontSize,fontWeight:l.typography.fontWeightMedium})});function Fe(){const c=fe.kM.getUrlSearchParams()?.panelState;if(c&&Array.isArray(c)&&c?.length>0&&typeof c[0]=="string")try{return JSON.parse(c[0])}catch(m){console.error("error parsing logsPanelState",m)}}async function Ae(l,c,m){if(l.rowId===void 0||!l.dataFrame.refId)return;const U={logs:{id:l.uid}},P=new URL(window.location.href);P.searchParams.set("panelState",JSON.stringify(U));const x=(0,q.sU)(l,c,{from:(0,V.yT)(m.from).valueOf(),to:(0,V.yT)(m.to).valueOf()});return P.searchParams.set("from",x.from.toString()),P.searchParams.set("to",x.to.toString()),await(0,q.VP)(P.toString()),Promise.resolve()}async function Z(l,c,m,U,P){if(!c.request)return[];const x=(0,ge.convertRawToRange)({from:(0,V.oZ)(U,m.from),to:(0,V.oZ)(U,m.to)}),K=(0,f.groupBy)(c.request.targets,"datasource.uid"),w=[];for(const I in K){const h=l.get(c.request.targets[0].refId);if(!h){console.warn(`Could not resolve data source for target ${c.request.targets[0].refId}`);continue}w.push(h.query({...c.request,range:x,targets:K[I]}))}const D=await Promise.all(w);let L=c.series;for(const I of D){const h=(0,M.A)(I)?await(0,v.s)(I):I;L=(0,De.Wn)({data:L},{data:h.data}).data,P&&P(L,h.data)}return L}},26035:(N,O,e)=>{e.r(O),e.d(O,{plugin:()=>S});var o=e(68256),i=e(7500),f=e(18163),T=e(30900),t=e(21288),M=e(18550);class v{getSuggestionsForData(g){const s=g.getListAppender({name:"",pluginId:"logs",options:{},fieldConfig:{defaults:{custom:{}},overrides:[]}}),{dataSummary:B}=g;!B.hasData||!B.hasTimeField||!B.hasStringField||(B.preferredVisualisationType==="logs"?s.append({name:M.m.Logs,score:t.nQ.Best}):s.append({name:M.m.Logs}))}}const S=new o.m(T.q).setPanelOptions(d=>{d.addBooleanSwitch({path:"showTime",name:"Time",description:"",defaultValue:!1}).addBooleanSwitch({path:"showLabels",name:"Unique labels",description:"",defaultValue:!1}).addBooleanSwitch({path:"showCommonLabels",name:"Common labels",description:"",defaultValue:!1}).addBooleanSwitch({path:"wrapLogMessage",name:"Wrap lines",description:"",defaultValue:!1}).addBooleanSwitch({path:"prettifyLogMessage",name:"Prettify JSON",description:"",defaultValue:!1}).addBooleanSwitch({path:"enableLogDetails",name:"Enable log details",description:"",defaultValue:!0}).addBooleanSwitch({path:"enableInfiniteScrolling",name:"Enable infinite scrolling",description:"Experimental. Request more results by scrolling to the bottom of the logs list.",defaultValue:!1}).addRadio({path:"dedupStrategy",name:"Deduplication",description:"",settings:{options:[{value:i.fY.none,label:"None",description:f._C[i.fY.none]},{value:i.fY.exact,label:"Exact",description:f._C[i.fY.exact]},{value:i.fY.numbers,label:"Numbers",description:f._C[i.fY.numbers]},{value:i.fY.signature,label:"Signature",description:f._C[i.fY.signature]}]},defaultValue:i.fY.none}).addRadio({path:"sortOrder",name:"Order",description:"",settings:{options:[{value:i.uH.Descending,label:"Newest first"},{value:i.uH.Ascending,label:"Oldest first"}]},defaultValue:i.uH.Descending})}).setSuggestionsSupplier(new v)},58886:(N,O,e)=>{e.d(O,{F7:()=>v,FL:()=>t,Fp:()=>T,Gc:()=>f,IU:()=>d,Qd:()=>S,VW:()=>g,wF:()=>i,xQ:()=>M});var o=e(96540);function i(s){return typeof s=="function"}function f(s){return typeof s=="function"}function T(s){return typeof s=="function"}function t(s){return typeof s=="function"}function M(s){return typeof s=="function"}function v(s){return typeof s=="function"}function S(s){return typeof s=="function"}function d(s){return typeof s=="function"}function g(s){return Array.isArray(s)&&s.every(o.isValidElement)}},31216:(N,O,e)=>{e.d(O,{O:()=>T});var o=e(96540),i=e(16817),f=e(98437);const T=t=>{const[M,v]=(0,o.useState)(new Map);return(0,i.A)(async()=>{if(!t){v(new Map);return}const S=await Promise.all(t.filter(d=>!!d.datasource?.uid).map(d=>(0,f.l)().get(d.datasource?.uid).then(g=>({key:d.refId,ds:g}))));v(new Map(S.map(({key:d,ds:g})=>[d,g])))},[t]),M}}}]);

//# sourceMappingURL=logsPanel.c30fe918c38d301fc698.js.map