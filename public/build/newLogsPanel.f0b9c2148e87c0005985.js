"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3976],{42172:(q,T,e)=>{e.r(T),e.d(T,{plugin:()=>ce});var r=e(68256),i=e(7500),p=e(18163),x=e(74848),t=e(22803),g=e(96540),A=e(8392),I=e(16753),d=e(32370),O=e(29675),a=e(90415),ee=e(40297),te=e(55514),W=e(55909),se=e(30900),ne=e(58886),ae=e(31216);const oe=({data:u,timeZone:U,fieldConfig:K,options:{dedupStrategy:y,enableInfiniteScrolling:ue,onNewLogsReceived:j,showTime:E,sortOrder:Y,wrapLogMessage:de},id:fe})=>{const ge=(0,O.of)(re),[G,Ee]=(0,g.useState)(null),[P,o]=(0,g.useState)(u),c=(0,ae.O)(u.request?.targets),v=(0,g.useRef)(!1),D=(0,g.useRef)(!1),{eventBus:C}=(0,a.d2)(),L=(0,g.useMemo)(()=>{const f=P?(0,W.HT)(P.series,P.request?.intervalMs,void 0,P.request?.targets):null;return f?(0,W.M0)(f.rows,y):[]},[y,P]);(0,g.useEffect)(()=>{u.state!==A.Gu.Loading&&o(u)},[u]);const V=(0,g.useCallback)(async f=>{if(!u.request||!d.$.featureToggles.logsInfiniteScrolling||D.current)return;D.current=!0;const R=(0,ne.IU)(j)?j:void 0;let h=[];try{h=await(0,se.g)(c,P,f,U,R)}catch(_){console.error(_)}finally{D.current=!1}v.current=!0,o({...P,series:h})},[u.request,c,j,P,U]),J=(0,g.useMemo)(()=>(u.request?.app===I.Jk.Dashboard||u.request?.app===I.Jk.PanelEditor)&&Y===i.uH.Ascending?"bottom":"top",[u.request?.app,Y]);return L.length?(0,x.jsx)("div",{className:ge.container,ref:f=>Ee(f),children:L.length>0&&G&&(0,x.jsx)(ee.Z,{app:I.Jk.Dashboard,containerElement:G,eventBus:C,initialScrollPosition:J,logs:L,loadMore:ue?V:void 0,showTime:E,sortOrder:Y,timeRange:u.timeRange,timeZone:U,wrapLogMessage:de})}):(0,x.jsx)(te.a,{fieldConfig:K,panelId:fe,data:u,needsStringField:!0})},re=u=>({container:(0,t.css)({marginBottom:u.spacing(1.5),minHeight:"100%",maxHeight:"100%",display:"flex",flex:1,flexDirection:"column"})});var le=e(21288),Q=e(18550);class ie{getSuggestionsForData(U){const K=U.getListAppender({name:"",pluginId:"logs-new",options:{},fieldConfig:{defaults:{custom:{}},overrides:[]}}),{dataSummary:y}=U;!y.hasData||!y.hasTimeField||!y.hasStringField||(y.preferredVisualisationType==="logs"?K.append({name:Q.m.Logs,score:le.nQ.Best}):K.append({name:Q.m.Logs}))}}const ce=new r.m(oe).setPanelOptions(u=>{u.addBooleanSwitch({path:"showTime",name:"Time",description:"",defaultValue:!1}).addBooleanSwitch({path:"wrapLogMessage",name:"Wrap lines",description:"",defaultValue:!1}).addBooleanSwitch({path:"enableLogDetails",name:"Enable log details",description:"",defaultValue:!0}).addBooleanSwitch({path:"enableInfiniteScrolling",name:"Enable infinite scrolling",description:"Experimental. Request more results by scrolling to the bottom of the logs list.",defaultValue:!1}).addRadio({path:"dedupStrategy",name:"Deduplication",description:"",settings:{options:[{value:i.fY.none,label:"None",description:p._C[i.fY.none]},{value:i.fY.exact,label:"Exact",description:p._C[i.fY.exact]},{value:i.fY.numbers,label:"Numbers",description:p._C[i.fY.numbers]},{value:i.fY.signature,label:"Signature",description:p._C[i.fY.signature]}]},defaultValue:i.fY.none}).addRadio({path:"sortOrder",name:"Order",description:"",settings:{options:[{value:i.uH.Descending,label:"Newest first"},{value:i.uH.Ascending,label:"Oldest first"}]},defaultValue:i.uH.Descending})}).setSuggestionsSupplier(new ie)},30900:(q,T,e)=>{e.d(T,{g:()=>P,q:()=>fe});var r=e(74848),i=e(22803),p=e(2543),x=e.n(p),t=e(96540),g=e(50832),A=e(75505),I=e(7500),d=e(18163),O=e(35383),a=e(16753),ee=e(8392),te=e(93407),W=e(3202),se=e(59577),ne=e(86833),ae=e(32370),oe=e(29675),re=e(90415),le=e(99134),Q=e(97414),ie=e(88231),ce=e(59878),u=e(55514),U=e(6e3),K=e(65552),y=e(28445),ue=e(10069),j=e(55909),E=e(58886),Y=e(31216);const de={},fe=({data:o,timeZone:c,fieldConfig:v,options:{showLabels:D,showTime:C,wrapLogMessage:L,showCommonLabels:V,prettifyLogMessage:J,sortOrder:f,dedupStrategy:R,enableLogDetails:h,showLogContextToggle:_,onClickFilterLabel:Me,onClickFilterOutLabel:Oe,onClickFilterOutString:De,onClickFilterString:Le,isFilterLabelActive:Re,logRowMenuIconsBefore:he,logRowMenuIconsAfter:_e,enableInfiniteScrolling:xe,onNewLogsReceived:me,...B},id:Ae})=>{const b=f===I.uH.Ascending,$=(0,oe.of)(ge),pe=(0,t.useRef)(null),[z,Se]=(0,t.useState)(null),[H,Ue]=(0,t.useState)(null),[F,Pe]=(0,t.useState)(B.displayedFields??[]),[Be,Ie]=(0,t.useState)(!1),ve=(0,t.useRef)(!1),[n,ye]=(0,t.useState)(o),M=(0,Y.O)(n.request?.targets),Ce=(0,t.useRef)(!1);let N=(0,t.useRef)();const{eventBus:X,onAddAdHocFilter:w}=(0,re.d2)();(0,t.useEffect)(()=>{(0,ne.J7)().publish(new d.Df({order:f}))},[f]);const We=(0,t.useCallback)(s=>{s&&X.publish(new O.b_({point:{time:s.timeEpochMs}}))},[X]),Ke=(0,t.useCallback)(()=>{X.publish(new O.ql)},[X]),je=(0,t.useCallback)(()=>{Se(null),N.current&&N.current()},[N]),Ve=(0,t.useCallback)((s,l)=>{Se(s),N.current=l},[N]),be=(0,t.useCallback)(s=>{if(!s.dataFrame.refId||!M||!_&&n.request?.app!==a.Jk.Dashboard&&n.request?.app!==a.Jk.PanelEditor&&n.request?.app!==a.Jk.PanelViewer)return!1;const l=M.get(s.dataFrame.refId);return(0,d.Ol)(l)},[M,_,n.request?.app]),He=(0,t.useCallback)(()=>!(n.request?.app!==a.Jk.Dashboard&&n.request?.app!==a.Jk.PanelEditor&&n.request?.app!==a.Jk.PanelViewer),[n.request?.app]),ke=(0,t.useCallback)(async(s,l,m)=>{if(!l.dataFrame.refId||!M)return Promise.resolve({data:[]});const S=n.request?.targets[0];if(!S)return Promise.resolve({data:[]});const Z=M.get(l.dataFrame.refId);return(0,d.Ol)(Z)?(m.scopedVars=n.request?.scopedVars,Z.getLogRowContext(s,m,S)):Promise.resolve({data:[]})},[n.request?.targets,n.request?.scopedVars,M]),Je=(0,t.useCallback)((s,l)=>{if(!s.dataFrame.refId||!M)return(0,r.jsx)(r.Fragment,{});const m=n.request?.targets[0];if(!m)return(0,r.jsx)(r.Fragment,{});const S=M.get(s.dataFrame.refId);return(0,d.wj)(S)?S.getLogRowContextUi?S.getLogRowContextUi(s,l,m,n.request?.scopedVars):(0,r.jsx)(r.Fragment,{}):(0,r.jsx)(r.Fragment,{})},[n.request?.targets,n.request?.scopedVars,M]),[k,we,Fe]=(0,t.useMemo)(()=>{const s=n?(0,j.HT)(n.series,n.request?.intervalMs,void 0,n.request?.targets):null,l=s?.rows||[],m=s?.meta?.find(Z=>Z.label===j.yR),S=(0,j.M0)(l,R);return[l,S,m]},[R,n]),Ye=(0,t.useCallback)(async s=>await Ee(s,k,n.timeRange),[n.timeRange,k]);(0,t.useEffect)(()=>{o.state!==ee.Gu.Loading&&ye(o)},[o]),(0,t.useLayoutEffect)(()=>{if(!pe.current||!H||Ce.current){Ce.current=!1;return}(n.request?.app===a.Jk.Dashboard||n.request?.app===a.Jk.PanelEditor)&&H.scrollTo(0,b?pe.current.scrollHeight:0)},[n.request?.app,b,H,k]);const Ne=(0,t.useCallback)((s,l)=>(0,Q.QL)({field:s,rowIndex:l,range:n.timeRange}),[n]),Qe=(0,t.useCallback)(s=>{H?.scrollTo({top:s.offsetTop,behavior:"smooth"})},[H]),Ge=(0,t.useCallback)((s,l)=>{w?.({key:s,value:l,operator:"="})},[w]),$e=(0,t.useCallback)((s,l)=>{w?.({key:s,value:l,operator:"!="})},[w]),ze=(0,t.useCallback)(s=>{F?.indexOf(s)===-1&&Pe(F?.concat(s))},[F]),Xe=(0,t.useCallback)(s=>{const l=F?.indexOf(s);l!==void 0&&l>-1&&Pe(F?.filter(m=>s!==m))},[F]);(0,t.useEffect)(()=>{B.displayedFields&&Pe(B.displayedFields)},[B.displayedFields]);const Ze=(0,t.useCallback)(async s=>{if(!o.request||!ae.$.featureToggles.logsInfiniteScrolling||ve.current)return;ve.current=!0,Ie(!0);const l=(0,E.IU)(me)?me:void 0;let m=[];try{m=await P(M,n,s,c,l)}catch(S){console.error(S)}finally{Ie(!1),ve.current=!1}Ce.current=!0,ye({...n,series:m})},[o.request,M,me,n,c]);if(!o||k.length===0)return(0,r.jsx)(u.a,{fieldConfig:v,panelId:Ae,data:o,needsStringField:!0});const Te=()=>(0,r.jsxs)("div",{className:(0,i.cx)($.labelContainer,b&&$.labelContainerAscending),children:[(0,r.jsx)("span",{className:$.label,children:"Common labels:"}),(0,r.jsx)(y.h,{labels:typeof Fe?.value=="object"?Fe?.value:de,emptyMessage:"(no common labels)"})]}),qe=w?Ge:void 0,et=w?$e:void 0,tt=(0,E.F7)(B.onClickShowField)?B.onClickShowField:ze,st=(0,E.Qd)(B.onClickHideField)?B.onClickHideField:Xe;return(0,r.jsxs)(r.Fragment,{children:[z&&(0,r.jsx)(ce.V,{open:z!==null,row:z,onClose:je,getRowContext:(s,l)=>ke(s,z,l),logsSortOrder:f,timeZone:c,getLogRowContextUi:Je}),(0,r.jsx)(le.P,{ref:s=>Ue(s),children:(0,r.jsxs)("div",{onMouseLeave:Ke,className:$.container,ref:pe,children:[V&&!b&&Te(),(0,r.jsx)(ie.u8,{loading:Be,loadMoreLogs:xe?Ze:void 0,range:o.timeRange,timeZone:c,rows:k,scrollElement:H,sortOrder:f,children:(0,r.jsx)(ue.k,{scrollElement:H,scrollIntoView:Qe,permalinkedRowId:G()?.logs?.id??void 0,onPermalinkClick:He()?Ye:void 0,logRows:k,showContextToggle:be,deduplicatedRows:we,dedupStrategy:R,showLabels:D,showTime:C,wrapLogMessage:L,prettifyLogMessage:J,timeZone:c,getFieldLinks:Ne,logsSortOrder:f,enableLogDetails:h,previewLimit:b?k.length:void 0,onLogRowHover:We,app:a.Jk.Dashboard,onOpenContext:Ve,onClickFilterLabel:(0,E.wF)(Me)?Me:qe,onClickFilterOutLabel:(0,E.Gc)(Oe)?Oe:et,onClickFilterString:(0,E.Fp)(Le)?Le:void 0,onClickFilterOutString:(0,E.FL)(De)?De:void 0,isFilterLabelActive:(0,E.xQ)(Re)?Re:void 0,displayedFields:F,onClickShowField:F!==void 0?tt:void 0,onClickHideField:F!==void 0?st:void 0,logRowMenuIconsBefore:(0,E.VW)(he)?he:void 0,logRowMenuIconsAfter:(0,E.VW)(_e)?_e:void 0,renderPreview:!b})}),V&&b&&Te()]})})]})},ge=o=>({container:(0,i.css)({marginBottom:o.spacing(1.5)}),labelContainer:(0,i.css)({margin:o.spacing(0,0,.5,.5),display:"flex",alignItems:"center"}),labelContainerAscending:(0,i.css)({margin:o.spacing(.5,0,.5,0)}),label:(0,i.css)({marginRight:o.spacing(.5),fontSize:o.typography.bodySmall.fontSize,fontWeight:o.typography.fontWeightMedium})});function G(){const c=te.kM.getUrlSearchParams()?.panelState;if(c&&Array.isArray(c)&&c?.length>0&&typeof c[0]=="string")try{return JSON.parse(c[0])}catch(v){console.error("error parsing logsPanelState",v)}}async function Ee(o,c,v){if(o.rowId===void 0||!o.dataFrame.refId)return;const D={logs:{id:o.uid}},C=new URL(window.location.href);C.searchParams.set("panelState",JSON.stringify(D));const L=(0,K.sU)(o,c,{from:(0,W.yT)(v.from).valueOf(),to:(0,W.yT)(v.to).valueOf()});return C.searchParams.set("from",L.from.toString()),C.searchParams.set("to",L.to.toString()),await(0,K.VP)(C.toString()),Promise.resolve()}async function P(o,c,v,D,C){if(!c.request)return[];const L=(0,se.convertRawToRange)({from:(0,W.oZ)(D,v.from),to:(0,W.oZ)(D,v.to)}),V=(0,p.groupBy)(c.request.targets,"datasource.uid"),J=[];for(const h in V){const _=o.get(c.request.targets[0].refId);if(!_){console.warn(`Could not resolve data source for target ${c.request.targets[0].refId}`);continue}J.push(_.query({...c.request,range:L,targets:V[h]}))}const f=await Promise.all(J);let R=c.series;for(const h of f){const _=(0,g.A)(h)?await(0,A.s)(h):h;R=(0,U.Wn)({data:R},{data:_.data}).data,C&&C(R,_.data)}return R}},58886:(q,T,e)=>{e.d(T,{F7:()=>A,FL:()=>t,Fp:()=>x,Gc:()=>p,IU:()=>d,Qd:()=>I,VW:()=>O,wF:()=>i,xQ:()=>g});var r=e(96540);function i(a){return typeof a=="function"}function p(a){return typeof a=="function"}function x(a){return typeof a=="function"}function t(a){return typeof a=="function"}function g(a){return typeof a=="function"}function A(a){return typeof a=="function"}function I(a){return typeof a=="function"}function d(a){return typeof a=="function"}function O(a){return Array.isArray(a)&&a.every(r.isValidElement)}},31216:(q,T,e)=>{e.d(T,{O:()=>x});var r=e(96540),i=e(16817),p=e(98437);const x=t=>{const[g,A]=(0,r.useState)(new Map);return(0,i.A)(async()=>{if(!t){A(new Map);return}const I=await Promise.all(t.filter(d=>!!d.datasource?.uid).map(d=>(0,p.l)().get(d.datasource?.uid).then(O=>({key:d.refId,ds:O}))));A(new Map(I.map(({key:d,ds:O})=>[d,O])))},[t]),g}}}]);

//# sourceMappingURL=newLogsPanel.f0b9c2148e87c0005985.js.map