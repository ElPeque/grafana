"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1909],{93112:(ae,F,t)=>{t.r(F),t.d(F,{default:()=>is});var e=t(74848),f=t(22803),r=t(96540),R=t(29675),Q=t(10247),C=t(88849),K=t(11238),W=t(65539),$=t(89857),y=t(2543),O=t(41053),m=t(37e3),c=t(48583),h=t(54594),N=t(17687),d=t(11817),H=t(35626),j=t(747),B=t(12444),U=t(85651),se=t(86655),Z=t(80187),oe=t(25779),de=t(13005),pe=t(16361),ye=t(9365),je=t(83466),Ie=t(79120),Me=t(75505),ge=t(28082),Te=t(88214);const u=n=>{const s=n.match(/^(\w+)(\[\d+\])?$/);return s?{type:s[1],index:s[2]}:{type:n,index:void 0}},l=n=>{const s={receivers:{},errorCount:0};n.forEach(a=>{s.receivers[a.name]={active:a.active,notifiers:{},errorCount:0};const o=s.receivers[a.name];a.integrations.forEach(g=>{!!g?.lastNotifyAttemptError&&(o.errorCount+=1);const x=S(g.name);x&&(o.notifiers[x]||(o.notifiers[x]=[]),o.notifiers[x].push(g))})});const i=Object.values(s.receivers).reduce((a,o)=>a+o.errorCount,0);return{...s,errorCount:i}},S=n=>u(n)?.type;async function V(n){try{const s=await(0,Me.s)((0,ge.AI)().fetch({url:`/api/alertmanager/${(0,Te.w5)(n)}/config/api/v1/receivers`,showErrorAlert:!1,showSuccessAlert:!1}));return l(s.data)}catch{return l([])}}const L=Ie.H.injectEndpoints({endpoints:n=>({contactPointsState:n.query({queryFn:async({amSourceName:s})=>{try{return{data:await V(s)}}catch(i){return{error:i}}}})})}),b=n=>{const s={receivers:{},errorCount:0},{currentData:i}=L.useContactPointsStateQuery({amSourceName:n??""},{skip:!n,pollingInterval:je.cB});return i??s};var z=t(86369),A=t(86489),Y=t(40271),he=t(6736),De=t(79784),Ce=t(34128),q=t(45565),_e=t(72614),Jt=t(84558),Ve=t(1814),Re=t(55936);const Xt=({onChangeReceiver:n,onChangeMatchers:s,matchingCount:i})=>{const[a,o]=(0,j.L7)(j.QI.ViewContactPoint),[g,p]=(0,Jt.l)(),x=(0,r.useRef)(null),{queryString:v,contactPoint:P}=kt(g),E=(0,R.of)(qt),I=(0,r.useCallback)(()=>(0,y.debounce)(s,500),[s]);(0,r.useEffect)(()=>{n(P)},[P,n]),(0,r.useEffect)(()=>{const D=(0,Re.Zc)(v??"").map(Ve.NL);I()(D)},[I,v]);const G=(0,r.useCallback)(()=>{x.current&&(x.current.value=""),p({contactPoint:"",queryString:void 0})},[p]),M=v||P;let T=!!(v&&v.length>3);try{v?(0,Re.S6)(v):T=!0}catch{T=!1}return(0,e.jsxs)(c.B,{direction:"row",alignItems:"flex-end",gap:1,children:[(0,e.jsx)(A.D,{className:E.noBottom,label:(0,e.jsx)(Y.J,{children:(0,e.jsxs)(c.B,{gap:.5,children:[(0,e.jsx)(d.x6,{i18nKey:"alerting.common.search-by-matchers",children:"Search by matchers"}),(0,e.jsx)(he.m,{content:(0,e.jsxs)(d.x6,{i18nKey:"alerting.policies.filter-description",children:["Filter notification policies by using a comma separated list of matchers, e.g.:",(0,e.jsx)("pre",{children:"severity=critical, region=EMEA"})]}),children:(0,e.jsx)(De.I,{name:"info-circle",size:"sm"})})]})}),invalid:!T,error:T?null:"Query must use valid matcher syntax",children:(0,e.jsx)(Ce.p,{ref:x,"data-testid":"search-query-input",placeholder:"Search",width:46,prefix:(0,e.jsx)(De.I,{name:"search"}),onChange:D=>{p({queryString:D.currentTarget.value})},defaultValue:v})}),a&&o&&(0,e.jsx)(A.D,{label:"Search by contact point",style:{marginBottom:0},children:(0,e.jsx)(_e.u,{selectProps:{id:"receiver","aria-label":"Search by contact point",onChange:D=>{p({contactPoint:D?.value?.name})},width:28,isClearable:!0},selectedContactPointName:g.get("contactPoint")??void 0})}),M&&(0,e.jsxs)(c.B,{alignItems:"center",children:[(0,e.jsx)(h.$n,{variant:"secondary",icon:"times",onClick:G,children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.clear-filters",children:"Clear filters"})}),(0,e.jsxs)(q.E,{variant:"bodySmall",color:"secondary",children:[i===0&&"No policies matching filters.",i===1&&`${i} policy matches the filters.`,i>1&&`${i} policies match the filters.`]})]})]})};function Mt(n,s){const i=new Map;function a(o,g){const p=[...g,o];if(s(o)){const x=i.get(o)??[];i.set(o,[...x,...p])}o.routes?.forEach(x=>a(x,p))}return a(n,[]),i}function Zt(n,s){const i=s.map(Tt),a=(0,Re.J$)(n).map(Tt);return i.every(o=>a.some(g=>(0,y.isEqual)(o,g)))}const Tt=([n,s,i])=>[(0,Re.yk)(n),s,(0,Re.yk)(i)],kt=n=>({queryString:n.get("queryString")??void 0,contactPoint:n.get("contactPoint")??void 0}),qt=()=>({noBottom:(0,f.css)({marginBottom:0})});var fe=t(25356),_t=t(20968),en=t(21294),tn=t(55127),et=t.n(tn),Oe=t(66384);const nn=({active:n=0,suppressed:s=0,unprocessed:i=0})=>{const a=[],o=n+s+i;return n&&a.push((0,e.jsx)(Oe.E,{color:"red",text:`${n} firing`},"firing")),s&&a.push((0,e.jsx)(Oe.E,{color:"blue",text:`${s} suppressed`},"suppressed")),i&&a.push((0,e.jsx)(Oe.E,{color:"orange",text:`${i} unprocessed`},"unprocessed")),a.length>1&&a.unshift((0,e.jsxs)(r.Fragment,{children:[o," ",et()("instance",o)]},"total")),!!a.length?(0,e.jsx)(c.B,{gap:.5,children:a}):null};var Pe=t(49785),sn=t(8270),tt=t(44826),an=t(43192);const At=(n,s)=>s(n===null?null:n?n.value?.name:"");var Be=t(10137),Ct=t(74053),$e=t(33337);const on=({actionButtons:n,alertManagerSourceName:s,onSubmit:i,route:a})=>{const o=(0,R.of)(Ct.t),[g,p]=(0,r.useState)(!1),[x,v]=(0,r.useState)((0,B.gY)(a.group_by)),P=(0,B.YE)(a),{handleSubmit:E,register:I,control:G,formState:{errors:M},setValue:T,getValues:D}=(0,Pe.mN)({defaultValues:{...P,overrideTimings:!0,overrideGrouping:!0}});return(0,e.jsxs)("form",{onSubmit:E(i),children:[(0,e.jsx)(A.D,{label:"Default contact point",invalid:!!M.receiver,error:M.receiver?.message,children:(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)("div",{className:o.container,"data-testid":"am-receiver-select",children:[(0,e.jsx)(Pe.xI,{render:({field:{onChange:w,ref:re,value:_,...k}})=>(0,e.jsx)(_e.u,{selectProps:{...k,onChange:ee=>At(ee,w)},selectedContactPointName:_}),control:G,name:"receiver",rules:{required:{value:!0,message:"Required."}}}),(0,e.jsx)("span",{children:"or"}),(0,e.jsx)(sn.N,{className:o.linkText,href:(0,U.nL)("/alerting/notifications/receivers/new",s),children:"Create a contact point"})]})})}),(0,e.jsx)(A.D,{label:"Group by",description:"Combine multiple alerts into a single notification by grouping them by the same label values.","data-testid":"am-group-select",children:(0,e.jsx)(Pe.xI,{render:({field:{onChange:w,ref:re,..._}})=>(0,e.jsx)(tt.KF,{"aria-label":"Group by",..._,allowCustomValue:!0,className:o.input,onCreateOption:k=>{v(ee=>[...ee,(0,B.Mk)(k)]),T("groupBy",[..._.value||[],k])},onChange:k=>w((0,B.ie)(k)),options:[...B.Yl,...x]}),control:G,name:"groupBy"})}),(0,e.jsx)(an.S,{collapsible:!0,className:o.collapse,isOpen:g,label:"Timing options",onToggle:p,children:(0,e.jsxs)("div",{className:o.timingFormContainer,children:[(0,e.jsx)(A.D,{label:"Group wait",description:"The waiting time before sending the first notification for a new group of alerts. Default 30 seconds.",invalid:!!M.groupWaitValue,error:M.groupWaitValue?.message,"data-testid":"am-group-wait",children:(0,e.jsx)(Be.V,{...I("groupWaitValue",{validate:B.hH}),placeholder:$e.H.group_wait,className:o.promDurationInput,"aria-label":"Group wait"})}),(0,e.jsx)(A.D,{label:"Group interval",description:"The wait time before sending a notification about changes in the alert group after the first notification has been sent. Default is 5 minutes.",invalid:!!M.groupIntervalValue,error:M.groupIntervalValue?.message,"data-testid":"am-group-interval",children:(0,e.jsx)(Be.V,{...I("groupIntervalValue",{validate:B.hH}),placeholder:$e.H.group_interval,className:o.promDurationInput,"aria-label":"Group interval"})}),(0,e.jsx)(A.D,{label:"Repeat interval",description:"The wait time before resending a notification that has already been sent successfully. Default is 4 hours. Should be a multiple of Group interval.",invalid:!!M.repeatIntervalValue,error:M.repeatIntervalValue?.message,"data-testid":"am-repeat-interval",children:(0,e.jsx)(Be.V,{...I("repeatIntervalValue",{validate:w=>{const re=D("groupIntervalValue");return(0,B.DY)(w,re)}}),placeholder:$e.H.repeat_interval,className:o.promDurationInput,"aria-label":"Repeat interval"})})]})}),(0,e.jsx)("div",{className:o.container,children:n})]})};var St=t(99764),nt=t(29010),rn=t(64467),ln=t(60937),Ee=t(81636);const bt=({actionButtons:n,route:s,onSubmit:i,defaults:a})=>{const o=(0,R.of)(cn),g=(0,R.of)(Ct.t),{selectedAlertmanager:p}=(0,de.VI)(),[,x]=(0,j.L7)(j.QI.ViewMuteTiming),[v,P]=(0,r.useState)((0,B.gY)(s?.group_by)),E=[{name:"",operator:Z.ho.equal,value:""}],I={...(0,B.YE)(s),...a},G={...I,object_matchers:s?I.object_matchers:E},{handleSubmit:M,control:T,register:D,formState:{errors:w},setValue:re,watch:_,getValues:k}=(0,Pe.mN)({defaultValues:G}),{fields:ee,append:ue,remove:Ae}=(0,Pe.jz)({control:T,name:"object_matchers"});return(0,e.jsxs)("form",{onSubmit:M(i),children:[(0,e.jsx)("input",{type:"hidden",...D("id")}),(0,e.jsxs)(c.B,{direction:"column",alignItems:"flex-start",children:[(0,e.jsx)("div",{children:"Matching labels"}),ee.length===0&&(0,e.jsx)(Oe.E,{color:"orange",className:o.noMatchersWarning,icon:"exclamation-triangle",text:"If no matchers are specified, this notification policy will handle all alert instances."}),ee.length>0&&(0,e.jsx)("div",{className:o.matchersContainer,children:ee.map((J,X)=>(0,e.jsxs)(c.B,{direction:"row",alignItems:"center",children:[(0,e.jsx)(A.D,{label:"Label",invalid:!!w.object_matchers?.[X]?.name,error:w.object_matchers?.[X]?.name?.message,children:(0,e.jsx)(Ce.p,{...D(`object_matchers.${X}.name`,{required:"Field is required"}),defaultValue:J.name,placeholder:"label",autoFocus:!0})}),(0,e.jsx)(A.D,{label:"Operator",children:(0,e.jsx)(Pe.xI,{render:({field:{onChange:ie,ref:le,...te}})=>(0,e.jsx)(tt.l6,{...te,className:o.matchersOperator,onChange:Se=>ie(Se?.value),options:Ve.xH,"aria-label":"Operator"}),defaultValue:J.operator,control:T,name:`object_matchers.${X}.operator`,rules:{required:{value:!0,message:"Required."}}})}),(0,e.jsx)(A.D,{label:"Value",invalid:!!w.object_matchers?.[X]?.value,error:w.object_matchers?.[X]?.value?.message,children:(0,e.jsx)(Ce.p,{...D(`object_matchers.${X}.value`),defaultValue:J.value,placeholder:"value"})}),(0,e.jsx)(St.K,{tooltip:"Remove matcher",name:"trash-alt",onClick:()=>Ae(X),children:"Remove"})]},J.id))}),(0,e.jsx)(h.$n,{className:o.addMatcherBtn,icon:"plus",onClick:()=>ue(B.Rg),variant:"secondary",type:"button",children:"Add matcher"})]}),(0,e.jsx)(A.D,{label:"Contact point",children:(0,e.jsx)(Pe.xI,{render:({field:{onChange:J,ref:X,value:ie,...le}})=>(0,e.jsx)(_e.u,{selectProps:{...le,className:g.input,onChange:te=>At(te,J),isClearable:!0},selectedContactPointName:ie}),control:T,name:"receiver"})}),(0,e.jsx)(A.D,{label:"Continue matching subsequent sibling nodes",children:(0,e.jsx)(nt.d,{id:"continue-toggle",...D("continue")})}),(0,e.jsx)(A.D,{label:"Override grouping",children:(0,e.jsx)(nt.d,{id:"override-grouping-toggle",...D("overrideGrouping")})}),_().overrideGrouping&&(0,e.jsx)(A.D,{label:"Group by",description:"Combine multiple alerts into a single notification by grouping them by the same label values. If empty, it is inherited from the parent policy.",children:(0,e.jsx)(Pe.xI,{rules:{validate:J=>!J||J.length===0?"At least one group by option is required.":!0},render:({field:{onChange:J,ref:X,...ie},fieldState:{error:le}})=>(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(tt.KF,{"aria-label":"Group by",...ie,invalid:!!le,allowCustomValue:!0,className:g.input,onCreateOption:te=>{P(Se=>[...Se,(0,B.Mk)(te)]),re("groupBy",[...ie.value||[],te])},onChange:te=>J((0,B.ie)(te)),options:[...B.Yl,...v]}),le&&(0,e.jsx)(rn.P,{children:le.message})]}),control:T,name:"groupBy"})}),(0,e.jsx)(A.D,{label:"Override general timings",children:(0,e.jsx)(nt.d,{id:"override-timings-toggle",...D("overrideTimings")})}),_().overrideTimings&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(A.D,{label:Ee.G.groupWait.label,description:Ee.G.groupWait.description,invalid:!!w.groupWaitValue,error:w.groupWaitValue?.message,children:(0,e.jsx)(Be.V,{...D("groupWaitValue",{validate:B.hH}),"aria-label":Ee.G.groupWait.ariaLabel,className:g.promDurationInput})}),(0,e.jsx)(A.D,{label:Ee.G.groupInterval.label,description:Ee.G.groupInterval.description,invalid:!!w.groupIntervalValue,error:w.groupIntervalValue?.message,children:(0,e.jsx)(Be.V,{...D("groupIntervalValue",{validate:B.hH}),"aria-label":Ee.G.groupInterval.ariaLabel,className:g.promDurationInput})}),(0,e.jsx)(A.D,{label:Ee.G.repeatInterval.label,description:Ee.G.repeatInterval.description,invalid:!!w.repeatIntervalValue,error:w.repeatIntervalValue?.message,children:(0,e.jsx)(Be.V,{...D("repeatIntervalValue",{validate:(J="")=>{const X=k("groupIntervalValue");return(0,B.DY)(J,X)}}),"aria-label":Ee.G.repeatInterval.ariaLabel,className:g.promDurationInput})})]}),(0,e.jsx)(A.D,{label:"Mute timings","data-testid":"am-mute-timing-select",description:"Add mute timing to policy",invalid:!!w.muteTimeIntervals,children:(0,e.jsx)(Pe.xI,{render:({field:{onChange:J,ref:X,...ie}})=>(0,e.jsx)(ln.A,{alertmanager:p,selectProps:{...ie,disabled:!x,onChange:le=>J((0,B.ie)(le))}}),control:T,name:"muteTimeIntervals"})}),n]})},cn=n=>{const s=n.spacing(3.5);return{addMatcherBtn:(0,f.css)({marginBottom:s}),matchersContainer:(0,f.css)({backgroundColor:n.colors.background.secondary,padding:`${n.spacing(1.5)} ${n.spacing(2)}`,paddingBottom:0,width:"fit-content"}),matchersOperator:(0,f.css)({minWidth:"120px"}),noMatchersWarning:(0,f.css)({padding:`${n.spacing(1)} ${n.spacing(2)}`,marginBottom:n.spacing(1)})}};var Dt=t(73370);const st=({error:n})=>{const s=(0,d.t)("alerting.policies.update-errors.title","Error saving notification policy"),i=(0,U.JZ)(n);return(0,e.jsxs)(m.F,{title:s,severity:"error",children:[(0,e.jsx)("div",{children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.update-errors.fallback",children:"Something went wrong when updating your notification policies."})}),(0,e.jsx)("div",{children:i||(0,e.jsxs)(d.x6,{i18nKey:"alerting.policies.update-errors.error-code",values:{error:n},children:['Error message: "',{error:n},'"']})}),(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.update-errors.suffix",children:"Please refresh the page and try again."})]})},dn=(n,s)=>{const[i,a]=(0,r.useState)(!1),[o,g]=(0,r.useState)(void 0),[p,x]=(0,r.useState)(),v=(0,r.useCallback)(()=>{x(void 0),g(void 0),I(void 0),a(!1)},[]),P=(0,r.useCallback)((M,T)=>{x(M),g(T),a(!0)},[]),[E,I]=(0,r.useState)(void 0);return[(0,r.useMemo)(()=>s?(0,e.jsx)(it,{isOpen:i}):(0,e.jsxs)(fe.a,{isOpen:i,onDismiss:v,closeOnBackdropClick:!0,closeOnEscape:!0,title:"Add notification policy",children:[E&&(0,e.jsx)(st,{error:E}),(0,e.jsx)(bt,{defaults:{groupBy:p?.group_by},onSubmit:M=>{p&&o&&n(M,p,o).catch(I)},actionButtons:(0,e.jsxs)(fe.a.ButtonRow,{children:[(0,e.jsx)(h.$n,{type:"button",variant:"secondary",onClick:v,fill:"outline",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)(h.$n,{type:"submit",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.save-policy",children:"Save policy"})})]})})]}),[E,n,v,o,s,p,i,I]),P,v]},un=(n,s,i)=>{const[a,o]=(0,r.useState)(!1),[g,p]=(0,r.useState)(!1),[x,v]=(0,r.useState)(),[P,E]=(0,r.useState)(void 0),I=(0,r.useCallback)(()=>{v(void 0),o(!1),E(void 0)},[]),G=(0,r.useCallback)((T,D)=>{p(D??!1),v(T),o(!0)},[]);return[(0,r.useMemo)(()=>i?(0,e.jsx)(it,{isOpen:a}):(0,e.jsxs)(fe.a,{isOpen:a,onDismiss:I,closeOnBackdropClick:!0,closeOnEscape:!0,title:"Edit notification policy",children:[P&&(0,e.jsx)(st,{error:P}),g&&x&&(0,e.jsx)(on,{alertManagerSourceName:n,onSubmit:T=>s(T).catch(E),route:x,actionButtons:(0,e.jsxs)(fe.a.ButtonRow,{children:[(0,e.jsx)(h.$n,{type:"button",variant:"secondary",onClick:I,fill:"outline",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)(h.$n,{type:"submit",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.default-policy.update",children:"Update default policy"})})]})}),!g&&(0,e.jsx)(bt,{route:x,onSubmit:T=>s(T).catch(E),actionButtons:(0,e.jsxs)(fe.a.ButtonRow,{children:[(0,e.jsx)(h.$n,{type:"button",variant:"secondary",onClick:I,fill:"outline",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)(h.$n,{type:"submit",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.update.update-policy",children:"Update policy"})})]})})]}),[i,a,I,P,g,x,n,s,E]),G,I]},mn=(n,s)=>{const[i,a]=(0,r.useState)(!1),[o,g]=(0,r.useState)(),[p,x]=(0,r.useState)(void 0),v=(0,r.useCallback)(()=>{g(void 0),a(!1),x(void 0)},[g]),P=(0,r.useCallback)(I=>{g(I),a(!0)},[]);return[(0,r.useMemo)(()=>s?(0,e.jsx)(it,{isOpen:i}):(0,e.jsxs)(fe.a,{isOpen:i,onDismiss:v,closeOnBackdropClick:!0,closeOnEscape:!0,title:"Delete notification policy",children:[p&&(0,e.jsx)(st,{error:p}),(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.delete.warning-1",children:"Deleting this notification policy will permanently remove it."})," ",(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.delete.warning-2",children:"Are you sure you want to delete this policy?"}),(0,e.jsxs)(fe.a.ButtonRow,{children:[(0,e.jsx)(h.$n,{type:"button",variant:"destructive",onClick:()=>o&&n(o).catch(x),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.delete.confirm",children:"Yes, delete policy"})}),(0,e.jsx)(h.$n,{type:"button",variant:"secondary",onClick:v,children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})]})]}),[v,s,i,p,o,n]),P,v]},pn=n=>{const[s,i]=(0,r.useState)(!1),[a,o]=(0,r.useState)([]),[g,p]=(0,r.useState)([]),[x,v]=(0,r.useState)("default"),P=(0,r.useCallback)(()=>{i(!1),o([]),p([])},[]),E=(0,r.useCallback)((M,T,D)=>{o(M),T&&p(T),D&&v(D),i(!0)},[]),I=(0,r.useMemo)(()=>{const M=a.flatMap(T=>T.alerts);return(0,y.groupBy)(M,T=>T.status.state)},[a]);return[(0,r.useMemo)(()=>(0,e.jsxs)(fe.a,{isOpen:s,onDismiss:P,closeOnBackdropClick:!0,closeOnEscape:!0,title:(0,e.jsxs)(c.B,{direction:"row",alignItems:"center",gap:1,wrap:"wrap",children:[(0,e.jsxs)(c.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(De.I,{name:"x"})," ",(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.matchers",children:"Matchers"})]}),(0,e.jsx)(Dt.s,{matchers:g,formatter:x})]}),children:[(0,e.jsxs)(c.B,{direction:"column",children:[(0,e.jsx)(nn,{active:I[Z.Or.Active]?.length,suppressed:I[Z.Or.Suppressed]?.length,unprocessed:I[Z.Or.Unprocessed]?.length}),(0,e.jsx)("div",{children:a.map((M,T)=>(0,e.jsx)(en._,{alertManagerSourceName:n,group:M},T))})]}),(0,e.jsx)(fe.a.ButtonRow,{children:(0,e.jsx)(h.$n,{type:"button",variant:"secondary",onClick:P,children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})})]}),[a,P,I,g,x,s,n]),E,P]},it=({isOpen:n})=>(0,e.jsx)(fe.a,{isOpen:n,onDismiss:()=>{},closeOnBackdropClick:!1,closeOnEscape:!1,title:(0,e.jsxs)(c.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.update.updating",children:"Updating..."})," ",(0,e.jsx)(_t.y,{inline:!0})]}),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.update.please-wait",children:"Please wait while we update your notification policies."})});var at=t(42941),gn=t(32370),Rt=t(60232),xe=t(19224),Ot=t(54731),hn=t(27671),ot=t(76966),fn=t(5127),rt=t(98747),xn=t(74625),Ue=t(57323),lt=t(2178),Bt=t(36692),ve=t(76778),Nt=t(27219),wt=t(7484),ze=t(81876),ct=t(5240),dt=t(75319),Lt=t(41494),Kt=t(65071);const vn=({exportFormat:n,onClose:s})=>{const{currentData:i="",isFetching:a}=ct.hK.useExportPoliciesQuery({format:n}),o=`policies-${new Date().getTime()}`;return a?(0,e.jsx)(ze._,{text:"Loading...."}):(0,e.jsx)(dt.J,{format:n,textDefinition:i,downloadFileName:o,onClose:s})},yn=({onClose:n})=>{const[s,i]=(0,r.useState)("yaml");return(0,e.jsx)(Lt.m,{activeTab:s,onTabChange:i,onClose:n,formatProviders:Object.values(Kt.sl),children:(0,e.jsx)(vn,{exportFormat:s,onClose:n})})},Wt=20,Gt=n=>{const{receivers:s=[],contactPointsState:i,readOnly:a=!1,provisioned:o=!1,alertManagerSourceName:g,currentRoute:p,inheritedProperties:x,routesMatchingFilters:v={filtersApplied:!1,matchedRoutesWithPath:new Map},matchingInstancesPreview:P={enabled:!1},onEditPolicy:E,onAddPolicy:I,onDeletePolicy:G,onShowAlertInstances:M,isAutoGenerated:T=!1,isDefaultPolicy:D=!1}=n,w=(0,R.of)(Ne),re=p.receiver,_=p.continue??!1,k=(0,Re.J$)(p),ee=!!(k&&k.length),{filtersApplied:ue,matchedRoutesWithPath:Ae}=v,J=Array.from(Ae.keys()),X=ue&&J.some(ne=>ne.id===p.id),ie=Array.from(Ae.values()).flat(),le=ie.some(ne=>ne.id===p.id),te=[],Se=!ee&&!D&&!_,mt=re??x?.receiver??"",me=i?Rn(mt,i):[],He=p.routes??[],we=ue?He.filter(ne=>ie.some(Fe=>Fe.id===ne.id)):He,Ye=we.length>0,[Je,Xe]=(0,at.A)(!1),Le=P?.groupsMap?.get(p.id),pt=Le?(0,y.sumBy)(Le,ne=>ne.alerts.length):void 0,[gt,Ke]=(0,j.L7)(j.QI.ViewAutogeneratedPolicyTree),be=Ft(p),[We,ht]=(0,at.A)(!be),ft=p.group_by,xt=p.mute_time_intervals??[],vt=p.active_time_intervals??[],yt={group_wait:p.group_wait,group_interval:p.group_interval,repeat_interval:p.repeat_interval};me.forEach(ne=>{te.push(ne)});const[Ze,jt]=(0,r.useState)(Wt),ke=Pn(T,D,o,E,p,Xe,G);if(T&&(!Ke||!gt)||ue&&!le)return null;const Pt=D||be,Et=we.filter(ne=>ie.some(Fe=>Fe.id===ne.id)),qe=ue?Et:we,ce=qe.slice(0,Ze),Ge=qe.length-ce.length,It=Ge>0;return(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)(c.B,{direction:"column",gap:1.5,children:[(0,e.jsxs)("div",{className:w.policyWrapper(X),"data-testid":D?"am-root-route-container":"am-route-container",children:[_&&(0,e.jsx)(Mn,{}),Se&&(0,e.jsx)(Tn,{}),(0,e.jsx)("div",{className:w.policyItemWrapper,children:(0,e.jsxs)(c.B,{direction:"column",gap:1,children:[(0,e.jsx)("div",{children:(0,e.jsxs)(c.B,{direction:"row",alignItems:"center",gap:1,children:[Ye?(0,e.jsx)(St.K,{name:We?"angle-down":"angle-right",onClick:ht,"aria-label":We?"Collapse":"Expand"}):null,Pt?be?(0,e.jsx)(Cn,{}):(0,e.jsx)(An,{}):ee?(0,e.jsx)(Dt.s,{matchers:k??[],formatter:(0,Ve.VE)(g)}):(0,e.jsx)("span",{className:w.metadata,children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.no-matchers",children:"No matchers"})}),(0,e.jsx)(wt.h,{}),te.length>0&&(0,e.jsx)(In,{errors:te}),o&&(0,e.jsx)(Nt.rS,{}),(0,e.jsxs)(c.B,{direction:"row",gap:.5,children:[!T&&!a&&(0,e.jsx)(Ue._,{actions:[j.QI.CreateNotificationPolicy],children:(0,e.jsx)(ot.A,{shouldWrap:o,wrap:ut,children:D?(0,e.jsx)(h.$n,{variant:"secondary",icon:"plus",size:"sm",disabled:o,type:"button",onClick:()=>I(p,"child"),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.new-child",children:"New child policy"})}):(0,e.jsx)(Rt.m,{overlay:(0,e.jsxs)(xe.W,{children:[(0,e.jsx)(xe.W.Item,{label:"New sibling above",icon:"arrow-up",onClick:()=>I(p,"above")}),(0,e.jsx)(xe.W.Item,{label:"New sibling below",icon:"arrow-down",onClick:()=>I(p,"below")}),(0,e.jsx)(xe.W.Divider,{}),(0,e.jsx)(xe.W.Item,{label:"New child policy",icon:"plus",onClick:()=>I(p,"child")})]}),children:(0,e.jsx)(h.$n,{size:"sm",variant:"secondary",disabled:o,icon:"angle-down",type:"button",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.new-policy",children:"Add new policy"})})})})}),ke.length>0&&(0,e.jsx)(Rt.m,{overlay:(0,e.jsx)(xe.W,{children:ke}),children:(0,e.jsx)(fn.A,{"aria-label":D?"more actions for default policy":"more actions for policy","data-testid":"more-actions"})})]})]})}),(0,e.jsx)(jn,{matchingInstancesPreview:P,numberOfAlertInstances:pt,contactPoint:re??void 0,groupBy:ft,muteTimings:xt,activeTimings:vt,timingOptions:yt,inheritedProperties:x,alertManagerSourceName:g,receivers:s,matchingAlertGroups:Le,matchers:k,isDefaultPolicy:D,onShowAlertInstances:M})]})})]}),(0,e.jsx)("div",{className:w.childPolicies,children:We&&(0,e.jsxs)(e.Fragment,{children:[ce.map(ne=>{const Fe=(0,se.W$)(p,ne,x),as=Ft(ne)||T,os=a||o||T;return(0,e.jsx)(Gt,{currentRoute:ne,receivers:s,contactPointsState:i,readOnly:os,inheritedProperties:Fe,onAddPolicy:I,onEditPolicy:E,onDeletePolicy:G,onShowAlertInstances:M,alertManagerSourceName:g,routesMatchingFilters:v,matchingInstancesPreview:P,isAutoGenerated:as,provisioned:o},ne.id)}),It&&(0,e.jsx)(h.$n,{size:"sm",icon:"angle-down",variant:"secondary",className:w.moreButtons,onClick:()=>jt(Ze+Wt),children:(0,e.jsxs)(d.x6,{i18nKey:"alerting.policies.n-more-policies",count:Ge,children:[{count:Ge}," additional policies"]})})]})}),Je&&(0,e.jsx)(yn,{onClose:Xe})]})})};function jn({numberOfAlertInstances:n,isDefaultPolicy:s,timingOptions:i,groupBy:a,muteTimings:o=[],activeTimings:g=[],matchingInstancesPreview:p,inheritedProperties:x,matchingAlertGroups:v,onShowAlertInstances:P,matchers:E,contactPoint:I,alertManagerSourceName:G,receivers:M}){const T=(0,R.of)(Ne),D=x&&x.group_by,w=x&&Object.keys(x).length>0,re=(0,y.isArray)(a)&&a[0]==="...",_=!re&&(0,y.isArray)(a)&&a.length>0,k=s&&(0,y.isArray)(a)&&a.length===0,ee=!!o.length,ue=!!g.length;return(0,e.jsx)("div",{className:T.metadataRow,children:(0,e.jsxs)(c.B,{direction:"row",alignItems:"center",gap:1,children:[p.enabled&&(0,e.jsxs)(ve.P,{icon:"layers-alt",onClick:()=>{v&&P(v,E,(0,Ve.VE)(G))},"data-testid":"matching-instances",children:[(0,e.jsx)(q.E,{color:"primary",children:n??"-"}),(0,e.jsx)("span",{children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.n-instances",count:n??0,children:"instance"})})]}),I&&(0,e.jsxs)(ve.P,{icon:"at","data-testid":"contact-point",children:[(0,e.jsxs)("span",{children:[(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.delivered-to",children:"Delivered to"})," "]}),(0,e.jsx)(Dn,{alertManagerSourceName:G,receivers:M,contactPoint:I})]}),!D&&(0,e.jsxs)(e.Fragment,{children:[_&&(0,e.jsxs)(ve.P,{icon:"layer-group","data-testid":"grouping",children:[(0,e.jsxs)("span",{children:[(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.grouped-by",children:"Grouped by"})," "]}),(0,e.jsx)(q.E,{color:"primary",children:a.join(", ")})]}),k&&(0,e.jsx)(ve.P,{icon:"layer-group",children:(0,e.jsx)("span",{children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.grouping.single-group",children:"Single group"})})}),re&&(0,e.jsx)(ve.P,{icon:"layer-group",children:(0,e.jsx)("span",{children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.grouping.none",children:"Not grouping"})})})]}),ee&&(0,e.jsxs)(ve.P,{icon:"calendar-slash","data-testid":"mute-timings",children:[(0,e.jsxs)("span",{children:[(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.mute-time",children:"Muted when"})," "]}),(0,e.jsx)(Vt,{timings:o,alertManagerSourceName:G})]}),ue&&(0,e.jsxs)(ve.P,{icon:"calendar-alt","data-testid":"active-timings",children:[(0,e.jsxs)("span",{children:[(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.active-time",children:"Active when"})," "]}),(0,e.jsx)(Vt,{timings:g,alertManagerSourceName:G})]}),i&&(0,e.jsx)(bn,{timingOptions:i}),w&&(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)(ve.P,{icon:"corner-down-right-alt","data-testid":"inherited-properties",children:[(0,e.jsx)("span",{children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.inherited",children:"Inherited"})}),(0,e.jsx)(Sn,{properties:x})]})})]})})}const Pn=(n,s,i,a,o,g,p)=>{const[[x,v],[P,E],[I,G]]=(0,j.Hl)([j.QI.UpdateNotificationPolicyTree,j.QI.DeleteNotificationPolicy,j.QI.ExportNotificationPolicies]),M=[],T=G&&I&&s&&!n,D=x&&v,w=P&&E&&!s&&!n;return D&&M.push((0,e.jsx)(r.Fragment,{children:(0,e.jsx)(ot.A,{shouldWrap:i,wrap:ut,children:(0,e.jsx)(xe.W.Item,{icon:"edit",disabled:i||n,label:"Edit",onClick:()=>a(o,s)})})},"edit-policy")),T&&M.push((0,e.jsx)(xe.W.Item,{icon:"download-alt",label:"Export",onClick:g},"export-policy")),w&&M.push((0,e.jsxs)(r.Fragment,{children:[(0,e.jsx)(xe.W.Divider,{}),(0,e.jsx)(ot.A,{shouldWrap:i,wrap:ut,children:(0,e.jsx)(xe.W.Item,{destructive:!0,icon:"trash-alt",disabled:i||n,label:"Delete",onClick:()=>p(o)})})]},"delete-policy")),M},En="__grafana_autogenerated__";function Ft(n){return!(gn.$.featureToggles.alertingSimplifiedRouting??!1)||!n.object_matchers?!1:n.object_matchers.some(i=>i[0]===En&&i[1]===Z.ho.equal&&i[2]==="true")??!1}const ut=n=>(0,e.jsx)(he.m,{content:"Provisioned items cannot be edited in the UI",placement:"top",children:(0,e.jsx)("span",{children:n})}),In=({errors:n})=>(0,e.jsx)(lt.B,{arrow:!0,placement:"top",content:(0,e.jsx)(c.B,{direction:"column",gap:.5,children:n.map(s=>(0,e.jsx)(r.Fragment,{children:s},(0,y.uniqueId)()))}),children:(0,e.jsx)("span",{children:(0,e.jsx)(Oe.E,{icon:"exclamation-circle",color:"red",text:et()("error",n.length,!0)})})}),Mn=()=>{const n=(0,R.of)(Ne);return(0,e.jsx)(he.m,{placement:"top",content:"This route will continue matching other policies",children:(0,e.jsx)("div",{className:n.gutterIcon,"data-testid":"continue-matching",children:(0,e.jsx)(De.I,{name:"arrow-down"})})})},Tn=()=>{const n=(0,R.of)(Ne);return(0,e.jsx)(he.m,{placement:"top",content:"This policy matches all labels",children:(0,e.jsx)("div",{className:n.gutterIcon,"data-testid":"matches-all",children:(0,e.jsx)(De.I,{name:"exclamation-triangle"})})})};function An(){const n=(0,R.of)(Ne);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(q.E,{element:"h2",variant:"body",weight:"medium",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.default-policy.title",children:"Default policy"})}),(0,e.jsx)("span",{className:n.metadata,children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.default-policy.description",children:"All alert instances will be handled by the default policy if no other matching policies are found."})})]})}function Cn(){return(0,e.jsx)(q.E,{element:"h3",variant:"body",weight:"medium",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.generated-policies",children:"Auto-generated policies"})})}const Sn=({properties:n})=>(0,e.jsx)(lt.B,{arrow:!0,placement:"top",content:(0,e.jsx)(c.B,{direction:"row",gap:.5,children:Object.entries(n).map(([s,i])=>i?(0,e.jsx)(Bt.J,{label:On(s),value:Bn(s,i)},s):null)}),children:(0,e.jsx)("div",{children:(0,e.jsx)(q.E,{color:"primary",children:et()("property",Object.keys(n).length,!0)})})}),Vt=({timings:n,alertManagerSourceName:s})=>{const[,i]=(0,j.L7)(j.QI.ViewMuteTiming);return(0,e.jsx)("div",{children:n.map((a,o)=>{const g=i?Ot.Y:q.E;return(0,e.jsxs)(r.Fragment,{children:[(0,e.jsx)(g,{href:(0,U.i7)(a,s),color:i?"primary":"secondary",variant:"bodySmall",inline:i?!1:void 0,children:a}),o<n.length-1&&", "]},a)})})},bn=({timingOptions:n})=>{const s=n.group_wait,i=n.group_interval,a=n.repeat_interval;if(!s&&!i&&!a)return null;const o=[];return s&&o.push((0,e.jsx)(he.m,{placement:"top",content:(0,d.t)("alerting.policies.metadata.timingOptions.groupWait.description","How long to initially wait to send a notification for a group of alert instances."),children:(0,e.jsx)("span",{children:(0,e.jsxs)(d.x6,{i18nKey:"alerting.policies.metadata.timingOptions.groupWait.label",children:["Wait ",(0,e.jsx)(rt.S,{content:s})," to group instances"]})})})),i&&o.push((0,e.jsx)(he.m,{placement:"top",content:(0,d.t)("alerting.policies.metadata.timingOptions.groupInterval.description","How long to wait before sending a notification about new alerts that are added to a group of alerts for which an initial notification has already been sent."),children:(0,e.jsx)("span",{children:(0,e.jsxs)(d.x6,{i18nKey:"alerting.policies.metadata.timingOptions.groupInterval.label",children:["Wait ",(0,e.jsx)(rt.S,{content:i})," before sending updates"]})})})),a&&o.push((0,e.jsx)(he.m,{placement:"top",content:(0,d.t)("alerting.policies.metadata.timingOptions.repeatInterval.description","How often notifications are sent if the group of alerts has not changed since the last notification."),children:(0,e.jsx)("span",{children:(0,e.jsxs)(d.x6,{i18nKey:"alerting.policies.metadata.timingOptions.repeatInterval.label",children:["Repeated every ",(0,e.jsx)(rt.S,{content:a})]})})})),(0,e.jsx)(ve.P,{icon:"hourglass","data-testid":"timing-options",children:o.map((g,p)=>(0,e.jsxs)("span",{children:[g,p<o.length-1&&" \xB7 "]},(0,y.uniqueId)()))})},Dn=({alertManagerSourceName:n,contactPoint:s,receivers:i})=>{const a=i.find(p=>p.name===s);if(!a)return(0,e.jsx)(q.E,{color:"secondary",variant:"bodySmall",children:s});const o=a.grafana_managed_receiver_configs,g="id"in a&&a.id?(0,U.bg)(a.id,n):(0,U.bI)(a.name,n);return(0,e.jsx)(lt.B,{disabled:!o,arrow:!0,placement:"top",header:(0,e.jsx)(ve.P,{icon:"at",children:(0,e.jsx)(q.E,{color:"primary",children:s})}),content:(0,e.jsx)(q.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(xn.yz,{receivers:a.grafana_managed_receiver_configs||[],limit:3})}),children:(0,e.jsx)(Ot.Y,{href:g,color:"primary",variant:"bodySmall",inline:!1,children:s})},(0,y.uniqueId)())};function Rn(n,s){return Object.entries(s[n]?.notifiers??[]).reduce((o=[],[g,p])=>{const x=p.filter(v=>v.lastNotifyAttemptError).map(v=>(0,e.jsx)(Bt.J,{icon:"at",label:`Contact Point \u203A ${v.name}`,value:v.lastNotifyAttemptError},(0,y.uniqueId)()));return o.concat(x)},[])}const On=n=>{switch(n){case"receiver":return"Contact Point";case"group_by":return"Group by";case"group_interval":return"Group interval";case"group_wait":return"Group wait";case"repeat_interval":return"Repeat interval";default:return n}},Bn=(n,s)=>{const i=n==="group_by"&&Array.isArray(s)&&s[0]==="...",a=n==="group_by"&&Array.isArray(s)&&s.length===0;return i?(0,e.jsx)(q.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.grouping.none",children:"Not grouping"})}):a?(0,e.jsx)(q.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.metadata.grouping.single-group",children:"Single group"})}):Array.isArray(s)?s.join(", "):s},Ne=n=>({matcher:s=>{const{color:i,borderColor:a}=(0,hn.MC)(s);return{wrapper:(0,f.css)({color:"#fff",background:i,padding:`${n.spacing(.33)} ${n.spacing(.66)}`,fontSize:n.typography.bodySmall.fontSize,border:`solid 1px ${a}`,borderRadius:n.shape.radius.default})}},childPolicies:(0,f.css)({marginLeft:n.spacing(4),position:"relative","&:before":{content:'""',position:"absolute",height:"calc(100% - 10px)",borderLeft:`solid 1px ${n.colors.border.weak}`,marginTop:0,marginLeft:"-20px"}}),policyItemWrapper:(0,f.css)({padding:n.spacing(1.5)}),metadataRow:(0,f.css)({borderBottomLeftRadius:n.shape.borderRadius(2),borderBottomRightRadius:n.shape.borderRadius(2)}),policyWrapper:(s=!1)=>(0,f.css)({flex:1,position:"relative",background:n.colors.background.secondary,borderRadius:n.shape.radius.default,border:`solid 1px ${n.colors.border.weak}`,...s&&{borderColor:n.colors.primary.border,background:n.colors.primary.transparent}}),metadata:(0,f.css)({color:n.colors.text.secondary,fontSize:n.typography.bodySmall.fontSize,fontWeight:n.typography.bodySmall.fontWeight}),break:(0,f.css)({width:"100%",height:0,marginBottom:n.spacing(2)}),gutterIcon:(0,f.css)({position:"absolute",top:0,transform:"translateY(50%)",left:`-${n.spacing(4)}`,color:n.colors.text.secondary,background:n.colors.background.primary,width:"25px",height:"25px",textAlign:"center",border:`solid 1px ${n.colors.border.weak}`,borderRadius:n.shape.radius.default,padding:0}),moreButtons:(0,f.css)({marginTop:n.spacing(.5),marginBottom:n.spacing(1.5)})});var Qe=t(27889);const Nn=()=>{const n=(0,N._2)(),[s,i]=(0,j.L7)(j.QI.ViewContactPoint),[a,o]=(0,j.L7)(j.QI.ViewAlertGroups),{useGetAlertmanagerAlertGroupsQuery:g}=ye.m,[p,x]=(0,r.useState)(),[v,P]=(0,r.useState)([]),{selectedAlertmanager:E,hasConfigurationAPI:I,isGrafanaAlertmanager:G}=(0,de.VI)(),{getRouteGroupsMap:M}=(0,z.L)(),T=s&&i,D=b(T?E??"":""),{currentData:w,isLoading:re,error:_,refetch:k}=(0,Qe.yV)({alertmanager:E??""}),[ee]=w??[],[ue,Ae]=(0,Qe.a1)({alertmanager:E??""}),[J,X]=(0,Qe.F)({alertmanager:E??""}),[ie,le]=(0,Qe.g0)({alertmanager:E??""}),{currentData:te,refetch:Se}=g({amSourceName:E??""},{skip:!o||!E}),{contactPoints:mt}=(0,H.dK)({alertmanager:E??"",fetchPolicies:!1,fetchStatuses:!0,skip:!T}),me=(0,r.useMemo)(()=>{if(ee)return(0,B.QM)(ee)},[ee]),[{value:He,error:we},Ye]=(0,O.A)(M,[M]);(0,r.useEffect)(()=>{me&&te&&Ye(me,te,{unquoteMatchers:!G})},[me,te,Ye,G]);const Je=(0,r.useMemo)(()=>me?wn(me,{contactPointFilter:p,labelMatchersFilter:v}):{filtersApplied:!1,matchedRoutesWithPath:new Map},[p,v,me]),Xe=()=>{k(),J.reset(),ue.reset(),ie.reset()};async function Le(ce){await J.execute(ce),Ke({error:X.error})}async function pt(ce){await ue.execute(ce.id),Ke({error:Ae.error})}async function gt(ce,Ge,It){await ie.execute({partialRoute:ce,referenceRouteIdentifier:Ge.id,insertPosition:It}),Ke({error:le.error})}function Ke({error:ce}){ce||n.success("Updated notification policies"),E&&Se(),yt(),ft(),ke()}const be=(0,oe.Gz)(X,Ae,le).loading,[We,ht,ft]=dn(gt,be),[xt,vt,yt]=un(E??"",Le,be),[Ze,jt,ke]=mn(pt,be),[Ht,Yt]=pn(E??"");if(!E)return null;const Pt=me&&!_&&!re,Et=!!_&&!re,qe=[le,X,Ae].some(ce=>(0,oe.bJ)(ce)&&(0,U.E2)(ce.error)===pe.g2);return(0,e.jsxs)(e.Fragment,{children:[Et&&(0,e.jsx)(m.F,{severity:"error",title:"Error loading Alertmanager config",children:(0,U.JZ)(_)||"Unknown error."}),qe&&(0,e.jsx)(m.F,{severity:"info",title:"Notification policies have changed",children:(0,e.jsxs)(c.B,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.update-errors.conflict",children:"The notification policy tree has been updated by another user."}),(0,e.jsx)(h.$n,{onClick:Xe,children:(0,e.jsx)(d.x6,{i18nKey:"alerting.policies.reload-policies",children:"Reload policies"})})]})}),Pt&&(0,e.jsxs)(c.B,{direction:"column",gap:1,children:[(0,e.jsx)(Xt,{onChangeMatchers:P,onChangeReceiver:x,matchingCount:Je.matchedRoutesWithPath.size}),(0,e.jsx)(Gt,{receivers:mt,currentRoute:(0,y.defaults)(me,$e.H),contactPointsState:D.receivers,readOnly:!I,provisioned:me[Z.uz]?.provisioned,alertManagerSourceName:E,onAddPolicy:ht,onEditPolicy:vt,onDeletePolicy:jt,onShowAlertInstances:Yt,routesMatchingFilters:Je,matchingInstancesPreview:{groupsMap:He,enabled:!!(o&&!we)},isAutoGenerated:!1,isDefaultPolicy:!0})]}),We,xt,Ze,Ht]})},wn=(n,s)=>{const{contactPointFilter:i,labelMatchersFilter:a=[]}=s,o=i||a.length>0,g=!!i&&a.length>0;if(!o)return{filtersApplied:!1,matchedRoutesWithPath:new Map};const p=[],x=(0,se._I)(n),v=i?Mt(x,M=>M.receiver===i):new Map,P=Array.from(v.keys());P&&p.push(P);const E=a.length?Mt(x,M=>Zt(M,a)):new Map,I=Array.from(E.keys());return E.size>0&&p.push(I),{filtersApplied:!0,matchedRoutesWithPath:g?Ln(E,v):new Map([...E,...v])}};function Ln(...n){const s=new Map;for(const i of n[0].keys())n.every(a=>a.has(i))&&s.set(i,n[0].get(i));return s}var Kn=t(32174),Wn=t(93185),Gn=t(65164);const Fn=({exportFormat:n,onClose:s})=>{const{currentData:i="",isFetching:a}=ct.hK.useExportMuteTimingsQuery({format:n}),o=`mute-timings-${new Date().getTime()}`;return a?(0,e.jsx)(ze._,{text:"Loading...."}):(0,e.jsx)(dt.J,{format:n,textDefinition:i,downloadFileName:o,onClose:s})},Vn=({exportFormat:n,onClose:s,muteTimingName:i})=>{const{currentData:a="",isFetching:o}=ct.hK.useExportMuteTimingQuery({format:n,muteTiming:i}),g=`mute-timing-${i}-${new Date().getTime()}`;return o?(0,e.jsx)(ze._,{text:"Loading...."}):(0,e.jsx)(dt.J,{format:n,textDefinition:a,downloadFileName:g,onClose:s})},$t=({onClose:n,muteTimingName:s})=>{const[i,a]=(0,r.useState)("yaml");return(0,e.jsx)(Lt.m,{activeTab:i,onTabChange:a,onClose:n,formatProviders:Object.values(Kt.sl),children:s?(0,e.jsx)(Vn,{exportFormat:i,onClose:n,muteTimingName:s}):(0,e.jsx)(Fn,{exportFormat:i,onClose:n})})},Ut=Symbol("all mute timings"),zt=()=>{const[n,s]=(0,r.useState)(null),[i,a]=(0,at.A)(!1),o=(0,r.useCallback)(()=>{s(null),a(!1)},[a]),g=x=>{s(x),a(!0)};return[(0,r.useMemo)(()=>!n||!i?null:n===Ut?(0,e.jsx)($t,{onClose:o}):(0,e.jsx)($t,{muteTimingName:n,onClose:o}),[i,o,n]),g]};var $n=t(45015);const Un=({muteTiming:n,alertManagerSourceName:s})=>{const[i,a]=(0,$.gB)({alertmanager:s}),[o,g]=(0,r.useState)(!1),[p,x]=zt(),[v,P]=(0,j.L7)(j.QI.ExportMuteTimings),E=()=>g(!1),I=s===Te.hY,G=(0,U.nL)("/alerting/routes/mute-timing/edit",s,{muteName:n.id}),M=(0,e.jsx)(h.z9,{href:G,variant:"secondary",size:"sm",icon:n.provisioned?"eye":"pen",disabled:(0,oe.VP)(a),children:n.provisioned?(0,e.jsx)(d.x6,{i18nKey:"alerting.common.view",children:"View"}):(0,e.jsx)(d.x6,{i18nKey:"alerting.common.edit",children:"Edit"})});return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(c.B,{direction:"row",alignItems:"center",justifyContent:"flex-end",wrap:"wrap",children:[!I&&(0,$n.d6)(n)&&(0,e.jsx)(Oe.E,{text:"Disabled",color:"orange"}),(0,e.jsx)(Ue._,{actions:[j.QI.UpdateMuteTiming],children:M}),v&&(0,e.jsx)(h.z9,{icon:"download-alt",variant:"secondary",size:"sm","data-testid":"export",disabled:!P||(0,oe.VP)(a),onClick:()=>x(n.name),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.export",children:"Export"})}),!n.provisioned&&(0,e.jsx)(Ue._,{actions:[j.QI.DeleteMuteTiming],children:(0,e.jsx)(h.z9,{icon:"trash-alt",variant:"secondary",size:"sm",onClick:()=>g(!0),disabled:(0,oe.VP)(a),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.delete",children:"Delete"})})})]}),(0,e.jsx)(Gn.u,{isOpen:o,title:"Delete mute timing",body:`Are you sure you would like to delete "${n.name}"?`,confirmText:(0,d.t)("alerting.common.delete","Delete"),onConfirm:async()=>{await i.execute({name:n?.metadata?.name??n.name}),E()},onDismiss:E}),p]})};var zn=t(18269),Qn=t(50585),Hn=t(4158);const Qt=({buttonIcon:n,buttonLabel:s,buttonSize:i="lg",buttonVariant:a="primary",onButtonClick:o,text:g,href:p,showButton:x=!0})=>{const v=(0,R.of)(Yn),P={className:v.button,icon:n,size:i,variant:a};return(0,e.jsx)(Hn.Z,{children:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("p",{className:v.text,children:g}),x&&(p?(0,e.jsx)(h.z9,{href:p,type:"button",...P,children:s}):(0,e.jsx)(h.$n,{onClick:o,type:"button",...P,children:s}))]})})},Yn=n=>({container:(0,f.css)({backgroundColor:n.colors.background.secondary,color:n.colors.text.secondary,padding:n.spacing(4),textAlign:"center"}),text:(0,f.css)({marginBottom:n.spacing(2)}),button:(0,f.css)({margin:n.spacing(2,0,1)})});var Jn=t(9894);const Xn=()=>{const{selectedAlertmanager:n="",hasConfigurationAPI:s}=(0,de.VI)(),i=!s,a=(0,R.of)(kn),[o,g]=zt(),{data:p,isLoading:x,error:v}=(0,$.Ad)({alertmanager:n??""}),P=(0,r.useMemo)(()=>(p||[]).map(w=>({id:w.id,data:w})),[p]),[E,I]=(0,j.L7)(j.QI.CreateMuteTiming),[G,M]=(0,j.L7)(j.QI.ExportMuteTimings),T=Zn(n,i);return x?(0,e.jsx)(ze._,{text:"Loading mute timings..."}):v?(0,e.jsx)(m.F,{severity:"error",title:(0,d.t)("alerting.mute_timings.error-loading.title","Error loading mute timings"),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.mute_timings.error-loading.description",children:"Could not load mute timings. Please try again later."})}):(0,e.jsxs)("div",{className:a.container,children:[(0,e.jsxs)(c.B,{direction:"row",alignItems:"center",children:[(0,e.jsx)(d.x6,{i18nKey:"alerting.mute-timings.description",children:"Enter specific time intervals when not to send notifications or freeze notifications for recurring periods of time."}),(0,e.jsx)(wt.h,{}),!i&&P.length>0&&(0,e.jsx)(Ue._,{actions:[j.QI.CreateMuteTiming],children:(0,e.jsx)(h.z9,{className:a.muteTimingsButtons,icon:"plus",variant:"primary",href:(0,U.nL)("alerting/routes/mute-timing/new",n),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.mute-timings.add-mute-timing",children:"Add mute timing"})})}),G&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(h.$n,{icon:"download-alt",className:a.muteTimingsButtons,variant:"secondary",disabled:!M,onClick:()=>g(Ut),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.export-all",children:"Export all"})}),o]})]}),P.length>0?(0,e.jsx)(Qn.E,{items:P,cols:T,pagination:{itemsPerPage:25}}):i?(0,e.jsx)(Qt,{text:"No mute timings configured",buttonLabel:"",showButton:!1}):(0,e.jsx)(Qt,{text:"You haven't created any mute timings yet",buttonLabel:"Add mute timing",buttonIcon:"plus",buttonSize:"lg",href:(0,U.nL)("alerting/routes/mute-timing/new",n),showButton:I})]})};function Zn(n,s=!1){const[[i,a],[o,g]]=(0,j.Hl)([j.QI.UpdateMuteTiming,j.QI.DeleteMuteTiming]),p=!s&&(a||g);return(0,r.useMemo)(()=>{const x=[{id:"name",label:"Name",renderCell:function({data:P}){return(0,e.jsxs)("div",{children:[P.name," ",P.provisioned&&(0,e.jsx)(Nt.rS,{tooltip:!0,provenance:P.metadata?.annotations?.[zn.a3]})]})},size:1},{id:"timeRange",label:"Time range",renderCell:({data:v})=>(0,Jn.av)(v),size:5}];return p&&x.push({id:"actions",label:"Actions",alignColumn:"end",renderCell:({data:v})=>(0,e.jsx)(Un,{muteTiming:v,alertManagerSourceName:n}),size:2}),x},[p,n])}const kn=n=>({container:(0,f.css)({display:"flex",flexFlow:"column nowrap"}),muteTimingsButtons:(0,f.css)({marginBottom:n.spacing(2)})});var qn=t(37104),_n=(n=>(n.NotificationPolicies="notification_policies",n.MuteTimings="mute_timings",n))(_n||{});const es=()=>{const n=(0,R.of)(ts),{selectedAlertmanager:s=""}=(0,de.VI)(),[i,a]=(0,j.L7)(j.QI.ViewNotificationPolicyTree),[o,g]=(0,j.L7)(j.QI.ViewMuteTiming),p=[a&&"notification_policies",g&&"mute_timings"].filter(w=>!!w),{data:x=[]}=(0,$.Ad)({alertmanager:s,skip:!g}),[v,P]=(0,W.s)(),{tab:E}=ns(v,p[0]),[I,G]=(0,r.useState)(E),M=I==="mute_timings",T=I==="notification_policies",D=x.length;return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Wn.M,{currentAlertmanager:s}),(0,e.jsxs)(Q.U,{children:[i&&a&&(0,e.jsx)(C.o,{label:"Notification Policies",active:T,onChangeTab:()=>{G("notification_policies"),P({tab:"notification_policies"})}}),o&&g&&(0,e.jsx)(C.o,{label:"Mute Timings",active:M,counter:D,onChangeTab:()=>{G("mute_timings"),P({tab:"mute_timings"})}})]}),(0,e.jsxs)(K.J,{className:n.tabContent,children:[T&&(0,e.jsx)(Nn,{}),M&&(0,e.jsx)(Xn,{})]})]})},ts=n=>({tabContent:(0,f.css)({marginTop:n.spacing(2)})});function ns(n,s){let i=s;return n.tab==="notification_policies"&&(i="notification_policies"),n.tab==="mute_timings"&&(i="mute_timings"),{tab:i}}function ss(){return(0,e.jsx)(Kn.y,{navId:"am-routes",accessType:"notification",children:(0,e.jsx)(es,{})})}const is=(0,qn.S)(ss)},57323:(ae,F,t)=>{t.d(F,{_:()=>Q});var e=t(74848),f=t(2543),r=t.n(f),R=t(747);const Q=({actions:O,children:m})=>{const c=(0,f.filter)(O,$),h=(0,f.filter)(O,y);return c.length?(0,e.jsx)(C,{actions:c,children:m}):h.length?(0,e.jsx)(K,{actions:h,children:m}):null},C=({actions:O,children:m})=>{const c=(0,R.iI)();return W(c,O)?(0,e.jsx)(e.Fragment,{children:m}):null},K=({actions:O,children:m})=>{const c=(0,R.e2)();return W(c,O)?(0,e.jsx)(e.Fragment,{children:m}):null};function W(O,m){return(0,f.chain)(O).pick(m).values().value().some(([c,h])=>h===!0)}function $(O){return Object.values(R.QI).includes(O)}function y(O){return Object.values(R.RY).includes(O)}},4158:(ae,F,t)=>{t.d(F,{Z:()=>R});var e=t(74848),f=t(22803),r=t(29675);const R=({children:C})=>{const K=(0,r.of)(Q);return(0,e.jsx)("div",{className:K.container,children:C})},Q=C=>({container:(0,f.css)({backgroundColor:C.colors.background.secondary,color:C.colors.text.secondary,padding:C.spacing(4),textAlign:"center"})})},21294:(ae,F,t)=>{t.d(F,{_:()=>ge});var e=t(74848),f=t(22803),r=t(96540),R=t(29675),Q=t(48583),C=t(54731),K=t(85651),W=t(3429),$=t(79653),y=t(76778),O=t(66102),m=t(9172),c=t(35912),h=t(54594),N=t(61351),d=t(80187),H=t(61491),j=t(747),B=t(88214),U=t(9985),se=t(57323);const Z=({alert:u,alertManagerSourceName:l})=>{const S=(0,R.of)(oe),V=(0,B.z2)(l),L=V?N.TP.hasPermission(H.AccessControlAction.AlertingRuleRead):!0;return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("div",{className:S.actionsRow,children:[u.status.state===d.Or.Suppressed&&(0,e.jsx)(se._,{actions:[j.QI.CreateSilence,j.QI.UpdateSilence],children:(0,e.jsx)(h.z9,{href:`${(0,K.nL)("/alerting/silences",l)}&silenceIds=${u.status.silencedBy.join(",")}`,className:S.button,icon:"bell",size:"sm",children:"Manage silences"})}),u.status.state===d.Or.Active&&(0,e.jsx)(se._,{actions:[j.QI.CreateSilence],children:(0,e.jsx)(h.z9,{href:(0,K.BK)(l,u.labels),className:S.button,icon:"bell-slash",size:"sm",children:"Silence"})}),L&&u.generatorURL&&(0,e.jsx)(h.z9,{className:S.button,href:u.generatorURL,icon:"chart-line",size:"sm",children:V?"See alert rule":"See source"})]}),Object.entries(u.annotations).map(([b,z])=>(0,e.jsx)(U.s,{annotationKey:b,value:z},b)),(0,e.jsxs)("div",{className:S.receivers,children:["Receivers:"," ",u.receivers.map(({name:b})=>b).filter(b=>!!b).join(", ")]})]})},oe=u=>({button:(0,f.css)({"& + &":{marginLeft:u.spacing(1)}}),actionsRow:(0,f.css)({padding:`${u.spacing(2,0)} !important`,borderBottom:`1px solid ${u.colors.border.medium}`}),receivers:(0,f.css)({padding:u.spacing(1,0)})}),de=({alerts:u,alertManagerSourceName:l})=>{const S=(0,R.of)(pe),V=(0,r.useMemo)(()=>[{id:"state",label:"Notification state",renderCell:({data:b})=>(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(c.y,{state:b.status.state}),(0,e.jsxs)("span",{className:S.duration,children:["for"," ",(0,O.dU)({start:new Date(b.startsAt),end:new Date(b.endsAt)})]})]}),size:"220px"},{id:"labels",label:"Instance labels",renderCell:({data:{labels:b}})=>(0,e.jsx)(W.m,{labels:b,size:"sm"}),size:1}],[S]),L=(0,r.useMemo)(()=>u.map(b=>({id:b.fingerprint,data:b})),[u]);return(0,e.jsx)("div",{className:S.tableWrapper,"data-testid":"alert-group-table",children:(0,e.jsx)(m.B,{cols:V,items:L,isExpandable:!0,renderExpandedContent:({data:b})=>(0,e.jsx)(Z,{alert:b,alertManagerSourceName:l})})})},pe=u=>({tableWrapper:(0,f.css)({marginTop:u.spacing(3),[u.breakpoints.up("md")]:{marginLeft:u.spacing(4.5)}}),duration:(0,f.css)({marginLeft:u.spacing(1),fontSize:u.typography.bodySmall.fontSize})});var ye=t(55127),je=t.n(ye);const Ie=u=>({[d.Or.Active]:(0,f.css)({color:u.colors.error.text}),[d.Or.Suppressed]:(0,f.css)({color:u.colors.primary.text}),[d.Or.Unprocessed]:(0,f.css)({color:u.colors.secondary.text})}),Me=({group:u})=>{const l=(0,R.of)(Ie),S=u.alerts.length,V=u.alerts.reduce((L,b)=>(L[b.status.state]?L[b.status.state]+=1:L[b.status.state]=1,L),{});return(0,e.jsxs)("div",{children:[`${S} ${je()("alert",S)}: `,Object.entries(V).map(([L,b],z)=>(0,e.jsxs)("span",{className:l[L],children:[z>0&&", ",`${b} ${L}`]},`${JSON.stringify(u.labels)}-notifications-${z}`))]})},ge=({alertManagerSourceName:u,group:l})=>{const[S,V]=(0,r.useState)(!0),L=(0,R.of)(Te),b=l.receiver.name!=="NONE",z=l.receiver.name;return(0,e.jsxs)("div",{className:L.wrapper,children:[(0,e.jsxs)("div",{className:L.header,children:[(0,e.jsxs)("div",{className:L.group,"data-testid":"alert-group",children:[(0,e.jsx)($.e,{size:"sm",isCollapsed:S,onToggle:()=>V(!S),"data-testid":"alert-group-collapse-toggle"}),Object.keys(l.labels).length?(0,e.jsxs)(Q.B,{direction:"row",alignItems:"center",children:[(0,e.jsx)(W.m,{labels:l.labels,size:"sm"}),b&&(0,e.jsxs)(y.P,{icon:"at",children:["Delivered to"," ",(0,e.jsx)(C.Y,{href:(0,K.bI)(z,u),variant:"bodySmall",color:"primary",inline:!1,children:l.receiver.name})]})]}):(0,e.jsx)("span",{children:"No grouping"})]}),(0,e.jsx)(Me,{group:l})]}),!S&&(0,e.jsx)(de,{alertManagerSourceName:u,alerts:l.alerts})]})},Te=u=>({wrapper:(0,f.css)({"& + &":{marginTop:u.spacing(2)}}),header:(0,f.css)({display:"flex",flexDirection:"row",flexWrap:"wrap",alignItems:"center",justifyContent:"space-between",padding:u.spacing(1),backgroundColor:u.colors.background.secondary,width:"100%"}),group:(0,f.css)({display:"flex",flexDirection:"row",alignItems:"center"})})},60937:(ae,F,t)=>{t.d(F,{A:()=>K});var e=t(74848),f=t(44826),r=t(89857),R=t(1814);const Q=({name:W,time_intervals:$})=>({value:W,label:W,description:$.map(y=>(0,R.LF)(y)).join(", AND ")}),K=({alertmanager:W,selectProps:$})=>{const{data:y}=(0,r.my)({alertmanager:W,skip:$.disabled}),O=y?.map(m=>Q(m))||[];return(0,e.jsx)(f.KF,{"aria-label":"Mute timings",options:O,placeholder:"Select mute timings...",...$})}},89857:(ae,F,t)=>{t.d(F,{XW:()=>ye,gB:()=>Me,zm:()=>je,Ad:()=>pe,my:()=>Te,SD:()=>Ie,br:()=>ge});var e=t(96540),f=t(9365),r=t(79120);const R=["TimeInterval"],C=r.H.enhanceEndpoints({addTagTypes:R}).injectEndpoints({endpoints:u=>({listNamespacedTimeInterval:u.query({query:l=>({url:`/apis/notifications.alerting.grafana.app/v0alpha1/namespaces/${l.namespace}/timeintervals`,params:{pretty:l.pretty,allowWatchBookmarks:l.allowWatchBookmarks,continue:l.continue,fieldSelector:l.fieldSelector,labelSelector:l.labelSelector,limit:l.limit,resourceVersion:l.resourceVersion,resourceVersionMatch:l.resourceVersionMatch,sendInitialEvents:l.sendInitialEvents,timeoutSeconds:l.timeoutSeconds,watch:l.watch}}),providesTags:["TimeInterval"]}),createNamespacedTimeInterval:u.mutation({query:l=>({url:`/apis/notifications.alerting.grafana.app/v0alpha1/namespaces/${l.namespace}/timeintervals`,method:"POST",body:l.comGithubGrafanaGrafanaPkgApisAlertingNotificationsV0Alpha1TimeInterval,params:{pretty:l.pretty,dryRun:l.dryRun,fieldManager:l.fieldManager,fieldValidation:l.fieldValidation}}),invalidatesTags:["TimeInterval"]}),replaceNamespacedTimeInterval:u.mutation({query:l=>({url:`/apis/notifications.alerting.grafana.app/v0alpha1/namespaces/${l.namespace}/timeintervals/${l.name}`,method:"PUT",body:l.comGithubGrafanaGrafanaPkgApisAlertingNotificationsV0Alpha1TimeInterval,params:{pretty:l.pretty,dryRun:l.dryRun,fieldManager:l.fieldManager,fieldValidation:l.fieldValidation}}),invalidatesTags:["TimeInterval"]}),deleteNamespacedTimeInterval:u.mutation({query:l=>({url:`/apis/notifications.alerting.grafana.app/v0alpha1/namespaces/${l.namespace}/timeintervals/${l.name}`,method:"DELETE",body:l.ioK8SApimachineryPkgApisMetaV1DeleteOptions,params:{pretty:l.pretty,dryRun:l.dryRun,gracePeriodSeconds:l.gracePeriodSeconds,orphanDependents:l.orphanDependents,propagationPolicy:l.propagationPolicy}}),invalidatesTags:["TimeInterval"]})}),overrideExisting:!1});var K=t(9894),W=t(88214),$=t(18269),y=t(13693),O=t(77855),m=t(25779),c=t(25061),h=t(65665);const{useLazyGetAlertmanagerConfigurationQuery:N,useGetMuteTimingListQuery:d}=f.m,{useLazyListNamespacedTimeIntervalQuery:H,useCreateNamespacedTimeIntervalMutation:j,useReplaceNamespacedTimeIntervalMutation:B,useDeleteNamespacedTimeIntervalMutation:U}=C,se=u=>{const{metadata:l,spec:S}=u;return{...S,id:S.name,metadata:l,provisioned:(0,y.Uo)(u)}},Z=(u,l)=>({...u,id:u.name,provisioned:!!(l&&l!==$.rh)}),oe=()=>N({selectFromResult:({data:u,...l})=>{if(!u)return{data:u,...l};const{alertmanager_config:S}=u,V=S.muteTimeProvenances??{};return{data:(0,K.IT)(S).map(z=>Z(z,V[z.name])),...l}}}),de=()=>H({selectFromResult:({data:u,...l})=>({data:u?.items.map(S=>se(S)),...l})}),pe=({alertmanager:u,skip:l})=>{const S=(0,y.dM)(u),[V,L]=de(),[b,z]=oe();return(0,e.useEffect)(()=>{if(!l)if(S){const A=(0,O.G)();V({namespace:A})}else b(u)},[u,b,V,l,S]),S?L:z},ye=({alertmanager:u})=>{const l=(0,y.dM)(u),[S]=j(),[V]=(0,c.d)(),L=(0,m.Yb)(({interval:z})=>{const A=(0,O.G)();return S({namespace:A,comGithubGrafanaGrafanaPkgApisAlertingNotificationsV0Alpha1TimeInterval:{metadata:{},spec:z}}).unwrap()}),b=(0,m.Yb)(({interval:z})=>{const A=(0,h.X9)({interval:z});return V(A)});return l?L:b},je=({alertmanager:u,name:l})=>{const S=(0,y.dM)(u),[V,L]=H({selectFromResult:({data:A,...Y})=>A?A.items.length===0?{...Y,data:void 0,isError:!0}:{data:se(A.items[0]),...Y}:{data:A,...Y}}),[b,z]=N({selectFromResult:({data:A,...Y})=>{if(!A)return{data:A,...Y};const he=A?.alertmanager_config??{},Ce=(0,K.IT)(he).find(({name:q})=>q===l);if(Ce){const q=he?.muteTimeProvenances??{};return{data:Z(Ce,q[Ce.name]),...Y}}return{...Y,data:void 0,isError:!0}}});return(0,e.useEffect)(()=>{if(S){const A=(0,O.G)(),Y=(0,y.O)(l);V({namespace:A,fieldSelector:`spec.name=${Y}`},!0)}else b(u,!0)},[u,b,V,l,S]),S?L:z},Ie=({alertmanager:u})=>{const l=(0,y.dM)(u),[S]=B(),[V]=(0,c.d)(),L=(0,m.Yb)(async({interval:z,originalName:A})=>{const Y=(0,O.G)();return S({name:A,namespace:Y,comGithubGrafanaGrafanaPkgApisAlertingNotificationsV0Alpha1TimeInterval:{spec:z,metadata:{name:A}}}).unwrap()}),b=(0,m.Yb)(async({interval:z,originalName:A})=>{const Y=(0,h.ov)({interval:z,originalName:A});return V(Y)});return l?L:b},Me=({alertmanager:u})=>{const l=(0,y.dM)(u),[S,V]=(0,c.d)(),[L]=U(),b=(0,m.Yb)(async({name:A})=>{const Y=(0,h.$8)({name:A});return S(Y)}),z=(0,m.Yb)(async({name:A})=>{const Y=(0,O.G)();await L({name:A,namespace:Y,ioK8SApimachineryPkgApisMetaV1DeleteOptions:{}}).unwrap()});return l?z:b},ge=({alertmanager:u})=>{const l=(0,y.dM)(u),[S]=oe();return l?()=>{}:async(V,L)=>{if(!L)return S(u).unwrap().then(b=>!!(0,K.IT)(b.alertmanager_config)?.find(Y=>Y.name===V)?`Mute timing already exists with name "${V}"`:void 0)}},Te=({alertmanager:u,skip:l})=>{const S=(0,y.dM)(u),V=u===W.hY&&!S,L=d(void 0,{skip:l||!V}),b=pe({alertmanager:u,skip:l||V});return V?L:b}},9894:(ae,F,t)=>{t.d(F,{Hy:()=>W,IT:()=>$,av:()=>O,oB:()=>y});var e=t(74848),f=t(95093),r=t.n(f),R=t(96540),Q=t(48583),C=t(1814);const K=/^((([01][0-9])|(2[0-3])):[0-5][0-9])$|(^24:00$)/,W=m=>m?K.test(m):!0,$=m=>[...m.mute_time_intervals??[],...m.time_intervals??[]],y=(m,c)=>{if(!m&&!c)return!0;if(!m&&c||m&&!c)return!1;const h="HH:mm",N=r()().startOf("day").add(m,h),d=r()().startOf("day").add(c,h);return!!(m&&c&&N.isBefore(d)||m&&c&&d.isAfter(N))};function O(m){const h=m.time_intervals.map((N,d)=>{const{times:H,weekdays:j,days_of_month:B,months:U,years:se,location:Z}=N,oe=(0,C.Dm)(H,Z),de=(0,C.uH)(j),pe=(0,C.UL)(B),ye=(0,C.$P)(U),je=(0,C.mP)(se);return(0,e.jsx)(R.Fragment,{children:(0,e.jsxs)("div",{children:[`${oe} ${de}`,(0,e.jsx)("br",{}),[pe,ye,je].join(" | "),(0,e.jsx)("br",{})]})},JSON.stringify(N)+d)});return(0,e.jsx)(Q.B,{direction:"column",gap:1,children:h})}},72614:(ae,F,t)=>{t.d(F,{u:()=>d});var e=t(74848),f=t(22803),r=t(96540),R=t(29675),Q=t(45565),C=t(37e3),K=t(48583),W=t(44826),$=t(99764),y=t(74625),O=t(13005),m=t(35626);const c=500,h=B=>new Promise(U=>setTimeout(U,B)),N=1e3,d=({selectProps:B,showRefreshButton:U,selectedContactPointName:se})=>{const{selectedAlertmanager:Z}=(0,O.VI)(),{contactPoints:oe,isLoading:de,error:pe,refetch:ye}=(0,m.dK)({alertmanager:Z}),[je,Ie]=(0,r.useState)(!1),Me=(0,R.of)(j),ge=oe.map(l=>({label:l.name,value:l,component:()=>(0,e.jsx)(Q.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(y.yz,{receivers:l.grafana_managed_receiver_configs,limit:2})})})),Te=(0,r.useMemo)(()=>ge.find(l=>l.value?.name===se)||null,[ge,se]),u=()=>{Ie(!0),Promise.all([ye(),h(N)]).finally(()=>{Ie(!1)})};return pe?(0,e.jsx)(C.F,{title:"Failed to fetch contact points",severity:"error"}):(0,e.jsxs)(K.B,{children:[(0,e.jsx)(W.l6,{virtualized:ge.length>c,options:ge,value:Te,...B,isLoading:de}),U&&(0,e.jsx)($.K,{name:"sync",onClick:u,"aria-label":"Refresh contact points",tooltip:"Refresh contact points list",className:(0,f.cx)(Me.refreshButton,{[Me.loading]:je||de})})]})},H=(0,f.keyframes)({from:{transform:"rotate(0deg)"},to:{transform:"rotate(720deg)"}}),j=B=>({refreshButton:(0,f.css)({color:B.colors.text.secondary,cursor:"pointer",borderRadius:B.shape.radius.circle,overflow:"hidden"}),loading:(0,f.css)({pointerEvents:"none",[B.transitions.handleMotion("no-preference")]:{animation:`${H} 2s infinite linear`},[B.transitions.handleMotion("reduce")]:{animation:`${H} 6s infinite linear`}})})},73370:(ae,F,t)=>{t.d(F,{s:()=>y});var e=t(74848),f=t(22803),r=t(2543),R=t.n(r),Q=t(29675),C=t(48583),K=t(27671),W=t(55936),$=t(2178);const y=({matchers:c,formatter:h="default"})=>{const N=(0,Q.of)(m),d=5,H=(0,r.take)(c,d),j=(0,r.takeRight)(c,c.length-d),B=j.length>0;return(0,e.jsx)("span",{"data-testid":"label-matchers",children:(0,e.jsxs)(C.B,{direction:"row",gap:1,alignItems:"center",wrap:"wrap",children:[H.map(U=>(0,e.jsx)(O,{matcher:U,formatter:h},(0,r.uniqueId)())),B&&(0,e.jsx)($.B,{arrow:!0,placement:"top",content:(0,e.jsx)(e.Fragment,{children:j.map(U=>(0,e.jsx)(O,{matcher:U},(0,r.uniqueId)()))}),children:(0,e.jsx)("span",{children:(0,e.jsx)("div",{className:N.metadata,children:`and ${j.length} more`})})})]})})},O=({matcher:c,formatter:h="default"})=>{const N=(0,Q.of)(m);return(0,e.jsx)("div",{className:N.matcher(c[0]).wrapper,children:(0,e.jsx)(C.B,{direction:"row",gap:0,alignItems:"baseline",children:W.t8[h](c)})})},m=c=>({matcher:h=>{const{color:N,borderColor:d}=(0,K.MC)(h);return{wrapper:(0,f.css)({color:"#fff",background:N,padding:`${c.spacing(.33)} ${c.spacing(.66)}`,fontSize:c.typography.bodySmall.fontSize,border:`solid 1px ${d}`,borderRadius:c.shape.borderRadius(2),whiteSpace:"pre"})}},metadata:(0,f.css)({color:c.colors.text.secondary,fontSize:c.typography.bodySmall.fontSize,fontWeight:c.typography.bodySmall.fontWeight})})},10137:(ae,F,t)=>{t.d(F,{V:()=>m});var e=t(74848),f=t(96540),r=t(34128),R=t(79784),Q=t(2178),C=t(22803),K=t(29675),W=t(42430);function $(){const c=(0,K.of)(O);return(0,e.jsxs)("div",{children:["Prometheus duration format consist of a number followed by a time unit.",(0,e.jsx)("br",{}),"Different units can be combined for more granularity.",(0,e.jsx)("hr",{}),(0,e.jsxs)("div",{className:c.list,children:[(0,e.jsxs)("div",{className:c.header,children:[(0,e.jsx)("div",{children:"Symbol"}),(0,e.jsx)("div",{children:"Time unit"}),(0,e.jsx)("div",{children:"Example"})]}),(0,e.jsx)(y,{unit:W.y.seconds,name:"seconds",example:"20s"}),(0,e.jsx)(y,{unit:W.y.minutes,name:"minutes",example:"10m"}),(0,e.jsx)(y,{unit:W.y.hours,name:"hours",example:"4h"}),(0,e.jsx)(y,{unit:W.y.days,name:"days",example:"3d"}),(0,e.jsx)(y,{unit:W.y.weeks,name:"weeks",example:"2w"}),(0,e.jsxs)("div",{className:c.examples,children:[(0,e.jsx)("div",{children:"Multiple units combined"}),(0,e.jsx)("code",{children:"1m30s, 2h30m20s, 1w2d"})]})]})]})}function y({unit:c,name:h,example:N}){const d=(0,K.of)(O);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:d.unit,children:c}),(0,e.jsx)("div",{children:h}),(0,e.jsx)("code",{children:N})]})}const O=c=>({unit:(0,C.css)({fontWeight:c.typography.fontWeightBold}),list:(0,C.css)({display:"grid",gridTemplateColumns:"max-content 1fr 2fr",gap:c.spacing(1,3)}),header:(0,C.css)({display:"contents",fontWeight:c.typography.fontWeightBold}),examples:(0,C.css)({display:"contents","& > div":{gridColumn:"1 / span 2"}})}),m=(0,f.forwardRef)((c,h)=>(0,e.jsx)(r.p,{suffix:(0,e.jsx)(Q.B,{content:(0,e.jsx)($,{}),disabled:!1,children:(0,e.jsx)(R.I,{name:"info-circle",size:"lg"})}),...c,ref:h}));m.displayName="PromDurationInput"},74053:(ae,F,t)=>{t.d(F,{t:()=>f});var e=t(22803);const f=r=>({container:(0,e.css)({alignItems:"center",display:"flex",flexFlow:"row nowrap","& > * + *":{marginLeft:r.spacing(1)}}),input:(0,e.css)({flex:1}),promDurationInput:(0,e.css)({maxWidth:r.spacing(32)}),timingFormContainer:(0,e.css)({padding:r.spacing(1)}),linkText:(0,e.css)({textDecoration:"underline"}),collapse:(0,e.css)({border:"none",background:"none",color:r.colors.text.primary})})},81636:(ae,F,t)=>{t.d(F,{G:()=>e});const e={groupWait:{label:"Group wait",description:"The wait time before sending the first notification for a new group of alerts. If empty, it is inherited from the parent policy.",ariaLabel:"Group wait value"},groupInterval:{label:"Group interval",description:"The wait time before sending a notification about changes in the alert group after the first notification has been sent. If empty, it is inherited from the parent policy.",ariaLabel:"Group interval value"},repeatInterval:{label:"Repeat interval",description:"The wait time before resending a notification that has already been sent successfully.",ariaLabel:"Repeat interval value"}}},33337:(ae,F,t)=>{t.d(F,{H:()=>e});const e={group_wait:"30s",group_interval:"5m",repeat_interval:"4h"}},86369:(ae,F,t)=>{t.d(F,{L:()=>$});var e=t(14590),f=t(96540),r=t(83893),R=t(89956);const Q=()=>new R.c(new URL(t.p+t.u(3430),t.b));let C;function K(){let y;if(C===void 0)try{y=Q(),C=e.LV(y)}catch(m){m instanceof Error&&(0,r.vV)(m)}return{disposeWorker:()=>{y&&C&&(C[e.A2](),y.terminate(),C=void 0,y=void 0)}}}function W(y){if(!C)throw new Error("Route Matcher has not been initialized")}function $(){(0,f.useEffect)(()=>{const{disposeWorker:m}=K();return m},[]);const y=(0,f.useCallback)(async(m,c,h)=>{W(C);const N=performance.now(),d=await C.getRouteGroupsMap(m,c,h),H=performance.now()-N;return(0,r.fH)(`Route Groups Matched in  ${H} ms`,{matchingTime:H.toString(),alertGroupsCount:c.length.toString(),topLevelRoutesCount:m.routes?.length.toString()??"0"}),d},[]),O=(0,f.useCallback)(async(m,c,h)=>{W(C);const N=performance.now(),d=await C.matchInstancesToRoute(m,c,h),H=performance.now()-N;return(0,r.fH)(`Instances Matched in  ${H} ms`,{matchingTime:H.toString(),instancesToMatchCount:c.length.toString(),topLevelRoutesCount:m.routes?.length.toString()??"0"}),d},[]);return{getRouteGroupsMap:y,matchInstancesToRoute:O}}},45015:(ae,F,t)=>{t.d(F,{KR:()=>R,Ww:()=>C,d6:()=>O,iF:()=>W,jU:()=>r,jb:()=>y,oU:()=>Q});var e=t(2543),f=t.n(e);const r=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],R=["january","february","march","april","may","june","july","august","september","october","november","december"],Q={times:[{start_time:"",end_time:""}],weekdays:"",days_of_month:"",months:"",years:"",location:"",disable:!1},C=(m,c,h)=>m?m.split(",").map(N=>N.trim()).every(N=>N.split(":").every(c))||h:!0,K=m=>m?m.split(",").map(c=>c.trim()):void 0,W=m=>{const c=m.time_intervals.map(({times:h,weekdays:N,days_of_month:d,months:H,years:j,location:B,disable:U})=>{const se={times:$(h,U),weekdays:K(N)?.map(Z=>Z.toLowerCase()),days_of_month:K(d),months:K(H),years:K(j),location:B||void 0};return(0,e.omitBy)(se,e.isUndefined)});return{name:m.name,time_intervals:c}};function $(m,c){if(c)return[];const h=m?.filter(({start_time:N,end_time:d})=>!!N&&!!d);return h?.length?h:void 0}function y(m){return m.times?.length===0||m.weekdays?.length===0||m.days_of_month?.length===0||m.months?.length===0||m.years?.length===0}function O(m){return m.time_intervals.every(c=>y(c))}}}]);

//# sourceMappingURL=NotificationPoliciesPage.c2785feef6738bef1d25.js.map