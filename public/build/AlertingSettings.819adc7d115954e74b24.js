"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9438],{20605:(dn,B,r)=>{r.r(B),r.d(B,{default:()=>ee});var n=r(74848),p=r(54594),C=r(48583),I=r(45565),G=r(32174),K=r(72974),v=r(96540),gn=r(58528),un=r(10247),X=r(88849),A=r(88214),V=r(22803),fn=r(49785),mn=r(70713),k=r(29675),T=r(37e3),hn=r(3886),q=r(65164),_=r(11817),vn=r(83893),An=r(17618),nn=r(9912),en=r(7484);function Sn({alertmanagerName:e,onDismiss:t,onSave:a,onReset:s}){const{loading:i,error:l}=(0,nn.$)(D=>D.deleteAMConfig),{loading:m,error:o}=(0,nn.$)(D=>D.saveAMConfig),[d,g]=(0,v.useState)(!1),h=e?(0,A.AL)(e):!1,x=e===A.hY,j=(0,k.of)(xn),{currentData:y,error:R,isSuccess:L,isLoading:u}=(0,An.f)(e),c={configJSON:y?JSON.stringify(y,null,2):""},{register:f,setValue:E,setError:M,handleSubmit:H,formState:{errors:F}}=(0,fn.mN)({defaultValues:c});(0,v.useEffect)(()=>{y&&E("configJSON",JSON.stringify(y,null,2))},[y,E]),(0,v.useEffect)(()=>{o&&M("configJSON",{type:"deps",message:o.message})},[o,M]),(0,v.useEffect)(()=>{l&&M("configJSON",{type:"deps",message:l.message})},[l,M]),f("configJSON",{required:{value:!0,message:"Configuration cannot be empty"},validate:D=>{try{return JSON.parse(D),!0}catch(W){return W instanceof Error?W.message:"JSON is invalid"}}});const Z=H(D=>{a(e,c.configJSON,D.configJSON)},vn.KF),U=u||i||m;if(R)return(0,n.jsx)(T.F,{severity:"error",title:"Failed to load Alertmanager configuration",children:R.message??"An unknown error occurred."});if(i)return(0,n.jsx)(T.F,{severity:"info",title:"Resetting Alertmanager configuration",children:"Resetting configuration, this might take a while."});const te=x?"Are you sure you want to reset configuration for the Grafana Alertmanager? Contact points and notification policies will be reset to their defaults.":`Are you sure you want to reset configuration for "${e}"? Contact points and notification policies will be reset to their defaults.`;return(0,n.jsxs)("div",{className:j.container,children:[F.configJSON&&(0,n.jsx)(T.F,{severity:"error",title:"Oops, something went wrong",children:F.configJSON.message||"An unknown error occurred."}),L&&(0,n.jsx)("div",{className:j.content,children:(0,n.jsx)(mn.default,{children:({height:D,width:W})=>(0,n.jsx)(hn.B,{language:"json",width:W,height:D,showLineNumbers:!0,monacoOptions:{scrollBeyondLastLine:!1},value:c.configJSON,showMiniMap:!1,onSave:Q=>E("configJSON",Q),onBlur:Q=>E("configJSON",Q),readOnly:U})})}),(0,n.jsxs)(C.B,{justifyContent:"flex-end",children:[!h&&(0,n.jsx)(p.$n,{variant:"destructive",onClick:()=>g(!0),disabled:U,children:"Reset"}),(0,n.jsx)(en.h,{}),(0,n.jsx)(p.$n,{variant:"secondary",onClick:()=>t(),disabled:U,children:(0,n.jsx)(_.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),!h&&(0,n.jsx)(p.$n,{variant:"primary",onClick:Z,disabled:U,children:(0,n.jsx)(_.x6,{i18nKey:"common.save",children:"Save"})})]}),(0,n.jsx)(q.u,{isOpen:d,title:"Reset Alertmanager configuration",body:te,confirmText:"Yes, reset configuration",onConfirm:()=>{s(e),g(!1)},onDismiss:()=>{g(!1)}})]})}const xn=e=>({container:(0,V.css)({display:"flex",flexDirection:"column",height:"100%",gap:e.spacing(2)}),content:(0,V.css)({flex:"1 1 100%"})});var b=r(2543),pn=r(52718),Cn=r(86833),jn=r(32370),O=r(80187),Y=r(83394),J=r(9365),yn=r(79120);const P=yn.H.injectEndpoints({endpoints:e=>({getAllDataSourceSettings:e.query({query:()=>({url:"api/datasources"}),providesTags:t=>t?t.map(({uid:a})=>({type:"DataSourceSettings",id:a})):["DataSourceSettings"]}),getDataSourceSettingsForUID:e.query({query:t=>({url:`api/datasources/uid/${t}`}),providesTags:(t,a,s)=>[{type:"DataSourceSettings",id:s}]}),updateDataSourceSettingsForUID:e.mutation({query:({uid:t,settings:a})=>({url:`api/datasources/uid/${t}`,method:"PUT",data:a,showSuccessAlert:!1}),invalidatesTags:(t,a,s)=>[{type:"DataSourceSettings",id:s.uid}]})})});function En({refetchOnMountOrArgChange:e=!1}={}){const{alertmanagerDataSources:t}=P.endpoints.getAllDataSourceSettings.useQuery(void 0,{refetchOnReconnect:!0,refetchOnMountOrArgChange:e,selectFromResult:s=>{const i=s.currentData?.filter(A.bD)??[];return{...s,alertmanagerDataSources:i}}}),{currentData:a}=J.m.endpoints.getExternalAlertmanagers.useQuery(void 0,{refetchOnReconnect:!0,refetchOnMountOrArgChange:e});return t?t.map(s=>{const i=a?Dn(a,s):"unknown";return{dataSourceSettings:s,status:i}}):[]}function Dn(e,t){if(!t.jsonData.handleGrafanaManagedAlerts)return"uninterested";const s=e?.activeAlertManagers.some(o=>tn(t.url,o.url))??[],i=e?.droppedAlertManagers.some(o=>tn(t.url,o.url))??[];return!s&&!i?"pending":s&&i?"inconclusive":s?"active":i?"dropped":"unknown"}const In="/alertmanager/api/v2/alerts",On="/api/v2/alerts";function tn(e,t){const a=Mn(e),s=t===`${a}${On}`,i=t===`${a}${In}`;return s||i}function Mn(e){return(new RegExp("^[^:]*://").test(e)?e:`http://${e}`).replace(/\/+$/,"")}var rn=r(48542);const an=e=>{if(!e)return!0;switch(e.alertmanagersChoice){case O.nA.Internal:case O.nA.All:return!0;case O.nA.External:default:return!1}};var Rn=r(1932);const Ln=()=>{const[e,t]=P.endpoints.getDataSourceSettingsForUID.useLazyQuery(),[a,s]=P.endpoints.updateDataSourceSettingsForUID.useMutation(),i=async(d,g)=>{const S=await e(d).unwrap();if(!(0,A.bD)(S))throw new Error(`Data source with UID ${d} is not an Alertmanager data source`);const h=(0,Rn.jM)(S,x=>{x.jsonData.handleGrafanaManagedAlerts=g});a({uid:d,settings:h})},l=d=>i(d,!0),m=d=>i(d,!1),o={isLoading:t.isLoading||s.isLoading,isError:t.isError||s.isError,error:t.error||s.error,data:s.data};return[l,m,o]},Nn=(0,Cn.J7)(),sn=(0,v.createContext)(void 0),on=e=>e===A.hY,Tn=e=>{const t=[],a=jn.$.featureToggles.alertingDisableSendAlertsExternal===!0,{currentData:s,isLoading:i}=J.m.endpoints.getGrafanaAlertingConfiguration.useQuery(),[l,m]=J.m.endpoints.updateGrafanaAlertingConfiguration.useMutation(),[o,d,g]=Ln(),S=En({refetchOnMountOrArgChange:!0});an(s)&&t.push(A.hY),S.filter(u=>(0,A.iV)(u.dataSourceSettings)).forEach(u=>{t.push(u.dataSourceSettings.uid)});const x=u=>{const c=(0,b.union)([u],t),f=ln(c);f!==null&&(f!==s?.alertmanagersChoice&&l({alertmanagersChoice:f}),on(u)||o(u))},j=u=>{const c=(0,b.without)(t,u),f=ln(c);f!==null&&(f!==s?.alertmanagersChoice&&l({alertmanagersChoice:f}),on(u)||d(u))},y=(u,c,f)=>{(0,Y.JD)((0,rn.RW)({newConfig:JSON.parse(f),oldConfig:JSON.parse(c),alertManagerSourceName:u,successMessage:"Alertmanager configuration updated."}))},R=u=>{(0,Y.JD)((0,rn.nO)(u))},L={configuration:s,forwardingDisabled:a,externalAlertmanagerDataSourcesWithStatus:S,enableAlertmanager:x,disableAlertmanager:j,isLoading:i,isUpdating:m.isLoading||g.isLoading,updateAlertmanagerSettings:y,resetAlertmanagerSettings:R};return(0,n.jsx)(sn.Provider,{value:L,children:e.children})};function ln(e){const t=e.some(s=>s===A.hY),a=e.some(s=>s!==A.hY);return t&&a?O.nA.All:!t&&a?O.nA.External:t&&!a?O.nA.Internal:(Nn.publish({type:pn.r1.alertError.name,payload:["You need to have at least one Alertmanager to receive alerts."]}),null)}function w(){const e=(0,v.useContext)(sn);if(e===void 0)throw new Error("useSettings must be used within a SettingsContext");const t=(0,b.debounce)(()=>{(0,Y.JD)(P.util.invalidateTags(["AlertmanagerConnectionStatus"]))},3e3),a=(0,v.useRef)(t);return e.externalAlertmanagerDataSourcesWithStatus.some(({status:i})=>i==="pending")&&a.current(),(0,v.useEffect)(()=>{t.cancel()},[t]),e}var bn=r(95093),Jn=r.n(bn),$=r(66384),$n=r(14123),Bn=r(51738),Gn=r(65456),Vn=r(85651);const Pn=30,wn=({alertmanagerName:e})=>{const[t,a]=(0,v.useState)(void 0),[s,i]=(0,v.useState)(!1),[l,m]=(0,v.useState)(void 0),{currentData:o=[],isLoading:d,error:g}=J.m.endpoints.getAlertmanagerConfigurationHistory.useQuery(void 0),[S,h]=J.m.endpoints.resetAlertmanagerConfigurationToOldVersion.useMutation(),x=()=>{i(!0)},j=()=>{i(!1)},y=c=>{m(void 0),a(void 0),S({id:c})};if(g)return(0,n.jsx)(T.F,{title:"Failed to load configuration history",children:(0,Vn.JZ)(g)});if(d)return"Loading...";if(!o.length)return"No previous configurations";const L=o.map((c,f)=>{const E=o[0],M=o[f];return{...c,diff:M?(0,Gn.h)(c,E,z):{added:0,removed:0}}}).map(c=>({id:String(c.id??0),lastAppliedAt:c.last_applied??"unknown",diff:c.diff})),u=[{id:"lastAppliedAt",header:"Last applied",cell:Un},{id:"diff",disableGrow:!0,cell:({row:c,value:f})=>c.index===0?null:(0,n.jsxs)(C.B,{alignItems:"baseline",gap:.5,children:[(0,n.jsxs)(I.E,{color:"success",variant:"bodySmall",children:["+",f.added]}),(0,n.jsxs)(I.E,{color:"error",variant:"bodySmall",children:["-",f.removed]})]})},{id:"actions",disableGrow:!0,cell:({row:c})=>{const f=c.index===0,E=Number(c.id);return(0,n.jsx)(C.B,{direction:"row",alignItems:"center",justifyContent:"flex-end",children:f?(0,n.jsx)($.E,{text:"Latest",color:"blue"}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(p.$n,{variant:"secondary",size:"sm",icon:"code-branch",fill:"outline",onClick:()=>{const M=o[0],H=o[c.index],F=z(M),Z=z(H);a(E),m([JSON.stringify(F,null,2),JSON.stringify(Z,null,2)])},children:"Compare"}),(0,n.jsx)(p.$n,{variant:"secondary",size:"sm",icon:"history",onClick:()=>{a(E),x()},disabled:h.isLoading,children:"Restore"})]})})}}];return h.isLoading?(0,n.jsx)(T.F,{severity:"info",title:"Restoring Alertmanager configuration",children:"This might take a while..."}):(0,n.jsxs)(n.Fragment,{children:[l?(0,n.jsx)(Fn,{left:l[0],right:l[1],disabled:h.isLoading,onCancel:()=>{a(void 0),m(void 0),j()},onConfirm:()=>{x()}}):(0,n.jsx)($n.j,{pageSize:Pn,columns:u,data:L,getRowId:c=>c.id}),(0,n.jsx)(q.u,{isOpen:s,title:"Restore Version",body:"Are you sure you want to restore the configuration to this version? All unsaved changes will be lost.",confirmText:"Yes, restore configuration",onConfirm:()=>{t&&y(t),j()},onDismiss:()=>j()})]})};function Fn({left:e,right:t,disabled:a=!1,onCancel:s,onConfirm:i}){const l=(0,k.of)(Wn);return(0,n.jsxs)("div",{className:l.drawerWrapper,children:[(0,n.jsx)("div",{className:l.diffWrapper,children:(0,n.jsx)(Bn.M,{newValue:e,oldValue:t,hideLineNumbers:!0})}),(0,n.jsxs)(C.B,{direction:"row",alignItems:"center",children:[(0,n.jsx)(en.h,{}),(0,n.jsx)(p.$n,{variant:"secondary",onClick:s,disabled:a,children:"Return"}),(0,n.jsx)(p.$n,{icon:"history",variant:"primary",onClick:i,disabled:a,children:"Restore"})]})]})}const Un=({value:e})=>{const t=Jn()(e);return(0,n.jsxs)(C.B,{direction:"row",alignItems:"center",children:[t.toLocaleString(),(0,n.jsx)(I.E,{variant:"bodySmall",color:"secondary",children:t.fromNow()})]})},Wn=e=>({drawerWrapper:(0,V.css)({maxHeight:"100%",display:"flex",flexDirection:"column",gap:e.spacing(1)}),diffWrapper:(0,V.css)({overflowY:"auto"})});function z(e){return(0,b.omit)(e,["id","last_applied"])}function Yn(){const[e,t]=(0,v.useState)("configuration"),[a,s]=(0,v.useState)(),[i,l]=(0,v.useState)(!1),{updateAlertmanagerSettings:m,resetAlertmanagerSettings:o}=w(),d=h=>{s(h),l(!0)},g=(0,v.useCallback)(()=>{t("configuration"),l(!1)},[]);return[(0,v.useMemo)(()=>{if(!i)return null;const h=a===A.hY,x=h?"Internal Grafana Alertmanager":a;return(0,n.jsxs)(gn._,{onClose:g,title:x,subtitle:"Edit the Alertmanager configuration",tabs:(0,n.jsxs)(un.U,{children:[(0,n.jsx)(X.o,{label:"JSON Model",icon:"arrow",active:e==="configuration",onChangeTab:()=>t("configuration")},"configuration"),(0,n.jsx)(X.o,{label:"Versions",icon:"history",active:e==="versions",onChangeTab:()=>t("versions"),hidden:!h},"versions")]}),children:[e==="configuration"&&a&&(0,n.jsx)(Sn,{alertmanagerName:a,onDismiss:g,onSave:m,onReset:o}),e==="versions"&&a&&(0,n.jsx)(wn,{alertmanagerName:a})]})},[i,a,g,e,m,o]),d,g]}var zn=r(84641),Hn=r(35874),N=r(6210),Zn=r(54731),Qn=r(27219);function cn({name:e,href:t,url:a,logo:s="public/app/plugins/datasource/alertmanager/img/logo.svg",provisioned:i=!1,readOnly:l=i,showStatus:m=!0,implementation:o,receiving:d=!1,status:g="unknown",onEditConfiguration:S,onEnable:h,onDisable:x}){const j=!i&&!!h&&!!x;return(0,n.jsxs)(N.Z,{"data-testid":`alertmanager-card-${e}`,children:[(0,n.jsx)(N.Z.Heading,{children:(0,n.jsxs)(C.B,{alignItems:"center",gap:1,children:[t?(0,n.jsx)(K.d,{title:"Alerting settings",component:(0,n.jsx)(Zn.Y,{href:t,inline:!1,children:e})}):e,i&&(0,n.jsx)(Qn.rS,{})]})}),(0,n.jsx)(N.Z.Figure,{children:(0,n.jsx)("img",{alt:`logo for ${e}`,src:s})}),(0,n.jsx)(N.Z.Meta,{children:(0,n.jsxs)(C.B,{direction:"column",gap:1,alignItems:"flex-start",children:[(0,n.jsxs)(N.Z.Meta,{children:[o&&(0,b.capitalize)(o),a&&a]}),m?(0,n.jsx)(n.Fragment,{children:d?(0,n.jsxs)(n.Fragment,{children:[g==="pending"&&(0,n.jsx)($.E,{text:"Activation in progress",color:"orange"}),g==="active"&&(0,n.jsx)($.E,{text:"Receiving Grafana-managed alerts",color:"green"}),g==="dropped"&&(0,n.jsx)($.E,{text:"Failed to adopt Alertmanager",color:"red"}),g==="inconclusive"&&(0,n.jsx)($.E,{text:"Inconclusive",color:"orange"})]}):(0,n.jsx)(I.E,{variant:"bodySmall",children:"Not receiving Grafana managed alerts"})}):null]})}),(0,n.jsx)(N.Z.Tags,{children:(0,n.jsxs)(C.B,{direction:"row",gap:1,children:[(0,n.jsx)(p.$n,{onClick:S,icon:l?"eye":"edit",variant:"secondary",fill:"outline",children:l?"View configuration":"Edit configuration"}),j?(0,n.jsx)(n.Fragment,{children:d?(0,n.jsx)(p.$n,{icon:"times",variant:"destructive",fill:"outline",onClick:x,children:"Disable"}):(0,n.jsx)(p.$n,{icon:"check",variant:"secondary",fill:"outline",onClick:h,children:"Enable"})}):null]})})]})}const Kn=({onEditConfiguration:e})=>{const{externalAlertmanagerDataSourcesWithStatus:t,configuration:a,enableAlertmanager:s,disableAlertmanager:i,forwardingDisabled:l}=w(),m=o=>{const d=[O.nA.All,O.nA.External].some(S=>a?.alertmanagersChoice===S),g=(0,A.iV)(o.dataSourceSettings);return d&&g};return(0,n.jsx)(C.B,{direction:"column",gap:0,children:t.map(o=>{const{uid:d,name:g,jsonData:S,url:h}=o.dataSourceSettings,{status:x}=o,j=m(o),y=(0,A.yc)(o.dataSourceSettings),R=(0,A.AL)(o.dataSourceSettings.name),L=(0,Hn.G)(zn.I.Edit.replace(/:uid/gi,d)),u=()=>e(g),c=l?void 0:()=>s(d),f=l?void 0:()=>i(d);return(0,n.jsx)(cn,{name:g,href:L,url:h,provisioned:y,readOnly:R,showStatus:!l,implementation:S.implementation??"Prometheus",receiving:j,status:x,onEditConfiguration:u,onDisable:f,onEnable:c},d)})})},Xn="Grafana built-in";function kn({onEditConfiguration:e}){const{configuration:t,enableAlertmanager:a,disableAlertmanager:s,forwardingDisabled:i}=w(),l=an(t),m=l?"active":"uninterested",o=()=>e(A.hY),d=i?void 0:()=>a(A.hY),g=i?void 0:()=>s(A.hY);return(0,n.jsx)(cn,{name:Xn,logo:"public/img/grafana_icon.svg",status:m,receiving:l,onEditConfiguration:o,onEnable:d,onDisable:g})}var qn=r(37104);function _n(){return(0,n.jsx)(Tn,{children:(0,n.jsx)(ne,{})})}function ne(){const[e,t]=Yn(),{isLoading:a}=w();return(0,n.jsxs)(G.d,{navId:"alerting-admin",isLoading:a,actions:[(0,n.jsx)(K.d,{title:"Alerting settings",component:(0,n.jsx)(p.z9,{href:"/connections/datasources/alertmanager",icon:"plus",variant:"primary",children:"Add new Alertmanager"})},"add-alertmanager")],children:[(0,n.jsxs)(C.B,{direction:"column",gap:2,children:[(0,n.jsx)(I.E,{variant:"h5",children:"Built-in Alertmanager"}),(0,n.jsx)(kn,{onEditConfiguration:t}),(0,n.jsx)(I.E,{variant:"h5",children:"Other Alertmanagers"}),(0,n.jsx)(Kn,{onEditConfiguration:t})]}),e]})}const ee=(0,qn.S)(_n)},17618:(dn,B,r)=>{r.d(B,{f:()=>p});var n=r(9365);function p(C,I){const G=n.m.endpoints.getAlertmanagerConfiguration.useQuery(C??"",{refetchOnMountOrArgChange:!0,...I,skip:!C});return{...G,error:G.error}}}}]);

//# sourceMappingURL=AlertingSettings.819adc7d115954e74b24.js.map