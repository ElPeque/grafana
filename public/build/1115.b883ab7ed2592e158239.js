"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1115],{59051:(Rt,nt,s)=>{s.d(nt,{L:()=>Re});var l=s(74848),P=s(96540),Z=s(71468),U=s(65305),X=s(14297),z=s(94701);function y({children:n,width:t,height:o,onLoad:e,onChange:a}){const i=(0,P.useId)(),[r,d]=(0,P.useState)(!1),[c,h]=(0,P.useState)(!1),g=(0,P.useRef)(null);return(0,z.A)(()=>{y.addCallback(i,I=>{!r&&I.isIntersecting&&(d(!0),e?.()),h(I.isIntersecting),a?.(I.isIntersecting)});const f=g.current;return f&&y.observer.observe(f),()=>{delete y.callbacks[i],f&&y.observer.unobserve(f),Object.keys(y.callbacks).length===0&&y.observer.disconnect()}}),(0,l.jsx)("div",{id:i,ref:g,style:{width:t,height:o},children:r&&(typeof n=="function"?n({isInView:c}):n)})}const st={};y.callbacks=st,y.addCallback=(n,t)=>y.callbacks[n]=t,y.observer=new IntersectionObserver(n=>{for(const t of n)y.callbacks[t.target.id]&&y.callbacks[t.target.id](t)},{rootMargin:"100px"});var Y=s(64423),D=s(8392),R=s(55801),G=s(4050),M=s(96325),N=s(88023),q=s(40828),Q=s(56152),J=s(80757),ut=s(60997),Et=s(39736),b=s(53027),gt=s(32370),at=s(83424),w=s(76530),F=s(90143),yt=s(54414),V=s(22803),ot=s(91323),pt=s(29675),it=s(6736),_=s(79784),K=s(78968),j=s(19224),Dt=s(60232),ft=s(52120);function Pt({panelLinks:n,onShowPanelLinks:t}){const o=(0,pt.of)(St),e=()=>{const a=t();return(0,l.jsx)(j.W,{children:a?.map((i,r)=>(0,l.jsx)(j.W.Item,{label:i.title,url:i.href,target:i.target,onClick:i.onClick},r))})};if(n.length===1){const a=t()[0];return(0,l.jsx)(M.NR.TitleItem,{href:a.href,onClick:a.onClick,target:a.target,title:a.title,children:(0,l.jsx)(_.I,{name:"external-link-alt",size:"md"})})}else return(0,l.jsx)(Dt.m,{overlay:e,children:(0,l.jsx)(ft.I,{icon:"external-link-alt",iconSize:"md","aria-label":"panel links",className:o.menuTrigger})})}const St=n=>({menuTrigger:(0,V.css)({height:"100%",background:"inherit",border:"none",borderRadius:`${n.shape.radius.default}`,cursor:"context-menu"})});var E=s(31047);function m(n){const{alertState:t,data:o,panelId:e,onShowPanelLinks:a,panelLinks:i,angularNotice:r}=n,d=(0,pt.of)(v),c=(0,l.jsx)(it.m,{content:t??"unknown",children:(0,l.jsx)(M.NR.TitleItem,{className:(0,V.cx)({[d.ok]:t===ot.O.OK,[d.pending]:t===ot.O.Pending,[d.alerting]:t===ot.O.Alerting}),children:(0,l.jsx)(_.I,{name:t==="alerting"?"heart-break":"heart",size:"md"})})}),h=(0,l.jsx)(l.Fragment,{children:o.request&&o.request.timeInfo&&(0,l.jsx)(it.m,{content:(0,l.jsx)(K.xS,{timeRange:o.request?.range,timeZone:o.request?.timezone}),children:(0,l.jsxs)(M.NR.TitleItem,{className:d.timeshift,children:[(0,l.jsx)(_.I,{name:"clock-nine",size:"md"})," ",o.request?.timeInfo]})})}),g=`This ${S(r)} requires Angular (deprecated).`,f=(0,l.jsx)(it.m,{content:g,children:(0,l.jsx)(M.NR.TitleItem,{className:d.angularNotice,"data-testid":"angular-deprecation-icon",children:(0,l.jsx)(_.I,{name:"exclamation-triangle",size:"md"})})});return(0,l.jsxs)(l.Fragment,{children:[i&&i.length>0&&a&&(0,l.jsx)(Pt,{onShowPanelLinks:a,panelLinks:i}),(0,l.jsx)(E.Z,{panelId:e,frames:o.series}),h,t&&c,r?.show&&f]})}const S=n=>n?.isAngularPanel?"panel":n?.isAngularDatasource?"data source":"panel or data source",v=n=>({ok:(0,V.css)({color:n.colors.success.text,"&:hover":{color:n.colors.emphasize(n.colors.success.text,.03)}}),pending:(0,V.css)({color:n.colors.warning.text,"&:hover":{color:n.colors.emphasize(n.colors.warning.text,.03)}}),alerting:(0,V.css)({color:n.colors.error.text,"&:hover":{color:n.colors.emphasize(n.colors.error.text,.03)}}),timeshift:(0,V.css)({color:n.colors.text.link,gap:n.spacing(.5),whiteSpace:"nowrap","&:hover":{color:n.colors.emphasize(n.colors.text.link,.03)}}),angularNotice:(0,V.css)({color:n.colors.warning.text})});function T(n){function t(){return n.data.request&&n.data.request.timeInfo?!1:!n.panel.hasTitle()}const o=()=>{const O=(0,Et.w)().replace(n.panel.description,n.panel.scopedVars);return(0,ut.G)(O)},e=()=>{const O=(0,F.E7)(n.panel);if(!O)return[];const B=O&&O.getLinks(n.panel.replaceVariables);return B.map(x=>({...x,onClick:(...Ct)=>{at.c.panelLinkClicked({has_multiple_links:B.length>1}),x.onClick?.(...Ct)}}))},a=(O,B)=>{O.stopPropagation(),b.Ny.partial({inspect:n.panel.id,inspectTab:B})},i=O=>{O.stopPropagation(),b.Ny.partial({inspect:n.panel.id,inspectTab:w.q.Error}),at.c.panelStatusMessageClicked()},r=()=>{n.panel.getQueryRunner().cancelQuery(),at.c.panelCancelQueryClicked({data_state:n.data.state})},d=n.plugin.noPadding?"none":"md",c=n.data.alertState?.state,h=n.panel.datasource?.uid?(0,yt.Hv)(n.panel.datasource?.uid):!1,g=n.panel.isAngularPlugin()&&!n.plugin.meta.angular?.hideDeprecation,f=(gt.$.featureToggles.angularDeprecationUI??!1)&&(h||g),L=(n.panel.links&&n.panel.links.length>0&&e||n.data.series.length>0&&n.data.series.some(O=>(O.meta?.notices?.length??0)>0)||n.data.request&&n.data.request.timeInfo||f||c)&&(0,l.jsx)(m,{alertState:c,data:n.data,panelId:n.panel.id,panelLinks:n.panel.links,angularNotice:{show:f,isAngularDatasource:h,isAngularPanel:g},onShowPanelLinks:e}),ct=n.panel.description?o:void 0,A=!(n.isViewing||n.isEditing)&&(n.isDraggable??!0)?"grid-drag-handle":"",tt=n.panel.getDisplayTitle();return{hasOverlayHeader:t,onShowPanelDescription:o,onShowPanelLinks:e,onOpenInspector:a,onOpenErrorInspect:i,onCancelQuery:r,padding:d,description:ct,dragClass:A,title:tt,titleItems:L}}var p=s(58779);function $({items:n}){const t=o=>o.map(e=>{switch(e.type){case"divider":return(0,l.jsx)(j.W.Divider,{},e.text);case"group":return(0,l.jsx)(j.W.Group,{label:e.text,children:e.subMenu?t(e.subMenu):void 0},e.text);default:return(0,l.jsx)(j.W.Item,{label:e.text,icon:e.iconClassName,childItems:e.subMenu?t(e.subMenu):void 0,url:e.href,onClick:e.onClick,shortcut:e.shortcut,testId:p.Tp.components.Panels.Panel.menuItems(e.text)},e.text)}});return(0,l.jsx)(j.W,{children:t(n)})}var rt=s(93253),lt=s(35023),Mt=s(29012),mt=s(61491),Ft=s(93407),It=s(17687),C=s(11817),Wt=s(80847),Lt=s(61351),Bt=s(44608),zt=s(95536),Qt=s(82096),W=s(57398),Jt=s(54506),wt=s(32056),Kt=s(11747),xt=s(83394),$t=s(96621),kt=s(67078);function Zt(n,t,o,e){const a=u=>{u.preventDefault(),b.Ny.partial({viewPanel:t.id})},i=u=>{u.preventDefault(),b.Ny.partial({editPanel:t.id})},r=u=>{u.preventDefault(),(0,W.Mc)(n,t)},d=u=>{u.preventDefault(),(0,W.d7)(n,t)},c=u=>{u.preventDefault(),(0,W.ZY)(t)},h=u=>{b.Ny.partial({inspect:t.id,inspectTab:u})},g=u=>{u.preventDefault(),(0,W.iU)(n,t)},f=u=>{u.preventDefault(),(0,W.KJ)(t)},I=u=>{u.preventDefault(),(0,W.FC)(n,t,!0)},L=u=>{u.preventDefault();const et=u.ctrlKey||u.metaKey?ht=>window.open(`${N.Ay.appSubUrl}${ht}`):void 0;xt.M_.dispatch((0,kt.ow)(t,{timeRange:(0,J.jG)().timeRange(),getExploreUrl:zt.Xe,openInNewWindow:et}))},ct=u=>{u.preventDefault(),(0,W.ET)(t)},A=[];t.isEditing||A.push({text:(0,C.t)("panel.header-menu.view","View"),iconClassName:"eye",onClick:a,shortcut:"v"}),n.canEditPanel(t)&&!t.isEditing&&A.push({text:(0,C.t)("panel.header-menu.edit","Edit"),iconClassName:"edit",onClick:i,shortcut:"e"}),A.push({text:(0,C.t)("panel.header-menu.share","Share"),iconClassName:"share-alt",onClick:r,shortcut:"p s"}),Lt.TP.hasAccessToExplore()&&!(t.plugin&&t.plugin.meta.skipDataQuery)&&t.datasource?.uid!==Kt.K&&A.push({text:(0,C.t)("panel.header-menu.explore","Explore"),iconClassName:"compass",onClick:L,shortcut:"p x"});const tt=[];t.plugin&&!t.plugin.meta.skipDataQuery&&(tt.push({text:(0,C.t)("panel.header-menu.inspect-data","Data"),onClick:u=>h(w.q.Data)}),n.meta.canEdit&&tt.push({text:(0,C.t)("panel.header-menu.query","Query"),onClick:u=>h(w.q.Query)})),tt.push({text:(0,C.t)("panel.header-menu.inspect-json","Panel JSON"),onClick:u=>h(w.q.JSON)}),A.push({type:"submenu",text:(0,C.t)("panel.header-menu.inspect","Inspect"),iconClassName:"info-circle",shortcut:"i",subMenu:tt});const O=async()=>{let u;try{u=await(0,Qt.mp)(t,n)}catch(ht){const k=`Error getting rule values from the panel: ${(0,Bt.q6)(ht)}`;(0,xt.JD)((0,Wt.dx)((0,It.gi)(k)));return}const et=Ft.kM.renderUrl("/alerting/new",{defaults:JSON.stringify(u),returnTo:location.pathname+location.search});b.Ny.push(et)},B=u=>{u.preventDefault(),O()},x=[],Ct=n.canEditPanel(t),Ht=(0,$t.q0)();if(t.isViewing||t.isEditing||(Ct?(x.push({text:(0,C.t)("panel.header-menu.duplicate","Duplicate"),onClick:g,shortcut:"p d"}),x.push({text:(0,C.t)("panel.header-menu.copy","Copy"),onClick:f}),(0,Jt.X)(t)?x.push({text:(0,C.t)("panel.header-menu.unlink-library-panel","Unlink library panel"),onClick:c}):x.push({text:(0,C.t)("panel.header-menu.create-library-panel","Create library panel"),onClick:d})):Lt.TP.isEditor&&x.push({text:(0,C.t)("panel.header-menu.copy","Copy"),onClick:f})),Ht&&x.push({text:(0,C.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:B}),e){const u=e.getScope(),et=u.$$childHead.ctrl,ht=et.getExtendedMenu();for(const k of ht){const Gt={text:k.text,href:k.href,shortcut:k.shortcut};k.click&&(Gt.onClick=()=>{u.$eval(k.click,{ctrl:et})}),x.push(Gt)}}return t.options.legend&&x.push({text:t.options.legend.showLegend?(0,C.t)("panel.header-menu.hide-legend","Hide legend"):(0,C.t)("panel.header-menu.show-legend","Show legend"),onClick:ct,shortcut:"p l"}),t.isEditing&&(x.length=0,Ht&&x.push({text:(0,C.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:B})),Ct&&t.plugin&&!t.plugin.meta.skipDataQuery&&x.push({text:(0,C.t)("panel.header-menu.get-help","Get help"),onClick:u=>h(w.q.Help)}),o.length>0&&!t.isEditing&&A.push({text:"Extensions",iconClassName:"plug",type:"submenu",subMenu:(0,wt.N9)(o)}),x.length&&A.push({type:"submenu",text:(0,C.t)("panel.header-menu.more","More..."),iconClassName:"cube",subMenu:x}),n.canEditPanel(t)&&!t.isEditing&&!t.isViewing&&(A.push({type:"divider",text:""}),A.push({text:(0,C.t)("panel.header-menu.remove","Remove"),iconClassName:"trash-alt",onClick:I,shortcut:"p r"})),A}function Xt({panel:n,dashboard:t,loadingState:o,children:e}){const[a,i]=(0,P.useState)([]),r=(0,mt.useSelector)(h=>(0,Q.U)(h,n)?.angularComponent),d=(0,P.useMemo)(()=>Yt(n,t),[n,t]),{links:c}=(0,Mt.U)({extensionPointId:rt.S.DashboardPanelMenu,context:d,limitPerPlugin:3});return(0,P.useEffect)(()=>{i(Zt(t,n,c,r))},[t,n,r,o,i,c]),e({items:a})}function Yt(n,t){return{id:n.id,pluginId:n.type,title:n.title,timeRange:t.time,timeZone:(0,lt.O)({timeZone:t.timezone}),dashboard:{uid:t.uid,title:t.title,tags:Array.from(t.tags)},targets:n.targets,scopedVars:n.scopedVars,data:n.getQueryRunner().getLastResult()}}function Ut({style:n,panel:t,dashboard:o,loadingState:e}){return(0,l.jsx)(Xt,{panel:t,dashboard:o,loadingState:e,children:({items:a})=>(0,l.jsx)($,{style:n,items:a})})}class qt extends P.PureComponent{constructor(t){super(t),this.element=null,this.timeSrv=(0,J.jG)(),this.subs=new Y.yU,this.state={data:{state:D.Gu.NotStarted,series:[],timeRange:(0,R.E2)()}}}componentDidMount(){const{panel:t}=this.props;this.loadAngularPanel();const o=t.getQueryRunner();this.subs.add(o.getData({withTransforms:!1,withFieldConfig:!1}).subscribe({next:e=>this.onPanelDataUpdate(e)}))}onPanelDataUpdate(t){let o;if(t.state===D.Gu.Error){const{error:e}=t;e&&o!==e.message&&(o=e.message)}this.setState({data:t,errorMessage:o})}componentWillUnmount(){this.subs.unsubscribe(),this.props.angularComponent&&this.props.angularComponent?.destroy()}componentDidUpdate(t,o){const{plugin:e,height:a,width:i,panel:r}=this.props;t.plugin!==e&&this.loadAngularPanel(),(t.width!==i||t.height!==a)&&this.scopeProps&&(this.scopeProps.size.height=this.getInnerPanelHeight(),this.scopeProps.size.width=this.getInnerPanelWidth(),r.render())}getInnerPanelHeight(){const{plugin:t,height:o}=this.props,{theme:e}=N.Ay,a=this.hasOverlayHeader()?0:e.panelHeaderHeight,i=t.noPadding?0:e.panelPadding;return o-a-i*2-q.IZ}getInnerPanelWidth(){const{plugin:t,width:o}=this.props,{theme:e}=N.Ay,a=t.noPadding?0:e.panelPadding;return o-a*2-q.IZ}loadAngularPanel(){const{panel:t,dashboard:o,setPanelAngularComponent:e}=this.props;if(!this.element)return;const a=(0,G.E)(),i='<plugin-component type="panel" class="panel-height-helper"></plugin-component>';this.scopeProps={panel:t,dashboard:o,size:{width:this.getInnerPanelWidth(),height:this.getInnerPanelHeight()}},e({key:t.key,angularComponent:a.load(this.element,this.scopeProps,i)})}hasOverlayHeader(){const{panel:t}=this.props,{data:o}=this.state;return o.request&&o.request.timeInfo?!1:!t.hasTitle()}render(){const{dashboard:t,panel:o}=this.props,{errorMessage:e,data:a}=this.state,{transparent:i}=o,r=T({...this.props,data:a}),d=(o.gridPos?.y??0)===0?-16:void 0,c=(0,l.jsx)("div",{"data-testid":"panel-dropdown",children:(0,l.jsx)(Ut,{panel:o,dashboard:t,loadingState:a.state})});return(0,l.jsx)(M.NR,{width:this.props.width,height:this.props.height,title:r.title,loadingState:a.state,statusMessage:e,statusMessageOnClick:r.onOpenErrorInspect,description:r.description,titleItems:r.titleItems,menu:this.props.hideMenu?void 0:c,dragClass:r.dragClass,dragClassCancel:"grid-drag-cancel",padding:r.padding,hoverHeaderOffset:d,hoverHeader:r.hasOverlayHeader(),displayMode:i?"transparent":"default",onCancelQuery:r.onCancelQuery,children:()=>(0,l.jsx)("div",{ref:h=>this.element=h,className:"panel-height-helper"})})}}const _t=(n,t)=>({angularComponent:(0,Q.U)(n,t.panel)?.angularComponent}),te={setPanelAngularComponent:X.S3},ee=(0,Z.connect)(_t,te)(qt);var ne=s(2543),se=s(74958),dt=s(16753),vt=s(35383),bt=s(3202),ae=s(61809),oe=s(4038),ie=s(86833),re=s(90415),le=s(49816),de=s(22492),ce=s(81804),he=s(10059),ue=s(34394),ge=s(45288),Vt=s(38075),pe=s(62931);const fe=(n,t,o)=>{const{overrides:e}=o,a=o.overrides.findIndex(h=>h.matcher.id===Vt.Ct.byName&&h.matcher.options===n);if(a<0)return{...o,overrides:[...o.overrides,me(n,t)]};const i=Array.from(e),r=i[a],d=r.properties.findIndex(h=>h.id==="color");if(d<0)return i[a]={...r,properties:[...r.properties,Nt(t)]},{...o,overrides:i};const c=Array.from(r.properties);return c[d]=Nt(t),i[a]={...r,properties:c},{...o,overrides:i}},me=(n,t)=>({matcher:{id:Vt.Ct.byName,options:n},properties:[Nt(t)]}),Nt=n=>({id:"color",value:{mode:pe.Y.Fixed,fixedColor:n}});var ve=s(91830),Tt=s(65596),Ot=s(85754),Ce=s(47238),jt=s(32631),H=(n=>(n.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT="field config overrides changed",n.NEW_PANEL_OPTION_EVENT="new panel option",n.PANEL_OPTION_CHANGED_EVENT="panel option changed",n.NEW_DEFAULT_FIELD_CONFIG_EVENT="new default field config",n.DEFAULT_FIELD_CONFIG_CHANGED_EVENT="default field config changed",n.NEW_CUSTOM_FIELD_CONFIG_EVENT="new custom field config",n.CUSTOM_FIELD_CONFIG_CHANGED_EVENT="custom field config changed",n.MEASURE_PANEL_LOAD_TIME_EVENT="measure panel load time",n.THRESHOLDS_COUNT_CHANGED_EVENT="thresholds count changed",n.THRESHOLDS_MODE_CHANGED_EVENT="thresholds mode changed",n.MAPPINGS_COUNT_CHANGED_EVENT="mappings count changed",n.LINKS_COUNT_CHANGED_EVENT="links count changed",n.PANEL_ERROR="panel error",n))(H||{});const Ee="overrides",ye="custom",De=n=>{const t=performance.now();return(0,P.useEffect)(()=>{N.$W.grafanaJavascriptAgent.enabled&&requestAnimationFrame(()=>{setTimeout(()=>{jt.P.api.pushMeasurement({type:H.MEASURE_PANEL_LOAD_TIME_EVENT,values:{start_loading_time_ms:t,load_time_ms:performance.now()-t}},{context:{panel_type:n.panelType,panel_id:String(n.panelId),panel_title:n.panelTitle}})},0)})},[]),null};var Pe=s(90968),At=s(5468);class Se{constructor(t,o,e){this.logChanges=(a,i)=>{this.logPanelOptionChanges(a,this.initialPanelOptions),this.logFieldConfigChanges(i,this.initialFieldConfig),this.initialPanelOptions=a,this.initialFieldConfig=i},this.logPanelEvent=(a,i,r,d)=>{if(!N.$W.grafanaJavascriptAgent.enabled)return;const c={key:i,newValue:r,oldValue:d??"",panelTitle:this.panelLogInfo.panelTitle,panelId:this.panelLogInfo.panelId,panelType:this.panelLogInfo.panelType};jt.P.api.pushEvent(a,c)},this.logPanelOptionChanges=(a,i)=>{if(typeof a!="object"||a===null||typeof i!="object"||i===null)return;const r={...i};for(const[d,c]of Object.entries(a)){const h=typeof c!="string"?JSON.stringify(c):c,g=typeof c!="string"?JSON.stringify(r[d]):String(r[d]);r[d]===void 0?this.logPanelEvent(H.NEW_PANEL_OPTION_EVENT,d,h):g!==h&&this.logPanelEvent(H.PANEL_OPTION_CHANGED_EVENT,d,h,g)}},this.logFieldConfigChanges=(a,i)=>{const r=JSON.stringify(i.overrides),d=JSON.stringify(a.overrides);r!==d&&this.logPanelEvent(H.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT,Ee,d,r);const c={...i.defaults};for(const[g,f]of Object.entries(a.defaults)){if(g===ye)continue;const I=typeof f!="string"?JSON.stringify(f):f,L=typeof f!="string"?JSON.stringify(c[g]):String(c[g]);c[g]===void 0?this.logPanelEvent(H.NEW_DEFAULT_FIELD_CONFIG_EVENT,g,I):L!==I&&this.logPanelEvent(H.DEFAULT_FIELD_CONFIG_CHANGED_EVENT,g,I,L)}if(!a.defaults.custom||c.custom===void 0)return;const h={...c.custom};for(const[g,f]of Object.entries(a.defaults.custom)){if(c.custom===null||h[g]===null)continue;const I=typeof f!="string"?JSON.stringify(f):f,L=typeof f!="string"?JSON.stringify(h[g]):String(h[g]);h[g]===void 0?this.logPanelEvent(H.NEW_CUSTOM_FIELD_CONFIG_EVENT,g,I):L!==I&&this.logPanelEvent(H.CUSTOM_FIELD_CONFIG_CHANGED_EVENT,g,I,L)}},this.initialPanelOptions=t,this.initialFieldConfig=o,this.panelLogInfo=e}}const Ie="Error in plugin";class xe extends P.PureComponent{constructor(t){super(t),this.timeSrv=(0,J.jG)(),this.subs=new Y.yU,this.eventFilter={onlyLocal:!0},this.panelOptionsLogger=void 0,this.getSync=()=>this.props.isEditing?se.y.Off:this.props.dashboard.graphTooltip,this.onInstanceStateChange=e=>{this.props.onInstanceStateChange(e),this.setState({context:{...this.state.context,instanceState:e}})},this.onUpdateData=e=>(0,ge.H)(this.props.panel,e),this.onSeriesColorChange=(e,a)=>{this.onFieldConfigChange(fe(e,a,this.props.panel.fieldConfig))},this.onSeriesVisibilityChange=(e,a)=>{this.onFieldConfigChange((0,Pe.M)(e,a,this.props.panel.fieldConfig,this.state.data.series))},this.onToggleLegendSort=e=>{const a=this.props.panel.options.legend;if(!a)return;let i=a.sortDesc,r=a.sortBy;e!==r&&(i=void 0),i===!1?(r=void 0,i=void 0):(i=!i,r=e),this.onOptionsChange({...this.props.panel.options,legend:{...a,sortBy:r,sortDesc:i}})},this.onRefresh=()=>{const{dashboard:e,panel:a,isInView:i,width:r}=this.props;if(!e.snapshot&&!i){a.refreshWhenInView=!0;return}const d=(0,W.nk)(a,this.timeSrv.timeRange());if(this.wantsQueryExecution){if(r<0)return;a.refreshWhenInView=!1,a.runAllPanelQueries({dashboardUID:e.uid,dashboardTimezone:e.getTimezone(),timeData:d,width:r})}else this.setState({data:{...this.state.data,timeRange:this.timeSrv.timeRange()},renderCounter:this.state.renderCounter+1,liveTime:void 0})},this.onRender=()=>{const e={renderCounter:this.state.renderCounter+1};this.setState(e)},this.onOptionsChange=e=>{this.props.panel.updateOptions(e)},this.onFieldConfigChange=e=>{this.props.panel.updateFieldConfig(e)},this.onPanelError=e=>{N.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===dt.Jk.PanelEditor&&this.logPanelChangesOnError();const a=e.message||Ie;this.state.errorMessage!==a&&this.setState({errorMessage:a})},this.onPanelErrorRecover=()=>{this.setState({errorMessage:void 0})},this.onAnnotationCreate=async e=>{const a=e.from!==e.to,i={dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:e.from,timeEnd:a?e.to:0,tags:e.tags,text:e.description};await(0,Tt.vJ)(i),(0,Ot.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new vt.We(i))},this.onAnnotationDelete=async e=>{await(0,Tt.Xm)({id:e}),(0,Ot.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new vt.We({id:e}))},this.onAnnotationUpdate=async e=>{const a=e.from!==e.to,i={id:e.id,dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:e.from,timeEnd:a?e.to:0,tags:e.tags,text:e.description};await(0,Tt.rJ)(i),(0,Ot.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new vt.We(i))},this.onChangeTimeRange=e=>{this.timeSrv.setTime({from:(0,bt.yT)(e.from),to:(0,bt.yT)(e.to)})},this.onAddAdHocFilter=e=>{const{key:a,value:i,operator:r}=e,d=(0,he.tR)().getInstanceSettings(this.props.panel.datasource),c=d&&(0,ae.p$)(d);c&&(0,xt.JD)((0,ue.z_)({datasource:c,key:a,operator:r,value:i}))};const o=t.dashboard.events.newScopedBus(`panel:${t.panel.id}`,this.eventFilter);if(this.debouncedSetPanelAttention=(0,ne.debounce)(this.setPanelAttention.bind(this),100),this.state={isFirstLoad:!0,renderCounter:0,context:{eventsScope:"__global_",eventBus:o,app:this.getPanelContextApp(),sync:this.getSync,onSeriesColorChange:this.onSeriesColorChange,onToggleSeriesVisibility:this.onSeriesVisibilityChange,onAnnotationCreate:this.onAnnotationCreate,onAnnotationUpdate:this.onAnnotationUpdate,onAnnotationDelete:this.onAnnotationDelete,onInstanceStateChange:this.onInstanceStateChange,onToggleLegendSort:this.onToggleLegendSort,canAddAnnotations:t.dashboard.canAddAnnotations.bind(t.dashboard),canEditAnnotations:t.dashboard.canEditAnnotations.bind(t.dashboard),canDeleteAnnotations:t.dashboard.canDeleteAnnotations.bind(t.dashboard),onAddAdHocFilter:this.onAddAdHocFilter,onUpdateData:this.onUpdateData},data:this.getInitialPanelDataState()},N.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===dt.Jk.PanelEditor){const e={panelId:String(t.panel.id),panelType:t.panel.type,panelTitle:t.panel.title};this.panelOptionsLogger=new Se(t.panel.getOptions(),t.panel.fieldConfig,e)}}getPanelContextApp(){return this.props.isEditing?dt.Jk.PanelEditor:this.props.isViewing?dt.Jk.PanelViewer:dt.Jk.Dashboard}getInitialPanelDataState(){return{state:D.Gu.NotStarted,series:[],timeRange:(0,R.E2)()}}componentDidMount(){const{panel:t,dashboard:o}=this.props;if(this.subs.add(t.events.subscribe(ie._,this.onRefresh)),this.subs.add(t.events.subscribe(ve.XM,this.onRender)),o.panelInitialized(this.props.panel),this.hasPanelSnapshot){this.setState({data:(0,Ce.d)(t,o),isFirstLoad:!1});return}this.wantsQueryExecution||this.setState({isFirstLoad:!1}),this.subs.add(t.getQueryRunner().getData({withTransforms:!0,withFieldConfig:!0}).subscribe({next:e=>this.onDataUpdate(e)})),At.a.listen(this)}componentWillUnmount(){this.subs.unsubscribe(),At.a.remove(this)}liveTimeChanged(t){const{data:o}=this.state;if(o.timeRange){const e=t.to.valueOf()-o.timeRange.to.valueOf();if(e<100){console.log("Skip tick render",this.props.panel.title,e);return}}this.setState({liveTime:t})}componentDidUpdate(t){const{isInView:o,width:e,panel:a}=this.props,{context:i}=this.state,r=this.getPanelContextApp();i.app!==r&&this.setState({context:{...i,app:r}}),o!==t.isInView&&o&&a.refreshWhenInView&&this.onRefresh(),e!==t.width&&At.a.updateInterval(this)}onDataUpdate(t){const{dashboard:o,panel:e,plugin:a}=this.props;if(a.meta.skipDataQuery){this.setState({data:this.getInitialPanelDataState()});return}let{isFirstLoad:i}=this.state,r;switch(t.state){case D.Gu.Loading:if(this.state.data.state===D.Gu.Loading)return;break;case D.Gu.Error:const{error:d,errors:c}=t;c?.length?c.length===1?r=c[0].message:r="Multiple errors found. Click for more details":d&&r!==d.message&&(r=d.message);break;case D.Gu.Done:o.snapshot&&(e.snapshotData=t.series.map(h=>(0,oe.Kl)(h))),i&&(i=!1);break}this.setState({isFirstLoad:i,errorMessage:r,data:t,liveTime:void 0})}logPanelChangesOnError(){this.panelOptionsLogger.logChanges(this.props.panel.getOptions(),this.props.panel.fieldConfig)}get hasPanelSnapshot(){const{panel:t}=this.props;return t.snapshotData&&t.snapshotData.length}get wantsQueryExecution(){return!(this.props.plugin.meta.skipDataQuery||this.hasPanelSnapshot)}shouldSignalRenderingCompleted(t,o){return t===D.Gu.Done||t===D.Gu.Streaming||t===D.Gu.Error||o.skipDataQuery}skipFirstRender(t){const{isFirstLoad:o}=this.state;return this.wantsQueryExecution&&o&&(t===D.Gu.Loading||t===D.Gu.NotStarted)}renderPanelContent(t,o){const{panel:e,plugin:a,dashboard:i}=this.props,{renderCounter:r,data:d}=this.state,{state:c}=d;if(this.skipFirstRender(c))return null;this.shouldSignalRenderingCompleted(c,a.meta)&&ce.E.renderingCompleted();const h=a.panel,g=this.state.liveTime??d.timeRange??this.timeSrv.timeRange(),f=e.getOptions();return this.eventFilter.onlyLocal=i.graphTooltip===0,(0,l.jsx)(l.Fragment,{children:(0,l.jsxs)(re.XF,{value:this.state.context,children:[(0,l.jsx)(h,{id:e.id,data:d,title:e.title,timeRange:g,timeZone:this.props.dashboard.getTimezone(),options:f,fieldConfig:e.fieldConfig,transparent:e.transparent,width:t,height:o,renderCounter:r,replaceVariables:e.replaceVariables,onOptionsChange:this.onOptionsChange,onFieldConfigChange:this.onFieldConfigChange,onChangeTimeRange:this.onChangeTimeRange,eventBus:i.events}),N.Ay.featureToggles.panelMonitoring&&this.state.errorMessage===void 0&&(0,l.jsx)(De,{panelType:a.meta.id,panelId:e.id,panelTitle:e.title})]})})}setPanelAttention(){de.A.publish(new vt.Tp({panelId:this.props.panel.id}))}debouncedSetPanelAttention(){}render(){const{dashboard:t,panel:o,width:e,height:a,plugin:i}=this.props,{errorMessage:r,data:d}=this.state,{transparent:c}=o,h=T({...this.props,data:d}),g=(o.gridPos?.y??0)===0?-16:void 0,f=(0,l.jsx)("div",{"data-testid":"panel-dropdown",children:(0,l.jsx)(Ut,{panel:o,dashboard:t,loadingState:d.state})});return(0,l.jsx)(M.NR,{width:e,height:a,title:h.title,loadingState:d.state,statusMessage:r,statusMessageOnClick:h.onOpenErrorInspect,description:h.description,titleItems:h.titleItems,menu:this.props.hideMenu?void 0:f,dragClass:h.dragClass,dragClassCancel:"grid-drag-cancel",padding:h.padding,hoverHeaderOffset:g,hoverHeader:h.hasOverlayHeader(),displayMode:c?"transparent":"default",onCancelQuery:h.onCancelQuery,onFocus:()=>this.setPanelAttention(),onMouseEnter:()=>this.setPanelAttention(),onMouseMove:()=>this.debouncedSetPanelAttention(),children:(I,L)=>(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(le.tH,{dependencies:[d,i,o.getOptions()],onError:this.onPanelError,onRecover:this.onPanelErrorRecover,children:({error:ct})=>ct?null:this.renderPanelContent(I,L)})})})}}const Ne=(n,t)=>{const o=n.panels[t.stateKey];return o?{plugin:o.plugin,instanceState:o.instanceState}:{plugin:void 0}},Te={initPanelState:U.Ap,setPanelInstanceState:X.nF},Oe=(0,Z.connect)(Ne,Te);class Ae extends P.PureComponent{constructor(){super(...arguments),this.onInstanceStateChange=t=>{this.props.setPanelInstanceState({key:this.props.stateKey,value:t})},this.onVisibilityChange=t=>{this.props.panel.isInView=t},this.onPanelLoad=()=>{this.props.plugin||this.props.initPanelState(this.props.panel)},this.renderPanel=({isInView:t})=>{const{dashboard:o,panel:e,isViewing:a,isEditing:i,width:r,height:d,plugin:c,timezone:h,hideMenu:g,isDraggable:f=!0}=this.props;return c?c&&c.angularPanelCtrl?(0,l.jsx)(ee,{plugin:c,panel:e,dashboard:o,isViewing:a,isEditing:i,isInView:t,isDraggable:f,width:r,height:d}):(0,l.jsx)(xe,{plugin:c,panel:e,dashboard:o,isViewing:a,isEditing:i,isInView:t,isDraggable:f,width:r,height:d,onInstanceStateChange:this.onInstanceStateChange,timezone:h,hideMenu:g}):null}}static{this.defaultProps={lazy:!0}}componentDidMount(){this.props.panel.isInView=!this.props.lazy,this.props.lazy||this.onPanelLoad()}render(){const{width:t,height:o,lazy:e}=this.props;return e?(0,l.jsx)(y,{width:t,height:o,onChange:this.onVisibilityChange,onLoad:this.onPanelLoad,children:this.renderPanel}):this.renderPanel({isInView:!0})}}const Re=Oe(Ae)},83241:(Rt,nt,s)=>{s.d(nt,{v:()=>Pt});var l=s(2567),P=s(3202),Z=s(35383),U=s(53027),X=s(28082),z=s(32370),y=s(23737),st=s(22492),Y=s(17687),D=s(75911),R=s(82856),G=s(36314),M=s(55227),N=s(16910),q=s(80757),Q=s(44172),J=s(25202),ut=s(64199),Et=s(31512);function b(E){return async m=>{const S=await D.IB.getFolderByUid(E);return m((0,Et.jl)(S)),m((0,y.Vz)((0,ut.R4)(S))),S}}var gt=s(10474),at=s(40819),w=s(2510),F=s(61491),yt=s(85754),V=s(20138),ot=s(58843),pt=s(68131),it=s(36503),_=s(94038),K=s(86983);const j="initDashboard";async function Dt(E,m,S){try{switch(E.routeName){case F.DashboardRoutes.Home:{const T=(0,Q.sP)().getDashboardFromCache(Q.m6);if(T)return T;const p=await D.IB.get("/api/dashboards/home");if((0,F.isRedirectResponse)(p)){const $=l.I.stripBaseFromUrl(p.redirectUri);return U.Ny.replace($),null}return p.meta.canSave=!1,p.meta.canShare=!1,p.meta.canStar=!1,p}case F.DashboardRoutes.Public:return await M.np.loadDashboard("public",E.urlSlug,E.accessToken);case F.DashboardRoutes.Normal:{const v=await M.np.loadDashboard(E.urlType,E.urlSlug,E.urlUid);if(v.meta.folderUid)try{await m(b(v.meta.folderUid))}catch(T){console.warn("Error fetching parent folder",v.meta.folderUid,"for dashboard",T)}if(E.fixUrl&&v.meta.url&&!at._o.state.isPlaying){const T=l.I.stripBaseFromUrl(v.meta.url),p=U.Ny.getLocation().pathname;T!==p&&(U.Ny.replace({...U.Ny.getLocation(),pathname:T}),console.log("not correct url correcting",T,p))}return v}case F.DashboardRoutes.New:return E.urlFolderUid&&await m(b(E.urlFolderUid)),await(0,J.X)(E.urlFolderUid);default:throw{message:"Unknown route "+E.routeName}}}catch(v){return(0,X.NF)(v)&&v.cancelled||(m((0,K.ig)({message:"Failed to fetch dashboard",error:v})),console.error(v)),null}}const ft=(E,m={})=>(E.forEach(S=>{S.panels?ft(S.panels,m):S.targets&&S.targets.forEach(v=>{v.datasource?.type&&(m[v.datasource.type]?m[v.datasource.type].push(v):m[v.datasource.type]=[v])})}),m);function Pt(E){return async(m,S)=>{(0,G.j)(j),m((0,K.xS)());const v=await Dt(E,m,S),T=v?.dashboard?.version;if(!v)return;St(v),m((0,K.X1)());let p;try{p=new it.G(v.dashboard,v.meta)}catch(C){m((0,K.ig)({message:"Failed create dashboard model",error:C})),console.error(C);return}const $=S(),rt=U.Ny.getSearchObject();rt.orgId||U.Ny.partial({orgId:$.user.orgId},!0);const lt=(0,q.jG)();(0,N.UA)().setCurrent(p),lt.init(p);const mt=(0,w.q4)(E.urlUid??p.uid);if(await m((0,V._q)(mt,p)),(0,yt.nm)({dashboard:p,timeSrv:lt}).run({dashboard:p,range:lt.timeRange()}),(0,ot.Tk)(S())!==mt||S().dashboard.initPhase!==F.DashboardInitPhase.Services)return;try{p.processRepeats(),rt.autofitpanels&&p.autoFitPanels(window.innerHeight,rt.kiosk),z.$.publicDashboardAccessToken||E.keybindingSrv.setupDashboardBindings(p)}catch(C){C instanceof Error&&m((0,y.dx)((0,Y.gi)("Dashboard init failed",C))),console.error(C)}E.routeName!==F.DashboardRoutes.New?((0,_.B)(p),gt.t.watch(p.uid)):gt.t.leave(),p.weekStart!==""?(0,P.$D)(p.weekStart):(0,P.$D)(z.$.bootData.user.weekStart),st.A.publish(new Z.gc({dashboardId:p.uid,orgId:$.user.orgId,userId:$.user.user?.id,grafanaVersion:z.$.buildInfo.version,queries:ft(p.panels)}));const It=(0,G.z)(j);(0,pt.dM)(p,It?.duration,T),m((0,K.O9)(p))}}function St(E){const m=R.A.getObject(F.DASHBOARD_FROM_LS_KEY);m&&(m.dashboard.panels&&(E.dashboard.panels=m.dashboard.panels.concat(E.dashboard.panels)),m.dashboard.time&&(E.dashboard.time=m.dashboard.time),R.A.delete(F.DASHBOARD_FROM_LS_KEY))}},47238:(Rt,nt,s)=>{s.d(nt,{d:()=>D});var l=s(4038),P=s(55801),Z=s(75906),U=s(8392),X=s(47286),z=s(88023),y=s(58109),st=s(80757),Y=s(57398);function D(R,G){const M=(0,l.Bt)(R.snapshotData),N=new y.F,q={dashboard:G,range:(0,P.E2)()},Q=N.canWork(q)?N.getAnnotationsInSnapshot(G,R.id):[],J=[(0,Z.I)(Q)];return{timeRange:(0,Y.nk)(R,(0,st.jG)().timeRange()).timeRange,state:U.Gu.Done,series:(0,X.we)({data:M,fieldConfig:{defaults:{},overrides:[]},replaceVariables:R.replaceVariables,fieldConfigRegistry:R.plugin.fieldConfigRegistry,theme:z.$W.theme2,timeZone:G.getTimezone()}),structureRev:1,annotations:J}}}}]);

//# sourceMappingURL=1115.b883ab7ed2592e158239.js.map