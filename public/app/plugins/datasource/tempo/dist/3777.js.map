{"version":3,"file":"3777.js","mappings":"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","sources":["webpack://tempo/./_importedDependencies/datasources/prometheus/RawQuery.tsx","webpack://tempo/../../../../../packages/grafana-ui/src/themes/ThemeContext.tsx","webpack://tempo/./_importedDependencies/datasources/prometheus/QueryOptionGroup.tsx","webpack://tempo/./traceql/TempoQueryBuilderOptions.tsx","webpack://tempo/./SearchTraceQLEditor/DurationInput.tsx","webpack://tempo/./SearchTraceQLEditor/InlineSearchField.tsx","webpack://tempo/./SearchTraceQLEditor/GroupByField.tsx","webpack://tempo/./SearchTraceQLEditor/TraceQLSearch.tsx","webpack://tempo/./_importedDependencies/components/AdHocFilter/AdHocFilterKey.tsx","webpack://tempo/./_importedDependencies/components/AdHocFilter/AdHocFilterValue.tsx","webpack://tempo/./_importedDependencies/components/AdHocFilter/OperatorSegment.tsx","webpack://tempo/./_importedDependencies/components/AdHocFilter/AdHocFilterRenderer.tsx","webpack://tempo/./_importedDependencies/components/AdHocFilter/AdHocFilterBuilder.tsx","webpack://tempo/./_importedDependencies/components/AdHocFilter/ConditionSegment.tsx","webpack://tempo/./_importedDependencies/components/AdHocFilter/AdHocFilter.tsx","webpack://tempo/./ServiceGraphSection.tsx","webpack://tempo/./types.ts","webpack://tempo/./traceql/situation.ts","webpack://tempo/./traceql/autocomplete.ts","webpack://tempo/./traceql/highlighting.ts","webpack://tempo/./traceql/TraceQLEditor.tsx","webpack://tempo/./traceql/QueryEditor.tsx","webpack://tempo/./QueryField.tsx"],"sourcesContent":["import { css, cx } from '@emotion/css';\nimport Prism, { Grammar } from 'prismjs';\n\nimport { GrafanaTheme2 } from '@grafana/data/src';\nimport { useTheme2 } from '@grafana/ui/src';\n\nexport interface Props {\n  query: string;\n  lang: {\n    grammar: Grammar;\n    name: string;\n  };\n  className?: string;\n}\nexport function RawQuery({ query, lang, className }: Props) {\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n  const highlighted = Prism.highlight(query, lang.grammar, lang.name);\n\n  return (\n    <div\n      className={cx(styles.editorField, 'prism-syntax-highlight', className)}\n      aria-label=\"selector\"\n      dangerouslySetInnerHTML={{ __html: highlighted }}\n    />\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    editorField: css({\n      fontFamily: theme.typography.fontFamilyMonospace,\n      fontSize: theme.typography.bodySmall.fontSize,\n    }),\n  };\n};\n","import hoistNonReactStatics from 'hoist-non-react-statics';\nimport memoize from 'micro-memoize';\nimport { useContext } from 'react';\nimport * as React from 'react';\n\nimport { GrafanaTheme, GrafanaTheme2, ThemeContext } from '@grafana/data';\n\nimport { Themeable, Themeable2 } from '../types/theme';\n\nimport { stylesFactory } from './stylesFactory';\n\ntype Omit<T, K> = Pick<T, Exclude<keyof T, K>>;\ntype Subtract<T, K> = Omit<T, keyof K>;\n\n/**\n * Mock used in tests\n */\nlet ThemeContextMock: React.Context<GrafanaTheme2> | null = null;\n\n// Used by useStyles()\nexport const memoizedStyleCreators = new WeakMap();\n\n/** @deprecated use withTheme2 */\n/** @public */\nexport const withTheme = <P extends Themeable, S extends {} = {}>(Component: React.ComponentType<P>) => {\n  const WithTheme: React.FunctionComponent<Subtract<P, Themeable>> = (props) => {\n    /**\n     * If theme context is mocked, let's use it instead of the original context\n     * This is used in tests when mocking theme using mockThemeContext function defined below\n     */\n    const ContextComponent = ThemeContextMock || ThemeContext;\n    return (\n      // @ts-ignore\n      <ContextComponent.Consumer>{(theme) => <Component {...props} theme={theme.v1} />}</ContextComponent.Consumer>\n    );\n  };\n\n  WithTheme.displayName = `WithTheme(${Component.displayName})`;\n  hoistNonReactStatics(WithTheme, Component);\n  type Hoisted = typeof WithTheme & S;\n  return WithTheme as Hoisted;\n};\n\n/** @alpha */\nexport const withTheme2 = <P extends Themeable2, S extends {} = {}>(Component: React.ComponentType<P>) => {\n  const WithTheme: React.FunctionComponent<Subtract<P, Themeable2>> = (props) => {\n    /**\n     * If theme context is mocked, let's use it instead of the original context\n     * This is used in tests when mocking theme using mockThemeContext function defined below\n     */\n    const ContextComponent = ThemeContextMock || ThemeContext;\n    return (\n      // @ts-ignore\n      <ContextComponent.Consumer>{(theme) => <Component {...props} theme={theme} />}</ContextComponent.Consumer>\n    );\n  };\n\n  WithTheme.displayName = `WithTheme(${Component.displayName})`;\n  hoistNonReactStatics(WithTheme, Component);\n  type Hoisted = typeof WithTheme & S;\n  return WithTheme as Hoisted;\n};\n\n/** @deprecated use useTheme2 */\n/** @public */\nexport function useTheme(): GrafanaTheme {\n  return useContext(ThemeContextMock || ThemeContext).v1;\n}\n\n/** @public */\nexport function useTheme2(): GrafanaTheme2 {\n  return useContext(ThemeContextMock || ThemeContext);\n}\n\n/**\n * Hook for using memoized styles with access to the theme.\n *\n * NOTE: For memoization to work, you need to ensure that the function\n * you pass in doesn't change, or only if it needs to. (i.e. declare\n * your style creator outside of a function component or use `useCallback()`.)\n * */\n/** @deprecated use useStyles2 */\n/** @public */\nexport function useStyles<T>(getStyles: (theme: GrafanaTheme) => T) {\n  const theme = useTheme();\n\n  let memoizedStyleCreator: typeof getStyles = memoizedStyleCreators.get(getStyles);\n\n  if (!memoizedStyleCreator) {\n    memoizedStyleCreator = stylesFactory(getStyles);\n    memoizedStyleCreators.set(getStyles, memoizedStyleCreator);\n  }\n\n  return memoizedStyleCreator(theme);\n}\n\n/**\n * Hook for using memoized styles with access to the theme. Pass additional\n * arguments to the getStyles function as additional arguments to this hook.\n *\n * Prefer using primitive values (boolean, number, string, etc) for\n * additional arguments for better performance\n *\n * ```\n * const getStyles = (theme, isDisabled, isOdd) => {css(...)}\n * [...]\n * const styles = useStyles2(getStyles, true, Boolean(index % 2))\n * ```\n *\n * NOTE: For memoization to work, ensure that all arguments don't change\n * across renders (or only change if they need to)\n *\n * @public\n * */\nexport function useStyles2<T extends unknown[], CSSReturnValue>(\n  getStyles: (theme: GrafanaTheme2, ...args: T) => CSSReturnValue,\n  ...additionalArguments: T\n): CSSReturnValue {\n  const theme = useTheme2();\n\n  // Grafana ui can be bundled and used in older versions of Grafana where the theme doesn't have elevated background\n  // This can be removed post G12\n  if (!theme.colors.background.elevated) {\n    theme.colors.background.elevated =\n      theme.colors.mode === 'light' ? theme.colors.background.primary : theme.colors.background.secondary;\n  }\n\n  let memoizedStyleCreator: typeof getStyles = memoizedStyleCreators.get(getStyles);\n\n  if (!memoizedStyleCreator) {\n    memoizedStyleCreator = memoize(getStyles, { maxSize: 10 }); // each getStyles function will memoize 10 different sets of props\n    memoizedStyleCreators.set(getStyles, memoizedStyleCreator);\n  }\n\n  return memoizedStyleCreator(theme, ...additionalArguments);\n}\n\n/**\n * Enables theme context mocking\n */\n/** @public */\nexport const mockThemeContext = (theme: Partial<GrafanaTheme2>) => {\n  ThemeContextMock = React.createContext(theme as GrafanaTheme2);\n\n  return () => {\n    ThemeContextMock = null;\n  };\n};\n","import { css } from '@emotion/css';\nimport * as React from 'react';\nimport { useToggle } from 'react-use';\n\nimport { getValueFormat, GrafanaTheme2 } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { Collapse, Icon, Tooltip, useStyles2, Stack } from '@grafana/ui';\n\nimport { QueryStats } from '../loki/types';\n\nexport interface Props {\n  title: string;\n  collapsedInfo: string[];\n  queryStats?: QueryStats | null;\n  children: React.ReactNode;\n  onToggle?: (isOpen: boolean) => void;\n  isOpen?: boolean;\n}\n\nexport function QueryOptionGroup({ title, children, collapsedInfo, queryStats, onToggle, isOpen: propsIsOpen }: Props) {\n  const [isOpen, toggleOpen] = useToggle(false);\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.wrapper}>\n      <Collapse\n        className={styles.collapse}\n        collapsible\n        isOpen={propsIsOpen ?? isOpen}\n        onToggle={onToggle ?? toggleOpen}\n        label={\n          <Stack gap={0}>\n            <h6 className={styles.title}>{title}</h6>\n            {!isOpen && (\n              <div className={styles.description}>\n                {collapsedInfo.map((x, i) => (\n                  <span key={i}>{x}</span>\n                ))}\n              </div>\n            )}\n          </Stack>\n        }\n      >\n        <div className={styles.body}>{children}</div>\n      </Collapse>\n\n      {queryStats && config.featureToggles.lokiQuerySplitting && (\n        <Tooltip content=\"Note: the query will be split into multiple parts and executed in sequence. Query limits will only apply each individual part.\">\n          <Icon tabIndex={0} name=\"info-circle\" className={styles.tooltip} size=\"sm\" />\n        </Tooltip>\n      )}\n\n      {queryStats && <p className={styles.stats}>{generateQueryStats(queryStats)}</p>}\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    collapse: css({\n      backgroundColor: 'unset',\n      border: 'unset',\n      marginBottom: 0,\n\n      ['> button']: {\n        padding: theme.spacing(0, 1),\n      },\n    }),\n    wrapper: css({\n      width: '100%',\n      display: 'flex',\n      justifyContent: 'space-between',\n      alignItems: 'baseline',\n    }),\n    title: css({\n      flexGrow: 1,\n      overflow: 'hidden',\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.fontWeightMedium,\n      margin: 0,\n    }),\n    description: css({\n      color: theme.colors.text.secondary,\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.bodySmall.fontWeight,\n      paddingLeft: theme.spacing(2),\n      gap: theme.spacing(2),\n      display: 'flex',\n    }),\n    body: css({\n      display: 'flex',\n      gap: theme.spacing(2),\n      flexWrap: 'wrap',\n    }),\n    stats: css({\n      margin: '0px',\n      color: theme.colors.text.secondary,\n      fontSize: theme.typography.bodySmall.fontSize,\n    }),\n    tooltip: css({\n      marginRight: theme.spacing(0.25),\n    }),\n  };\n};\n\nconst generateQueryStats = (queryStats: QueryStats) => {\n  if (queryStats.message) {\n    return queryStats.message;\n  }\n\n  return `This query will process approximately ${convertUnits(queryStats)}.`;\n};\n\nconst convertUnits = (queryStats: QueryStats): string => {\n  const { text, suffix } = getValueFormat('bytes')(queryStats.bytes, 1);\n  return text + suffix;\n};\n","import { css } from '@emotion/css';\nimport * as React from 'react';\nimport { useToggle } from 'react-use';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { EditorField, EditorRow } from '@grafana/plugin-ui';\nimport { AutoSizeInput, RadioButtonGroup, useStyles2 } from '@grafana/ui';\n\nimport { QueryOptionGroup } from '../_importedDependencies/datasources/prometheus/QueryOptionGroup';\nimport { SearchTableType, MetricsQueryType } from '../dataquery.gen';\nimport { DEFAULT_LIMIT, DEFAULT_SPSS } from '../datasource';\nimport { TempoQuery } from '../types';\n\ninterface Props {\n  onChange: (value: TempoQuery) => void;\n  query: Partial<TempoQuery> & TempoQuery;\n  searchStreaming: boolean;\n  metricsStreaming: boolean;\n}\n\n/**\n * Parse a string value to integer. If the conversion fails, for example because we are prosessing an empty value for\n * a field, return a fallback (default) value.\n *\n * @param val the value to be parsed to an integer\n * @param fallback the fallback value\n * @returns the converted value or the fallback value if the conversion fails\n */\nconst parseIntWithFallback = (val: string, fallback: number) => {\n  const parsed = parseInt(val, 10);\n  return isNaN(parsed) ? fallback : parsed;\n};\n\nexport const TempoQueryBuilderOptions = React.memo<Props>(({ onChange, query, searchStreaming, metricsStreaming }) => {\n  const styles = useStyles2(getStyles);\n  const [isOpen, toggleOpen] = useToggle(false);\n\n  if (!query.hasOwnProperty('limit')) {\n    query.limit = DEFAULT_LIMIT;\n  }\n\n  if (!query.hasOwnProperty('tableType')) {\n    query.tableType = SearchTableType.Traces;\n  }\n\n  if (!query.hasOwnProperty('metricsQueryType')) {\n    query.metricsQueryType = MetricsQueryType.Range;\n  }\n\n  const onLimitChange = (e: React.FormEvent<HTMLInputElement>) => {\n    onChange({ ...query, limit: parseIntWithFallback(e.currentTarget.value, DEFAULT_LIMIT) });\n  };\n  const onSpssChange = (e: React.FormEvent<HTMLInputElement>) => {\n    onChange({ ...query, spss: parseIntWithFallback(e.currentTarget.value, DEFAULT_SPSS) });\n  };\n  const onTableTypeChange = (val: SearchTableType) => {\n    onChange({ ...query, tableType: val });\n  };\n  const onMetricsQueryTypeChange = (val: MetricsQueryType) => {\n    onChange({ ...query, metricsQueryType: val });\n  };\n  const onStepChange = (e: React.FormEvent<HTMLInputElement>) => {\n    onChange({ ...query, step: e.currentTarget.value });\n  };\n\n  // There's a bug in Tempo which causes the exemplars param to be ignored. It's commented out for now.\n\n  // const onExemplarsChange = (e: React.FormEvent<HTMLInputElement>) => {\n  //   const exemplars = parseInt(e.currentTarget.value, 10);\n  //   if (!isNaN(exemplars) && exemplars >= 0) {\n  //     onChange({ ...query, exemplars });\n  //   } else {\n  //     onChange({ ...query, exemplars: undefined });\n  //   }\n  // };\n\n  const collapsedSearchOptions = [\n    `Limit: ${query.limit || DEFAULT_LIMIT}`,\n    `Spans Limit: ${query.spss || DEFAULT_SPSS}`,\n    `Table Format: ${query.tableType === SearchTableType.Traces ? 'Traces' : 'Spans'}`,\n    '|',\n    `Streaming: ${searchStreaming ? 'Enabled' : 'Disabled'}`,\n  ];\n\n  const collapsedMetricsOptions = [\n    `Step: ${query.step || 'auto'}`,\n    `Type: ${query.metricsQueryType === MetricsQueryType.Range ? 'Range' : 'Instant'}`,\n    '|',\n    `Streaming: ${metricsStreaming ? 'Enabled' : 'Disabled'}`,\n    // `Exemplars: ${query.exemplars !== undefined ? query.exemplars : 'auto'}`,\n  ];\n\n  return (\n    <EditorRow>\n      <div className={styles.options}>\n        <QueryOptionGroup\n          title=\"Search Options\"\n          collapsedInfo={collapsedSearchOptions}\n          isOpen={isOpen}\n          onToggle={toggleOpen}\n        >\n          <EditorField label=\"Limit\" tooltip=\"Maximum number of traces to return.\">\n            <AutoSizeInput\n              className=\"width-4\"\n              placeholder=\"auto\"\n              type=\"number\"\n              min={1}\n              defaultValue={query.limit || DEFAULT_LIMIT}\n              onCommitChange={onLimitChange}\n              value={query.limit}\n            />\n          </EditorField>\n          <EditorField label=\"Span Limit\" tooltip=\"Maximum number of spans to return for each span set.\">\n            <AutoSizeInput\n              className=\"width-4\"\n              placeholder=\"auto\"\n              type=\"number\"\n              min={1}\n              defaultValue={query.spss || DEFAULT_SPSS}\n              onCommitChange={onSpssChange}\n              value={query.spss}\n            />\n          </EditorField>\n          <EditorField label=\"Table Format\" tooltip=\"How the query data should be displayed in the results table\">\n            <RadioButtonGroup\n              options={[\n                { label: 'Traces', value: SearchTableType.Traces },\n                { label: 'Spans', value: SearchTableType.Spans },\n              ]}\n              value={query.tableType}\n              onChange={onTableTypeChange}\n            />\n          </EditorField>\n          <EditorField label=\"Streaming\" tooltip={<StreamingTooltip />} tooltipInteractive>\n            <div>{searchStreaming ? 'Enabled' : 'Disabled'}</div>\n          </EditorField>\n        </QueryOptionGroup>\n\n        <QueryOptionGroup\n          title=\"Metrics Options\"\n          collapsedInfo={collapsedMetricsOptions}\n          isOpen={isOpen}\n          onToggle={toggleOpen}\n        >\n          <EditorField\n            label=\"Step\"\n            tooltip=\"Defines the step for metric queries. Use duration notation, for example 30s or 1m\"\n          >\n            <AutoSizeInput\n              className=\"width-4\"\n              placeholder=\"auto\"\n              type=\"string\"\n              defaultValue={query.step}\n              onCommitChange={onStepChange}\n              value={query.step}\n            />\n          </EditorField>\n          <EditorField label=\"Type\" tooltip=\"Type of metrics query to run\">\n            <RadioButtonGroup\n              options={[\n                { label: 'Range', value: MetricsQueryType.Range },\n                { label: 'Instant', value: MetricsQueryType.Instant },\n              ]}\n              value={query.metricsQueryType}\n              onChange={onMetricsQueryTypeChange}\n            />\n          </EditorField>\n\n          <EditorField label=\"Streaming\" tooltip={<StreamingTooltip />} tooltipInteractive>\n            <div>{metricsStreaming ? 'Enabled' : 'Disabled'}</div>\n          </EditorField>\n          {/*<EditorField*/}\n          {/*  label=\"Exemplars\"*/}\n          {/*  tooltip=\"Defines the amount of exemplars to request for metric queries. A value of 0 means no exemplars.\"*/}\n          {/*>*/}\n          {/*  <AutoSizeInput*/}\n          {/*    className=\"width-4\"*/}\n          {/*    placeholder=\"auto\"*/}\n          {/*    type=\"string\"*/}\n          {/*    defaultValue={query.exemplars}*/}\n          {/*    onCommitChange={onExemplarsChange}*/}\n          {/*    value={query.exemplars}*/}\n          {/*  />*/}\n          {/*</EditorField>*/}\n        </QueryOptionGroup>\n      </div>\n    </EditorRow>\n  );\n});\n\nconst StreamingTooltip = () => {\n  return (\n    <div style={{ display: 'flex', gap: '4px' }}>\n      <span>\n        Indicates if streaming is currently enabled. Streaming allows you to view partial query results before the\n        entire query completes.\n      </span>\n      <a\n        href={'https://grafana.com/docs/tempo/latest/traceql/#stream-query-results'}\n        aria-label={'Learn more about streaming query results'}\n        target={'_blank'}\n        rel=\"noreferrer\"\n        style={{ textDecoration: 'underline' }}\n      >\n        Learn more\n      </a>\n    </div>\n  );\n};\n\nTempoQueryBuilderOptions.displayName = 'TempoQueryBuilderOptions';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    options: css({\n      display: 'flex',\n      width: '-webkit-fill-available',\n      gap: theme.spacing(1),\n\n      '> div': {\n        width: 'auto',\n      },\n    }),\n  };\n};\n","import { css } from '@emotion/css';\n\nimport { Select, HorizontalGroup, Input, useStyles2 } from '@grafana/ui';\n\nimport { TraceqlFilter } from '../dataquery.gen';\n\nimport { operatorSelectableValue } from './utils';\n\ninterface Props {\n  filter: TraceqlFilter;\n  updateFilter: (f: TraceqlFilter) => void;\n  isTagsLoading?: boolean;\n  operators: string[];\n}\n\n// Support template variables (e.g., `$dur`, `$v_1`) and durations (e.g., `300µs`, `1.2ms`)\nconst validationRegex = /^(\\$\\w+)|(\\d+(?:\\.\\d)?\\d*(?:us|µs|ns|ms|s|m|h))$/;\n\nconst getStyles = () => ({\n  noBoxShadow: css({\n    boxShadow: 'none',\n    '*:focus': {\n      boxShadow: 'none',\n    },\n  }),\n});\n\nconst DurationInput = ({ filter, operators, updateFilter }: Props) => {\n  const styles = useStyles2(getStyles);\n\n  let invalid = false;\n  if (typeof filter.value === 'string') {\n    invalid = filter.value ? !validationRegex.test(filter.value.concat('')) : false;\n  }\n\n  return (\n    <HorizontalGroup spacing={'none'}>\n      <Select\n        className={styles.noBoxShadow}\n        inputId={`${filter.id}-operator`}\n        options={operators.map(operatorSelectableValue)}\n        value={filter.operator}\n        onChange={(v) => {\n          updateFilter({ ...filter, operator: v?.value });\n        }}\n        isClearable={false}\n        aria-label={`select ${filter.id} operator`}\n        allowCustomValue={true}\n        width={8}\n      />\n      <Input\n        className={styles.noBoxShadow}\n        value={filter.value}\n        onChange={(v) => {\n          updateFilter({ ...filter, value: v.currentTarget.value });\n        }}\n        placeholder=\"e.g. 100ms, 1.2s\"\n        aria-label={`select ${filter.id} value`}\n        invalid={invalid}\n        width={18}\n      />\n    </HorizontalGroup>\n  );\n};\n\nexport default DurationInput;\n","import * as React from 'react';\n\nimport { InlineFieldRow, InlineField } from '@grafana/ui';\n\ninterface Props {\n  label: string;\n  tooltip?: string;\n  children: React.ReactElement;\n}\nconst SearchField = ({ label, tooltip, children }: Props) => {\n  return (\n    <InlineFieldRow>\n      <InlineField label={label} labelWidth={28} grow tooltip={tooltip}>\n        {children}\n      </InlineField>\n    </InlineFieldRow>\n  );\n};\n\nexport default SearchField;\n","import { css } from '@emotion/css';\nimport { useEffect, useMemo, useState } from 'react';\nimport { v4 as uuidv4 } from 'uuid';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { AccessoryButton } from '@grafana/plugin-ui';\nimport { Alert, HorizontalGroup, InputActionMeta, Select, useStyles2 } from '@grafana/ui';\n\nimport { TraceqlFilter, TraceqlSearchScope } from '../dataquery.gen';\nimport { TempoDatasource } from '../datasource';\nimport { OPTIONS_LIMIT } from '../language_provider';\nimport { TempoQuery } from '../types';\n\nimport InlineSearchField from './InlineSearchField';\nimport { withTemplateVariableOptions } from './SearchField';\nimport { replaceAt } from './utils';\n\ninterface Props {\n  datasource: TempoDatasource;\n  onChange: (value: TempoQuery) => void;\n  query: Partial<TempoQuery> & TempoQuery;\n  isTagsLoading: boolean;\n  addVariablesToOptions?: boolean;\n}\n\nexport const GroupByField = (props: Props) => {\n  const { datasource, onChange, query, isTagsLoading, addVariablesToOptions } = props;\n  const styles = useStyles2(getStyles);\n  const generateId = () => uuidv4().slice(0, 8);\n  const [tagQuery, setTagQuery] = useState<string>('');\n\n  useEffect(() => {\n    if (!query.groupBy || query.groupBy.length === 0) {\n      onChange({\n        ...query,\n        groupBy: [\n          {\n            id: generateId(),\n            scope: TraceqlSearchScope.Span,\n          },\n        ],\n      });\n    }\n  }, [onChange, query]);\n\n  const tagOptions = useMemo(\n    () => (f: TraceqlFilter) => {\n      const tags = datasource!.languageProvider.getMetricsSummaryTags(f.scope);\n      if (tagQuery.length === 0) {\n        return tags.slice(0, OPTIONS_LIMIT);\n      }\n\n      const queryLowerCase = tagQuery.toLowerCase();\n      return tags.filter((tag) => tag.toLowerCase().includes(queryLowerCase)).slice(0, OPTIONS_LIMIT);\n    },\n    [datasource, tagQuery]\n  );\n\n  const addFilter = () => {\n    updateFilter({\n      id: generateId(),\n      scope: TraceqlSearchScope.Span,\n    });\n  };\n\n  const removeFilter = (filter: TraceqlFilter) => {\n    onChange({ ...query, groupBy: query.groupBy?.filter((f) => f.id !== filter.id) });\n  };\n\n  const updateFilter = (filter: TraceqlFilter) => {\n    const copy = { ...query };\n    copy.groupBy ||= [];\n    const indexOfFilter = copy.groupBy.findIndex((f) => f.id === filter.id);\n    if (indexOfFilter >= 0) {\n      copy.groupBy = replaceAt(copy.groupBy, indexOfFilter, filter);\n    } else {\n      copy.groupBy.push(filter);\n    }\n    onChange(copy);\n  };\n\n  const scopeOptions = Object.values(TraceqlSearchScope)\n    .filter((s) => {\n      // only add scope if it has tags\n      return datasource.languageProvider.getTags(s).length > 0;\n    })\n    .map((t) => ({ label: t, value: t }));\n\n  return (\n    <InlineSearchField\n      label=\"Aggregate by\"\n      tooltip={`Note: We recommend using Explore Traces instead. Select one or more tags to see the metrics summary.`}\n    >\n      <>\n        {query.groupBy?.map((f, i) => {\n          const tags = tagOptions(f)\n            ?.concat(f.tag !== undefined && f.tag !== '' && !tagOptions(f)?.includes(f.tag) ? [f.tag] : [])\n            .map((t) => ({\n              label: t,\n              value: t,\n            }));\n          return (\n            <div key={f.id}>\n              <HorizontalGroup spacing={'none'} width={'auto'}>\n                <Select\n                  aria-label={`Select scope for filter ${i + 1}`}\n                  onChange={(v) => {\n                    updateFilter({ ...f, scope: v?.value, tag: '' });\n                  }}\n                  options={scopeOptions}\n                  placeholder=\"Select scope\"\n                  value={f.scope}\n                />\n                <Select\n                  aria-label={`Select tag for filter ${i + 1}`}\n                  isClearable\n                  allowCustomValue\n                  isLoading={isTagsLoading}\n                  key={f.tag}\n                  onChange={(v) => {\n                    updateFilter({ ...f, tag: v?.value });\n                  }}\n                  options={addVariablesToOptions ? withTemplateVariableOptions(tags) : tags}\n                  onInputChange={(value: string, { action }: InputActionMeta) => {\n                    if (action === 'input-change') {\n                      setTagQuery(value);\n                    }\n                  }}\n                  onCloseMenu={() => setTagQuery('')}\n                  placeholder=\"Select tag\"\n                  value={f.tag || ''}\n                />\n                {(f.tag || (query.groupBy?.length ?? 0) > 1) && (\n                  <AccessoryButton\n                    aria-label={`Remove tag for filter ${i + 1}`}\n                    icon=\"times\"\n                    onClick={() => removeFilter(f)}\n                    tooltip=\"Remove tag\"\n                    title={`Remove tag for filter ${i + 1}`}\n                    variant=\"secondary\"\n                  />\n                )}\n                {f.tag && i === (query.groupBy?.length ?? 0) - 1 && (\n                  <span className={styles.addTag}>\n                    <AccessoryButton\n                      aria-label=\"Add tag\"\n                      icon=\"plus\"\n                      onClick={() => addFilter()}\n                      tooltip=\"Add tag\"\n                      variant=\"secondary\"\n                    />\n                  </span>\n                )}\n              </HorizontalGroup>\n            </div>\n          );\n        })}\n        {query.groupBy && query.groupBy.length > 0 && query.groupBy[0].tag && (\n          <Alert title=\"\" severity=\"warning\" className={styles.notice}>\n            The aggregate by feature is deprecated. We recommend using Explore Traces instead. If you want to write your\n            own TraceQL queries to replicate this API, please check\n            <a\n              href={\n                'https://grafana.com/docs/tempo/latest/api_docs/metrics-summary/#deprecation-in-favor-of-traceql-metrics'\n              }\n              className={styles.noticeLink}\n              target=\"_blank\"\n              rel=\"noreferrer noopener\"\n            >\n              this page\n            </a>\n            .\n          </Alert>\n        )}\n      </>\n    </InlineSearchField>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  addTag: css({\n    marginLeft: theme.spacing(1),\n  }),\n  notice: css({\n    width: '500px',\n    marginTop: theme.spacing(0.75),\n  }),\n  noticeLink: css({\n    color: theme.colors.text.link,\n    textDecoration: 'underline',\n    marginLeft: '5px',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { useCallback, useEffect, useState } from 'react';\n\nimport { CoreApp, GrafanaTheme2 } from '@grafana/data';\nimport { TemporaryAlert } from '@grafana/o11y-ds-frontend';\nimport { config, FetchError, getTemplateSrv, reportInteraction } from '@grafana/runtime';\nimport { Alert, Button, HorizontalGroup, Select, useStyles2 } from '@grafana/ui';\n\nimport { RawQuery } from '../_importedDependencies/datasources/prometheus/RawQuery';\nimport { TraceqlFilter, TraceqlSearchScope } from '../dataquery.gen';\nimport { TempoDatasource } from '../datasource';\nimport { TempoQueryBuilderOptions } from '../traceql/TempoQueryBuilderOptions';\nimport { traceqlGrammar } from '../traceql/traceql';\nimport { TempoQuery } from '../types';\n\nimport DurationInput from './DurationInput';\nimport { GroupByField } from './GroupByField';\nimport InlineSearchField from './InlineSearchField';\nimport SearchField from './SearchField';\nimport TagsInput from './TagsInput';\nimport { filterScopedTag, filterTitle, interpolateFilters, replaceAt } from './utils';\n\ninterface Props {\n  datasource: TempoDatasource;\n  query: TempoQuery;\n  onChange: (value: TempoQuery) => void;\n  onBlur?: () => void;\n  onClearResults: () => void;\n  app?: CoreApp;\n  addVariablesToOptions?: boolean;\n}\n\nconst hardCodedFilterIds = ['min-duration', 'max-duration', 'status'];\n\nconst TraceQLSearch = ({ datasource, query, onChange, onClearResults, app, addVariablesToOptions = true }: Props) => {\n  const styles = useStyles2(getStyles);\n  const [alertText, setAlertText] = useState<string>();\n  const [error, setError] = useState<Error | FetchError | null>(null);\n\n  const [isTagsLoading, setIsTagsLoading] = useState(true);\n  const [traceQlQuery, setTraceQlQuery] = useState<string>('');\n\n  const templateSrv = getTemplateSrv();\n\n  const updateFilter = useCallback(\n    (s: TraceqlFilter) => {\n      const copy = { ...query };\n      copy.filters ||= [];\n      const indexOfFilter = copy.filters.findIndex((f) => f.id === s.id);\n      if (indexOfFilter >= 0) {\n        // update in place if the filter already exists, for consistency and to avoid UI bugs\n        copy.filters = replaceAt(copy.filters, indexOfFilter, s);\n      } else {\n        copy.filters.push(s);\n      }\n      onChange(copy);\n    },\n    [onChange, query]\n  );\n\n  const deleteFilter = (s: TraceqlFilter) => {\n    onChange({ ...query, filters: query.filters.filter((f) => f.id !== s.id) });\n  };\n\n  const templateVariables = getTemplateSrv().getVariables();\n  useEffect(() => {\n    setTraceQlQuery(datasource.languageProvider.generateQueryFromFilters(interpolateFilters(query.filters || [])));\n  }, [datasource.languageProvider, query, templateVariables]);\n\n  const findFilter = useCallback((id: string) => query.filters?.find((f) => f.id === id), [query.filters]);\n\n  useEffect(() => {\n    const fetchTags = async () => {\n      try {\n        await datasource.languageProvider.start();\n        setIsTagsLoading(false);\n        setAlertText(undefined);\n      } catch (error) {\n        if (error instanceof Error) {\n          setAlertText(`Error: ${error.message}`);\n        }\n      }\n    };\n    fetchTags();\n  }, [datasource, setAlertText]);\n\n  useEffect(() => {\n    // Initialize state with configured static filters that already have a value from the config\n    datasource.search?.filters\n      ?.filter((f) => f.value)\n      .forEach((f) => {\n        if (!findFilter(f.id)) {\n          updateFilter(f);\n        }\n      });\n  }, [datasource.search?.filters, findFilter, updateFilter]);\n\n  // filter out tags that already exist in the static fields\n  const staticTags = datasource.search?.filters?.map((f) => f.tag) || [];\n  staticTags.push('duration');\n  staticTags.push('traceDuration');\n  staticTags.push('span:duration');\n  staticTags.push('trace:duration');\n  staticTags.push('status');\n  staticTags.push('span:status');\n\n  // Dynamic filters are all filters that don't match the ID of a filter in the datasource configuration\n  // The duration and status fields are a special case since its selector is hard-coded\n  const dynamicFilters = (query.filters || []).filter(\n    (f) =>\n      !hardCodedFilterIds.includes(f.id) &&\n      (datasource.search?.filters?.findIndex((sf) => sf.id === f.id) || 0) === -1 &&\n      f.id !== 'duration-type'\n  );\n\n  // We use this function to generate queries without a specfic filter.\n  // This is useful because we're sending the query to Tempo so it can return the attributes and values filtered down.\n  // However, if we send the full query then we won't see more values for the filter we're trying to edit.\n  // For example, if we already have a service.name value selected and try to add another one, we won't see the other\n  // values if we send the full query since Tempo will only return the service.name that's already selected.\n  const generateQueryWithoutFilter = (filter?: TraceqlFilter) => {\n    if (!filter) {\n      return traceQlQuery;\n    }\n    const filtersAfterRemoval = query.filters?.filter((f) => f.id !== filter.id) || [];\n    return datasource.languageProvider.generateQueryFromFilters(interpolateFilters(filtersAfterRemoval || []));\n  };\n\n  return (\n    <>\n      <div className={styles.container}>\n        <div>\n          {datasource.search?.filters?.map(\n            (f) =>\n              f.tag && (\n                <InlineSearchField\n                  key={f.id}\n                  label={filterTitle(f, datasource.languageProvider)}\n                  tooltip={`Filter your search by ${filterScopedTag(\n                    f,\n                    datasource.languageProvider\n                  )}. To modify the default filters shown for search visit the Tempo datasource configuration page.`}\n                >\n                  <SearchField\n                    filter={findFilter(f.id) || f}\n                    datasource={datasource}\n                    setError={setError}\n                    updateFilter={updateFilter}\n                    tags={[]}\n                    hideScope={true}\n                    hideTag={true}\n                    query={generateQueryWithoutFilter(findFilter(f.id))}\n                    addVariablesToOptions={addVariablesToOptions}\n                  />\n                </InlineSearchField>\n              )\n          )}\n          <InlineSearchField label={'Status'}>\n            <SearchField\n              filter={\n                findFilter('status') || {\n                  id: 'status',\n                  tag: 'status',\n                  scope: TraceqlSearchScope.Intrinsic,\n                  operator: '=',\n                }\n              }\n              datasource={datasource}\n              setError={setError}\n              updateFilter={updateFilter}\n              tags={[]}\n              hideScope={true}\n              hideTag={true}\n              query={generateQueryWithoutFilter(findFilter('status'))}\n              isMulti={false}\n              allowCustomValue={false}\n              addVariablesToOptions={addVariablesToOptions}\n            />\n          </InlineSearchField>\n          <InlineSearchField\n            label={'Duration'}\n            tooltip=\"The trace or span duration, i.e. end - start time of the trace/span. Accepted units are ns, ms, s, m, h\"\n          >\n            <HorizontalGroup spacing={'none'}>\n              <Select\n                options={[\n                  { label: 'span', value: 'span' },\n                  { label: 'trace', value: 'trace' },\n                ]}\n                value={findFilter('duration-type')?.value ?? 'span'}\n                onChange={(v) => {\n                  const filter = findFilter('duration-type') || {\n                    id: 'duration-type',\n                    value: 'span',\n                  };\n                  updateFilter({ ...filter, value: v?.value });\n                }}\n                aria-label={'duration type'}\n              />\n              <DurationInput\n                filter={\n                  findFilter('min-duration') || {\n                    id: 'min-duration',\n                    tag: 'duration',\n                    operator: '>',\n                    valueType: 'duration',\n                  }\n                }\n                operators={['>', '>=']}\n                updateFilter={updateFilter}\n              />\n              <DurationInput\n                filter={\n                  findFilter('max-duration') || {\n                    id: 'max-duration',\n                    tag: 'duration',\n                    operator: '<',\n                    valueType: 'duration',\n                  }\n                }\n                operators={['<', '<=']}\n                updateFilter={updateFilter}\n              />\n            </HorizontalGroup>\n          </InlineSearchField>\n          <InlineSearchField label={'Tags'}>\n            <TagsInput\n              filters={dynamicFilters}\n              datasource={datasource}\n              setError={setError}\n              updateFilter={updateFilter}\n              deleteFilter={deleteFilter}\n              staticTags={staticTags}\n              isTagsLoading={isTagsLoading}\n              generateQueryWithoutFilter={generateQueryWithoutFilter}\n              requireTagAndValue={true}\n              addVariablesToOptions={addVariablesToOptions}\n            />\n          </InlineSearchField>\n          {config.featureToggles.metricsSummary && (\n            <GroupByField\n              datasource={datasource}\n              onChange={onChange}\n              query={query}\n              isTagsLoading={isTagsLoading}\n              addVariablesToOptions={addVariablesToOptions}\n            />\n          )}\n        </div>\n        <div className={styles.rawQueryContainer}>\n          <RawQuery query={templateSrv.replace(traceQlQuery)} lang={{ grammar: traceqlGrammar, name: 'traceql' }} />\n          <Button\n            variant=\"secondary\"\n            size=\"sm\"\n            onClick={() => {\n              reportInteraction('grafana_traces_copy_to_traceql_clicked', {\n                app: app ?? '',\n                grafana_version: config.buildInfo.version,\n                location: 'search_tab',\n              });\n\n              onClearResults();\n              const traceQlQuery = datasource.languageProvider.generateQueryFromFilters(query.filters || []);\n              onChange({\n                ...query,\n                query: traceQlQuery,\n                queryType: 'traceql',\n              });\n            }}\n          >\n            Edit in TraceQL\n          </Button>\n        </div>\n        <TempoQueryBuilderOptions\n          onChange={onChange}\n          query={query}\n          searchStreaming={datasource.isStreamingSearchEnabled() ?? false}\n          metricsStreaming={datasource.isStreamingMetricsEnabled() ?? false}\n        />\n      </div>\n      {error ? (\n        <Alert title=\"Unable to connect to Tempo search\" severity=\"info\" className={styles.alert}>\n          Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can\n          configure it in the <a href={`/datasources/edit/${datasource.uid}`}>datasource settings</a>.\n        </Alert>\n      ) : null}\n      {alertText && <TemporaryAlert severity={'error'} text={alertText} />}\n    </>\n  );\n};\n\nexport default TraceQLSearch;\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  alert: css({\n    maxWidth: '75ch',\n    marginTop: theme.spacing(2),\n  }),\n  container: css({\n    display: 'flex',\n    gap: '4px',\n    flexWrap: 'wrap',\n    flexDirection: 'column',\n  }),\n  rawQueryContainer: css({\n    alignItems: 'center',\n    backgroundColor: theme.colors.background.secondary,\n    display: 'flex',\n    justifyContent: 'space-between',\n    padding: theme.spacing(1),\n  }),\n});\n","import { ReactElement } from 'react';\n\nimport { AdHocVariableFilter, DataSourceRef, SelectableValue } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Icon, SegmentAsync } from '@grafana/ui';\n\ninterface Props {\n  datasource: DataSourceRef;\n  filterKey: string | null;\n  onChange: (item: SelectableValue<string | null>) => void;\n  allFilters: AdHocVariableFilter[];\n  disabled?: boolean;\n}\n\nconst MIN_WIDTH = 90;\nexport const AdHocFilterKey = ({ datasource, onChange, disabled, filterKey, allFilters }: Props) => {\n  const loadKeys = () => fetchFilterKeys(datasource, filterKey, allFilters);\n  const loadKeysWithRemove = () => fetchFilterKeysWithRemove(datasource, filterKey, allFilters);\n\n  if (filterKey === null) {\n    return (\n      <div className=\"gf-form\" data-testid=\"AdHocFilterKey-add-key-wrapper\">\n        <SegmentAsync\n          disabled={disabled}\n          className=\"query-segment-key\"\n          Component={plusSegment}\n          value={filterKey}\n          onChange={onChange}\n          loadOptions={loadKeys}\n          inputMinWidth={MIN_WIDTH}\n        />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"gf-form\" data-testid=\"AdHocFilterKey-key-wrapper\">\n      <SegmentAsync\n        disabled={disabled}\n        className=\"query-segment-key\"\n        value={filterKey}\n        onChange={onChange}\n        loadOptions={loadKeysWithRemove}\n        inputMinWidth={MIN_WIDTH}\n      />\n    </div>\n  );\n};\n\nexport const REMOVE_FILTER_KEY = '-- remove filter --';\nconst REMOVE_VALUE = { label: REMOVE_FILTER_KEY, value: REMOVE_FILTER_KEY };\n\nconst plusSegment: ReactElement = (\n  <span className=\"gf-form-label query-part\" aria-label=\"Add Filter\">\n    <Icon name=\"plus\" />\n  </span>\n);\n\nconst fetchFilterKeys = async (\n  datasource: DataSourceRef,\n  currentKey: string | null,\n  allFilters: AdHocVariableFilter[]\n): Promise<Array<SelectableValue<string>>> => {\n  const ds = await getDataSourceSrv().get(datasource);\n\n  if (!ds || !ds.getTagKeys) {\n    return [];\n  }\n\n  const otherFilters = allFilters.filter((f) => f.key !== currentKey);\n  const response = await ds.getTagKeys({ filters: otherFilters });\n  const metrics = Array.isArray(response) ? response : response.data;\n  return metrics.map((m) => ({ label: m.text, value: m.text }));\n};\n\nconst fetchFilterKeysWithRemove = async (\n  datasource: DataSourceRef,\n  currentKey: string | null,\n  allFilters: AdHocVariableFilter[]\n): Promise<Array<SelectableValue<string>>> => {\n  const keys = await fetchFilterKeys(datasource, currentKey, allFilters);\n  return [REMOVE_VALUE, ...keys];\n};\n","import { AdHocVariableFilter, DataSourceRef, SelectableValue, getDefaultTimeRange } from '@grafana/data';\n// import { getTimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { SegmentAsync } from '@grafana/ui';\n\ninterface Props {\n  datasource: DataSourceRef;\n  filterKey: string;\n  filterValue?: string;\n  onChange: (item: SelectableValue<string>) => void;\n  placeHolder?: string;\n  disabled?: boolean;\n  allFilters: AdHocVariableFilter[];\n}\n\nexport const AdHocFilterValue = ({\n  datasource,\n  disabled,\n  onChange,\n  filterKey,\n  filterValue,\n  placeHolder,\n  allFilters,\n}: Props) => {\n  const loadValues = () => fetchFilterValues(datasource, filterKey, allFilters);\n\n  return (\n    <div className=\"gf-form\" data-testid=\"AdHocFilterValue-value-wrapper\">\n      <SegmentAsync\n        className=\"query-segment-value\"\n        disabled={disabled}\n        placeholder={placeHolder}\n        value={filterValue}\n        onChange={onChange}\n        loadOptions={loadValues}\n      />\n    </div>\n  );\n};\n\nconst fetchFilterValues = async (\n  datasource: DataSourceRef,\n  key: string,\n  allFilters: AdHocVariableFilter[]\n): Promise<Array<SelectableValue<string>>> => {\n  const ds = await getDataSourceSrv().get(datasource);\n\n  if (!ds || !ds.getTagValues) {\n    return [];\n  }\n\n  // const timeRange = getTimeSrv().timeRange();\n  // As https://github.com/grafana/grafana/pull/76118/files#diff-260d46415915a2e3e7d294e313bd128666e9f0868aa94d8aee4d4a24a060b542L27-R26\n  const timeRange = getDefaultTimeRange();\n\n  // Filter out the current filter key from the list of all filters\n  const otherFilters = allFilters.filter((f) => f.key !== key);\n  const response = await ds.getTagValues({ key, filters: otherFilters, timeRange });\n  const metrics = Array.isArray(response) ? response : response.data;\n  return metrics.map((m) => ({ label: m.text, value: m.text }));\n};\n","import { SelectableValue } from '@grafana/data';\nimport { Segment } from '@grafana/ui';\n\ninterface Props {\n  value: string;\n  onChange: (item: SelectableValue<string>) => void;\n  disabled?: boolean;\n}\n\nconst options = ['=', '!=', '<', '>', '=~', '!~'].map<SelectableValue<string>>((value) => ({\n  label: value,\n  value,\n}));\n\nexport const OperatorSegment = ({ value, disabled, onChange }: Props) => {\n  return (\n    <Segment\n      className=\"query-segment-operator\"\n      value={value}\n      disabled={disabled}\n      options={options}\n      onChange={onChange}\n    />\n  );\n};\n","import { AdHocVariableFilter, DataSourceRef, SelectableValue } from '@grafana/data';\n\nimport { AdHocFilterKey } from './AdHocFilterKey';\nimport { AdHocFilterValue } from './AdHocFilterValue';\nimport { OperatorSegment } from './OperatorSegment';\n\ninterface Props {\n  datasource: DataSourceRef;\n  filter: AdHocVariableFilter;\n  allFilters: AdHocVariableFilter[];\n  onKeyChange: (item: SelectableValue<string | null>) => void;\n  onOperatorChange: (item: SelectableValue<string>) => void;\n  onValueChange: (item: SelectableValue<string>) => void;\n  placeHolder?: string;\n  getTagKeysOptions?: any;\n  disabled?: boolean;\n}\n\nexport const AdHocFilterRenderer = ({\n  datasource,\n  filter: { key, operator, value },\n  onKeyChange,\n  onOperatorChange,\n  onValueChange,\n  placeHolder,\n  allFilters,\n  disabled,\n}: Props) => {\n  return (\n    <>\n      <AdHocFilterKey\n        disabled={disabled}\n        datasource={datasource}\n        filterKey={key}\n        onChange={onKeyChange}\n        allFilters={allFilters}\n      />\n      <div className=\"gf-form\">\n        <OperatorSegment disabled={disabled} value={operator} onChange={onOperatorChange} />\n      </div>\n      <AdHocFilterValue\n        disabled={disabled}\n        datasource={datasource}\n        filterKey={key}\n        filterValue={value}\n        allFilters={allFilters}\n        onChange={onValueChange}\n        placeHolder={placeHolder}\n      />\n    </>\n  );\n};\n","import i18n from 'i18next';\nimport { useCallback, useState } from 'react';\nimport * as React from 'react';\n\nimport { AdHocVariableFilter, DataSourceRef, SelectableValue } from '@grafana/data';\n\nimport { AdHocFilterKey, REMOVE_FILTER_KEY } from './AdHocFilterKey';\nimport { AdHocFilterRenderer } from './AdHocFilterRenderer';\n\ninterface Props {\n  datasource: DataSourceRef;\n  onCompleted: (filter: AdHocVariableFilter) => void;\n  appendBefore?: React.ReactNode;\n  allFilters: AdHocVariableFilter[];\n}\n\n// Reassign t() so i18next-parser doesn't warn on dynamic key, and we can have 'failOnWarnings' enabled\nconst tFunc = i18n.t;\n\n// import { t } from 'app/core/internationalization';\nexport const t = (id: string, defaultMessage: string, values?: Record<string, unknown>) => {\n  return tFunc(id, defaultMessage, values);\n};\n\nexport const AdHocFilterBuilder = ({ datasource, appendBefore, onCompleted, allFilters }: Props) => {\n  const [key, setKey] = useState<string | null>(null);\n  const [operator, setOperator] = useState<string>('=');\n\n  const onKeyChanged = useCallback(\n    (item: SelectableValue<string | null>) => {\n      if (item.value !== REMOVE_FILTER_KEY) {\n        setKey(item.value ?? '');\n        return;\n      }\n      setKey(null);\n    },\n    [setKey]\n  );\n\n  const onOperatorChanged = useCallback(\n    (item: SelectableValue<string>) => setOperator(item.value ?? ''),\n    [setOperator]\n  );\n\n  const onValueChanged = useCallback(\n    (item: SelectableValue<string>) => {\n      onCompleted({\n        value: item.value ?? '',\n        operator: operator,\n        key: key!,\n      });\n      setKey(null);\n      setOperator('=');\n    },\n    [onCompleted, operator, key]\n  );\n\n  if (key === null) {\n    return <AdHocFilterKey datasource={datasource} filterKey={key} onChange={onKeyChanged} allFilters={allFilters} />;\n  }\n\n  return (\n    <React.Fragment key=\"filter-builder\">\n      {appendBefore}\n      <AdHocFilterRenderer\n        datasource={datasource}\n        filter={{ key, value: '', operator }}\n        placeHolder={t('variable.adhoc.placeholder', 'Select value')}\n        onKeyChange={onKeyChanged}\n        onOperatorChange={onOperatorChanged}\n        onValueChange={onValueChanged}\n        allFilters={allFilters}\n      />\n    </React.Fragment>\n  );\n};\n","interface Props {\n  label: string;\n}\n\nexport const ConditionSegment = ({ label }: Props) => {\n  return (\n    <div className=\"gf-form\">\n      <span className=\"gf-form-label query-keyword\">{label}</span>\n    </div>\n  );\n};\n","import { Fragment, PureComponent, ReactNode } from 'react';\n\nimport { AdHocVariableFilter, DataSourceRef, SelectableValue } from '@grafana/data';\nimport { Segment } from '@grafana/ui';\n\nimport { AdHocFilterBuilder } from './AdHocFilterBuilder';\nimport { REMOVE_FILTER_KEY } from './AdHocFilterKey';\nimport { AdHocFilterRenderer } from './AdHocFilterRenderer';\nimport { ConditionSegment } from './ConditionSegment';\n\ninterface Props {\n  datasource: DataSourceRef | null;\n  filters: AdHocVariableFilter[];\n  baseFilters?: AdHocVariableFilter[];\n  addFilter: (filter: AdHocVariableFilter) => void;\n  removeFilter: (index: number) => void;\n  changeFilter: (index: number, newFilter: AdHocVariableFilter) => void;\n  disabled?: boolean;\n}\n\n/**\n * Simple filtering component that automatically uses datasource APIs to get available labels and its values, for\n * dynamic visual filtering without need for much setup. Instead of having single onChange prop this reports all the\n * change events with separate props so it is usable with AdHocPicker.\n *\n * Note: There isn't API on datasource to suggest the operators here so that is hardcoded to use prometheus style\n * operators. Also filters are assumed to be joined with `AND` operator, which is also hardcoded.\n */\nexport class AdHocFilter extends PureComponent<Props> {\n  onChange = (index: number, prop: string) => (key: SelectableValue<string | null>) => {\n    const { filters } = this.props;\n    const { value } = key;\n\n    if (key.value === REMOVE_FILTER_KEY) {\n      return this.props.removeFilter(index);\n    }\n\n    return this.props.changeFilter(index, {\n      ...filters[index],\n      [prop]: value,\n    });\n  };\n\n  appendFilterToVariable = (filter: AdHocVariableFilter) => {\n    this.props.addFilter(filter);\n  };\n\n  render() {\n    const { filters, disabled } = this.props;\n\n    return (\n      <div className=\"gf-form-inline\">\n        {this.renderFilters(filters, disabled)}\n\n        {!disabled && (\n          <AdHocFilterBuilder\n            datasource={this.props.datasource!}\n            appendBefore={filters.length > 0 ? <ConditionSegment label=\"AND\" /> : null}\n            onCompleted={this.appendFilterToVariable}\n            allFilters={this.getAllFilters()}\n          />\n        )}\n      </div>\n    );\n  }\n\n  getAllFilters() {\n    if (this.props.baseFilters) {\n      return this.props.baseFilters.concat(this.props.filters);\n    }\n\n    return this.props.filters;\n  }\n\n  renderFilters(filters: AdHocVariableFilter[], disabled?: boolean) {\n    if (filters.length === 0 && disabled) {\n      return <Segment disabled={disabled} value=\"No filters\" options={[]} onChange={() => {}} />;\n    }\n\n    return filters.reduce((segments: ReactNode[], filter, index) => {\n      if (segments.length > 0) {\n        segments.push(<ConditionSegment label=\"AND\" key={`condition-${index}`} />);\n      }\n      segments.push(this.renderFilterSegments(filter, index, disabled));\n      return segments;\n    }, []);\n  }\n\n  renderFilterSegments(filter: AdHocVariableFilter, index: number, disabled?: boolean) {\n    return (\n      <Fragment key={`filter-${index}`}>\n        <AdHocFilterRenderer\n          disabled={disabled}\n          datasource={this.props.datasource!}\n          filter={filter}\n          onKeyChange={this.onChange(index, 'key')}\n          onOperatorChange={this.onChange(index, 'operator')}\n          onValueChange={this.onChange(index, 'value')}\n          allFilters={this.getAllFilters()}\n        />\n      </Fragment>\n    );\n  }\n}\n","import { css } from '@emotion/css';\nimport { useEffect, useState } from 'react';\nimport useAsync from 'react-use/lib/useAsync';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Alert, InlineField, InlineFieldRow, useStyles2 } from '@grafana/ui';\n\nimport { AdHocFilter } from './_importedDependencies/components/AdHocFilter/AdHocFilter';\nimport { AdHocVariableFilter } from './_importedDependencies/components/AdHocFilter/types';\nimport { PrometheusDatasource } from './_importedDependencies/datasources/prometheus/types';\nimport { TempoQuery } from './types';\nimport { getDS } from './utils';\n\nexport function ServiceGraphSection({\n  graphDatasourceUid,\n  query,\n  onChange,\n}: {\n  graphDatasourceUid?: string;\n  query: TempoQuery;\n  onChange: (value: TempoQuery) => void;\n}) {\n  const styles = useStyles2(getStyles);\n  const dsState = useAsync(() => getDS(graphDatasourceUid), [graphDatasourceUid]);\n\n  // Check if service graph metrics are being collected. If not, displays a warning\n  const [hasKeys, setHasKeys] = useState<boolean | undefined>(undefined);\n  useEffect(() => {\n    async function fn(ds: PrometheusDatasource) {\n      const keys = await ds.getTagKeys({\n        filters: [\n          {\n            key: '__name__',\n            operator: '=~',\n            value:\n              'traces_service_graph_request_server_seconds_sum|traces_service_graph_request_total|traces_service_graph_request_failed_total',\n            condition: '',\n          },\n        ],\n      });\n      setHasKeys(Boolean(keys.length));\n    }\n    if (!dsState.loading && dsState.value) {\n      fn(dsState.value as PrometheusDatasource);\n    }\n  }, [dsState]);\n\n  if (dsState.loading) {\n    return null;\n  }\n\n  const ds = dsState.value;\n\n  if (!graphDatasourceUid) {\n    return getWarning(\n      'No service graph datasource selected',\n      'Please set up a service graph datasource in the datasource settings',\n      styles\n    );\n  }\n\n  if (graphDatasourceUid && !ds) {\n    return getWarning(\n      'No service graph data found',\n      'Service graph datasource is configured but the data source no longer exists. Please configure existing data source to use the service graph functionality',\n      styles\n    );\n  }\n\n  const filters = queryToFilter(\n    (Array.isArray(query.serviceMapQuery) ? query.serviceMapQuery[0] : query.serviceMapQuery) || ''\n  );\n\n  return (\n    <div>\n      <InlineFieldRow>\n        <InlineField label=\"Filter\" labelWidth={14} grow>\n          <AdHocFilter\n            datasource={{ uid: graphDatasourceUid }}\n            filters={filters}\n            baseFilters={[\n              {\n                key: '__name__',\n                operator: '=~',\n                value: 'traces_service_graph_request_total|traces_spanmetrics_calls_total',\n                condition: '',\n              },\n            ]}\n            addFilter={(filter: AdHocVariableFilter) => {\n              onChange({\n                ...query,\n                serviceMapQuery: filtersToQuery([...filters, filter]),\n              });\n            }}\n            removeFilter={(index: number) => {\n              const newFilters = [...filters];\n              newFilters.splice(index, 1);\n              onChange({ ...query, serviceMapQuery: filtersToQuery(newFilters) });\n            }}\n            changeFilter={(index: number, filter: AdHocVariableFilter) => {\n              const newFilters = [...filters];\n              newFilters.splice(index, 1, filter);\n              onChange({ ...query, serviceMapQuery: filtersToQuery(newFilters) });\n            }}\n          />\n        </InlineField>\n      </InlineFieldRow>\n      {hasKeys === false\n        ? getWarning(\n            'No service graph data found',\n            'Please ensure that service graph metrics are set up correctly',\n            styles\n          )\n        : null}\n    </div>\n  );\n}\n\nfunction getWarning(title: string, description: string, styles: { alert: string; link: string }) {\n  return (\n    <Alert title={title} severity=\"info\" className={styles.alert}>\n      {description} according to the{' '}\n      <a\n        target=\"_blank\"\n        rel=\"noreferrer noopener\"\n        href=\"https://grafana.com/docs/grafana/latest/datasources/tempo/service-graph/\"\n        className={styles.link}\n      >\n        Tempo documentation\n      </a>\n      .\n    </Alert>\n  );\n}\n\nfunction queryToFilter(query: string): AdHocVariableFilter[] {\n  let match;\n  let filters: AdHocVariableFilter[] = [];\n  const re = /([\\w_]+)(=|!=|<|>|=~|!~)\"(.*?)\"/g;\n  while ((match = re.exec(query)) !== null) {\n    filters.push({\n      key: match[1],\n      operator: match[2],\n      value: match[3],\n      condition: '',\n    });\n  }\n  return filters;\n}\n\nfunction filtersToQuery(filters: AdHocVariableFilter[]): string {\n  return `{${filters.map((f) => `${f.key}${f.operator}\"${f.value}\"`).join(',')}}`;\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  alert: css({\n    maxWidth: '75ch',\n    marginTop: theme.spacing(2),\n  }),\n  link: css({\n    color: theme.colors.text.link,\n    textDecoration: 'underline',\n  }),\n});\n","import { DataSourceJsonData } from '@grafana/data/src';\nimport { NodeGraphOptions, TraceToLogsOptions } from '@grafana/o11y-ds-frontend';\n\nimport { TempoQuery as TempoBase, TempoQueryType, TraceqlFilter } from './dataquery.gen';\n\nexport interface TempoJsonData extends DataSourceJsonData {\n  tracesToLogs?: TraceToLogsOptions;\n  serviceMap?: {\n    datasourceUid?: string;\n  };\n  search?: {\n    hide?: boolean;\n    filters?: TraceqlFilter[];\n  };\n  nodeGraph?: NodeGraphOptions;\n  spanBar?: {\n    tag: string;\n  };\n  tagLimit?: number;\n  traceQuery?: {\n    timeShiftEnabled?: boolean;\n    spanStartTimeShift?: string;\n    spanEndTimeShift?: string;\n  };\n  streamingEnabled?: {\n    search?: boolean;\n  };\n}\n\nexport interface TempoQuery extends TempoBase {\n  queryType: TempoQueryType;\n}\n\nexport interface MyDataSourceOptions extends DataSourceJsonData {}\n\nexport const defaultQuery: Partial<TempoQuery> = {};\n\nexport type TraceSearchMetadata = {\n  traceID: string;\n  rootServiceName: string;\n  rootTraceName: string;\n  startTimeUnixNano?: string;\n  durationMs?: number;\n  spanSet?: Spanset; // deprecated in Tempo, https://github.com/grafana/tempo/blob/3cc44fca03ba7d676dc77da6a18b8222546ede3c/docs/sources/tempo/api_docs/_index.md?plain=1#L619\n  spanSets?: Spanset[];\n};\n\nexport type SearchMetrics = {\n  inspectedTraces?: number;\n  inspectedBytes?: number;\n  totalBlocks?: number;\n  completedJobs?: number;\n  totalJobs?: number;\n  totalBlockBytes?: number;\n};\n\nexport enum SpanKind {\n  UNSPECIFIED,\n  INTERNAL,\n  SERVER,\n  CLIENT,\n  PRODUCER,\n  CONSUMER,\n}\n\nexport type SpanAttributes = {\n  key: string;\n  value: {\n    stringValue?: string;\n    intValue?: string;\n    boolValue?: boolean;\n    doubleValue?: string;\n    Value?: {\n      string_value?: string;\n      int_value?: string;\n      bool_value?: boolean;\n      double_value?: string;\n    };\n  };\n};\n\nexport type Span = {\n  durationNanos: string;\n  traceId?: string;\n  spanID: string;\n  traceState?: string;\n  parentSpanId?: string;\n  name?: string;\n  kind?: SpanKind;\n  startTimeUnixNano: string;\n  endTimeUnixNano?: string;\n  attributes?: SpanAttributes[];\n  dropped_attributes_count?: number;\n};\n\nexport type Spanset = {\n  attributes?: SpanAttributes[];\n  spans: Span[];\n};\n\nexport type SearchResponse = {\n  traces: TraceSearchMetadata[];\n  metrics: SearchMetrics;\n};\n\nexport type Scope = {\n  name: string;\n  tags: string[];\n};\n","import { SyntaxNode, Tree } from '@lezer/common';\n\nimport {\n  Aggregate,\n  And,\n  AttributeField,\n  ComparisonOp,\n  FieldExpression,\n  FieldOp,\n  GroupOperation,\n  IntrinsicField,\n  Or,\n  parser,\n  Pipe,\n  ScalarFilter,\n  SelectArgs,\n  SelectOperation,\n  SpansetFilter,\n  SpansetPipeline,\n  SpansetPipelineExpression,\n  Static,\n  String as StringNode,\n  TraceQL,\n} from '@grafana/lezer-traceql';\n\ntype Direction = 'parent' | 'firstChild' | 'lastChild' | 'nextSibling' | 'prevSibling';\ntype NodeType = number;\n\nexport type Situation = { query: string } & SituationType;\n\nexport type SituationType =\n  | {\n      type: 'UNKNOWN';\n    }\n  | {\n      type: 'EMPTY';\n    }\n  | {\n      type: 'SPANSET_EMPTY';\n    }\n  | {\n      type: 'SPANSET_ONLY_DOT';\n    }\n  | {\n      type: 'SPANSET_EXPRESSION_OPERATORS';\n    }\n  | {\n      type: 'SPANFIELD_COMBINING_OPERATORS';\n    }\n  | {\n      type: 'SPANSET_IN_NAME';\n    }\n  | {\n      type: 'SPANSET_IN_NAME_SCOPE';\n      scope: string;\n    }\n  | {\n      type: 'SPANSET_IN_VALUE';\n      tagName: string;\n      betweenQuotes: boolean;\n    }\n  | {\n      type: 'SPANSET_AFTER_VALUE';\n    }\n  | {\n      type: 'SPANSET_COMBINING_OPERATORS';\n    }\n  | {\n      type: 'SPANSET_PIPELINE_AFTER_OPERATOR';\n    }\n  | {\n      type: 'SPANSET_IN_THE_MIDDLE';\n    }\n  | {\n      type: 'SPANSET_EXPRESSION_OPERATORS_WITH_MISSING_CLOSED_BRACE';\n    }\n  | {\n      type: 'NEW_SPANSET';\n    }\n  | {\n      type: 'ATTRIBUTE_FOR_FUNCTION';\n    }\n  | {\n      type: 'SPANSET_COMPARISON_OPERATORS';\n    };\n\ntype Path = Array<[Direction, NodeType[]]>;\n\ntype Resolver = {\n  path: NodeType[];\n  fun: (node: SyntaxNode, text: string, pos: number, originalPos: number) => SituationType | void;\n};\n\nfunction getErrorNode(tree: Tree, cursorPos: number): SyntaxNode | null {\n  const cur = tree.cursorAt(cursorPos);\n  do {\n    if (cur.from === cursorPos || cur.to === cursorPos) {\n      const { node } = cur;\n      if (node.type.isError) {\n        return node;\n      }\n    }\n  } while (cur.next());\n  return null;\n}\n\nfunction move(node: SyntaxNode, direction: Direction): SyntaxNode | null {\n  return node[direction];\n}\n\nfunction walk(node: SyntaxNode, path: Path): SyntaxNode | null {\n  let current: SyntaxNode | null = node;\n  for (const [direction, expectedNodeIDs] of path) {\n    current = move(current, direction);\n    if (current === null) {\n      // we could not move in the direction, we stop\n      return null;\n    }\n\n    // note that the found value can be 0, which is acceptable\n    if (expectedNodeIDs.find((id) => id === current?.type.id) === undefined) {\n      // the reached node has wrong type, we stop\n      return null;\n    }\n  }\n  return current;\n}\n\nfunction getNodeText(node: SyntaxNode, text: string): string {\n  // if the from and to are them same (e.g. for an error node) we can subtract 1 from the start/from index\n  return text.slice(node.from === node.to ? node.from - 1 : node.from, node.to);\n}\n\nfunction isPathMatch(resolverPath: NodeType[], cursorPath: number[]): boolean {\n  return resolverPath.every((item, index) => item === cursorPath[index]);\n}\n\n/**\n * Figure out where is the cursor and what kind of suggestions are appropriate.\n * @param text the user input\n * @param offset the position of the cursor (starting from 0) in the user input\n */\nexport function getSituation(text: string, offset: number): Situation | null {\n  // there is a special case when we are at the start of writing text,\n  // so we handle that case first\n  if (text === '') {\n    return {\n      query: text,\n      type: 'EMPTY',\n    };\n  }\n\n  const tree = parser.parse(text);\n\n  // Whitespaces (especially when multiple) on the left of the text cursor can trick the Lezer parser,\n  // causing a wrong tree cursor to be picked.\n  // Example: `{ span.foo =    ↓ }`, with `↓` being the cursor, tricks the parser.\n  // Quick and dirty hack: Shift the cursor to the left until we find a non-whitespace character on its left.\n  let shiftedOffset = offset;\n  while (shiftedOffset - 1 >= 0 && text[shiftedOffset - 1] === ' ') {\n    shiftedOffset -= 1;\n  }\n\n  // If the tree contains error, it's probable that our node is one of those error nodes.\n  // If there are errors, the node lezer finds us might not be the best node.\n  // So, first we check if there is an error node at the cursor position.\n  let errorNode = getErrorNode(tree, shiftedOffset);\n  if (!errorNode) {\n    // Try again with the previous character.\n    errorNode = getErrorNode(tree, shiftedOffset - 1);\n  }\n  if (!errorNode) {\n    // Try again with the next character\n    errorNode = getErrorNode(tree, shiftedOffset + 1);\n  }\n\n  const cur = errorNode != null ? errorNode.cursor() : tree.cursorAt(shiftedOffset);\n\n  const currentNode = cur.node;\n  const ids = [cur.type.id];\n  while (cur.parent()) {\n    ids.push(cur.type.id);\n  }\n\n  let situationType: SituationType | void = undefined;\n  for (let resolver of RESOLVERS) {\n    if (isPathMatch(resolver.path, ids)) {\n      situationType = resolver.fun(currentNode, text, shiftedOffset, offset);\n    }\n  }\n\n  return { query: text, ...(situationType ?? { type: 'UNKNOWN' }) };\n}\n\nconst ERROR_NODE_ID = 0;\n\nconst RESOLVERS: Resolver[] = [\n  // Curson on error node cases\n  {\n    path: [ERROR_NODE_ID, AttributeField],\n    fun: resolveAttribute,\n  },\n  {\n    path: [ERROR_NODE_ID, FieldExpression],\n    fun: resolveExpression,\n  },\n  {\n    path: [ERROR_NODE_ID, SpansetFilter],\n    fun: resolveSpansetWithNoClosedBrace,\n  },\n  {\n    path: [ERROR_NODE_ID, Aggregate],\n    fun: resolveAttributeForFunction,\n  },\n  {\n    path: [ERROR_NODE_ID, IntrinsicField],\n    fun: resolveAttributeForFunction,\n  },\n  {\n    path: [ERROR_NODE_ID, GroupOperation],\n    fun: resolveAttributeForFunction,\n  },\n  {\n    path: [ERROR_NODE_ID, SelectOperation],\n    fun: resolveAttributeForFunction,\n  },\n  {\n    path: [ERROR_NODE_ID, SpansetPipelineExpression],\n    fun: resolveSpansetPipeline,\n  },\n  {\n    path: [ERROR_NODE_ID, ScalarFilter, SpansetPipeline],\n    fun: resolveArithmeticOperator,\n  },\n  // Curson on valid node cases (the whole query could contain errors nevertheless)\n  {\n    path: [FieldExpression],\n    fun: resolveSpanset,\n  },\n  {\n    path: [SpansetFilter],\n    fun: resolveSpanset,\n  },\n  {\n    path: [SpansetPipelineExpression],\n    fun: resolveNewSpansetExpression,\n  },\n  {\n    path: [TraceQL],\n    fun: resolveNewSpansetExpression,\n  },\n  {\n    path: [StringNode, Static],\n    fun: resolveExpression,\n  },\n];\n\nconst resolveAttributeCompletion = (node: SyntaxNode, text: string, pos: number): SituationType | void => {\n  // The user is completing an expression. We can take advantage of the fact that the Monaco editor is smart\n  // enough to automatically detect that there are some characters before the cursor and to take them into\n  // account when providing suggestions.\n  const getAttributeFieldUpToDot = (node: SyntaxNode) => {\n    const attributeFieldParent = walk(node, [['firstChild', [AttributeField]]]);\n    const attributeFieldParentText = attributeFieldParent ? getNodeText(attributeFieldParent, text) : '';\n    const indexOfDot = attributeFieldParentText.indexOf('.');\n    return attributeFieldParentText.slice(0, indexOfDot);\n  };\n\n  // If there is a space, for sure the attribute is completed and no suggestions to complete it should be provided\n  if (text[pos - 1] === ' ') {\n    return;\n  }\n\n  const endOfPathNode = walk(node, [['firstChild', [FieldExpression]]]);\n  if (endOfPathNode) {\n    return {\n      type: 'SPANSET_IN_NAME_SCOPE',\n      scope: getAttributeFieldUpToDot(endOfPathNode),\n    };\n  }\n\n  const endOfPathNode2 = walk(node, [\n    ['parent', [SpansetFilter]],\n    ['firstChild', [FieldExpression]],\n  ]);\n  // In this case, we also need to check the character at `pos`\n  if (endOfPathNode2 && text[pos] !== ' ') {\n    return {\n      type: 'SPANSET_IN_NAME_SCOPE',\n      scope: getAttributeFieldUpToDot(endOfPathNode2),\n    };\n  }\n};\n\nfunction resolveSpanset(node: SyntaxNode, text: string, _: number, originalPos: number): SituationType {\n  const situation = resolveAttributeCompletion(node, text, originalPos);\n  if (situation) {\n    return situation;\n  }\n\n  let endOfPathNode = walk(node, [\n    ['firstChild', [FieldExpression]],\n    ['firstChild', [AttributeField]],\n  ]);\n  if (endOfPathNode) {\n    return {\n      type: 'SPANSET_EXPRESSION_OPERATORS',\n    };\n  }\n\n  endOfPathNode = walk(node, [\n    ['lastChild', [FieldExpression]],\n    ['lastChild', [FieldExpression]],\n    ['lastChild', [Static]],\n  ]);\n  if (endOfPathNode) {\n    return {\n      type: 'SPANFIELD_COMBINING_OPERATORS',\n    };\n  }\n\n  endOfPathNode = walk(node, [['lastChild', [FieldExpression]]]);\n  if (endOfPathNode) {\n    return {\n      type: 'SPANSET_EXPRESSION_OPERATORS',\n    };\n  }\n\n  return {\n    type: 'SPANSET_EMPTY',\n  };\n}\n\nfunction resolveAttribute(node: SyntaxNode, text: string): SituationType {\n  const attributeFieldParent = walk(node, [['parent', [AttributeField]]]);\n  const attributeFieldParentText = attributeFieldParent ? getNodeText(attributeFieldParent, text) : '';\n\n  if (attributeFieldParentText === '.') {\n    return {\n      type: 'SPANSET_ONLY_DOT',\n    };\n  }\n\n  const indexOfDot = attributeFieldParentText.indexOf('.');\n  const attributeFieldUpToDot = attributeFieldParentText.slice(0, indexOfDot);\n\n  if (\n    ['event', 'instrumentation', 'link', 'resource', 'span', 'parent'].find((item) => item === attributeFieldUpToDot)\n  ) {\n    return {\n      type: 'SPANSET_IN_NAME_SCOPE',\n      scope: attributeFieldUpToDot,\n    };\n  }\n  return {\n    type: 'SPANSET_IN_NAME',\n  };\n}\n\nfunction resolveExpression(node: SyntaxNode, text: string, _: number, originalPos: number): SituationType {\n  const situation = resolveAttributeCompletion(node, text, originalPos);\n  if (situation) {\n    return situation;\n  }\n\n  if (\n    walk(node, [\n      ['parent', [Static]],\n      ['parent', [FieldExpression]],\n      ['prevSibling', [FieldOp]],\n    ])\n  ) {\n    let attributeField = node.parent?.parent?.prevSibling?.prevSibling;\n    if (attributeField) {\n      return {\n        type: 'SPANSET_IN_VALUE',\n        tagName: getNodeText(attributeField, text),\n        betweenQuotes: true,\n      };\n    }\n  }\n\n  if (node.prevSibling?.type.id === FieldOp) {\n    let attributeField = node.prevSibling?.prevSibling;\n    if (attributeField) {\n      return {\n        type: 'SPANSET_IN_VALUE',\n        tagName: getNodeText(attributeField, text),\n        betweenQuotes: false,\n      };\n    }\n  }\n\n  if (node.prevSibling?.type.name === 'And' || node.prevSibling?.type.name === 'Or') {\n    return {\n      type: 'SPANSET_EMPTY',\n    };\n  }\n\n  return {\n    type: 'SPANSET_IN_THE_MIDDLE',\n  };\n}\n\nfunction resolveArithmeticOperator(node: SyntaxNode, _0: string, _1: number): SituationType | void {\n  if (node.prevSibling?.type.id !== ComparisonOp) {\n    return {\n      type: 'SPANSET_COMPARISON_OPERATORS',\n    };\n  }\n}\n\nfunction resolveNewSpansetExpression(node: SyntaxNode, text: string, offset: number): SituationType {\n  // Select the node immediately before the one pointed by the cursor\n  let previousNode = node.firstChild;\n  try {\n    previousNode = node.firstChild;\n    while (previousNode!.to < offset) {\n      previousNode = previousNode!.nextSibling;\n    }\n  } catch (error) {\n    console.error('Unexpected error while searching for previous node', error);\n  }\n\n  if (previousNode?.type.id === And || previousNode?.type.id === Or) {\n    return {\n      type: 'NEW_SPANSET',\n    };\n  }\n\n  return {\n    type: 'SPANSET_COMBINING_OPERATORS',\n  };\n}\n\nfunction resolveAttributeForFunction(node: SyntaxNode, _0: string, _1: number): SituationType | void {\n  const parent = node?.parent;\n  if (!!parent && [IntrinsicField, Aggregate, GroupOperation, SelectOperation, SelectArgs].includes(parent.type.id)) {\n    return {\n      type: 'ATTRIBUTE_FOR_FUNCTION',\n    };\n  }\n}\n\nfunction resolveSpansetPipeline(node: SyntaxNode, _1: string, _2: number): SituationType {\n  if (node.prevSibling?.type.id === Pipe) {\n    return {\n      type: 'SPANSET_PIPELINE_AFTER_OPERATOR',\n    };\n  }\n  return {\n    type: 'NEW_SPANSET',\n  };\n}\n\nfunction resolveSpansetWithNoClosedBrace(node: SyntaxNode, text: string, originalPos: number): SituationType {\n  const situation = resolveAttributeCompletion(node, text, originalPos);\n  if (situation) {\n    return situation;\n  }\n\n  return {\n    type: 'SPANSET_EXPRESSION_OPERATORS_WITH_MISSING_CLOSED_BRACE',\n  };\n}\n","import { IMarkdownString, languages } from 'monaco-editor';\n\nimport { SelectableValue } from '@grafana/data';\nimport { isFetchError } from '@grafana/runtime';\nimport type { Monaco, monacoTypes } from '@grafana/ui';\n\nimport TempoLanguageProvider from '../language_provider';\n\nimport { getSituation, Situation } from './situation';\nimport { scopes } from './traceql';\n\ntype MinimalCompletionItem = {\n  label: string;\n  insertText: string;\n  detail?: string;\n  documentation?: string | IMarkdownString;\n};\n\nexport type CompletionItemType = 'TAG_NAME' | 'TAG_VALUE' | 'KEYWORD' | 'OPERATOR' | 'SCOPE' | 'FUNCTION';\ntype CompletionItem = MinimalCompletionItem & {\n  type: CompletionItemType;\n  insertTextRules?: monacoTypes.languages.CompletionItemInsertTextRule; // we used it to position the cursor\n};\n\ninterface Props {\n  languageProvider: TempoLanguageProvider;\n  setAlertText: (text?: string) => void;\n}\n\n/**\n * Class that implements CompletionItemProvider interface and allows us to provide suggestion for the Monaco\n * autocomplete system.\n *\n * Here we want to provide suggestions for TraceQL. Please refer to\n * https://grafana.com/docs/tempo/latest/traceql for the syntax of the language.\n */\nexport class CompletionProvider implements monacoTypes.languages.CompletionItemProvider {\n  languageProvider: TempoLanguageProvider;\n  registerInteractionCommandId: string | null;\n  setAlertText: (text?: string) => void;\n\n  constructor(props: Props) {\n    this.languageProvider = props.languageProvider;\n    this.setAlertText = props.setAlertText;\n    this.registerInteractionCommandId = null;\n  }\n\n  triggerCharacters = ['{', '.', '[', '(', '=', '~', ' ', '\"'];\n\n  // Operators\n  static readonly arithmeticOps: MinimalCompletionItem[] = [\n    {\n      label: '+',\n      insertText: '+',\n      detail: 'Plus',\n    },\n    {\n      label: '-',\n      insertText: '-',\n      detail: 'Minus',\n    },\n    {\n      label: '*',\n      insertText: '*',\n      detail: 'Times',\n    },\n    {\n      label: '/',\n      insertText: '/',\n      detail: 'Over',\n    },\n  ];\n\n  static readonly logicalOps: MinimalCompletionItem[] = [\n    {\n      label: '&&',\n      insertText: '&&',\n      detail: 'And',\n      documentation: 'And (intersection) operator. Checks that both conditions found matches.',\n    },\n    {\n      label: '||',\n      insertText: '||',\n      detail: 'Or',\n      documentation: 'Or (union) operator. Checks that either condition found matches.',\n    },\n  ];\n\n  static readonly comparisonOps: MinimalCompletionItem[] = [\n    {\n      label: '=',\n      insertText: '=',\n      detail: 'Equality',\n    },\n    {\n      label: '!=',\n      insertText: '!=',\n      detail: 'Inequality',\n    },\n    {\n      label: '>',\n      insertText: '>',\n      detail: 'Greater than',\n    },\n    {\n      label: '>=',\n      insertText: '>=',\n      detail: 'Greater than or equal to',\n    },\n    {\n      label: '<',\n      insertText: '<',\n      detail: 'Less than',\n    },\n    {\n      label: '<=',\n      insertText: '<=',\n      detail: 'Less than or equal to',\n    },\n    {\n      label: '=~',\n      insertText: '=~',\n      detail: 'Regular expression',\n    },\n    {\n      label: '!~',\n      insertText: '!~',\n      detail: 'Negated regular expression',\n    },\n  ];\n  static readonly structuralOps: MinimalCompletionItem[] = [\n    {\n      label: '>>',\n      insertText: '>>',\n      detail: 'Descendant',\n      documentation:\n        'Descendant operator. Looks for spans matching {condB} that are descendants of a span matching {condA}',\n    },\n    {\n      label: '>',\n      insertText: '>',\n      detail: 'Child',\n      documentation:\n        'Child operator. Looks for spans matching {condB} that are direct child spans of a parent matching {condA}',\n    },\n    {\n      label: '<<',\n      insertText: '<<',\n      detail: 'Ancestor',\n      documentation:\n        'Ancestor operator. Looks for spans matching {condB} that are ancestors of a span matching {condA}',\n    },\n    {\n      label: '<',\n      insertText: '<',\n      detail: 'Parent',\n      documentation:\n        'Parent operator. Looks for spans matching {condB} that are direct parent spans of a child matching {condA}',\n    },\n    {\n      label: '~',\n      insertText: '~',\n      detail: 'Sibling',\n      documentation:\n        'Sibling operator. Checks that spans matching {condA} and {condB} are siblings of the same parent span.',\n    },\n  ];\n\n  static readonly spansetOps: MinimalCompletionItem[] = [\n    {\n      label: '|',\n      insertText: '|',\n      detail: 'Pipe',\n    },\n    ...CompletionProvider.logicalOps,\n    ...CompletionProvider.structuralOps,\n  ];\n\n  // Functions (aggregator, selector, and combining operators)\n  static readonly aggregatorFunctions: MinimalCompletionItem[] = [\n    {\n      label: 'avg',\n      insertText: 'avg($0)',\n      detail: 'Average of attribute',\n      documentation: 'Computes the average of a given numeric attribute or intrinsic for a spanset.',\n    },\n    {\n      label: 'count',\n      insertText: 'count()$0',\n      detail: 'Number of spans',\n      documentation: 'Counts the number of spans in a spanset.',\n    },\n    {\n      label: 'max',\n      insertText: 'max($0)',\n      detail: 'Max value of attribute',\n      documentation: 'Computes the maximum value of a given numeric attribute or intrinsic for a spanset.',\n    },\n    {\n      label: 'min',\n      insertText: 'min($0)',\n      detail: 'Min value of attribute',\n      documentation: 'Computes the minimum value of a given numeric attribute or intrinsic for a spanset.',\n    },\n    {\n      label: 'sum',\n      insertText: 'sum($0)',\n      detail: 'Sum value of attribute',\n      documentation: 'Computes the sum value of a given numeric attribute or intrinsic for a spanset.',\n    },\n  ];\n\n  static readonly functions: MinimalCompletionItem[] = [\n    ...this.aggregatorFunctions,\n    {\n      label: 'by',\n      insertText: 'by($0)',\n      detail: 'Grouping of attributes',\n      documentation: 'Groups by arbitrary attributes.',\n    },\n    {\n      label: 'count_over_time',\n      insertText: 'count_over_time()$0',\n      detail: 'Number of spans over time',\n      documentation: 'Counts the number of spans over time.',\n    },\n    {\n      label: 'histogram_over_time',\n      insertText: 'histogram_over_time($0)',\n      detail: 'Histogram of attribute over time',\n      documentation: 'Retrieves a histogram of an attributes values over time which are sorted into buckets.',\n    },\n    {\n      label: 'quantile_over_time',\n      insertText: 'quantile_over_time($0)',\n      detail: 'Quantile of attribute over time',\n      documentation: 'Retrieves one or more quantiles of an attributes numeric values over time.',\n    },\n    {\n      label: 'rate',\n      insertText: 'rate()$0',\n      detail: 'Rate of spans',\n      documentation: 'Counts the rate of spans per second.',\n    },\n    {\n      label: 'select',\n      insertText: 'select($0)',\n      detail: 'Selection of fields',\n      documentation: 'Selects arbitrary fields from spans.',\n    },\n  ];\n\n  // We set these directly and ae required for the provider to function.\n  monaco: Monaco | undefined;\n  editor: monacoTypes.editor.IStandaloneCodeEditor | undefined;\n\n  private cachedValues: { [key: string]: Array<SelectableValue<string>> } = {};\n\n  provideCompletionItems(\n    model: monacoTypes.editor.ITextModel,\n    position: monacoTypes.Position\n  ): monacoTypes.languages.ProviderResult<monacoTypes.languages.CompletionList> {\n    // Should not happen, this should not be called before it is initialized\n    if (!(this.monaco && this.editor)) {\n      throw new Error('provideCompletionItems called before CompletionProvider was initialized');\n    }\n\n    // if the model-id does not match, then this call is from a different editor-instance,\n    // not \"our instance\", so return nothing\n    if (this.editor.getModel()?.id !== model.id) {\n      return { suggestions: [] };\n    }\n\n    const { range, offset } = getRangeAndOffset(this.monaco, model, position);\n    const situation = getSituation(model.getValue(), offset);\n    const completionItems = situation != null ? this.getCompletions(situation, this.setAlertText) : Promise.resolve([]);\n\n    return completionItems.then((items) => {\n      const suggestions = completionItemsToSuggestions(\n        items,\n        range,\n        this.registerInteractionCommandId ?? undefined,\n        model.getValue(),\n        offset\n      );\n      return { suggestions };\n    });\n  }\n\n  /**\n   * Set the ID for the registerInteraction command, to be used to keep track of how many completions are used by the users\n   */\n  setRegisterInteractionCommandId(id: string | null) {\n    this.registerInteractionCommandId = id;\n  }\n\n  private async getTagValues(tagName: string, query: string): Promise<Array<SelectableValue<string>>> {\n    let tagValues: Array<SelectableValue<string>>;\n    const cacheKey = `${tagName}:${query}`;\n\n    if (this.cachedValues.hasOwnProperty(cacheKey)) {\n      tagValues = this.cachedValues[cacheKey];\n    } else {\n      tagValues = await this.languageProvider.getOptionsV2(tagName, query);\n      this.cachedValues[cacheKey] = tagValues;\n    }\n    return tagValues;\n  }\n\n  /**\n   * Get suggestion based on the situation we are in like whether we should suggest tag names or values.\n   * @param situation\n   * @private\n   */\n  private async getCompletions(situation: Situation, setAlertText: (text?: string) => void): Promise<CompletionItem[]> {\n    switch (situation.type) {\n      // This should only happen for cases that we do not support yet\n      case 'UNKNOWN': {\n        return [];\n      }\n      case 'EMPTY': {\n        return this.getScopesCompletions('{ ', '$0 }')\n          .concat(this.getIntrinsicsCompletions('{ ', '$0 }'))\n          .concat(this.getTagsCompletions('{ .'));\n      }\n      case 'SPANSET_EMPTY':\n        return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions('.'));\n      case 'SPANSET_ONLY_DOT': {\n        return this.getTagsCompletions();\n      }\n      case 'SPANSET_IN_THE_MIDDLE':\n      case 'SPANSET_EXPRESSION_OPERATORS_WITH_MISSING_CLOSED_BRACE':\n        return this.getOperatorsCompletions([...CompletionProvider.comparisonOps, ...CompletionProvider.logicalOps]);\n      case 'SPANSET_IN_NAME':\n        return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions());\n      case 'SPANSET_IN_NAME_SCOPE':\n        return this.getTagsCompletions(undefined, situation.scope);\n      case 'SPANSET_EXPRESSION_OPERATORS':\n        return this.getOperatorsCompletions([\n          ...CompletionProvider.comparisonOps,\n          ...CompletionProvider.logicalOps,\n          ...CompletionProvider.arithmeticOps,\n        ]);\n      case 'SPANFIELD_COMBINING_OPERATORS':\n        return this.getOperatorsCompletions([\n          ...CompletionProvider.logicalOps,\n          ...CompletionProvider.arithmeticOps,\n          ...CompletionProvider.comparisonOps,\n        ]);\n      case 'SPANSET_COMBINING_OPERATORS':\n        return this.getOperatorsCompletions(CompletionProvider.spansetOps);\n      case 'SPANSET_PIPELINE_AFTER_OPERATOR':\n        const functions = CompletionProvider.functions.map((key) => ({\n          ...key,\n          insertTextRules: languages.CompletionItemInsertTextRule.InsertAsSnippet,\n          type: 'FUNCTION' as const,\n        }));\n        const tags = this.getScopesCompletions()\n          .concat(this.getIntrinsicsCompletions())\n          .concat(this.getTagsCompletions('.'));\n        return [...functions, ...tags];\n      case 'SPANSET_COMPARISON_OPERATORS':\n        return this.getOperatorsCompletions(CompletionProvider.comparisonOps);\n      case 'SPANSET_IN_VALUE':\n        let tagValues;\n        try {\n          tagValues = await this.getTagValues(situation.tagName, situation.query);\n          setAlertText(undefined);\n        } catch (error) {\n          if (isFetchError(error)) {\n            setAlertText(error.data.error);\n          } else if (error instanceof Error) {\n            setAlertText(`Error: ${error.message}`);\n          }\n        }\n\n        const getInsertionText = (val: SelectableValue<string>): string => {\n          if (situation.betweenQuotes) {\n            return val.label!;\n          }\n          return val.type === 'string' ? `\"${val.label}\"` : val.label!;\n        };\n\n        const items: CompletionItem[] = [];\n        tagValues?.forEach((val) => {\n          if (val?.label) {\n            items.push({\n              label: val.label,\n              insertText: getInsertionText(val),\n              type: 'TAG_VALUE',\n            });\n          }\n        });\n        return items;\n      case 'SPANSET_AFTER_VALUE':\n        return CompletionProvider.logicalOps.map((key) => ({\n          label: key.label,\n          insertText: key.insertText + '}',\n          type: 'OPERATOR',\n        }));\n      case 'NEW_SPANSET':\n        return this.getScopesCompletions('{ ', '$0 }')\n          .concat(this.getIntrinsicsCompletions('{ ', '$0 }'))\n          .concat(this.getTagsCompletions('.'));\n      case 'ATTRIBUTE_FOR_FUNCTION':\n        return this.getScopesCompletions().concat(this.getIntrinsicsCompletions()).concat(this.getTagsCompletions('.'));\n      default:\n        throw new Error(`Unexpected situation ${situation}`);\n    }\n  }\n\n  private getTagsCompletions(prepend?: string, scope?: string): CompletionItem[] {\n    const tags = this.languageProvider.getTraceqlAutocompleteTags(scope);\n    return tagsToCompletionItems(tags, prepend);\n  }\n\n  private getIntrinsicsCompletions(prepend?: string, append?: string): CompletionItem[] {\n    return this.languageProvider.getIntrinsics().map((key) => ({\n      label: key,\n      insertText: (prepend || '') + key + (append || ''),\n      type: 'KEYWORD',\n      insertTextRules: languages.CompletionItemInsertTextRule?.InsertAsSnippet,\n    }));\n  }\n\n  private getScopesCompletions(prepend?: string, append?: string): CompletionItem[] {\n    return scopes.map((key) => ({\n      label: key,\n      insertText: (prepend || '') + key + (append || ''),\n      type: 'SCOPE',\n      insertTextRules: languages.CompletionItemInsertTextRule?.InsertAsSnippet,\n    }));\n  }\n\n  private getOperatorsCompletions(ops: MinimalCompletionItem[]): CompletionItem[] {\n    return ops.map((key) => ({\n      ...key,\n      type: 'OPERATOR',\n    }));\n  }\n}\n\n/**\n * Get item kind which is used for icon next to the suggestion.\n * @param type\n * @param monaco\n */\nfunction getMonacoCompletionItemKind(type: CompletionItemType): languages.CompletionItemKind {\n  switch (type) {\n    case 'TAG_NAME':\n      return languages.CompletionItemKind.Enum;\n    case 'KEYWORD':\n      return languages.CompletionItemKind.Keyword;\n    case 'OPERATOR':\n      return languages.CompletionItemKind.Operator;\n    case 'TAG_VALUE':\n      return languages.CompletionItemKind.EnumMember;\n    case 'SCOPE':\n      return languages.CompletionItemKind.Class;\n    case 'FUNCTION':\n      return languages.CompletionItemKind.Function;\n    default:\n      throw new Error(`Unexpected CompletionItemType: ${type}`);\n  }\n}\n\nfunction getRangeAndOffset(monaco: Monaco, model: monacoTypes.editor.ITextModel, position: monacoTypes.Position) {\n  const word = model.getWordAtPosition(position);\n  const range =\n    word != null\n      ? monaco.Range.lift({\n          startLineNumber: position.lineNumber,\n          endLineNumber: position.lineNumber,\n          startColumn: word.startColumn,\n          endColumn: word.endColumn,\n        })\n      : monaco.Range.fromPositions(position);\n\n  // documentation says `position` will be \"adjusted\" in `getOffsetAt` so we clone it here just for sure.\n  const positionClone = {\n    column: position.column,\n    lineNumber: position.lineNumber,\n  };\n\n  const offset = model.getOffsetAt(positionClone);\n  return { offset, range };\n}\n\nconst SUGGEST_REGEXP = /(event\\.|instrumentation\\.|link\\.|resource\\.|span\\.|\\.)?([\\w./-]*)$/;\n\nfunction completionItemsToSuggestions(\n  items: CompletionItem[],\n  range: monacoTypes.IRange | languages.CompletionItemRanges,\n  registerInteractionCommandId = 'noOp',\n  modelValue: string,\n  offset: number\n) {\n  // monaco by-default alphabetically orders the items.\n  // to stop it, we use a number-as-string sortkey,\n  // so that monaco keeps the order we use\n  const [_, scope, tag] = modelValue.substring(0, offset).match(SUGGEST_REGEXP) ?? [];\n  const maxIndexDigits = items.length.toString().length;\n  const suggestions: languages.CompletionItem[] = items.map((item, index) => {\n    const suggestion: languages.CompletionItem = {\n      kind: getMonacoCompletionItemKind(item.type),\n      label: item.label,\n      insertText: item.insertText,\n      insertTextRules: item.insertTextRules,\n      detail: item.detail,\n      documentation: item.documentation,\n      sortText: index.toString().padStart(maxIndexDigits, '0'), // to force the order we have\n      range,\n      command: {\n        id: registerInteractionCommandId,\n        title: 'Report Interaction',\n        arguments: [item.label, item.type],\n      },\n    };\n\n    if (tag && item.type === 'TAG_NAME') {\n      fixSuggestion(suggestion, offset, tag, scope);\n    }\n\n    return suggestion;\n  });\n\n  return suggestions;\n}\n\n/**\n * Fix the suggestions range and insert text. For the range we have to adjust because monaco by default replaces just\n * the last word which stops at dot while traceQL tags contain dots themselves and we want to replace the whole tag\n * name when suggesting. The insert text needs to be adjusted for scope (leading dot) if scope is currently missing.\n * This may be doable also when creating the suggestions but for a particular situation this seems to be easier to do\n * here.\n */\nfunction fixSuggestion(suggestion: monacoTypes.languages.CompletionItem, offset: number, tag: string, scope?: string) {\n  // Add the default scope if needed.\n  if (scope == null && suggestion.insertText[0] !== '.') {\n    suggestion.insertText = '.' + suggestion.insertText;\n  }\n\n  // Adjust the range, so that we will replace the whole tag.\n  suggestion.range = {\n    ...suggestion.range,\n    startColumn: offset - tag.length + 1,\n  };\n}\n\nconst collator = new Intl.Collator('en', { sensitivity: 'accent' });\n\nfunction tagsToCompletionItems(tags: string[], prepend = ''): CompletionItem[] {\n  return tags.sort(collator.compare).map((key) => ({\n    label: key,\n    insertText: `${prepend}${key}`,\n    type: 'TAG_NAME',\n  }));\n}\n","import { SyntaxNode } from '@lezer/common';\n\nimport {\n  Aggregate,\n  And,\n  AttributeField,\n  ComparisonOp,\n  Event,\n  FieldExpression,\n  FieldOp,\n  GroupOperation,\n  Identifier,\n  Instrumentation,\n  IntrinsicField,\n  Link,\n  Or,\n  Parent,\n  parser,\n  Pipe,\n  Resource,\n  ScalarExpression,\n  ScalarFilter,\n  SelectOperation,\n  Span,\n  SpansetFilter,\n  SpansetPipelineExpression,\n} from '@grafana/lezer-traceql';\nimport { monacoTypes } from '@grafana/ui';\n\n/**\n * Given an error node, generate an error message to be displayed to the user.\n *\n * @param errorNode the error node, as returned by the TraceQL Lezer parser\n * @returns the error message\n */\nexport const computeErrorMessage = (errorNode: SyntaxNode) => {\n  switch (errorNode.parent?.type.id) {\n    case FieldExpression:\n      switch (errorNode.prevSibling?.type.id) {\n        case And:\n        case Or:\n          return 'Invalid value after logical operator.';\n        case FieldOp:\n          return 'Invalid value after comparison or arithmetic operator.';\n        default:\n          return 'Invalid operator after field expression.';\n      }\n    case SpansetFilter:\n      if (errorNode.prevSibling?.type.id === FieldExpression) {\n        return 'Invalid comparison operator after field expression.';\n      }\n      return 'Invalid expression for spanset.';\n    case SpansetPipelineExpression:\n      switch (errorNode.prevSibling?.type.id) {\n        case SpansetPipelineExpression:\n          return 'Invalid spanset combining operator after spanset expression.';\n        case Pipe:\n          return 'Invalid aggregation operator after pipeline operator.';\n        default:\n          return 'Invalid spanset expression after spanset combining operator.';\n      }\n    case IntrinsicField:\n    case Aggregate:\n      if (errorNode.parent?.parent?.parent?.type.id === GroupOperation) {\n        return 'Invalid expression for by operator.';\n      } else if (errorNode.parent?.parent?.parent?.parent?.type.id === SelectOperation) {\n        return 'Invalid expression for select operator.';\n      }\n      return 'Invalid expression for aggregator operator.';\n    case AttributeField:\n      return 'Invalid expression for spanset.';\n    case ScalarFilter:\n      switch (errorNode.prevSibling?.type.id) {\n        case ComparisonOp:\n          return 'Invalid value after comparison operator.';\n        case ScalarExpression:\n          if (errorNode.prevSibling?.firstChild?.type.id === Aggregate) {\n            return 'Invalid comparison operator after aggregator operator.';\n          }\n        default:\n          return 'Invalid value after comparison operator.';\n      }\n    default:\n      return 'Invalid query.';\n  }\n};\n\n/**\n * Parse the given query and find the error nodes, if any, in the resulting tree.\n *\n * @param query the TraceQL query of the user\n * @returns the error nodes\n */\nexport const getErrorNodes = (query: string): SyntaxNode[] => {\n  // Return immediately if the query is empty, to avoid raising exceptions in processing it\n  if (query.trim() === '') {\n    return [];\n  }\n\n  // Check whether this is a trace ID or traceQL query by checking if it only contains hex characters\n  const hexOnlyRegex = /^[0-9A-Fa-f]*$/;\n  if (query.trim().match(hexOnlyRegex)) {\n    return [];\n  }\n\n  const tree = parser.parse(query);\n\n  // Find all error nodes and compute the associated erro boundaries\n  const errorNodes: SyntaxNode[] = [];\n  tree.iterate({\n    enter: (nodeRef) => {\n      if (nodeRef.type.id === 0) {\n        errorNodes.push(nodeRef.node);\n      }\n    },\n  });\n\n  return errorNodes;\n};\n\n/**\n * Use markers (squiggles) to highlight syntax errors or warnings in queries.\n *\n */\nexport const setMarkers = (\n  monaco: typeof monacoTypes,\n  model: monacoTypes.editor.ITextModel,\n  errorNodes: SyntaxNode[]\n) => {\n  const markers = [\n    ...getErrorMarkers(monaco.MarkerSeverity.Error, model, errorNodes),\n    ...getWarningMarkers(monaco.MarkerSeverity.Warning, model),\n  ];\n  monaco.editor.setModelMarkers(\n    model,\n    'owner', // default value\n    markers\n  );\n};\n\nexport const getErrorMarkers = (severity: number, model: monacoTypes.editor.ITextModel, errorNodes: SyntaxNode[]) => {\n  return errorNodes.map((errorNode) => {\n    const message = computeErrorMessage(errorNode);\n    return getMarker(severity, message, model, errorNode.from, errorNode.to);\n  });\n};\n\nexport const getWarningMarkers = (severity: number, model: monacoTypes.editor.ITextModel) => {\n  let markers = [];\n\n  // Check if there are issues that should result in a warning marker\n  const text = model.getValue();\n  const tree = parser.parse(text);\n  const indexOfDot = text.indexOf('.');\n  if (indexOfDot > -1) {\n    const cur = tree.cursorAt(0);\n    do {\n      const { node } = cur;\n      if (node.type.id === Identifier) {\n        // Make sure prevSibling is using the proper scope\n        if (\n          node.prevSibling?.type.id !== Parent &&\n          node.prevSibling?.type.id !== Event &&\n          node.prevSibling?.type.id !== Instrumentation &&\n          node.prevSibling?.type.id !== Link &&\n          node.prevSibling?.type.id !== Resource &&\n          node.prevSibling?.type.id !== Span\n        ) {\n          const from = node.prevSibling ? node.prevSibling.from : node.from - 1;\n          const to = node.prevSibling ? node.prevSibling.to : node.from - 1;\n          const message = 'Add resource or span scope to attribute to improve query performance.';\n          markers.push(getMarker(severity, message, model, from, to));\n        }\n      }\n    } while (cur.next());\n  }\n\n  return markers;\n};\n\nexport const getMarker = (\n  severity: number,\n  message: string,\n  model: monacoTypes.editor.ITextModel,\n  from: number,\n  to: number\n) => {\n  let startLine = 0;\n  let endLine = 0;\n  let start = from;\n  let end = to;\n\n  while (start > 0) {\n    startLine++;\n    start -= model.getLineLength(startLine) + 1; // new lines don't count for getLineLength() but they still count as a character for the parser\n  }\n  while (end > 0) {\n    endLine++;\n    end -= model.getLineLength(endLine) + 1;\n  }\n\n  return {\n    message,\n    severity,\n\n    startLineNumber: startLine,\n    endLineNumber: endLine,\n\n    // `+ 2` because of the above computations\n    startColumn: start + model.getLineLength(startLine) + 2,\n    endColumn: end + model.getLineLength(endLine) + 2,\n  };\n};\n","import { css } from '@emotion/css';\nimport { useEffect, useRef, useState } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { TemporaryAlert } from '@grafana/o11y-ds-frontend';\nimport { reportInteraction } from '@grafana/runtime';\nimport { CodeEditor, Monaco, monacoTypes, useTheme2 } from '@grafana/ui';\n\nimport { TempoDatasource } from '../datasource';\nimport { TempoQuery } from '../types';\n\nimport { CompletionProvider, CompletionItemType } from './autocomplete';\nimport { getErrorNodes, setMarkers } from './highlighting';\nimport { languageDefinition } from './traceql';\n\ninterface Props {\n  placeholder: string;\n  query: TempoQuery;\n  onChange: (val: TempoQuery) => void;\n  onRunQuery: () => void;\n  datasource: TempoDatasource;\n  readOnly?: boolean;\n}\n\nexport function TraceQLEditor(props: Props) {\n  const [alertText, setAlertText] = useState<string>();\n\n  const { query, onChange, onRunQuery, placeholder } = props;\n  const setupAutocompleteFn = useAutocomplete(props.datasource, setAlertText);\n  const theme = useTheme2();\n  const styles = getStyles(theme, placeholder);\n\n  // The Monaco Editor uses the first version of props.onChange in handleOnMount i.e. always has the initial\n  // value of query because underlying Monaco editor is passed `query` below in the onEditorChange callback.\n  // handleOnMount is called only once when the editor is mounted and does not get updates to query.\n  // So we need useRef to get the latest version of query in the onEditorChange callback.\n  const queryRef = useRef(query);\n  queryRef.current = query;\n  const onEditorChange = (value: string) => {\n    onChange({ ...queryRef.current, query: value });\n  };\n\n  // work around the problem that `onEditorDidMount` is called once\n  // and wouldn't get new version of onRunQuery\n  const onRunQueryRef = useRef(onRunQuery);\n  onRunQueryRef.current = onRunQuery;\n\n  const errorTimeoutId = useRef<number>();\n\n  return (\n    <>\n      <CodeEditor\n        value={query.query || ''}\n        language={langId}\n        onBlur={onEditorChange}\n        onChange={onEditorChange}\n        containerStyles={styles.queryField}\n        readOnly={props.readOnly}\n        monacoOptions={{\n          folding: false,\n          fontSize: 14,\n          lineNumbers: 'off',\n          overviewRulerLanes: 0,\n          renderLineHighlight: 'none',\n          scrollbar: {\n            vertical: 'hidden',\n            verticalScrollbarSize: 8, // used as \"padding-right\"\n            horizontal: 'hidden',\n            horizontalScrollbarSize: 0,\n          },\n          scrollBeyondLastLine: false,\n          wordWrap: 'on',\n        }}\n        onBeforeEditorMount={ensureTraceQL}\n        onEditorDidMount={(editor, monaco) => {\n          if (!props.readOnly) {\n            setupAutocompleteFn(editor, monaco, setupRegisterInteractionCommand(editor));\n            setupActions(editor, monaco, () => onRunQueryRef.current());\n            setupPlaceholder(editor, monaco, styles);\n          }\n          setupAutoSize(editor);\n\n          // Parse query that might already exist (e.g., after a page refresh)\n          const model = editor.getModel();\n          if (model) {\n            const errorNodes = getErrorNodes(model.getValue());\n            setMarkers(monaco, model, errorNodes);\n          }\n\n          // Register callback for query changes\n          editor.onDidChangeModelContent((changeEvent) => {\n            const model = editor.getModel();\n\n            if (!model) {\n              return;\n            }\n\n            // Remove previous callback if existing, to prevent squiggles from been shown while the user is still typing\n            window.clearTimeout(errorTimeoutId.current);\n\n            const errorNodes = getErrorNodes(model.getValue());\n            const cursorPosition = changeEvent.changes[0].rangeOffset;\n\n            // Immediately updates the squiggles, in case the user fixed an error,\n            // excluding the error around the cursor position\n            setMarkers(\n              monaco,\n              model,\n              errorNodes.filter((errorNode) => !(errorNode.from <= cursorPosition && cursorPosition <= errorNode.to))\n            );\n\n            // Show all errors after a short delay, to avoid flickering\n            errorTimeoutId.current = window.setTimeout(() => {\n              setMarkers(monaco, model, errorNodes);\n            }, 500);\n          });\n        }}\n      />\n      {alertText && <TemporaryAlert severity=\"error\" text={alertText} />}\n    </>\n  );\n}\n\nfunction setupPlaceholder(editor: monacoTypes.editor.IStandaloneCodeEditor, monaco: Monaco, styles: EditorStyles) {\n  const placeholderDecorators = [\n    {\n      range: new monaco.Range(1, 1, 1, 1),\n      options: {\n        className: styles.placeholder,\n        isWholeLine: true,\n      },\n    },\n  ];\n\n  let decorators: string[] = [];\n\n  const checkDecorators = (): void => {\n    const model = editor.getModel();\n\n    if (!model) {\n      return;\n    }\n\n    const newDecorators = model.getValueLength() === 0 ? placeholderDecorators : [];\n    decorators = model.deltaDecorations(decorators, newDecorators);\n  };\n\n  checkDecorators();\n  editor.onDidChangeModelContent(checkDecorators);\n}\n\nfunction setupActions(editor: monacoTypes.editor.IStandaloneCodeEditor, monaco: Monaco, onRunQuery: () => void) {\n  editor.addAction({\n    id: 'run-query',\n    label: 'Run Query',\n    keybindings: [monaco.KeyMod.Shift | monaco.KeyCode.Enter],\n    contextMenuGroupId: 'navigation',\n    contextMenuOrder: 1.5,\n    run: function () {\n      onRunQuery();\n    },\n  });\n}\n\nfunction setupRegisterInteractionCommand(editor: monacoTypes.editor.IStandaloneCodeEditor): string | null {\n  return editor.addCommand(0, function (_, label, type: CompletionItemType) {\n    const properties: Record<string, unknown> = { datasourceType: 'tempo', type };\n    // Filter out the label for TAG_VALUE completions to avoid potentially exposing sensitive data\n    if (type !== 'TAG_VALUE') {\n      properties.label = label;\n    }\n    reportInteraction('grafana_traces_traceql_completion', properties);\n  });\n}\n\nfunction setupAutoSize(editor: monacoTypes.editor.IStandaloneCodeEditor) {\n  const container = editor.getDomNode();\n  const updateHeight = () => {\n    if (container) {\n      const contentHeight = Math.min(1000, editor.getContentHeight());\n      const width = parseInt(container.style.width, 10);\n      container.style.width = `${width}px`;\n      container.style.height = `${contentHeight}px`;\n      editor.layout({ width, height: contentHeight });\n    }\n  };\n  editor.onDidContentSizeChange(updateHeight);\n  updateHeight();\n}\n\n/**\n * Hook that returns function that will set up monaco autocomplete for the label selector\n * @param datasource the Tempo datasource instance\n * @param setAlertText setter for alert's text\n */\nfunction useAutocomplete(datasource: TempoDatasource, setAlertText: (text?: string) => void) {\n  // We need the provider ref so we can pass it the label/values data later. This is because we run the call for the\n  // values here but there is additional setup needed for the provider later on. We could run the getSeries() in the\n  // returned function but that is run after the monaco is mounted so would delay the request a bit when it does not\n  // need to.\n  const providerRef = useRef<CompletionProvider>(\n    new CompletionProvider({ languageProvider: datasource.languageProvider, setAlertText })\n  );\n\n  useEffect(() => {\n    const fetchTags = async () => {\n      try {\n        await datasource.languageProvider.start();\n        setAlertText(undefined);\n      } catch (error) {\n        if (error instanceof Error) {\n          setAlertText(`Error: ${error.message}`);\n        }\n      }\n    };\n    fetchTags();\n  }, [datasource, setAlertText]);\n\n  const autocompleteDisposeFun = useRef<(() => void) | null>(null);\n  useEffect(() => {\n    // when we unmount, we unregister the autocomplete-function, if it was registered\n    return () => {\n      autocompleteDisposeFun.current?.();\n    };\n  }, []);\n\n  // This should be run in monaco onEditorDidMount\n  return (\n    editor: monacoTypes.editor.IStandaloneCodeEditor,\n    monaco: Monaco,\n    registerInteractionCommandId: string | null\n  ) => {\n    providerRef.current.editor = editor;\n    providerRef.current.monaco = monaco;\n    providerRef.current.setRegisterInteractionCommandId(registerInteractionCommandId);\n\n    const { dispose } = monaco.languages.registerCompletionItemProvider(langId, providerRef.current);\n    autocompleteDisposeFun.current = dispose;\n  };\n}\n\n// we must only run the setup code once\nlet traceqlSetupDone = false;\nconst langId = 'traceql';\n\nfunction ensureTraceQL(monaco: Monaco) {\n  if (!traceqlSetupDone) {\n    traceqlSetupDone = true;\n    const { aliases, extensions, mimetypes, def } = languageDefinition;\n    monaco.languages.register({ id: langId, aliases, extensions, mimetypes });\n    monaco.languages.setMonarchTokensProvider(langId, def.language);\n    monaco.languages.setLanguageConfiguration(langId, def.languageConfiguration);\n  }\n}\n\ninterface EditorStyles {\n  placeholder: string;\n  queryField: string;\n}\n\nconst getStyles = (theme: GrafanaTheme2, placeholder: string): EditorStyles => {\n  return {\n    queryField: css({\n      borderRadius: theme.shape.radius.default,\n      border: `1px solid ${theme.components.input.borderColor}`,\n      flex: 1,\n    }),\n    placeholder: css({\n      '::after': {\n        content: `'${placeholder}'`,\n        fontFamily: theme.typography.fontFamilyMonospace,\n        opacity: 0.3,\n      },\n    }),\n  };\n};\n","import { css } from '@emotion/css';\nimport { defaults } from 'lodash';\nimport { useState } from 'react';\n\nimport { GrafanaTheme2, QueryEditorProps } from '@grafana/data';\nimport { config, reportInteraction } from '@grafana/runtime';\nimport { Button, InlineLabel, useStyles2 } from '@grafana/ui';\n\nimport { TempoDatasource } from '../datasource';\nimport { defaultQuery, MyDataSourceOptions, TempoQuery } from '../types';\n\nimport { TempoQueryBuilderOptions } from './TempoQueryBuilderOptions';\nimport { TraceQLEditor } from './TraceQLEditor';\n\ntype EditorProps = {\n  onClearResults: () => void;\n};\n\ntype Props = EditorProps & QueryEditorProps<TempoDatasource, TempoQuery, MyDataSourceOptions>;\n\nexport function QueryEditor(props: Props) {\n  const styles = useStyles2(getStyles);\n  const query = defaults(props.query, defaultQuery);\n  const [showCopyFromSearchButton, setShowCopyFromSearchButton] = useState(() => {\n    const genQuery = props.datasource.languageProvider.generateQueryFromFilters(query.filters || []);\n    return genQuery === query.query || genQuery === '{}';\n  });\n\n  return (\n    <>\n      <InlineLabel>\n        Build complex queries using TraceQL to select a list of traces.{' '}\n        <a rel=\"noreferrer\" target=\"_blank\" href=\"https://grafana.com/docs/tempo/latest/traceql/\">\n          Documentation\n        </a>\n      </InlineLabel>\n      {!showCopyFromSearchButton && (\n        <div className={styles.copyContainer}>\n          <span>Continue editing the query from the Search tab?</span>\n          <Button\n            variant=\"secondary\"\n            size=\"sm\"\n            onClick={() => {\n              reportInteraction('grafana_traces_copy_to_traceql_clicked', {\n                app: props.app ?? '',\n                grafana_version: config.buildInfo.version,\n                location: 'traceql_tab',\n              });\n\n              props.onClearResults();\n              props.onChange({\n                ...query,\n                query: props.datasource.languageProvider.generateQueryFromFilters(query.filters || []),\n              });\n              setShowCopyFromSearchButton(true);\n            }}\n            style={{ marginLeft: '10px' }}\n          >\n            Copy query from Search\n          </Button>\n        </div>\n      )}\n      <TraceQLEditor\n        placeholder=\"Enter a TraceQL query or trace ID (run with Shift+Enter)\"\n        query={query}\n        onChange={props.onChange}\n        datasource={props.datasource}\n        onRunQuery={props.onRunQuery}\n      />\n      <div className={styles.optionsContainer}>\n        <TempoQueryBuilderOptions\n          query={query}\n          onChange={props.onChange}\n          searchStreaming={props.datasource.isStreamingSearchEnabled() ?? false}\n          metricsStreaming={props.datasource.isStreamingMetricsEnabled() ?? false}\n        />\n      </div>\n    </>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  optionsContainer: css({\n    marginTop: '10px',\n  }),\n  copyContainer: css({\n    backgroundColor: theme.colors.background.secondary,\n    padding: theme.spacing(0.5, 1),\n    fontSize: theme.typography.body.fontSize,\n  }),\n});\n","import { css } from '@emotion/css';\nimport { PureComponent } from 'react';\n\nimport { QueryEditorProps, SelectableValue } from '@grafana/data';\nimport { config, reportInteraction } from '@grafana/runtime';\nimport {\n  Button,\n  FileDropzone,\n  HorizontalGroup,\n  InlineField,\n  InlineFieldRow,\n  Modal,\n  RadioButtonGroup,\n  Themeable2,\n  withTheme2,\n} from '@grafana/ui';\n\nimport TraceQLSearch from './SearchTraceQLEditor/TraceQLSearch';\nimport { ServiceGraphSection } from './ServiceGraphSection';\nimport { TempoQueryType } from './dataquery.gen';\nimport { TempoDatasource } from './datasource';\nimport { QueryEditor } from './traceql/QueryEditor';\nimport { TempoQuery } from './types';\nimport { migrateFromSearchToTraceQLSearch } from './utils';\n\ninterface Props extends QueryEditorProps<TempoDatasource, TempoQuery>, Themeable2 {\n  // should template variables be added to tag options. default true\n  addVariablesToOptions?: boolean;\n}\ninterface State {\n  uploadModalOpen: boolean;\n}\n\n// This needs to default to traceql for data sources like Splunk, where clicking on a\n// data link should open the traceql tab and run a search based on the configured query.\nconst DEFAULT_QUERY_TYPE: TempoQueryType = 'traceql';\n\nclass TempoQueryFieldComponent extends PureComponent<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      uploadModalOpen: false,\n    };\n  }\n\n  // Set the default query type when the component mounts.\n  // Also do this if queryType is 'clear' (which is the case when the user changes the query type)\n  // otherwise if the user changes the query type and refreshes the page, no query type will be selected\n  // which is inconsistent with how the UI was originally when they selected the Tempo data source.\n  async componentDidMount() {\n    if (!this.props.query.queryType || this.props.query.queryType === 'clear') {\n      this.props.onChange({\n        ...this.props.query,\n        queryType: DEFAULT_QUERY_TYPE,\n      });\n    }\n  }\n\n  onClearResults = () => {\n    // Run clear query to clear results\n    const { onChange, query, onRunQuery } = this.props;\n    onChange({\n      ...query,\n      queryType: 'clear',\n    });\n    onRunQuery();\n  };\n\n  render() {\n    const { query, onChange, datasource, app } = this.props;\n\n    const graphDatasourceUid = datasource.serviceMap?.datasourceUid;\n\n    let queryTypeOptions: Array<SelectableValue<TempoQueryType>> = [\n      { value: 'traceqlSearch', label: 'Search' },\n      { value: 'traceql', label: 'TraceQL' },\n      { value: 'serviceMap', label: 'Service Graph' },\n    ];\n\n    // Migrate user to new query type if they are using the old search query type\n    if (\n      query.spanName ||\n      query.serviceName ||\n      query.search ||\n      query.maxDuration ||\n      query.minDuration ||\n      query.queryType === 'nativeSearch'\n    ) {\n      onChange(migrateFromSearchToTraceQLSearch(query));\n    }\n\n    return (\n      <>\n        <Modal\n          title={'Upload trace'}\n          isOpen={this.state.uploadModalOpen}\n          onDismiss={() => this.setState({ uploadModalOpen: false })}\n        >\n          <div className={css({ padding: this.props.theme.spacing(2) })}>\n            <FileDropzone\n              options={{ multiple: false }}\n              onLoad={(result) => {\n                if (typeof result !== 'string' && result !== null) {\n                  throw Error(`Unexpected result type: ${typeof result}`);\n                }\n                this.props.datasource.uploadedJson = result;\n                onChange({\n                  ...query,\n                  queryType: 'upload',\n                });\n                this.setState({ uploadModalOpen: false });\n                this.props.onRunQuery();\n              }}\n            />\n          </div>\n        </Modal>\n        <InlineFieldRow>\n          <InlineField label=\"Query type\" grow={true}>\n            <HorizontalGroup spacing={'sm'} align={'center'} justify={'space-between'}>\n              <RadioButtonGroup<TempoQueryType>\n                options={queryTypeOptions}\n                value={query.queryType}\n                onChange={(v) => {\n                  reportInteraction('grafana_traces_query_type_changed', {\n                    datasourceType: 'tempo',\n                    app: app ?? '',\n                    grafana_version: config.buildInfo.version,\n                    newQueryType: v,\n                    previousQueryType: query.queryType ?? '',\n                  });\n\n                  this.onClearResults();\n                  onChange({\n                    ...query,\n                    queryType: v,\n                  });\n                }}\n                size=\"md\"\n              />\n              <Button\n                variant=\"secondary\"\n                size=\"sm\"\n                onClick={() => {\n                  this.setState({ uploadModalOpen: true });\n                }}\n              >\n                Import trace\n              </Button>\n            </HorizontalGroup>\n          </InlineField>\n        </InlineFieldRow>\n        {query.queryType === 'traceqlSearch' && (\n          <TraceQLSearch\n            datasource={this.props.datasource}\n            query={query}\n            onChange={onChange}\n            onBlur={this.props.onBlur}\n            app={app}\n            onClearResults={this.onClearResults}\n            addVariablesToOptions={this.props.addVariablesToOptions}\n          />\n        )}\n        {query.queryType === 'serviceMap' && (\n          <ServiceGraphSection graphDatasourceUid={graphDatasourceUid} query={query} onChange={onChange} />\n        )}\n        {query.queryType === 'traceql' && (\n          <QueryEditor\n            datasource={this.props.datasource}\n            query={query}\n            onRunQuery={this.props.onRunQuery}\n            onChange={onChange}\n            app={app}\n            onClearResults={this.onClearResults}\n          />\n        )}\n      </>\n    );\n  }\n}\n\nconst TempoQueryField = withTheme2(TempoQueryFieldComponent);\n\nexport default TempoQueryField;\n"],"names":["RawQuery","query","lang","className","theme","useContext","ThemeContext","styles","getStyles","highlighted","Prism","grammar","name","div","cx","editorField","aria-label","dangerouslySetInnerHTML","__html","WeakMap","css","fontFamily","typography","fontFamilyMonospace","fontSize","bodySmall","QueryOptionGroup","title","children","collapsedInfo","queryStats","onToggle","isOpen","propsIsOpen","toggleOpen","useToggle","useStyles2","wrapper","Collapse","collapse","collapsible","label","Stack","gap","h6","description","map","x","i","span","body","config","featureToggles","lokiQuerySplitting","Tooltip","content","Icon","tabIndex","tooltip","size","p","stats","generateQueryStats","backgroundColor","border","marginBottom","padding","spacing","width","display","justifyContent","alignItems","flexGrow","overflow","fontWeight","fontWeightMedium","margin","color","colors","text","secondary","paddingLeft","flexWrap","marginRight","message","convertUnits","suffix","getValueFormat","bytes","parseIntWithFallback","val","fallback","parsed","parseInt","isNaN","TempoQueryBuilderOptions","React","onChange","searchStreaming","metricsStreaming","hasOwnProperty","limit","DEFAULT_LIMIT","tableType","SearchTableType","Traces","metricsQueryType","MetricsQueryType","Range","collapsedSearchOptions","spss","DEFAULT_SPSS","collapsedMetricsOptions","step","EditorRow","options","EditorField","AutoSizeInput","placeholder","type","min","defaultValue","onCommitChange","e","currentTarget","value","RadioButtonGroup","Spans","StreamingTooltip","tooltipInteractive","Instant","style","a","href","target","rel","textDecoration","displayName","validationRegex","noBoxShadow","boxShadow","filter","operators","updateFilter","invalid","test","concat","HorizontalGroup","Select","inputId","id","operatorSelectableValue","operator","v","isClearable","allowCustomValue","Input","InlineFieldRow","InlineField","labelWidth","grow","GroupByField","props","datasource","isTagsLoading","addVariablesToOptions","generateId","uuidv4","slice","tagQuery","setTagQuery","useState","useEffect","groupBy","length","scope","TraceqlSearchScope","Span","tagOptions","useMemo","f","tags","languageProvider","getMetricsSummaryTags","OPTIONS_LIMIT","queryLowerCase","toLowerCase","tag","includes","copy","indexOfFilter","findIndex","replaceAt","push","scopeOptions","Object","values","s","getTags","t","InlineSearchField","undefined","isLoading","withTemplateVariableOptions","onInputChange","action","onCloseMenu","AccessoryButton","icon","onClick","removeFilter","variant","addTag","Alert","severity","notice","noticeLink","marginLeft","marginTop","link","hardCodedFilterIds","onClearResults","app","findFilter","alertText","setAlertText","error","setError","setIsTagsLoading","traceQlQuery","setTraceQlQuery","templateSrv","getTemplateSrv","useCallback","filters","templateVariables","getVariables","generateQueryFromFilters","interpolateFilters","find","fetchTags","start","Error","search","forEach","staticTags","dynamicFilters","sf","generateQueryWithoutFilter","filtersAfterRemoval","container","filterTitle","filterScopedTag","SearchField","hideScope","hideTag","Intrinsic","isMulti","DurationInput","valueType","TagsInput","deleteFilter","requireTagAndValue","metricsSummary","rawQueryContainer","replace","traceqlGrammar","Button","reportInteraction","grafana_version","buildInfo","version","location","queryType","isStreamingSearchEnabled","isStreamingMetricsEnabled","alert","uid","TemporaryAlert","maxWidth","flexDirection","background","AdHocFilterKey","disabled","filterKey","allFilters","data-testid","SegmentAsync","Component","plusSegment","loadOptions","fetchFilterKeys","inputMinWidth","fetchFilterKeysWithRemove","REMOVE_FILTER_KEY","REMOVE_VALUE","currentKey","ds","getDataSourceSrv","get","getTagKeys","otherFilters","key","response","Array","isArray","data","m","keys","AdHocFilterValue","filterValue","placeHolder","fetchFilterValues","getTagValues","timeRange","getDefaultTimeRange","OperatorSegment","Segment","AdHocFilterRenderer","onKeyChange","onOperatorChange","onValueChange","tFunc","i18n","AdHocFilterBuilder","appendBefore","onCompleted","setKey","setOperator","onKeyChanged","item","onOperatorChanged","onValueChanged","ConditionSegment","AdHocFilter","PureComponent","render","this","renderFilters","appendFilterToVariable","getAllFilters","baseFilters","reduce","segments","index","renderFilterSegments","Fragment","prop","changeFilter","addFilter","ServiceGraphSection","graphDatasourceUid","dsState","useAsync","getDS","hasKeys","setHasKeys","fn","condition","Boolean","loading","getWarning","match","re","exec","queryToFilter","serviceMapQuery","filtersToQuery","newFilters","splice","join","defaultQuery","getErrorNode","tree","cursorPos","cur","cursorAt","from","to","node","isError","next","move","direction","walk","path","current","expectedNodeIDs","getNodeText","isPathMatch","resolverPath","cursorPath","every","RESOLVERS","AttributeField","fun","attributeFieldParent","attributeFieldParentText","indexOfDot","indexOf","attributeFieldUpToDot","FieldExpression","resolveExpression","SpansetFilter","originalPos","situation","resolveAttributeCompletion","Aggregate","resolveAttributeForFunction","IntrinsicField","GroupOperation","SelectOperation","SpansetPipelineExpression","_1","_2","prevSibling","Pipe","ScalarFilter","SpansetPipeline","_0","ComparisonOp","resolveSpanset","resolveNewSpansetExpression","TraceQL","StringNode","Static","pos","getAttributeFieldUpToDot","endOfPathNode","endOfPathNode2","_","FieldOp","attributeField","parent","tagName","betweenQuotes","offset","previousNode","firstChild","nextSibling","console","And","Or","SelectArgs","CompletionProvider","provideCompletionItems","model","position","monaco","editor","getModel","suggestions","range","word","getWordAtPosition","lift","startLineNumber","lineNumber","endLineNumber","startColumn","endColumn","fromPositions","positionClone","column","getOffsetAt","getRangeAndOffset","parser","parse","shiftedOffset","errorNode","cursor","currentNode","ids","situationType","resolver","getSituation","getValue","getCompletions","Promise","resolve","then","items","registerInteractionCommandId","modelValue","SUGGEST_REGEXP","substring","maxIndexDigits","toString","suggestion","kind","getMonacoCompletionItemKind","insertText","insertTextRules","detail","documentation","sortText","padStart","command","arguments","fixSuggestion","completionItemsToSuggestions","setRegisterInteractionCommandId","tagValues","cacheKey","cachedValues","getOptionsV2","getScopesCompletions","getIntrinsicsCompletions","getTagsCompletions","getOperatorsCompletions","comparisonOps","logicalOps","arithmeticOps","spansetOps","functions","languages","CompletionItemInsertTextRule","InsertAsSnippet","isFetchError","getInsertionText","prepend","sort","collator","compare","tagsToCompletionItems","getTraceqlAutocompleteTags","append","getIntrinsics","scopes","ops","constructor","triggerCharacters","CompletionItemKind","Enum","Keyword","Operator","EnumMember","Class","Function","structuralOps","aggregatorFunctions","Intl","Collator","sensitivity","getErrorNodes","trim","errorNodes","iterate","enter","nodeRef","setMarkers","markers","getErrorMarkers","MarkerSeverity","getWarningMarkers","Warning","setModelMarkers","ScalarExpression","computeErrorMessage","getMarker","Identifier","Parent","Event","Instrumentation","Link","Resource","startLine","endLine","end","getLineLength","TraceQLEditor","onRunQuery","setupAutocompleteFn","providerRef","useRef","autocompleteDisposeFun","dispose","registerCompletionItemProvider","langId","useAutocomplete","useTheme2","queryRef","onEditorChange","onRunQueryRef","errorTimeoutId","CodeEditor","language","onBlur","containerStyles","queryField","readOnly","monacoOptions","folding","lineNumbers","overviewRulerLanes","renderLineHighlight","scrollbar","vertical","verticalScrollbarSize","horizontal","horizontalScrollbarSize","scrollBeyondLastLine","wordWrap","onBeforeEditorMount","ensureTraceQL","onEditorDidMount","addCommand","properties","datasourceType","setupRegisterInteractionCommand","addAction","keybindings","KeyMod","Shift","KeyCode","Enter","contextMenuGroupId","contextMenuOrder","run","setupActions","placeholderDecorators","isWholeLine","decorators","checkDecorators","newDecorators","getValueLength","deltaDecorations","onDidChangeModelContent","setupPlaceholder","getDomNode","updateHeight","contentHeight","Math","getContentHeight","height","layout","onDidContentSizeChange","setupAutoSize","changeEvent","window","clearTimeout","cursorPosition","changes","rangeOffset","setTimeout","traceqlSetupDone","aliases","extensions","mimetypes","def","languageDefinition","register","setMonarchTokensProvider","setLanguageConfiguration","languageConfiguration","borderRadius","shape","radius","default","components","input","borderColor","flex","opacity","QueryEditor","defaults","showCopyFromSearchButton","setShowCopyFromSearchButton","genQuery","InlineLabel","copyContainer","optionsContainer","TempoQueryFieldComponent","componentDidMount","serviceMap","datasourceUid","spanName","serviceName","maxDuration","minDuration","migrateFromSearchToTraceQLSearch","Modal","state","uploadModalOpen","onDismiss","setState","FileDropzone","multiple","onLoad","result","uploadedJson","align","justify","newQueryType","previousQueryType","TraceQLSearch","super","withTheme2"],"sourceRoot":""}