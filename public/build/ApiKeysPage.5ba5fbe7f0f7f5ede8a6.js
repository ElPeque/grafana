"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4196],{45525:(le,u,n)=>{n.r(u),n.d(u,{ApiKeysPageUnconnected:()=>C,MigrationSummary:()=>E,default:()=>ae});var e=n(74848),x=n(96540),D=n(71468),m=n(60484),T=n(29010),k=n(59830),j=n(25356),y=n(54594),f=n(54122),A=n(87638),R=n(11817),F=n(10743),v=n(61491),N=n(22560);const w=({searchQuery:s,disabled:t,onSearchChange:i})=>(0,e.jsx)("div",{className:"page-action-bar",children:(0,e.jsx)(m.I,{grow:!0,children:(0,e.jsx)(N.Z,{placeholder:"Search keys",value:s,onChange:i})})});var d=n(22803),I=n(88090),K=n(29675),B=n(6736),Q=n(79784),b=n(48583),L=n(87731);const O=({apiKeys:s,timeZone:t,onDelete:i,onMigrate:r})=>{const l=(0,K.$j)(),o=U(l);return(0,e.jsxs)("table",{className:"filter-table",children:[(0,e.jsx)("thead",{children:(0,e.jsxs)("tr",{children:[(0,e.jsx)("th",{children:"Name"}),(0,e.jsx)("th",{children:"Role"}),(0,e.jsx)("th",{children:"Expires"}),(0,e.jsx)("th",{children:"Last used at"}),(0,e.jsx)("th",{style:{width:"34px"}})]})}),s.length>0?(0,e.jsx)("tbody",{children:s.map(a=>{const c=!!(a.expiration&&Date.now()>new Date(a.expiration).getTime());return(0,e.jsxs)("tr",{className:o.tableRow(c),children:[(0,e.jsx)("td",{children:a.name}),(0,e.jsx)("td",{children:a.role}),(0,e.jsxs)("td",{children:[z(a.expiration,t),c&&(0,e.jsx)("span",{className:o.tooltipContainer,children:(0,e.jsx)(B.m,{content:"This API key has expired.",children:(0,e.jsx)(Q.I,{name:"exclamation-triangle"})})})]}),(0,e.jsx)("td",{children:$(t,a.lastUsedAt)}),(0,e.jsx)("td",{children:(0,e.jsxs)(b.B,{justifyContent:"flex-end",children:[(0,e.jsx)(y.$n,{size:"sm",onClick:()=>r(a),children:"Migrate to service account"}),(0,e.jsx)(L.e,{"aria-label":"Delete API key",size:"sm",onConfirm:()=>i(a),disabled:!A.TP.hasPermissionInMetadata(v.AccessControlAction.ActionAPIKeysDelete,a)})]})})]},a.id)})}):null]})};function $(s,t){return t?(0,I.LE)(t,{timeZone:s}):"Never"}function z(s,t){return s?(0,I.LE)(s,{timeZone:t}):"No expiration date"}const U=s=>({tableRow:t=>(0,d.css)({color:t?s.colors.text.secondary:s.colors.text.primary}),tooltipContainer:(0,d.css)({marginLeft:s.spacing(1)})});var P=n(37e3),V=n(65164);const Y=({onMigrate:s,apikeysCount:t,disabled:i})=>{const[r,l]=(0,x.useState)(!1),o=(0,K.of)(Z),a=(0,e.jsx)("a",{className:"external-link",href:"https://grafana.com/docs/grafana/latest/administration/service-accounts/migrate-api-keys/",target:"_blank",rel:"noopener noreferrer",children:"Find out more about the migration here."}),c=(0,e.jsx)("span",{children:"Migrating all API keys will hide the API keys tab."});return(0,e.jsxs)(e.Fragment,{children:[t>0&&(0,e.jsxs)(P.F,{title:"Switch from API keys to service accounts",severity:"warning",children:[(0,e.jsxs)("div",{className:o.text,children:["API keys are deprecated and will be removed from Grafana on Jan 31, 2025. Each API key will be migrated into a service account with a token and will continue to work as they were. We encourage you to migrate your API keys to service accounts now. ",a]}),(0,e.jsxs)("div",{className:o.actionRow,children:[(0,e.jsx)(y.$n,{className:o.actionButton,onClick:()=>l(!0),children:"Migrate all service accounts"}),(0,e.jsx)(V.u,{title:"Migrate API keys to Service accounts",isOpen:r,body:c,confirmText:"Yes, migrate now",onConfirm:s,onDismiss:()=>l(!1),confirmVariant:"primary",confirmButtonVariant:"primary"})]})]}),t===0&&(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(P.F,{title:"No API keys found",severity:"warning",children:(0,e.jsx)("div",{className:o.text,children:"No API keys were found. If you reload the browser, this page will not be available anymore."})})})]})},Z=s=>({text:(0,d.css)({marginBottom:s.spacing(2)}),actionRow:(0,d.css)({display:"flex",alignItems:"center"}),actionButton:(0,d.css)({marginRight:s.spacing(2)})});var h=n(75911),g=n(95242);function p(){return async s=>{s((0,g.h8)());const[t,i]=await Promise.all([(0,h.AI)().get("/api/auth/keys?includeExpired=false&accesscontrol=true"),(0,h.AI)().get("/api/auth/keys?includeExpired=true&accesscontrol=true")]);s((0,g.Sf)({keys:t,keysIncludingExpired:i}))}}function G(s){return async t=>{(0,h.AI)().delete(`/api/auth/keys/${s}`).then(()=>t(p()))}}function J(s){return async t=>{try{await(0,h.AI)().post(`/api/serviceaccounts/migrate/${s}`)}finally{t(p())}}}function W(){return async s=>{try{const t=await(0,h.AI)().post("/api/serviceaccounts/migrate");s((0,g.QB)(t))}finally{s(p())}}}function H(){return s=>{s((0,g.cV)())}}const X=s=>s.includeExpired?s.keysIncludingExpired.length:s.keys.length,q=s=>{const t=RegExp(s.searchQuery,"i");return(s.includeExpired?s.keysIncludingExpired:s.keys).filter(r=>t.test(r.name)||t.test(r.role))},_=s=>s.includeExpired,ee=s=>s.keys.length===0&&s.keysIncludingExpired.length>0;function se(s){const t=A.TP.hasPermission(v.AccessControlAction.ActionAPIKeysCreate);return{apiKeys:q(s.apiKeys),searchQuery:s.apiKeys.searchQuery,apiKeysCount:X(s.apiKeys),hasFetched:s.apiKeys.hasFetched,timeZone:(0,F.O)(s.user),includeExpired:_(s.apiKeys),includeExpiredDisabled:ee(s.apiKeys),canCreate:t,migrationResult:s.apiKeys.migrationResult}}const te={navId:"apikeys"},ne={loadApiKeys:p,deleteApiKey:G,migrateApiKey:J,migrateAll:W,setSearchQuery:g.Ri,toggleIncludeExpired:H},ie=(0,D.connect)(se,ne);class C extends x.PureComponent{constructor(t){super(t),this.onDeleteApiKey=i=>{this.props.deleteApiKey(i.id)},this.onMigrateApiKey=i=>{this.props.migrateApiKey(i.id)},this.onSearchQueryChange=i=>{this.props.setSearchQuery(i)},this.onIncludeExpiredChange=i=>{this.props.toggleIncludeExpired()},this.onMigrateApiKeys=async()=>{try{await this.props.migrateAll(),this.setState({showMigrationResult:!0})}catch(i){console.error(i)}},this.dismissModal=async()=>{this.setState({showMigrationResult:!1})},this.state={showMigrationResult:!1}}componentDidMount(){this.fetchApiKeys()}async fetchApiKeys(){await this.props.loadApiKeys()}render(){const{hasFetched:t,apiKeysCount:i,apiKeys:r,searchQuery:l,timeZone:o,includeExpired:a,includeExpiredDisabled:c,canCreate:re,migrationResult:S}=this.props,oe=i>0;return(0,e.jsxs)(f.Y,{...te,children:[(0,e.jsxs)(f.Y.Contents,{isLoading:!t,children:[(0,e.jsx)(Y,{onMigrate:this.onMigrateApiKeys,apikeysCount:i}),oe?(0,e.jsx)(w,{searchQuery:l,disabled:!re,onSearchChange:this.onSearchQueryChange}):null,(0,e.jsx)(m.I,{disabled:c,label:"Include expired keys",children:(0,e.jsx)(T.K,{id:"showExpired",value:a,onChange:this.onIncludeExpiredChange})}),r.length>0?(0,e.jsx)(O,{apiKeys:r,timeZone:o,onMigrate:this.onMigrateApiKey,onDelete:this.onDeleteApiKey}):(0,e.jsx)(k.p,{variant:"not-found",message:(0,R.t)("api-keys.empty-state.message","No API keys found")})]}),S&&(0,e.jsx)(E,{visible:this.state.showMigrationResult,data:S,onDismiss:this.dismissModal})]})}}const M={migrationSummary:{padding:"20px"},infoText:{color:"#007bff"},summaryDetails:{marginTop:"20px"},summaryParagraph:{margin:"10px 0"}},E=({visible:s,data:t,onDismiss:i})=>(0,e.jsxs)(j.a,{title:"Migration summary",isOpen:s,closeOnBackdropClick:!0,onDismiss:i,children:[t.failedApikeyIDs.length===0&&(0,e.jsxs)("div",{style:M.migrationSummary,children:[(0,e.jsx)("p",{children:"Migration Successful!"}),(0,e.jsxs)("p",{children:[(0,e.jsx)("strong",{children:"Total: "}),t.total]}),(0,e.jsxs)("p",{children:[(0,e.jsx)("strong",{children:"Migrated: "}),t.migrated]})]}),t.failedApikeyIDs.length!==0&&(0,e.jsxs)("div",{style:M.migrationSummary,children:[(0,e.jsx)("p",{children:"Migration Complete! Please note, while there might be a few API keys flagged as `failed migrations`, rest assured, all of your API keys are fully functional and operational. Please try again or contact support."}),(0,e.jsx)("hr",{}),(0,e.jsxs)("p",{children:[(0,e.jsx)("strong",{children:"Total: "}),t.total]}),(0,e.jsxs)("p",{children:[(0,e.jsx)("strong",{children:"Migrated: "}),t.migrated]}),(0,e.jsxs)("p",{children:[(0,e.jsx)("strong",{children:"Failed: "}),t.failed]}),(0,e.jsxs)("p",{children:[(0,e.jsx)("strong",{children:"Failed Api Key IDs: "}),t.failedApikeyIDs.join(", ")]}),(0,e.jsxs)("p",{children:[(0,e.jsx)("strong",{children:"Failed Details: "}),t.failedDetails.join(", ")]})]}),(0,e.jsx)(j.a.ButtonRow,{children:(0,e.jsx)(y.$n,{variant:"secondary",onClick:i,children:"Close"})})]}),ae=ie(C)}}]);

//# sourceMappingURL=ApiKeysPage.5ba5fbe7f0f7f5ede8a6.js.map